<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Mana Colors Assessment</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Inter', sans-serif;
  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
  color: #e0e0e0;
  min-height: 100vh;
  padding: 20px;
}

.container { max-width: 900px; margin: 0 auto; }

.mana-symbol {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  font-weight: 800;
  font-size: 18px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  border: 2px solid;
}

.mana-W { background: linear-gradient(135deg, #FEF3C7, #FDE047); color: #713F12; border-color: #F59E0B; }
.mana-U { background: linear-gradient(135deg, #DBEAFE, #93C5FD); color: #1E3A8A; border-color: #3B82F6; }
.mana-B { background: linear-gradient(135deg, #E5E7EB, #D1D5DB); color: #1F2937; border-color: #6B7280; }
.mana-R { background: linear-gradient(135deg, #FEE2E2, #FCA5A5); color: #7F1D1D; border-color: #EF4444; }
.mana-G { background: linear-gradient(135deg, #D1FAE5, #6EE7B7); color: #064E3B; border-color: #10B981; }

.card {
  background: rgba(30, 30, 46, 0.95);
  border: 2px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 32px;
  margin-bottom: 24px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
}

.choice-button {
  width: 100%;
  padding: 24px;
  margin: 12px 0;
  background: rgba(255, 255, 255, 0.05);
  border: 2px solid rgba(255, 255, 255, 0.1);
  border-radius: 12px;
  color: #e0e0e0;
  font-size: 16px;
  text-align: left;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 16px;
}

.choice-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(255, 255, 255, 0.3);
  transform: translateY(-2px);
}

.neither-button:hover {
  background: rgba(80, 80, 95, 0.12);
  border-color: rgba(120, 120, 140, 0.35);
  transform: translateY(-1px);
}

.mode-card {
  padding: 20px;
  background: rgba(255,255,255,0.05);
  border: 2px solid rgba(139, 92, 246, 0.3);
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s;
}

.mode-card:hover {
  background: rgba(139, 92, 246, 0.1);
  border-color: rgba(139, 92, 246, 0.5);
  transform: translateY(-2px);
}

.explorer-btn {
  background: rgba(255,255,255,0.05);
  border: 2px solid rgba(139, 92, 246, 0.3);
  color: #a78bfa;
  padding: 12px 24px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.explorer-btn:hover {
  background: rgba(139, 92, 246, 0.15);
  border-color: rgba(139, 92, 246, 0.6);
  transform: translateY(-2px);
}

.btn-primary {
  background: linear-gradient(135deg, #6366f1, #8b5cf6);
  color: white;
  padding: 16px 32px;
  border: none;
  border-radius: 12px;
  font-size: 18px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  box-shadow: 0 4px 16px rgba(99, 102, 241, 0.4);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(99, 102, 241, 0.6);
}

.hidden { display: none !important; }

.result-card {
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
  border: 2px solid rgba(139, 92, 246, 0.3);
  padding: 40px;
  border-radius: 20px;
  margin: 24px 0;
}

.confidence-badge {
  display: inline-block;
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 14px;
  font-weight: 700;
  text-transform: uppercase;
}

.confidence-HIGH { background: rgba(16, 185, 129, 0.2); color: #10B981; border: 1px solid #10B981; }
.confidence-MODERATE { background: rgba(59, 130, 246, 0.2); color: #3B82F6; border: 1px solid #3B82F6; }
.confidence-LOW { background: rgba(245, 158, 11, 0.2); color: #F59E0B; border: 1px solid #F59E0B; }

.fade-in { animation: fadeIn 0.5s ease-in; }
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.bounce-symbol {
  animation: bounce 1s ease-in-out infinite;
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-20px); }
}

.bounce-box {
  width: 16px;
  height: 16px;
  background: linear-gradient(135deg, #a78bfa, #c084fc);
  border-radius: 4px;
  animation: bounce 0.8s ease-in-out infinite;
  box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
}

.round-number-complete {
  width: 48px;
  height: 48px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 800;
  font-size: 24px;
  transition: all 0.3s ease;
}

.round-dot {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 12px;
  background: rgba(255, 255, 255, 0.05);
  border: 2px solid rgba(255, 255, 255, 0.15);
  color: #606070;
  transition: all 0.3s ease;
}

.round-dot.active {
  background: rgba(139, 92, 246, 0.3);
  border-color: rgba(139, 92, 246, 0.6);
  color: #c4b5fd;
  box-shadow: 0 0 12px rgba(139, 92, 246, 0.3);
}

.round-dot.complete {
  background: rgba(16, 185, 129, 0.3);
  border-color: rgba(16, 185, 129, 0.6);
  color: #6EE7B7;
}

.round-connector {
  width: 20px;
  height: 2px;
  background: rgba(255, 255, 255, 0.1);
  transition: all 0.3s ease;
}

.round-connector.active {
  background: rgba(139, 92, 246, 0.5);
}

.round-connector.complete {
  background: rgba(16, 185, 129, 0.5);
}

.archetype-plaque {
  background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(99, 102, 241, 0.15));
  border: 3px solid rgba(139, 92, 246, 0.4);
  border-radius: 16px;
  padding: 32px;
  margin: 32px 0;
  box-shadow: 0 8px 24px rgba(139, 92, 246, 0.2);
  position: relative;
}

.archetype-plaque::before {
  content: '';
  position: absolute;
  top: -2px;
  left: -2px;
  right: -2px;
  bottom: -2px;
  background: linear-gradient(45deg, rgba(139, 92, 246, 0.3), rgba(99, 102, 241, 0.3));
  border-radius: 18px;
  z-index: -1;
}

@media (max-width: 768px) {
  body { padding: 12px; }
  .card { padding: 20px; }
  .choice-button { padding: 16px; font-size: 14px; }
  .strengths-grid { grid-template-columns: 1fr !important; }
  #archetype-of-month > div[style*="grid-template-columns"] { grid-template-columns: 1fr !important; }
  .mode-card { padding: 16px !important; }
  #mode-constructed, #mode-draft { grid-column: span 1; }
  #explorer-mono, #explorer-guilds, #explorer-three, #explorer-four, #explorer-five {
    grid-template-columns: 1fr !important;
  }
  /* Stack explorer columns on mobile */
  #screen-explorer > div:nth-child(2) {
    grid-template-columns: 1fr !important;
  }
  #detail-panel {
    position: static !important;
    margin-top: 20px;
  }
  /* Stack pub descriptions on mobile */
  #detail-content > div:nth-child(3),
  #detail-content > div:nth-child(5) {
    grid-template-columns: 1fr !important;
  }
}

/* ==================================================================== */
/* ENHANCEMENTS: Shimmer, Glow, Modal, Round Display */
/* ==================================================================== */

.progress-shimmer { position: relative; overflow: hidden; }
.progress-shimmer::before {
  content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
  background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.15) 50%, transparent 70%);
  animation: shimmer 3s infinite; pointer-events: none;
}
@keyframes shimmer {
  0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
  100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
}
.progress-opalescent { box-shadow: inset 0 1px 2px rgba(255,255,255,0.4), inset 0 -1px 2px rgba(0,0,0,0.3), 0 2px 8px rgba(0,0,0,0.2); }
.dominant-glow { animation: pulse-glow 2s infinite; }
@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 10px rgba(167,139,250,0.5), inset 0 0 10px rgba(167,139,250,0.2); }
  50% { box-shadow: 0 0 20px rgba(167,139,250,0.8), inset 0 0 15px rgba(167,139,250,0.4); }
}
#modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.90); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px; }
.modal-content-wrapper { max-width: 900px; max-height: 90vh; width: 100%; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 2px solid rgba(139,92,246,0.4); border-radius: 20px; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.8); animation: slideUp 0.4s; }
@keyframes slideUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }
.modal-close { position: sticky; top: 16px; float: right; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #e0e0e0; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; line-height: 38px; text-align: center; cursor: pointer; transition: all 0.2s; margin: 16px; }
.modal-close:hover { background: rgba(255,255,255,0.2); transform: rotate(90deg); }
.deep-dive-btn { width: 100%; background: rgba(139,92,246,0.1); border: 1px solid rgba(139,92,246,0.3); color: #c4b5fd; padding: 18px 24px; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; margin: 10px 0; text-align: left; display: block; }
.deep-dive-btn:hover { background: rgba(139,92,246,0.2); border-color: rgba(139,92,246,0.5); transform: translateX(6px); color: #e9d5ff; }
.round-section { background: rgba(30,30,46,0.5); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 24px; margin: 20px 0; }

/* Modal Tab System */
.modal-tabs { display: flex; gap: 8px; border-bottom: 2px solid rgba(255,255,255,0.1); margin-bottom: 32px; flex-wrap: wrap; }
.tab-btn { background: none; border: none; color: #a0a0b0; padding: 12px 20px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; border-bottom: 3px solid transparent; margin-bottom: -2px; }
.tab-btn.active { color: #c4b5fd; border-bottom-color: #a78bfa; }
.tab-btn:hover { color: #d0d0e0; }
.tab-content { display: block; }
.tab-content.hidden { display: none; }

/* Info Boxes Within Tabs */
.info-box { background: rgba(30, 30, 46, 0.6); border: 1px solid rgba(255, 255, 255, 0.1); border-left: 4px solid #a78bfa; border-radius: 12px; padding: 24px; margin: 20px 0; }
.info-box.strength { border-left-color: #10B981; }
.info-box.shadow { border-left-color: #EF4444; }
.info-box.stress { border-left-color: #F59E0B; }
.info-box.development { border-left-color: #3B82F6; }
.box-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
.box-header h4 { font-size: 16px; font-weight: 700; color: #e0e0e0; text-transform: uppercase; letter-spacing: 1px; margin: 0; }
.box-content { font-size: 14px; line-height: 1.7; color: #d0d0d0; }
.box-content ul { list-style: none; padding: 0; margin: 0; }
.box-content li { padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
.box-content li:last-child { border-bottom: none; }
.quick-fact { background: rgba(139,92,246,0.08); padding: 16px; border-radius: 8px; margin: 12px 0; border-left: 3px solid #a78bfa; }
.quick-fact strong { color: #c4b5fd; display: block; margin-bottom: 6px; font-size: 13px; }

/* Round 2 Ranked List */
.ranking-instructions { background: rgba(139,92,246,0.1); border: 2px solid rgba(139,92,246,0.3); border-radius: 12px; padding: 20px; margin-bottom: 24px; font-size: 14px; line-height: 1.6; }
.ranking-list { background: rgba(0,0,0,0.3); border: 2px solid rgba(255,255,255,0.2); border-radius: 12px; padding: 20px; }
.rank-item { background: rgba(255,255,255,0.08); border: 2px solid rgba(255,255,255,0.15); border-radius: 12px; padding: 20px; margin: 12px 0; cursor: grab; transition: all 0.2s; display: flex; align-items: center; gap: 16px; }
.rank-item:hover { transform: translateY(-2px); border-color: rgba(139,92,246,0.5); box-shadow: 0 8px 20px rgba(0,0,0,0.4); }
.rank-item.dragging { opacity: 0.4; cursor: grabbing; }
.rank-number { background: rgba(139,92,246,0.3); color: #a78bfa; font-weight: 700; font-size: 18px; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.rank-text { flex: 1; font-size: 15px; line-height: 1.5; color: #e0e0e0; }
.rank-label { font-size: 11px; color: #a78bfa; font-weight: 700; text-transform: uppercase; margin-top: 8px; }

/* ============================================================================
   MOBILE RESPONSIVE STYLES
   ============================================================================ */

/* Tablet breakpoint */
@media (max-width: 768px) {
  body { padding: 12px; }
  .container { max-width: 100%; }
  .card { padding: 20px; margin-bottom: 16px; }
  
  /* Welcome screen */
  .mode-card { padding: 16px; }
  #screen-welcome h1 { font-size: 28px; }
  #screen-welcome .archetype-plaque { padding: 16px; }
  
  /* Choice buttons stack on mobile */
  .choice-button { padding: 16px; font-size: 14px; }
  
  /* Result cards */
  .alt-result-card { flex-direction: column; gap: 12px; }
  
  /* Mana pool */
  .mana-symbol { width: 28px; height: 28px; font-size: 14px; }
  
  /* Tab navigation */
  .tab-nav { flex-wrap: wrap; gap: 4px; }
  .tab-btn { padding: 8px 12px; font-size: 12px; }
  
  /* Round transition */
  .round-number-complete { width: 36px; height: 36px; font-size: 18px; }
  
  /* Hide non-essential on mobile */
  .desktop-only { display: none; }
}

/* Phone breakpoint */
@media (max-width: 480px) {
  body { padding: 8px; }
  .card { padding: 16px; border-radius: 12px; }
  
  /* Welcome screen */
  #screen-welcome h1 { font-size: 22px; line-height: 1.3; }
  #screen-welcome p { font-size: 14px; }
  
  /* Big take test button */
  #screen-welcome button[style*="font-size: 24px"] { 
    font-size: 18px !important; 
    padding: 18px 24px !important;
    letter-spacing: 1px !important;
  }
  
  /* Mode selection grid */
  .mode-card { 
    padding: 12px;
  }
  
  /* Stack mode cards vertically */
  div[style*="grid-template-columns: 1fr 1fr"] {
    display: flex !important;
    flex-direction: column !important;
    gap: 12px !important;
  }
  
  /* Assessment questions */
  .choice-button { 
    padding: 14px; 
    font-size: 13px; 
    min-height: auto;
  }
  
  /* Round indicator in header */
  .round-dot { width: 8px !important; height: 8px !important; }
  
  /* Progress info */
  #progress-counter { font-size: 12px; }
  #round-info { font-size: 11px; }
  
  /* Ranking items - make touch-friendly */
  .rank-item { 
    padding: 16px; 
    touch-action: none;
  }
  .rank-number { width: 32px; height: 32px; font-size: 16px; }
  .rank-text { font-size: 14px; }
  
  /* Results page */
  #res-id { font-size: 28px; }
  #res-tag { font-size: 14px; }
  
  /* Commander card */
  .commander-card { padding: 16px; }
  .commander-title { font-size: 18px; }
  
  /* Alternative results */
  .alt-result-card { padding: 12px; }
  
  /* Mana symbols smaller */
  .mana-symbol { width: 24px; height: 24px; font-size: 12px; }
  
  /* Debug panel - full width */
  #debug-section { font-size: 11px; }
  #debug-section pre { font-size: 10px; }
  
  /* Employee of month - compact */
  .archetype-plaque { padding: 12px; }
  .archetype-plaque .quote-text { font-size: 13px; }
  
  /* How it works - compact */
  .round-indicator-step { font-size: 13px; }
  
  /* Explorer modal */
  #modal-content { 
    width: 95vw !important; 
    max-height: 90vh !important;
    padding: 16px !important;
  }
  
  /* Tabs in explorer */
  .tab-btn { padding: 6px 10px; font-size: 11px; }
  
  /* Info boxes */
  .info-box { padding: 16px; }
  .box-header h4 { font-size: 14px; }
  .box-content { font-size: 13px; }
}

/* Touch device optimizations */
@media (hover: none) {
  .choice-button:hover { transform: none; }
  .rank-item:hover { transform: none; }
  .btn-primary:hover { transform: none; }
  
  /* Larger touch targets */
  .choice-button { min-height: 60px; }
  .rank-item { min-height: 70px; }
  button { min-height: 44px; }
}

/* Landscape phone */
@media (max-width: 812px) and (orientation: landscape) {
  .card { padding: 16px; }
  #screen-welcome { padding-top: 10px; }
  .archetype-plaque { display: none; } /* Hide employee of month in landscape */
}

/* High DPI displays */
@media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
  .mana-symbol { 
    box-shadow: 0 1px 4px rgba(0,0,0,0.3);
  }
}

</style>
</head>
<body>
<!-- ENHANCEMENT: Modal Overlay -->
<div id="modal-overlay" class="hidden" onclick="closeModal()">
  <div class="modal-content-wrapper" onclick="event.stopPropagation()">
    <button class="modal-close" onclick="closeModal()">‚úï</button>
    <div style="padding: 32px 48px 48px 48px;">
      <div id="modal-header" style="margin-bottom: 24px;">
        <!-- Identity name, tagline, symbols go here -->
      </div>
      
      <div class="modal-tabs" style="display: flex; gap: 8px; border-bottom: 2px solid rgba(255,255,255,0.1); margin-bottom: 32px;">
        <button class="tab-btn active" onclick="switchModalTab(event, 'overview')">Overview</button>
        <button class="tab-btn" onclick="switchModalTab(event, 'philosophy')">Philosophy</button>
        <button class="tab-btn" onclick="switchModalTab(event, 'workplace')">Workplace</button>
        <button class="tab-btn" onclick="switchModalTab(event, 'stress')">Stress</button>
        <button class="tab-btn" onclick="switchModalTab(event, 'development')">Development</button>
      </div>
      
      <div id="modal-body" style="min-height: 400px;">
        <div id="tab-overview" class="tab-content"><!-- Overview --></div>
        <div id="tab-philosophy" class="tab-content hidden"><!-- Philosophy --></div>
        <div id="tab-workplace" class="tab-content hidden"><!-- Workplace --></div>
        <div id="tab-stress" class="tab-content hidden"><!-- Stress --></div>
        <div id="tab-development" class="tab-content hidden"><!-- Development --></div>
      </div>
    </div>
  </div>
</div>


<div class="container">
  <div id="screen-welcome" class="fade-in">
    <div class="card" style="text-align: center;">
      <div style="display: flex; justify-content: center; gap: 12px; margin-bottom: 24px;">
        <span class="mana-symbol mana-W">W</span>
        <span class="mana-symbol mana-U">U</span>
        <span class="mana-symbol mana-B">B</span>
        <span class="mana-symbol mana-R">R</span>
        <span class="mana-symbol mana-G">G</span>
      </div>
      
      <h1 style="font-size: 48px; margin-bottom: 16px;">THE MANA CURVE</h1>
      <p style="font-size: 24px; color: #a0a0b0; margin-bottom: 8px; font-weight: 600;">Workplace Personality Framework</p>
      <p id="random-tagline" style="font-size: 16px; color: #808090; margin-bottom: 40px; font-style: italic;"></p>
      
      <!-- Employee of the Month - NOW AT TOP -->
      <div id="archetype-of-month" class="archetype-plaque" style="text-align: left; margin-bottom: 32px;"></div>
      
      <!-- Big Take the Test Button -->
      <button onclick="selectMode('draft'); startAssessment();" style="width: 100%; background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 50%, #7c3aed 100%); border: none; color: #fff; padding: 24px 32px; border-radius: 16px; font-size: 24px; font-weight: 800; cursor: pointer; transition: all 0.3s; box-shadow: 0 8px 24px rgba(139, 92, 246, 0.4); margin-bottom: 32px; text-transform: uppercase; letter-spacing: 2px;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 12px 32px rgba(139, 92, 246, 0.5)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 24px rgba(139, 92, 246, 0.4)';">
        ‚öîÔ∏è Take the Test ‚öîÔ∏è
      </button>
      
      <!-- Intro text with Learn More -->
      <div style="background: rgba(255,255,255,0.05); padding: 32px; border-radius: 12px; margin-bottom: 32px; text-align: left;">
        <p style="margin-bottom: 16px; line-height: 1.6;">Many successful people have taken personality assessments. We aren't implying causation, but do you want to leave it to chance?</p>
        <p style="margin-bottom: 16px; line-height: 1.6;">And if you HAVE to do a personality test, why not do a humorous one based on a 30 year old trading card game played by people who are all successful, good looking, elegant and wise?</p>
        
        <div onclick="const content = document.getElementById('learn-more-content'); const arrow = this.querySelector('.learn-more-arrow'); const wasHidden = content.style.display === 'none'; content.style.display = wasHidden ? 'block' : 'none'; arrow.textContent = wasHidden ? '‚ñº' : '‚ñ∂';" style="cursor: pointer; display: inline-flex; align-items: center; gap: 8px; color: #a78bfa; font-weight: 600; margin-bottom: 0; padding: 8px 0;" onmouseover="this.style.color='#c4b5fd'" onmouseout="this.style.color='#a78bfa'">
          <span class="learn-more-arrow">‚ñ∂</span> Learn more about why this exists
        </div>
        
        <div id="learn-more-content" style="display: none; padding: 20px; background: rgba(139, 92, 246, 0.1); border-radius: 8px; border-left: 3px solid #a78bfa; margin-top: 16px;">
          <p style="margin-bottom: 16px; line-height: 1.6; color: #d0d0d0;">The real value isn't predicting success‚Äîit's finally having language for why your coworker's "helpful suggestions" make you want to flip a table. That's Blue vs Red energy, and now you know.</p>
          <p style="margin-bottom: 16px; line-height: 1.6; color: #d0d0d0;">Many successful personality frameworks use colors. DISC uses four. True Colors uses four. Colors tend to be more memorable than 4 letters or a few numbers.</p>
          <p style="margin-bottom: 16px; line-height: 1.6; color: #d0d0d0;">If you've done one or more of these you might have noticed, like us, that those colors bear an awful resemblance to a certain trading card game...</p>
          <p style="margin-bottom: 16px; line-height: 1.6; color: #d0d0d0;">So we asked ourselves‚Äîcould we create a personality framework using <strong style="color: #93C5FD;">five colors from Magic: The Gathering?</strong> We started this as a joke, but the more we looked at it the more it made sense!</p>
          <p style="margin-bottom: 16px; line-height: 1.6; color: #d0d0d0;">We're not here to say it's science, but over 30+ years, millions of players have raged at control-freak Blue players, gotten stomped by massive Green creatures, watched White go wide with tokens, felt Black's ruthless plays, and experienced Red's chaotic aggression. The way we play relates to how we think about the world.</p>
          <p style="margin-bottom: 0; line-height: 1.6; color: #e0e0e0;"><strong>We think the game accidentally created a workplace psychology framework. So we turned it into one.</strong></p>
        </div>
      </div>
      
      <div style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); padding: 24px; border-radius: 12px; margin-bottom: 32px; text-align: left;">
        <h3 style="font-size: 18px; margin-bottom: 16px; color: #a78bfa;">How This Works</h3>
        <div style="display: flex; flex-direction: column; gap: 0; position: relative;">
          <!-- Round 1 -->
          <div style="display: flex; gap: 12px; align-items: start; position: relative; padding-bottom: 16px;">
            <div style="display: flex; flex-direction: column; align-items: center;">
              <div style="background: rgba(139, 92, 246, 0.25); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-weight: 700; color: #a78bfa; border: 2px solid rgba(139, 92, 246, 0.4);">1</div>
              <div style="width: 2px; height: 20px; background: linear-gradient(to bottom, rgba(139, 92, 246, 0.4), rgba(168, 85, 247, 0.5)); margin-top: 4px;"></div>
            </div>
            <div>
              <strong style="color: #c4b5fd;">Round 1: Enemy Pairs</strong> <span style="color: #808090; font-size: 13px;">(30 questions)</span><br>
              <span style="color: #a0a0b0; font-size: 14px;">Pick between opposing philosophies. We measure all five colors.</span>
            </div>
          </div>
          <!-- Round 2 -->
          <div style="display: flex; gap: 12px; align-items: start; position: relative; padding-bottom: 16px;">
            <div style="display: flex; flex-direction: column; align-items: center;">
              <div style="background: rgba(168, 85, 247, 0.35); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-weight: 700; color: #c084fc; border: 2px solid rgba(168, 85, 247, 0.5);">2</div>
              <div style="width: 2px; height: 20px; background: linear-gradient(to bottom, rgba(168, 85, 247, 0.5), rgba(192, 132, 252, 0.6)); margin-top: 4px;"></div>
            </div>
            <div>
              <strong style="color: #d8b4fe;">Round 2: Calibration</strong> <span style="color: #808090; font-size: 13px;">(6-12 questions)</span><br>
              <span style="color: #a0a0b0; font-size: 14px;">Tests ally pairs to validate Round 1 and detect noise.</span>
            </div>
          </div>
          <!-- Round 3 -->
          <div style="display: flex; gap: 12px; align-items: start; position: relative; padding-bottom: 16px;">
            <div style="display: flex; flex-direction: column; align-items: center;">
              <div style="background: rgba(192, 132, 252, 0.45); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-weight: 700; color: #d8b4fe; border: 2px solid rgba(192, 132, 252, 0.6);">3</div>
              <div style="width: 2px; height: 20px; background: linear-gradient(to bottom, rgba(192, 132, 252, 0.6), rgba(232, 121, 249, 0.7)); margin-top: 4px;"></div>
            </div>
            <div>
              <strong style="color: #e9d5ff;">Round 3: Final Determination</strong> <span style="color: #808090; font-size: 13px;">(2-4 questions)</span><br>
              <span style="color: #a0a0b0; font-size: 14px;">Rank approaches to confirm your exact identity.</span>
            </div>
          </div>
          <!-- Round 4: Results -->
          <div style="display: flex; gap: 12px; align-items: start;">
            <div style="display: flex; flex-direction: column; align-items: center;">
              <div style="background: linear-gradient(135deg, rgba(232, 121, 249, 0.6), rgba(244, 114, 182, 0.6)); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-weight: 700; color: #fdf4ff; border: 2px solid rgba(232, 121, 249, 0.8); box-shadow: 0 0 12px rgba(232, 121, 249, 0.4);">‚ú¶</div>
            </div>
            <div>
              <strong style="color: #f5d0fe;">Round 4: Results</strong><br>
              <span style="color: #a0a0b0; font-size: 14px;">Discover your mana identity. Judge yourself accordingly.</span>
            </div>
          </div>
        </div>
      </div>
      
      <div style="margin: 24px 0; padding: 20px; background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 12px;">
        <p style="font-size: 12px; color: #F59E0B; font-weight: 600; margin-bottom: 8px;">‚ö†Ô∏è WARNING: NOT FOR OFFICIAL USE</p>
        <p style="font-size: 11px; color: #d0a070; line-height: 1.6; margin-bottom: 6px;">Do not use this for hiring, firing, promoting, demoting, or any decision affecting actual humans.</p>
        <p style="font-size: 11px; color: #d0a070; line-height: 1.6; margin-bottom: 6px;">This is a personality framework based on a trading card game about wizards fighting each other.</p>
        <p style="font-size: 11px; color: #c09060; line-height: 1.6; font-style: italic;">Is this a joke? Unclear. But it's 30 years of game design about strategic philosophy, so it's not nothing.</p>
      </div>
      
      <!-- Mode Selection -->
      <div style="margin: 32px 0; padding: 24px; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 12px;">
        <h3 style="font-size: 18px; margin-bottom: 16px; color: #a78bfa;">Choose Your Format</h3>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
          <!-- Constructed Mode -->
          <div id="mode-constructed" onclick="selectMode('constructed')" class="mode-card">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <div style="width: 24px; height: 24px; border: 2px solid rgba(139, 92, 246, 0.5); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <div id="constructed-check" style="width: 12px; height: 12px; background: rgba(139, 92, 246, 0.8); border-radius: 50%; display: none;"></div>
              </div>
              <div style="font-size: 16px; font-weight: 700; color: #e0e0e0;">üèóÔ∏è Constructed</div>
            </div>
            <p style="font-size: 13px; color: #a0a0b0; line-height: 1.5; margin-bottom: 8px;">See the mana symbols for each choice. Understand exactly what colors you're picking.</p>
            <p style="font-size: 12px; color: #808090; font-style: italic;">I'm not saying your choices say something about you. But they do.</p>
          </div>
          
          <!-- Draft Mode -->
          <div id="mode-draft" onclick="selectMode('draft')" class="mode-card" style="border: 2px solid rgba(139, 92, 246, 0.8); background: rgba(139, 92, 246, 0.15);">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <div style="width: 24px; height: 24px; border: 2px solid rgba(139, 92, 246, 0.5); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <div id="draft-check" style="width: 12px; height: 12px; background: rgba(139, 92, 246, 0.8); border-radius: 50%;"></div>
              </div>
              <div style="font-size: 16px; font-weight: 700; color: #e0e0e0;">üì¶ Blind Draft</div>
            </div>
            <p style="font-size: 13px; color: #a0a0b0; line-height: 1.5; margin-bottom: 8px;">Make choices blind. No mana symbols shown. The test as it's meant to be played.</p>
            <p style="font-size: 12px; color: #808090; font-style: italic;">Recommended: Reveals your actual decision-making patterns.</p>
          </div>
        </div>
        
        <p style="font-size: 12px; color: #808090; text-align: center; font-style: italic;">You can always retake it in the other mode.</p>
      </div>
      
      <button class="btn-primary" onclick="startAssessment()">Enter the Arena</button>
      <p style="margin-top: 16px; color: #808090; font-size: 14px;">~13-15 minutes ‚Ä¢ If you're reading this far, let's be honest, you have the time</p>
      <p style="margin-top: 8px; color: #606070; font-size: 12px;">31 possible results because limiting yourself to 16 personality types is for cowards</p>
      
      <div style="margin-top: 24px; text-align: center;">
        <button onclick="showExplorer()" class="explorer-btn">
          üìö Explore All 31 Personality Types
        </button>
      </div>
      
      <div style="margin-top: 12px; text-align: center;">
        <button onclick="showInteractions()" class="explorer-btn">
          ü§ù How Colors Interact
        </button>
      </div>
    </div>
  </div>

  <div id="screen-assessment" class="hidden">
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <div id="header-mana-symbols" style="display: flex; gap: 8px;">
          <span class="mana-symbol mana-W" style="width: 28px; height: 28px; font-size: 14px;">W</span>
          <span class="mana-symbol mana-U" style="width: 28px; height: 28px; font-size: 14px;">U</span>
          <span class="mana-symbol mana-B" style="width: 28px; height: 28px; font-size: 14px;">B</span>
          <span class="mana-symbol mana-R" style="width: 28px; height: 28px; font-size: 14px;">R</span>
          <span class="mana-symbol mana-G" style="width: 28px; height: 28px; font-size: 14px;">G</span>
        </div>
        <div style="display: flex; gap: 12px; align-items: center;">
          <button id="debug-toggle-btn" onclick="toggleDebug()" style="background: rgba(139, 92, 246, 0.2); border: 1px solid rgba(139, 92, 246, 0.4); color: #a78bfa; padding: 4px 12px; border-radius: 6px; font-size: 11px; cursor: pointer; text-transform: uppercase; font-weight: 600; display: none;">Debug</button>
          <div style="text-align: right;">
            <div style="font-weight: 700; font-size: 14px;">Question <span id="q-num">1</span> of <span id="q-tot">30</span></div>
            <div style="font-size: 12px; color: #808090;" id="stage-label">Round 1</div>
          </div>
        </div>
      </div>
      
      <div style="margin-bottom: 8px;">
        <!-- Round Progress Indicator -->
        <div style="display: flex; justify-content: center; gap: 8px; margin-bottom: 12px; align-items: center;">
          <div id="round-dot-1" class="round-dot active" title="Round 1: Enemy Pairs">
            <span>1</span>
          </div>
          <div class="round-connector" id="connector-1-2"></div>
          <div id="round-dot-2" class="round-dot" title="Round 2: Calibration">
            <span>2</span>
          </div>
          <div class="round-connector" id="connector-2-3"></div>
          <div id="round-dot-3" class="round-dot" title="Round 3: Final">
            <span>3</span>
          </div>
          <div class="round-connector" id="connector-3-4"></div>
          <div id="round-dot-4" class="round-dot" title="Results">
            <span>‚ú¶</span>
          </div>
        </div>
        <div style="display: flex; justify-content: space-between; font-size: 11px; color: #606070; margin-bottom: 4px;">
          <span id="round-label-left">Round 1: Enemy Pairs</span>
          <span id="round-label-right" style="opacity: 0.5;">‚Üí Calibration ‚Üí Final ‚Üí Results</span>
        </div>
        <div style="position: relative; height: 12px; overflow: hidden;">
          <div style="position: absolute; width: 100%; height: 12px; background: rgba(255,255,255,0.05); border-radius: 6px;"></div>
          <div id="prog-s1" style="position: absolute; height: 12px; background: linear-gradient(90deg, #FDE047, #93C5FD, #D1D5DB, #FCA5A5, #6EE7B7); border-radius: 6px; transition: all 0.3s; width: 0%;"></div>
          <div id="prog-s2" style="position: absolute; height: 12px; background: rgba(245, 158, 11, 0.6); border-radius: 6px; transition: all 0.3s; width: 0%; opacity: 0;"></div>
          <div id="prog-s3" style="position: absolute; height: 12px; background: rgba(139, 92, 246, 0.6); border-radius: 6px; transition: all 0.3s; width: 0%; opacity: 0;"></div>
        </div>
      </div>
    </div>
    
    <div class="card" style="min-height: 280px; display: flex; flex-direction: column;">
      <div style="font-size: 12px; text-transform: uppercase; color: #808090; margin-bottom: 8px;" id="ctx">Context</div>
      <h2 style="font-size: 24px; margin-bottom: 24px; line-height: 1.4; flex-grow: 1;" id="scenario">Scenario</h2>
      <p style="color: #a0a0b0; margin-bottom: 24px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1);" id="instr">Choose the response <strong>more like you</strong>.</p>
      <div id="choices"></div>
    </div>
    
    <div id="debug-section" class="card" style="background: rgba(139, 92, 246, 0.05); border-color: rgba(139, 92, 246, 0.2); display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h4 style="font-size: 14px; color: #a78bfa; text-transform: uppercase; letter-spacing: 1px;">üîç Debug Info</h4>
        <button onclick="document.getElementById('debug-section').style.display='none'" style="background: none; border: none; color: #808090; cursor: pointer; font-size: 20px; padding: 0 8px;">√ó</button>
      </div>
      <div id="debug-content" style="font-family: monospace; font-size: 12px; color: #d0d0d0; line-height: 1.8;"></div>
    </div>
  </div>

  <div id="screen-interstitial" class="hidden">
    <div class="card fade-in" style="text-align: center;">
      <div style="display: flex; justify-content: center; gap: 12px; margin-bottom: 24px;">
        <span class="mana-symbol mana-W">W</span>
        <span class="mana-symbol mana-U">U</span>
        <span class="mana-symbol mana-B">B</span>
        <span class="mana-symbol mana-R">R</span>
        <span class="mana-symbol mana-G">G</span>
      </div>
      
      <h2 style="font-size: 36px; margin-bottom: 24px;">Round 1 Complete</h2>
      
      <div style="background: rgba(255,255,255,0.05); padding: 32px; border-radius: 12px; margin-bottom: 32px; text-align: left;">
        <p style="font-size: 18px; margin-bottom: 20px; font-weight: 600; text-align: center;">We've identified your strongest colors</p>
        
        <div style="margin: 20px 0; padding: 20px; background: rgba(139, 92, 246, 0.1); border-radius: 8px; text-align: center;">
          <div id="inter-scores" style="font-size: 15px; line-height: 1.8; color: #d0d0d0;"></div>
        </div>
        
        <p style="line-height: 1.8; margin-bottom: 20px; font-size: 15px; color: #d0d0d0;" id="inter-explanation">Explanation</p>
        <p style="line-height: 1.8; font-size: 15px; color: #a0a0b0; font-weight: 500;" id="inter-next">Next step</p>
      </div>
      
      <button class="btn-primary" onclick="continueToStage2()">Continue to Final Round</button>
      <p style="margin-top: 16px; color: #808090; font-size: 13px;">A few forced-choice questions to confirm your identity</p>
    </div>
  </div>

  <div id="screen-early-offer" class="hidden">
    <div class="card fade-in" style="text-align: center;">
      <div style="display: flex; justify-content: center; gap: 12px; margin-bottom: 24px;">
        <span class="mana-symbol mana-W">W</span>
        <span class="mana-symbol mana-U">U</span>
        <span class="mana-symbol mana-B">B</span>
        <span class="mana-symbol mana-R">R</span>
        <span class="mana-symbol mana-G">G</span>
      </div>
      
      <h2 style="font-size: 32px; margin-bottom: 16px;">üìä Round 1 Complete</h2>
      <p style="color: #a0a0b0; margin-bottom: 24px;">30 enemy pair comparisons analysed</p>
      
      <div style="background: rgba(139, 92, 246, 0.1); border: 2px solid rgba(139, 92, 246, 0.4); border-radius: 16px; padding: 28px; margin: 24px auto; max-width: 500px;">
        <p style="font-size: 14px; color: #a0a0b0; margin-bottom: 16px; text-transform: uppercase; letter-spacing: 1px;">You're trending toward</p>
        <div style="display: flex; justify-content: center; gap: 12px; margin-bottom: 16px;" id="early-symbols"></div>
        <h3 style="font-size: 28px; margin-bottom: 12px;" id="early-result-name">IDENTITY</h3>
        <p style="font-size: 16px; color: #a0a0b0; margin-bottom: 12px;" id="early-result-tag">Tagline</p>
        <span class="confidence-badge confidence-HIGH" id="early-confidence">Strong Signal</span>
        <p style="margin-top: 12px; font-size: 13px; color: #c0c0d0; line-height: 1.5;" id="early-message">Explanation message</p>
      </div>
      
      <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 20px; margin: 24px auto; max-width: 500px;">
        <p style="font-size: 14px; color: #d0d0d0; margin-bottom: 8px;">
          <strong style="color: #a78bfa;">Next:</strong> Round 2 calibrates your ally colors
        </p>
        <p style="font-size: 13px; color: #909090;">
          Round 1 tested enemy pairs. Round 2 tests ally pairs to confirm what's real vs. noise.
        </p>
      </div>
      
      <button onclick="continueToRound2()" style="background: linear-gradient(135deg, #a78bfa 0%, #8b5cf6 100%); border: none; color: #fff; padding: 18px 40px; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4); margin-top: 8px;">
        Continue to Round 2 ‚Üí
      </button>
      
      <p style="font-size: 12px; color: #606070; margin-top: 16px;">~12 more questions ‚Ä¢ 4-5 minutes</p>
    </div>
  </div>

  <div id="screen-calculating" class="hidden">
    <div class="card fade-in" style="text-align: center; min-height: 400px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
      <h2 style="font-size: 36px; margin-bottom: 32px;">Calculating Your Mana Curve...</h2>
      
      <div id="bouncing-symbols" style="display: flex; gap: 16px; margin-bottom: 32px;">
        <span class="mana-symbol mana-W bounce-symbol" style="animation-delay: 0s;">W</span>
        <span class="mana-symbol mana-U bounce-symbol" style="animation-delay: 0.1s;">U</span>
        <span class="mana-symbol mana-B bounce-symbol" style="animation-delay: 0.2s;">B</span>
        <span class="mana-symbol mana-R bounce-symbol" style="animation-delay: 0.3s;">R</span>
        <span class="mana-symbol mana-G bounce-symbol" style="animation-delay: 0.4s;">G</span>
      </div>
      
      <p style="color: #808090; font-size: 14px;">Analyzing your color distribution...</p>
    </div>
  </div>

  <!-- Round Transition Interstitial -->
  <div id="screen-round-transition" class="hidden">
    <div class="card fade-in" style="text-align: center; min-height: 400px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
      <div id="transition-round-indicator" style="display: flex; gap: 16px; margin-bottom: 32px; align-items: center;">
        <!-- Filled dynamically with bouncing box -->
      </div>
      <h2 id="transition-title" style="font-size: 32px; margin-bottom: 16px;">Round Complete</h2>
      <p id="transition-subtitle" style="color: #a0a0b0; font-size: 16px; margin-bottom: 32px;">Preparing next round...</p>
      <div style="display: flex; gap: 12px;">
        <div class="bounce-box" style="animation-delay: 0s;"></div>
        <div class="bounce-box" style="animation-delay: 0.15s;"></div>
        <div class="bounce-box" style="animation-delay: 0.3s;"></div>
      </div>
    </div>
  </div>

  <div id="screen-results" class="hidden">
    <div class="card fade-in" style="text-align: center;">
      <div style="display: flex; justify-content: center; gap: 12px; margin-bottom: 24px;">
        <span class="mana-symbol mana-W">W</span>
        <span class="mana-symbol mana-U">U</span>
        <span class="mana-symbol mana-B">B</span>
        <span class="mana-symbol mana-R">R</span>
        <span class="mana-symbol mana-G">G</span>
      </div>
      <h1 style="font-size: 42px; margin-bottom: 16px;">Your Color Identity</h1>
      <p style="color: #808090; font-size: 13px; margin-top: 8px; font-style: italic;" id="mode-used"></p>
    </div>
    
    <div class="result-card fade-in">
      <div style="text-align: center;">
        <div style="display: flex; justify-content: center; gap: 12px; margin-bottom: 24px;" id="res-syms"></div>
        <h2 style="font-size: 48px; margin-bottom: 12px;" id="res-id">IDENTITY</h2>
        <p style="font-size: 24px; color: #a0a0b0; margin-bottom: 16px;" id="res-tag">Tagline</p>
        <span class="confidence-badge" id="conf-badge">CONFIDENCE</span>
        <p style="margin-top: 12px; font-size: 13px; color: #808090; font-style: italic;" id="conf-exp">Explanation</p>

      </div>
      
      <!-- LOW confidence alternatives - shown right here if LOW -->
      <div id="alternative-results" style="display: none; margin-top: 24px; padding-top: 24px; border-top: 1px solid rgba(255,255,255,0.1);">
        <div style="font-size: 14px; font-weight: 600; color: #a78bfa; margin-bottom: 16px;">üîÄ You're borderline. Based on your choices, you could also be:</div>
        <div style="background: rgba(139, 92, 246, 0.15); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
          <p style="font-size: 14px; color: #e0e0e0; line-height: 1.6;" id="why-explanation">Explanation</p>
        </div>
        <div id="alternatives-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px;"></div>
      </div>
      
      <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid rgba(255,255,255,0.1);">
        <div style="font-size: 13px; font-weight: 600; color: #a0a0b0; margin-bottom: 8px;">Why this identity:</div>
        <p style="font-size: 14px; line-height: 1.6; color: #d0d0d0;" id="identity-exp">Explanation</p>
      </div>
    </div>
    
    <div class="card fade-in">
      <h3 style="font-size: 24px; margin-bottom: 8px;">Your Profile</h3>
      <p style="font-size: 13px; color: #808090; margin-bottom: 24px; font-style: italic;">What people who know you might say about you.</p>
      
      <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px; margin-bottom: 16px; border-left: 3px solid rgba(99, 102, 241, 0.5);">
        <div style="font-size: 11px; font-weight: 600; color: #6366f1; text-transform: uppercase; margin-bottom: 8px;">üíº How they might describe you to your face</div>
        <p style="line-height: 1.8; font-size: 16px;" id="res-desc">Description</p>
      </div>
      
      <div style="background: rgba(245, 158, 11, 0.08); padding: 20px; border-radius: 10px; margin-bottom: 24px; border-left: 3px solid rgba(245, 158, 11, 0.5);">
        <div style="font-size: 11px; font-weight: 600; color: #F59E0B; text-transform: uppercase; margin-bottom: 8px;">How they might describe you behind your back</div>
        <p style="line-height: 1.6; font-size: 14px; color: #d0a070; font-style: italic;" id="res-counter">Counter description</p>
      </div>
      
      <div style="background: rgba(255,255,255,0.05); padding: 24px; border-radius: 12px; margin: 24px 0; border: 1px solid rgba(255,255,255,0.1);" id="cmd-container">
        <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #808090; margin-bottom: 12px;">‚ö° Legendary Commander</div>
        
        <!-- Card Frame (only if oracle data exists) -->
        <div id="cmd-card-frame" style="background: linear-gradient(135deg, #2a2a3e 0%, #1f1f2e 100%); border: 3px solid rgba(139, 92, 246, 0.4); border-radius: 12px; padding: 16px; max-width: 500px; display: none;">
          
          <!-- Name and Mana Cost (top bar) -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding: 8px 12px; background: rgba(0,0,0,0.3); border-radius: 6px;">
            <div style="font-size: 18px; font-weight: 700; color: #fff;" id="cmd-name-card">Commander</div>
            <div id="cmd-cost" style="display: flex; gap: 3px;"></div>
          </div>
          
          <!-- Type Line -->
          <div style="padding: 6px 12px; background: rgba(0,0,0,0.2); border-radius: 4px; margin-bottom: 12px;">
            <div style="font-size: 13px; color: #d0d0d0; font-weight: 600;">Legendary Creature</div>
          </div>
          
          <!-- Card Text Box -->
          <div style="background: rgba(0,0,0,0.25); padding: 16px; padding-bottom: 48px; border-radius: 6px; min-height: 180px; position: relative;">
            <!-- Flavor text (our description) -->
            <p style="color: #b0b0c0; font-size: 13px; font-style: italic; line-height: 1.5; margin-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px;" id="cmd-desc-card">Description</p>
            
            <!-- Oracle text (abilities) -->
            <div id="cmd-oracle-text" style="font-size: 13px; color: #e0e0e0; line-height: 1.7; margin-bottom: 8px;"></div>
            
            <!-- P/T in bottom right corner -->
            <div id="cmd-pt" style="position: absolute; bottom: 12px; right: 12px; font-size: 20px; font-weight: 800; color: #fff; background: rgba(0,0,0,0.6); padding: 6px 14px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.2);"></div>
          </div>
        </div>
        
        <!-- Simple Reference (if no oracle data) -->
        <div id="cmd-simple" style="display: none;">
          <div style="font-weight: 700; font-size: 20px; margin-bottom: 8px; color: #fff;" id="cmd-name-simple">Commander</div>
          <p style="font-size: 14px; color: #b0b0c0; font-style: italic; line-height: 1.6;" id="cmd-desc-simple">Description</p>
          <p style="font-size: 12px; color: #808090; margin-top: 12px; font-style: italic;">Full card details coming soon...</p>
        </div>
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 32px 0;" class="strengths-grid">
        <div style="background: rgba(16, 185, 129, 0.08); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; padding: 20px;">
          <h4 style="font-size: 18px; margin-bottom: 8px; color: #10B981;">‚öî Strengths</h4>
          <p style="font-size: 11px; color: #6b9080; margin-bottom: 12px; font-style: italic;">These are probably strengths you have</p>
          <ul style="list-style: none; padding: 0;" id="strengths"></ul>
        </div>
        
        <div style="background: rgba(239, 68, 68, 0.08); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 12px; padding: 20px;">
          <h4 style="font-size: 18px; margin-bottom: 8px; color: #EF4444;">‚ö† Shadows</h4>
          <p style="font-size: 11px; color: #9b6b6b; margin-bottom: 12px; font-style: italic;">Risks of this type‚Äîyou may not have these, or may manage them well</p>
          <ul style="list-style: none; padding: 0;" id="weaknesses"></ul>
        </div>
      </div>
      
      <div style="margin: 32px 0;">
        <h4 style="font-size: 18px; margin-bottom: 8px;">üìã Stereotypical Roles</h4>
        <p style="font-size: 12px; color: #808090; margin-bottom: 12px; font-style: italic;">Where this identity typically thrives:</p>
        <p style="color: #a0a0b0; margin-bottom: 12px;" id="roles">Roles</p>
      </div>
      
      <!-- PRIMARY Color Indicator (only for multi-color with dominant) -->
      <div id="primary-color-indicator" style="display: none; margin: 32px 0; padding: 20px; background: rgba(139, 92, 246, 0.15); border: 1px solid rgba(139, 92, 246, 0.4); border-radius: 12px; border-left: 4px solid #a78bfa;">
        <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #a78bfa; margin-bottom: 8px; font-weight: 600;">‚≠ê PRIMARY COLOR WITHIN THIS COMBINATION</div>
        <p style="font-size: 15px; color: #e0e0e0; font-weight: 600; line-height: 1.6;"></p>
      </div>
    </div>
    

      <!-- ENHANCEMENT: Deep Dive Button -->
      <div style="margin: 40px 0; padding: 32px 0; border-top: 2px solid rgba(255,255,255,0.1);">
        <h3 style="font-size: 20px; font-weight: 700; margin-bottom: 20px; color: #e0e0e0;">üìö Explore Your Identity</h3>
        <button class="deep-dive-btn" onclick="showDeepDive('philosophy', state.result.identity)">
          <span style="font-size: 16px;">‚Üí</span> Full Philosophy & Workplace Patterns
        </button>
      </div>
    
    <!-- UNIFIED TESTING BREAKDOWN -->
    <div class="card fade-in">
      <div onclick="const breakdown = document.getElementById('unified-breakdown'); const arrow = this.querySelector('.expand-icon'); const wasHidden = breakdown.style.display === 'none'; breakdown.style.display = wasHidden ? 'block' : 'none'; arrow.textContent = wasHidden ? '‚ñº' : '‚ñ∂';" style="cursor: pointer; display: flex; align-items: center; gap: 12px;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
        <h3 style="font-size: 24px; margin: 0;">Your Mana Pool</h3>
        <span class="expand-icon" style="color: #a78bfa; font-size: 18px;">‚ñ∂</span>
      </div>
      <p style="font-size: 13px; color: #808090; margin: 8px 0 24px 0; font-style: italic;">Click to see how we identified your colors</p>
      
      <!-- Always visible: Quick percentage view -->
      <div id="mana-pool-bars"></div>
      
      <!-- Expandable: Full Round 1 + Round 2 + Round 3 breakdown -->
      <div id="unified-breakdown" style="display: none; margin-top: 32px; padding-top: 32px; border-top: 2px solid rgba(255,255,255,0.1);">
        
        <!-- ROUND 1: ENEMY PAIR TESTING -->
        <div style="margin-bottom: 40px;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
            <div style="background: rgba(99, 102, 241, 0.3); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; color: #6366f1; font-size: 20px;">1</div>
            <div>
              <h4 style="font-size: 20px; margin: 0; color: #e0e0e0;">Enemy Pair Testing</h4>
              <p style="font-size: 12px; color: #808090; margin: 0;">30 forced-choice questions</p>
            </div>
          </div>
          
          <div style="background: rgba(99, 102, 241, 0.05); padding: 24px; border-radius: 12px; border: 1px solid rgba(99, 102, 241, 0.2);">
            <p style="font-size: 14px; color: #d0d0d0; margin-bottom: 20px; line-height: 1.7;">
              We tested five enemy color pairs (White/Black, Blue/Red, Green/Blue, White/Red, Black/Green). 
              Each question forced you to choose between competing philosophies, revealing which colors genuinely resonate.
            </p>
            <div id="stage1-explanation-content"></div>
          </div>
        </div>
        
        <!-- ROUND 2: ALLY PAIR CALIBRATION -->
        <div id="round2-unified-section" style="display: none;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
            <div style="background: rgba(245, 158, 11, 0.3); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; color: #F59E0B; font-size: 20px;">2</div>
            <div>
              <h4 style="font-size: 20px; margin: 0; color: #e0e0e0;">Ally Pair Calibration</h4>
              <p style="font-size: 12px; color: #808090; margin: 0;" id="round2-question-count"><!-- filled dynamically --></p>
            </div>
          </div>
          
          <div style="background: rgba(245, 158, 11, 0.05); padding: 24px; border-radius: 12px; border: 1px solid rgba(245, 158, 11, 0.2);">
            <div id="round2-intro-text" style="font-size: 14px; color: #d0d0d0; margin-bottom: 20px; line-height: 1.7;">
              <!-- Filled dynamically with calibration explanation -->
            </div>
            <div id="round2-calibration-results"></div>
          </div>
        </div>
        
        <!-- ROUND 3: FINAL DETERMINATION -->
        <div id="round3-unified-section" style="display: none;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
            <div style="background: rgba(139, 92, 246, 0.3); width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 800; color: #a78bfa; font-size: 20px;">3</div>
            <div>
              <h4 style="font-size: 20px; margin: 0; color: #e0e0e0;">Final Determination</h4>
              <p style="font-size: 12px; color: #808090; margin: 0;" id="round3-question-count"><!-- filled dynamically --></p>
            </div>
          </div>
          
          <div style="background: rgba(139, 92, 246, 0.05); padding: 24px; border-radius: 12px; border: 1px solid rgba(139, 92, 246, 0.2);">
            <div id="round3-intro-text" style="font-size: 14px; color: #d0d0d0; margin-bottom: 20px; line-height: 1.7;">
              <!-- Filled dynamically with what was tested and why -->
            </div>
            
            <div id="round3-bars"></div>
            <div id="round3-testing-explanation" style="margin-top: 20px;"></div>
          </div>
        </div>
        
      </div>
    </div>
    
    <div style="text-align: center; margin-top: 32px;" class="fade-in">
      <button class="btn-primary" onclick="restart()" id="restart-btn">Take It Again</button>
      <p style="margin-top: 16px; color: #808090; font-size: 13px;" id="restart-text">Retake it to get the result you wanted instead of who you actually are?</p>
      
      <div style="margin-top: 24px;">
        <button onclick="showExplorer()" class="explorer-btn">
          üìö Explore All 31 Personality Types
        </button>
        <p style="margin-top: 12px; font-size: 12px; color: #808090; font-style: italic;" id="explorer-hint"></p>
      </div>
      
      <div style="margin-top: 12px;">
        <button onclick="showInteractions()" class="explorer-btn">
          ü§ù How Your Colors Interact With Others
        </button>
      </div>
      
      <div style="margin-top: 20px; padding: 20px; background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 12px; max-width: 600px; margin-left: auto; margin-right: auto;">
        <p style="font-size: 12px; color: #F59E0B; font-weight: 600; margin-bottom: 8px;">‚ö†Ô∏è WARNING: NOT FOR OFFICIAL USE</p>
        <p style="font-size: 11px; color: #d0a070; line-height: 1.6; margin-bottom: 6px;">Do not use this for hiring, firing, promoting, demoting, or any decision affecting actual humans.</p>
        <p style="font-size: 11px; color: #d0a070; line-height: 1.6; margin-bottom: 6px;">This is a personality framework based on a trading card game about wizards fighting each other.</p>
        <p style="font-size: 11px; color: #c09060; line-height: 1.6; font-style: italic;">Is this a joke? Unclear. But it's 30 years of game design about strategic philosophy, so it's not nothing.</p>
      </div>
    </div>
  </div>
  
  <!-- EXPLORER SCREEN -->
  <div id="screen-explorer" class="hidden">
    <div class="card fade-in" style="text-align: center;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <button onclick="closeExplorer()" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #a0a0b0; padding: 8px 16px; border-radius: 8px; font-size: 14px; cursor: pointer; font-weight: 600;">
          ‚Üê Back
        </button>
        <h1 style="font-size: 32px; margin: 0;">The Complete Framework</h1>
        <div style="width: 80px;"></div>
      </div>
      
      <p style="color: #a0a0b0; margin-bottom: 8px;">All 31 color identities in the Mana Curve framework</p>
      <p style="color: #808090; font-size: 13px; font-style: italic;">Click any identity to view its complete profile</p>
    </div>
    
    <!-- Two Column Layout: Grid + Detail -->
    <div style="display: grid; grid-template-columns: 1fr 1.2fr; gap: 24px; align-items: start;">
      
      <!-- LEFT: Identity Grid -->
      <div>
        <!-- Mono-Colors -->
        <div class="card fade-in" style="margin-bottom: 20px;">
          <h3 style="font-size: 16px; margin-bottom: 8px; color: #a78bfa; text-transform: uppercase; letter-spacing: 1px;">Mono-Color (5)</h3>
          <p style="font-size: 12px; color: #808090; margin-bottom: 16px; font-style: italic;">Pure, focused, uncompromising</p>
          <div style="display: grid; gap: 10px;" id="explorer-mono"></div>
        </div>
        
        <!-- Two-Color Guilds -->
        <div class="card fade-in" style="margin-bottom: 20px;">
          <h3 style="font-size: 16px; margin-bottom: 8px; color: #a78bfa; text-transform: uppercase; letter-spacing: 1px;">Two-Color Guilds (10)</h3>
          <p style="font-size: 12px; color: #808090; margin-bottom: 16px; font-style: italic;">Allied and enemy pairs</p>
          <div style="display: grid; gap: 10px;" id="explorer-guilds"></div>
        </div>
        
        <!-- Three-Color -->
        <div class="card fade-in" style="margin-bottom: 20px;">
          <h3 style="font-size: 16px; margin-bottom: 8px; color: #a78bfa; text-transform: uppercase; letter-spacing: 1px;">Three-Color (10)</h3>
          <p style="font-size: 12px; color: #808090; margin-bottom: 16px; font-style: italic;">Shards and wedges</p>
          <div style="display: grid; gap: 10px;" id="explorer-three"></div>
        </div>
        
        <!-- Four-Color -->
        <div class="card fade-in" style="margin-bottom: 20px;">
          <h3 style="font-size: 16px; margin-bottom: 8px; color: #a78bfa; text-transform: uppercase; letter-spacing: 1px;">Four-Color (5)</h3>
          <p style="font-size: 12px; color: #808090; margin-bottom: 16px; font-style: italic;">Defined by what's missing</p>
          <div style="display: grid; gap: 10px;" id="explorer-four"></div>
        </div>
        
        <!-- Five-Color -->
        <div class="card fade-in" style="margin-bottom: 20px;">
          <h3 style="font-size: 16px; margin-bottom: 8px; color: #a78bfa; text-transform: uppercase; letter-spacing: 1px;">Five-Color (1)</h3>
          <p style="font-size: 12px; color: #808090; margin-bottom: 16px; font-style: italic;">Everything at once</p>
          <div style="display: grid; gap: 10px;" id="explorer-five"></div>
        </div>
      </div>
      
      <!-- RIGHT: Detail Panel -->
      <div id="detail-panel" class="card fade-in" style="position: sticky; top: 20px; min-height: 600px;">
        <div id="detail-placeholder" style="text-align: center; padding: 60px 20px; color: #808090;">
          <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;">üëà</div>
          <p style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Select an Identity</p>
          <p style="font-size: 13px;">Click any personality type to view its complete profile</p>
        </div>
        
        <div id="detail-content" style="display: none;">
          <!-- Identity Header -->
          <div style="text-align: center; margin-bottom: 32px; padding-bottom: 24px; border-bottom: 2px solid rgba(255,255,255,0.1);">
            <div id="detail-symbols" style="display: flex; justify-content: center; gap: 8px; margin-bottom: 16px;"></div>
            <h2 id="detail-name" style="font-size: 32px; margin-bottom: 8px;">Identity Name</h2>
            <p id="detail-tag" style="font-size: 16px; color: #a78bfa; font-style: italic;">Tagline</p>
          </div>
          
          <!-- The Pitch -->
          <div style="margin-bottom: 24px;">
            <h4 style="font-size: 14px; text-transform: uppercase; letter-spacing: 1px; color: #808090; margin-bottom: 12px;">What This Is</h4>
            <p id="detail-desc" style="font-size: 15px; color: #d0d0d0; line-height: 1.7;"></p>
          </div>
          
          <!-- Pub Descriptions -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
            <div style="background: rgba(16, 185, 129, 0.08); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; padding: 16px;">
              <div style="font-size: 11px; font-weight: 600; color: #10B981; text-transform: uppercase; margin-bottom: 8px;">üíº To Your Face</div>
              <p id="detail-normal" style="font-size: 13px; color: #b0d0c0; line-height: 1.6; font-style: italic;"></p>
            </div>
            <div style="background: rgba(245, 158, 11, 0.08); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 8px; padding: 16px;">
              <div style="font-size: 11px; font-weight: 600; color: #F59E0B; text-transform: uppercase; margin-bottom: 8px;">üç∫ Behind Your Back</div>
              <p id="detail-banter" style="font-size: 13px; color: #d0a070; line-height: 1.6; font-style: italic;"></p>
            </div>
          </div>
          
          <!-- Commander Reference -->
          <div style="background: rgba(139, 92, 246, 0.08); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; padding: 16px; margin-bottom: 24px;">
            <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #a78bfa; margin-bottom: 8px;">‚ö° Legendary Commander</div>
            <div style="font-weight: 700; font-size: 16px; margin-bottom: 4px;" id="detail-cmd-name"></div>
            <p style="font-size: 13px; color: #b0b0c0; font-style: italic;" id="detail-cmd-desc"></p>
          </div>
          
          <!-- Quick Reference -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
            <div>
              <h4 style="font-size: 14px; text-transform: uppercase; letter-spacing: 1px; color: #808090; margin-bottom: 8px;">‚öî Key Strengths</h4>
              <ul id="detail-strengths" style="list-style: none; padding: 0; font-size: 13px; color: #10B981;"></ul>
            </div>
            <div>
              <h4 style="font-size: 14px; text-transform: uppercase; letter-spacing: 1px; color: #808090; margin-bottom: 8px;">‚ö† Key Shadows</h4>
              <ul id="detail-shadows" style="list-style: none; padding: 0; font-size: 13px; color: #EF4444;"></ul>
            </div>
          </div>
          
          <!-- Typical Roles -->
          <div>
            <h4 style="font-size: 14px; text-transform: uppercase; letter-spacing: 1px; color: #808090; margin-bottom: 8px;">üìã Typical Roles</h4>
            <p id="detail-roles" style="font-size: 14px; color: #a0a0b0;"></p>
          </div>
        </div>
      </div>
      
    </div>
  </div>
  
  <!-- INTERACTIONS GUIDE SCREEN -->
  <div id="screen-interactions" class="hidden">
    <div class="card fade-in" style="text-align: center;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <button onclick="closeInteractions()" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #a0a0b0; padding: 8px 16px; border-radius: 8px; font-size: 14px; cursor: pointer; font-weight: 600;">
          ‚Üê Back
        </button>
        <h1 style="font-size: 32px; margin: 0;">How Colors Interact</h1>
        <div style="width: 80px;"></div>
      </div>
      
      <p style="color: #a0a0b0; margin-bottom: 8px;">Communication and conflict resolution across the five colors</p>
    </div>
    
    <!-- Communication Strategies -->
    <div class="card fade-in">
      <h3 style="font-size: 20px; margin-bottom: 16px; color: #a78bfa;">Communication Strategies</h3>
      <p style="font-size: 13px; color: #808090; margin-bottom: 24px; font-style: italic;">How to effectively communicate with each color</p>
      
      <div style="display: grid; gap: 16px;">
        <!-- White -->
        <div style="background: rgba(255,255,255,0.03); border-left: 4px solid #F59E0B; padding: 16px; border-radius: 8px;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <span class="mana-symbol mana-W" style="width: 32px; height: 32px; font-size: 16px;">W</span>
            <h4 style="font-size: 16px; font-weight: 700; margin: 0;">Talking to WHITE</h4>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div>
              <div style="font-size: 12px; color: #10B981; text-transform: uppercase; margin-bottom: 8px; font-weight: 600;">‚úì DO</div>
              <ul style="list-style: none; padding: 0; font-size: 13px; color: #d0d0d0; line-height: 1.7;">
                <li>‚Ä¢ Frame in terms of team benefit</li>
                <li>‚Ä¢ Acknowledge fairness concerns</li>
                <li>‚Ä¢ Show proper process</li>
                <li>‚Ä¢ Build consensus</li>
              </ul>
            </div>
            <div>
              <div style="font-size: 12px; color: #EF4444; text-transform: uppercase; margin-bottom: 8px; font-weight: 600;">‚úó DON'T</div>
              <ul style="list-style: none; padding: 0; font-size: 13px; color: #d0d0d0; line-height: 1.7;">
                <li>‚Ä¢ Present as purely self-serving</li>
                <li>‚Ä¢ Skip process or ignore rules</li>
                <li>‚Ä¢ Make unilateral decisions</li>
                <li>‚Ä¢ Rush without buy-in</li>
              </ul>
            </div>
          </div>
        </div>
        
        <!-- Blue -->
        <div style="background: rgba(255,255,255,0.03); border-left: 4px solid #3B82F6; padding: 16px; border-radius: 8px;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <span class="mana-symbol mana-U" style="width: 32px; height: 32px; font-size: 16px;">U</span>
            <h4 style="font-size: 16px; font-weight: 700; margin: 0;">Talking to BLUE</h4>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div>
              <div style="font-size: 12px; color: #10B981; text-transform: uppercase; margin-bottom: 8px; font-weight: 600;">‚úì DO</div>
              <ul style="list-style: none; padding: 0; font-size: 13px; color: #d0d0d0; line-height: 1.7;">
                <li>‚Ä¢ Provide data and analysis</li>
                <li>‚Ä¢ Explain the logic</li>
                <li>‚Ä¢ Give time to think</li>
                <li>‚Ä¢ Respect expertise</li>
              </ul>
            </div>
            <div>
              <div style="font-size: 12px; color: #EF4444; text-transform: uppercase; margin-bottom: 8px; font-weight: 600;">‚úó DON'T</div>
              <ul style="list-style: none; padding: 0; font-size: 13px; color: #d0d0d0; line-height: 1.7;">
                <li>‚Ä¢ Rush without analysis</li>
                <li>‚Ä¢ Appeal only to emotion</li>
                <li>‚Ä¢ Make unsubstantiated claims</li>
                <li>‚Ä¢ Be imprecise or vague</li>
              </ul>
            </div>
          </div>
        </div>
        
        <!-- Black -->
        <div style="background: rgba(255,255,255,0.03); border-left: 4px solid #6B7280; padding: 16px; border-radius: 8px;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <span class="mana-symbol mana-B" style="width: 32px; height: 32px; font-size: 16px;">B</span>
            <h4 style="font-size: 16px; font-weight: 700; margin: 0;">Talking to BLACK</h4>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div>
              <div style="font-size: 12px; color: #10B981; text-transform: uppercase; margin-bottom: 8px; font-weight: 600;">‚úì DO</div>
              <ul style="list-style: none; padding: 0; font-size: 13px; color: #d0d0d0; line-height: 1.7;">
                <li>‚Ä¢ Be direct about mutual benefit</li>
                <li>‚Ä¢ Respect boundaries</li>
                <li>‚Ä¢ Negotiate clearly</li>
                <li>‚Ä¢ Don't waste time</li>
              </ul>
            </div>
            <div>
              <div style="font-size: 12px; color: #EF4444; text-transform: uppercase; margin-bottom: 8px; font-weight: 600;">‚úó DON'T</div>
              <ul style="list-style: none; padding: 0; font-size: 13px; color: #d0d0d0; line-height: 1.7;">
                <li>‚Ä¢ Expect altruism</li>
                <li>‚Ä¢ Be indirect or hint</li>
                <li>‚Ä¢ Appeal only to morality</li>
                <li>‚Ä¢ Assume they'll help for free</li>
              </ul>
            </div>
          </div>
        </div>
        
        <!-- Red -->
        <div style="background: rgba(255,255,255,0.03); border-left: 4px solid #EF4444; padding: 16px; border-radius: 8px;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <span class="mana-symbol mana-R" style="width: 32px; height: 32px; font-size: 16px;">R</span>
            <h4 style="font-size: 16px; font-weight: 700; margin: 0;">Talking to RED</h4>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div>
              <div style="font-size: 12px; color: #10B981; text-transform: uppercase; margin-bottom: 8px; font-weight: 600;">‚úì DO</div>
              <ul style="list-style: none; padding: 0; font-size: 13px; color: #d0d0d0; line-height: 1.7;">
                <li>‚Ä¢ Be authentic and passionate</li>
                <li>‚Ä¢ Get to the point quickly</li>
                <li>‚Ä¢ Bring energy</li>
                <li>‚Ä¢ Act, don't just plan</li>
              </ul>
            </div>
            <div>
              <div style="font-size: 12px; color: #EF4444; text-transform: uppercase; margin-bottom: 8px; font-weight: 600;">‚úó DON'T</div>
              <ul style="list-style: none; padding: 0; font-size: 13px; color: #d0d0d0; line-height: 1.7;">
                <li>‚Ä¢ Over-analyse everything</li>
                <li>‚Ä¢ Be cold or emotionless</li>
                <li>‚Ä¢ Make them wait unnecessarily</li>
                <li>‚Ä¢ Constrain their freedom</li>
              </ul>
            </div>
          </div>
        </div>
        
        <!-- Green -->
        <div style="background: rgba(255,255,255,0.03); border-left: 4px solid #10B981; padding: 16px; border-radius: 8px;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <span class="mana-symbol mana-G" style="width: 32px; height: 32px; font-size: 16px;">G</span>
            <h4 style="font-size: 16px; font-weight: 700; margin: 0;">Talking to GREEN</h4>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div>
              <div style="font-size: 12px; color: #10B981; text-transform: uppercase; margin-bottom: 8px; font-weight: 600;">‚úì DO</div>
              <ul style="list-style: none; padding: 0; font-size: 13px; color: #d0d0d0; line-height: 1.7;">
                <li>‚Ä¢ Give them time</li>
                <li>‚Ä¢ Respect precedent</li>
                <li>‚Ä¢ Don't force immediate change</li>
                <li>‚Ä¢ Value their experience</li>
              </ul>
            </div>
            <div>
              <div style="font-size: 12px; color: #EF4444; text-transform: uppercase; margin-bottom: 8px; font-weight: 600;">‚úó DON'T</div>
              <ul style="list-style: none; padding: 0; font-size: 13px; color: #d0d0d0; line-height: 1.7;">
                <li>‚Ä¢ Rush or pressure</li>
                <li>‚Ä¢ Dismiss tradition</li>
                <li>‚Ä¢ Force artificial solutions</li>
                <li>‚Ä¢ Ignore accumulated wisdom</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Conflict Resolution -->
    <div class="card fade-in">
      <h3 style="font-size: 20px; margin-bottom: 16px; color: #a78bfa;">Conflict Resolution</h3>
      <p style="font-size: 13px; color: #808090; margin-bottom: 24px; font-style: italic;">Understanding and resolving the five core color tensions</p>
      
      <div style="display: grid; gap: 16px;">
        <div style="background: rgba(255,255,255,0.03); padding: 16px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <span class="mana-symbol mana-W" style="width: 28px; height: 28px; font-size: 14px;">W</span>
            <span style="font-size: 20px; color: #808090;">‚Üî</span>
            <span class="mana-symbol mana-B" style="width: 28px; height: 28px; font-size: 14px;">B</span>
            <h4 style="font-size: 16px; font-weight: 700; margin: 0;">Community vs. Self-Interest</h4>
          </div>
          <p style="font-size: 13px; color: #b0b0b0; margin-bottom: 8px;"><strong>Source:</strong> White prioritizes team, Black prioritizes self</p>
          <p style="font-size: 13px; color: #10B981;"><strong>Resolution:</strong> Clarify when each value applies ("our people first" = Black's tribe, broader community = White's fairness)</p>
        </div>
        
        <div style="background: rgba(255,255,255,0.03); padding: 16px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <span class="mana-symbol mana-U" style="width: 28px; height: 28px; font-size: 14px;">U</span>
            <span style="font-size: 20px; color: #808090;">‚Üî</span>
            <span class="mana-symbol mana-R" style="width: 28px; height: 28px; font-size: 14px;">R</span>
            <h4 style="font-size: 16px; font-weight: 700; margin: 0;">Planning vs. Action</h4>
          </div>
          <p style="font-size: 13px; color: #b0b0b0; margin-bottom: 8px;"><strong>Source:</strong> Blue wants more analysis, Red wants to act now</p>
          <p style="font-size: 13px; color: #10B981;"><strong>Resolution:</strong> Time-box planning phase, then execute with learning loops</p>
        </div>
        
        <div style="background: rgba(255,255,255,0.03); padding: 16px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <span class="mana-symbol mana-B" style="width: 28px; height: 28px; font-size: 14px;">B</span>
            <span style="font-size: 20px; color: #808090;">‚Üî</span>
            <span class="mana-symbol mana-G" style="width: 28px; height: 28px; font-size: 14px;">G</span>
            <h4 style="font-size: 16px; font-weight: 700; margin: 0;">Extraction vs. Sustainability</h4>
          </div>
          <p style="font-size: 13px; color: #b0b0b0; margin-bottom: 8px;"><strong>Source:</strong> Black maximises short-term, Green preserves long-term</p>
          <p style="font-size: 13px; color: #10B981;"><strong>Resolution:</strong> Define regeneration rate, extract within sustainable limits</p>
        </div>
        
        <div style="background: rgba(255,255,255,0.03); padding: 16px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <span class="mana-symbol mana-R" style="width: 28px; height: 28px; font-size: 14px;">R</span>
            <span style="font-size: 20px; color: #808090;">‚Üî</span>
            <span class="mana-symbol mana-W" style="width: 28px; height: 28px; font-size: 14px;">W</span>
            <h4 style="font-size: 16px; font-weight: 700; margin: 0;">Freedom vs. Order</h4>
          </div>
          <p style="font-size: 13px; color: #b0b0b0; margin-bottom: 8px;"><strong>Source:</strong> Red wants autonomy, White wants coordination</p>
          <p style="font-size: 13px; color: #10B981;"><strong>Resolution:</strong> Minimum viable structure with clear boundaries but freedom inside</p>
        </div>
        
        <div style="background: rgba(255,255,255,0.03); padding: 16px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <span class="mana-symbol mana-G" style="width: 28px; height: 28px; font-size: 14px;">G</span>
            <span style="font-size: 20px; color: #808090;">‚Üî</span>
            <span class="mana-symbol mana-U" style="width: 28px; height: 28px; font-size: 14px;">U</span>
            <h4 style="font-size: 16px; font-weight: 700; margin: 0;">Acceptance vs. Improvement</h4>
          </div>
          <p style="font-size: 13px; color: #b0b0b0; margin-bottom: 8px;"><strong>Source:</strong> Green accepts what works, Blue wants to optimise everything</p>
          <p style="font-size: 13px; color: #10B981;"><strong>Resolution:</strong> Preserve what demonstrably works, improve what demonstrably doesn't</p>
        </div>
      </div>
    </div>
    
    <!-- De-escalation Strategies -->
    <div class="card fade-in">
      <h3 style="font-size: 20px; margin-bottom: 16px; color: #a78bfa;">De-escalation Strategies</h3>
      <p style="font-size: 13px; color: #808090; margin-bottom: 24px; font-style: italic;">When someone is upset, here's what they need</p>
      
      <div style="display: grid; gap: 12px;">
        <div style="background: rgba(255,255,255,0.03); padding: 14px; border-radius: 6px; border-left: 3px solid #F59E0B;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
            <span class="mana-symbol mana-W" style="width: 24px; height: 24px; font-size: 12px;">W</span>
            <strong style="font-size: 14px;">When WHITE is upset:</strong>
          </div>
          <p style="font-size: 13px; color: #d0d0d0;">Acknowledge impact on team, show concern for fairness, propose systematic solution, rebuild community connection</p>
        </div>
        
        <div style="background: rgba(255,255,255,0.03); padding: 14px; border-radius: 6px; border-left: 3px solid #3B82F6;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
            <span class="mana-symbol mana-U" style="width: 24px; height: 24px; font-size: 12px;">U</span>
            <strong style="font-size: 14px;">When BLUE is upset:</strong>
          </div>
          <p style="font-size: 13px; color: #d0d0d0;">Provide analysis and data, show logical reasoning, give time to process, address inefficiency directly</p>
        </div>
        
        <div style="background: rgba(255,255,255,0.03); padding: 14px; border-radius: 6px; border-left: 3px solid #6B7280;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
            <span class="mana-symbol mana-B" style="width: 24px; height: 24px; font-size: 12px;">B</span>
            <strong style="font-size: 14px;">When BLACK is upset:</strong>
          </div>
          <p style="font-size: 13px; color: #d0d0d0;">Acknowledge their interests weren't served, negotiate clear resolution, make explicit commitments, respect their boundaries</p>
        </div>
        
        <div style="background: rgba(255,255,255,0.03); padding: 14px; border-radius: 6px; border-left: 3px solid #EF4444;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
            <span class="mana-symbol mana-R" style="width: 24px; height: 24px; font-size: 12px;">R</span>
            <strong style="font-size: 14px;">When RED is upset:</strong>
          </div>
          <p style="font-size: 13px; color: #d0d0d0;">Let them express emotion, don't invalidate feelings, act quickly to resolve, bring energy and passion</p>
        </div>
        
        <div style="background: rgba(255,255,255,0.03); padding: 14px; border-radius: 6px; border-left: 3px solid #10B981;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
            <span class="mana-symbol mana-G" style="width: 24px; height: 24px; font-size: 12px;">G</span>
            <strong style="font-size: 14px;">When GREEN is upset:</strong>
          </div>
          <p style="font-size: 13px; color: #d0d0d0;">Give them time and space, don't force immediate change, respect their experience, slow down the pace</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
console.log('=== SCRIPT START ===');

// ============================================================================
// CONTEXT HINTS - Non-work alternatives for corporate scenarios
// ============================================================================
const CONTEXT_HINTS = {
  TEAM: {
    hint: "No team at work? Think: sports club, volunteer group, band, or any group you collaborate with.",
    patterns: [/your team/i, /team members/i, /team is/i, /team has/i, /team needs/i, /new team/i, /team away-day/i, /team culture/i, /team collaborates/i, /team operates/i]
  },
  BUDGET: {
    hint: "No budget? Think: splitting holiday costs, choosing which events to attend when you can't afford both.",
    patterns: [/your budget/i, /budget to/i, /initiatives need funding/i, /give everyone a small raise/i]
  },
  HIRING: {
    hint: "Not hiring? Think: choosing a doubles partner, picking who to invite when you've only got one spare ticket.",
    patterns: [/candidates for a role/i, /final candidates/i, /choosing between two.*candidates/i]
  },
  COLLEAGUE: {
    hint: "No colleagues? Think: housemates, club members, friends you see regularly‚Äîanyone you cooperate with.",
    patterns: [/a colleague/i, /your colleague/i]
  },
  MANAGER: {
    hint: "No manager? Think: a parent, older sibling, coach, or anyone whose decisions affect you.",
    patterns: [/your manager/i]
  },
  ORGANISATION: {
    hint: "No organisation? Think: your family, sports club, church group, or any group that makes collective decisions.",
    patterns: [/your organisation/i, /the organisation/i, /cross-functional/i, /institutional knowledge/i, /parts of the organisation/i, /organisation is implementing/i, /major changes affecting/i]
  },
  DEPARTMENT: {
    hint: "No department? Think: your friend group vs another, your team within a larger club or community.",
    patterns: [/your department/i, /another department/i, /the department/i, /hit the department/i]
  },
  CUSTOMER: {
    hint: "No customers? Think: people you're helping‚Äîfriends asking advice, someone you're tutoring, anyone relying on you.",
    patterns: [/customers are waiting/i, /customer problem/i]
  },
  SUPPLIER: {
    hint: "No suppliers? Think: your regular mechanic, favourite restaurant, any long-term service relationship.",
    patterns: [/supplier relationship/i]
  },
  PERFORMANCE: {
    hint: "No performance reviews? Think: giving feedback to a friend, addressing a housemate's habits, any honest conversation.",
    patterns: [/underperforming/i, /performance standards/i, /acting inappropriately/i, /honest feedback/i]
  },
  DELIVERABLE: {
    hint: "No deliverables? Think: any project with a deadline‚Äîuni assignment, DIY project, event you're organising.",
    patterns: [/a deliverable/i, /deliver a project/i, /behind on a project/i, /project faster/i]
  },
  STAKEHOLDER: {
    hint: "No stakeholders? Think: anyone affected by your decisions‚Äîfamily, friends, club members.",
    patterns: [/stakeholders/i]
  },
  ONBOARDING: {
    hint: "No onboarding? Think: showing a new housemate how things work, teaching someone the rules of a game.",
    patterns: [/onboarding checklist/i, /new hire points out/i, /new team member.*struggling/i]
  },
  NEGOTIATION: {
    hint: "No negotiations at work? Think: haggling over rent, splitting bills, convincing friends on holiday plans.",
    patterns: [/difficult negotiation/i, /renegotiate/i]
  },
  MEETING: {
    hint: "No meetings? Think: any group decision‚Äîwhere to eat, what to watch, planning something with friends.",
    patterns: [/attending a meeting/i, /in a meeting/i]
  },
  CRISIS: {
    hint: "No work crises? Think: car breaking down, kitchen flooding, any sudden problem needing quick action.",
    patterns: [/system has crashed/i, /sudden crisis/i, /critical system/i, /critical project.*failing/i, /immediate intervention/i]
  },
  COMPETITIVE: {
    hint: "No business competition? Think: applying for the same flat, competing in sports, any situation with rivals.",
    patterns: [/competitor.*strategy/i, /stay competitive/i, /rivals for/i, /competitive situation/i]
  },
  CAREER: {
    hint: "Not thinking about career? Think: any long-term path‚Äîhobby progression, fitness journey, learning over years.",
    patterns: [/career path/i, /career development/i, /networking event/i, /advance your position/i, /your current role/i]
  },
  STRATEGY: {
    hint: "No strategy at work? Think: planning a trip, deciding what skills to learn, any multi-year planning.",
    patterns: [/strategy for your function/i, /over the next 2-3 years/i, /developing strategy/i]
  },
  GOVERNANCE: {
    hint: "No governance? Think: house rules with housemates, club constitution, how your friend group makes decisions.",
    patterns: [/decision-making frameworks/i, /governance/i, /new policies/i, /implementing new policies/i]
  },
  MTG: {
    hint: "Don't play card games? Just imagine any hobby where you collect things, build strategies, and compete with friends.",
    patterns: [/Commander/i, /playing Commander/i]
  }
};

// Function to detect which hint applies to a scenario
function getContextHint(scenarioText, questionId) {
  // MTG questions detected by ID
  if (questionId && questionId.startsWith('MTG-')) {
    return CONTEXT_HINTS.MTG.hint;
  }
  
  // Check each hint type's patterns against the scenario
  for (const [type, data] of Object.entries(CONTEXT_HINTS)) {
    if (type === 'MTG') continue; // Already handled
    for (const pattern of data.patterns) {
      if (pattern.test(scenarioText)) {
        return data.hint;
      }
    }
  }
  
  return null; // No hint needed - universal scenario
}

// ============================================================================
// 40 RANDOM NAMES FOR QUOTE ATTRIBUTION
// ============================================================================
const QUOTE_NAMES = [
  'Sarah', 'Marcus', 'Jennifer', 'David', 'Emily', 'James', 'Lisa', 'Michael',
  'Amanda', 'Chris', 'Rachel', 'Tom', 'Nicole', 'Kevin', 'Ashley', 'Brian',
  'Lauren', 'Matt', 'Stephanie', 'Dan', 'Michelle', 'Alex', 'Jessica', 'Ryan',
  'Megan', 'John', 'Katie', 'Steve', 'Heather', 'Mark', 'Brittany', 'Paul',
  'Crystal', 'Tim', 'Amber', 'Greg', 'Melissa', 'Josh', 'Rebecca', 'Scott'
];

function getRandomName() {
  return QUOTE_NAMES[Math.floor(Math.random() * QUOTE_NAMES.length)];
}

// ============================================================================
// MANA COST PARSER
// ============================================================================
function renderManaCost(costString) {
  // Parse {2}{U}{U}{R} into individual symbols
  const symbols = costString.match(/{[^}]+}/g) || [];
  const html = symbols.map(symbol => {
    const content = symbol.slice(1, -1); // Remove { }
    
    // Check if it's a number (generic mana)
    if (/^\d+$/.test(content)) {
      return `<span class="mana-symbol" style="background: linear-gradient(135deg, #9CA3AF, #6B7280); color: #1F2937; border-color: #4B5563; width: 28px; height: 28px; font-size: 14px; font-weight: 800;">${content}</span>`;
    }
    // Check if it's hybrid mana like {G/W}
    else if (content.includes('/')) {
      const [c1, c2] = content.split('/');
      return `<span class="mana-symbol mana-${c1}" style="width: 28px; height: 28px; font-size: 14px; position: relative;">
        <span style="position: absolute; top: 0; left: 0; width: 50%; height: 100%; overflow: hidden;">${c1}</span>
        <span style="position: absolute; top: 0; right: 0; width: 50%; height: 100%; overflow: hidden;">${c2}</span>
      </span>`;
    }
    // Regular colored mana
    else {
      return `<span class="mana-symbol mana-${content}" style="width: 28px; height: 28px; font-size: 14px;">${content}</span>`;
    }
  }).join('');
  
  return html;
}

const POOL_A = [
  // WHITE vs BLACK (W-B) - Collective good vs individual advancement
  {id:'A-WB-W01',pair:'W-B',ctx:'Team Success',sc:'Your team has delivered a major win, primarily driven by the exceptional effort of two specific individuals.',r:[{t:'Frame it as a collective victory to ensure the entire team feels equally recognised and valued',c:'W'},{t:'Single out the high performers to ensure they are explicitly rewarded for their disproportionate impact',c:'B'}]},
  {id:'A-WB-W03',pair:'W-B',ctx:'Resource Allocation',sc:'Two initiatives need funding, but your budget only allows you to support one.',r:[{t:'Fund the initiative that distributes benefits to the widest group of stakeholders fairly',c:'W'},{t:'Fund the initiative that provides your specific department with the strongest strategic advantage',c:'B'}]},
  {id:'A-WB-W05',pair:'W-B',ctx:'Process Integrity',sc:'A colleague bypassed standard protocols to complete a project ahead of schedule.',r:[{t:'Address the violation immediately‚Äîallowing exceptions undermines trust in the system',c:'W'},{t:'Evaluate the result first‚Äîif the outcome was superior, the rule-breaking was justified',c:'B'}]},
  {id:'A-WB-L01',pair:'W-B',ctx:'Ethics',sc:'You find a wallet on the street with cash and an ID inside.',r:[{t:'Return it intact; it is the right thing to do and what you would want someone to do for you',c:'W'},{t:'Return the wallet and ID, but keep some cash as a finder\'s fee for your time and effort',c:'B'}]},
  {id:'A-WB-L02',pair:'W-B',ctx:'Competition',sc:'You are playing a competitive board game with friends.',r:[{t:'Prioritise the group having fun; you\'ll go easy on struggling players to keep the mood light',c:'W'},{t:'Play to win; the game has rules and a winner, and you intend to be that winner',c:'B'}]},
  {id:'A-WB-L05',pair:'W-B',ctx:'Social Norms',sc:'You are driving and traffic is backed up at a merge point.',r:[{t:'Wait your turn in the queue like everyone else to maintain order',c:'W'},{t:'Drive to the very front of the merge lane to cut in; it is efficient and the space is there',c:'B'}]},
  // PSYCHOLOGY JOKE: W-B
  {id:'A-WB-PSY',pair:'W-B',ctx:'Deep Reflection',sc:'A therapist shows you an inkblot and asks what you see.',r:[{t:'Two people shaking hands and reaching a fair agreement',c:'W'},{t:'A person climbing a ladder whilst others watch from below',c:'B'}]},

  // BLUE vs RED (U-R) - Analysis vs action
  {id:'A-UR-W01',pair:'U-R',ctx:'Crisis Management',sc:'A critical system has crashed and customers are waiting for a resolution.',r:[{t:'Pause to map the architecture and identify the root cause before attempting a fix',c:'U'},{t:'Act immediately based on instinct‚Äîtry solutions rapidly until the system is restored',c:'R'}]},
  {id:'A-UR-W03',pair:'U-R',ctx:'Innovation',sc:'Your team is tackling a complex new customer problem.',r:[{t:'Research precedents, build a prototype, and test systematically before launching',c:'U'},{t:'Build a minimum viable version quickly and iterate based on live feedback',c:'R'}]},
  {id:'A-UR-W05',pair:'U-R',ctx:'Team Leadership',sc:'You are choosing between two final candidates for a role.',r:[{t:'Select the candidate with the strongest objective qualifications and proven track record',c:'U'},{t:'Select the candidate who just "feels right" regarding the team\'s energy',c:'R'}]},
  {id:'A-UR-L01',pair:'U-R',ctx:'Planning',sc:'You are planning a two-week international holiday.',r:[{t:'Create a detailed itinerary, researching the best spots and booking everything in advance',c:'U'},{t:'Book the flight and figure the rest out when you land based on what feels fun',c:'R'}]},
  {id:'A-UR-L03',pair:'U-R',ctx:'Decision Making',sc:'You are buying a new car.',r:[{t:'Spend weeks comparing specs, fuel efficiency, and resale value in spreadsheets',c:'U'},{t:'Test drive a few and buy the one that gives you the biggest thrill when you accelerate',c:'R'}]},
  {id:'A-UR-L05',pair:'U-R',ctx:'Free Time',sc:'You have a free Saturday with zero obligations.',r:[{t:'Use the time to catch up on reading, learning, or organising your life',c:'U'},{t:'Go on an adventure, see friends, or do something exciting and spontaneous',c:'R'}]},
  // PSYCHOLOGY JOKE: U-R
  {id:'A-UR-PSY',pair:'U-R',ctx:'Meta-Analysis',sc:'On a scale of 1-10, how would you rate your relationship with scales of 1-10?',r:[{t:'I appreciate well-designed measurement instruments and would rate this question a 7.3',c:'U'},{t:'Scales are boring‚ÄîI prefer to just know how I feel about something',c:'R'}]},

  // GREEN vs BLUE (G-U) - Acceptance vs optimisation
  {id:'A-GU-W08',pair:'G-U',ctx:'Strategic Planning',sc:'Your organisation is evaluating a switch to a new software platform.',r:[{t:'Avoid the disruption‚Äîif the current tools function, there is no need to change them',c:'G'},{t:'Evaluate the specifications‚Äîif the new tool offers measurable improvements, make the switch',c:'U'}]},
  {id:'A-GU-W10',pair:'G-U',ctx:'Innovation',sc:'You are facing a problem that looks very similar to one you solved three years ago.',r:[{t:'Use the solution that worked last time‚Äîrely on proven patterns',c:'G'},{t:'Re-evaluate from scratch‚Äîthe old solution might not be the optimal one today',c:'U'}]},
  {id:'A-GU-W12',pair:'G-U',ctx:'Strategic Planning',sc:'You are establishing a method for preserving institutional knowledge.',r:[{t:'Prioritise storytelling and wisdom transfer from long-tenured employees',c:'G'},{t:'Prioritise creating searchable databases and decision-making frameworks',c:'U'}]},
  {id:'A-GU-L02',pair:'G-U',ctx:'Parenting',sc:'You are helping a child or younger relative with school.',r:[{t:'Encourage them to find their natural talents and let them develop at their own pace',c:'G'},{t:'Get them a tutor and specific tools to improve their grades in their weakest subjects',c:'U'}]},
  {id:'A-GU-L04',pair:'G-U',ctx:'Environment',sc:'You are planning your garden or home d√©cor.',r:[{t:'Use native plants and natural materials that fit the local environment',c:'G'},{t:'Engineer a landscape with irrigation systems and carefully selected hybrids',c:'U'}]},
  {id:'A-GU-L05',pair:'G-U',ctx:'Ageing',sc:'You are thinking about getting older.',r:[{t:'Accept it as a natural part of life; there is wisdom in every stage of existence',c:'G'},{t:'Fight it; use science, medicine, and technology to extend your prime as long as possible',c:'U'}]},
  // PSYCHOLOGY JOKE: G-U
  {id:'A-GU-PSY',pair:'G-U',ctx:'The Big Question',sc:'A researcher asks whether your personality is shaped more by nature or nurture.',r:[{t:'Nature‚Äîwe are who we were born to be, and that\'s rather beautiful',c:'G'},{t:'Nurture‚Äîwith the right interventions, anyone can optimise their development',c:'U'}]},

  // WHITE vs RED (W-R) - Order vs freedom
  {id:'A-WR-W07',pair:'W-R',ctx:'Crisis Management',sc:'A sudden crisis has hit the department.',r:[{t:'Immediately convene the team to assign clear roles and ensure coordination',c:'W'},{t:'Jump into the fire immediately and coordinate on the fly',c:'R'}]},
  {id:'A-WR-W09',pair:'W-R',ctx:'Performance',sc:'You witness a colleague acting inappropriately.',r:[{t:'Document the incident and address it formally during your scheduled one-to-one',c:'W'},{t:'Pull them aside right now and handle it whilst the emotion is fresh',c:'R'}]},
  {id:'A-WR-W11',pair:'W-R',ctx:'Team Leadership',sc:'You are planning a team away-day to build cohesion.',r:[{t:'Create a structured agenda with facilitated activities to ensure everyone participates',c:'W'},{t:'Ditch the agenda‚Äîput everyone in a room and let the interactions happen spontaneously',c:'R'}]},
  {id:'A-WR-L01',pair:'W-R',ctx:'Social',sc:'You are hosting a party for friends.',r:[{t:'Plan the start time, food service, and activities to ensure the event runs smoothly',c:'W'},{t:'Open the doors, crank the music, and let the night go wherever it goes',c:'R'}]},
  {id:'A-WR-L03',pair:'W-R',ctx:'Self-Expression',sc:'You are choosing an outfit for a public event.',r:[{t:'Wear something appropriate that respects the dress code and fits in with the group',c:'W'},{t:'Wear something bold that expresses your unique personality, even if it stands out',c:'R'}]},
  {id:'A-WR-L06',pair:'W-R',ctx:'Learning',sc:'You start a new hobby (e.g., painting, martial arts).',r:[{t:'Learn the fundamentals and proper forms before trying anything advanced',c:'W'},{t:'Jump straight into sparring or painting to experience the rush of doing it',c:'R'}]},
  // PSYCHOLOGY JOKE: W-R
  {id:'A-WR-PSY',pair:'W-R',ctx:'Delayed Gratification',sc:'A researcher offers you one biscuit now, or two biscuits if you wait fifteen minutes.',r:[{t:'Wait for two‚Äîdelayed gratification is a sign of maturity and self-control',c:'W'},{t:'Take the one now‚Äîlife is short and the future is uncertain',c:'R'}]},

  // BLACK vs GREEN (B-G) - Exploitation vs sustainability
  {id:'A-BG-W08',pair:'B-G',ctx:'Team Leadership',sc:'A high-output expert is causing friction with the team.',r:[{t:'Keep them‚Äîthe value of their expertise outweighs the interpersonal cost',c:'B'},{t:'Address it‚Äîif they cannot harmonise with the group, they cannot stay',c:'G'}]},
  {id:'A-BG-W10',pair:'B-G',ctx:'Resource Allocation',sc:'Your team needs to develop new skills quickly to stay competitive.',r:[{t:'Buy it‚Äîhire a contractor or acquire a smaller firm to plug the gap immediately',c:'B'},{t:'Grow it‚Äîidentify internal potential and mentor them until they are ready',c:'G'}]},
  {id:'A-BG-W12',pair:'B-G',ctx:'Strategic Planning',sc:'A long-term supplier relationship is no longer yielding high returns.',r:[{t:'Aggressively renegotiate or drop them‚Äîloyalty doesn\'t pay the bills',c:'B'},{t:'Stay loyal‚Äîlong-term partners will come through for you when you need them most',c:'G'}]},
  {id:'A-BG-L02',pair:'B-G',ctx:'Wealth',sc:'You come into a small inheritance.',r:[{t:'Invest it aggressively to maximise your personal wealth and status',c:'B'},{t:'Use it to support your extended family or secure your home for the future',c:'G'}]},
  {id:'A-BG-L04',pair:'B-G',ctx:'Relationships',sc:'You are looking for a romantic partner.',r:[{t:'Look for someone who elevates your status and helps you achieve your goals',c:'B'},{t:'Look for someone with whom you share a natural, effortless connection',c:'G'}]},
  {id:'A-BG-L06',pair:'B-G',ctx:'Achievement',sc:'You have achieved a major personal milestone.',r:[{t:'Display your success proudly; you worked hard and deserve the recognition',c:'B'},{t:'Stay humble; acknowledge that luck and help from others played a huge role',c:'G'}]},
  // PSYCHOLOGY JOKE: B-G
  {id:'A-BG-PSY',pair:'B-G',ctx:'Therapeutic Exploration',sc:'A therapist asks: "And how does that make you feel?"',r:[{t:'I feel like we should focus on actionable outcomes rather than dwelling on feelings',c:'B'},{t:'I appreciate you asking‚Äîlet me sit with that and see what comes up naturally',c:'G'}]},

  // ============================================================================
  // MTG HUMOR QUESTIONS - ENEMY PAIRS
  // ============================================================================
  
  // MTG W-B Set 1
  {id:'MTG-WB-01',pair:'W-B',ctx:'Magic: The Gathering',sc:'You\'re playing a multiplayer card game and about to win, but it requires going back on something you sort of implied earlier.',r:[{t:'I look my opponent in the eye. I apologise. I pass the turn. I lose the game. I sleep peacefully.',c:'W'},{t:'I never *said* I wouldn\'t combo off. I said "that\'s interesting" when you asked if I was playing combo. Those are different sentences.',c:'B'}]},
  // MTG W-B Set 2
  {id:'MTG-WB-02',pair:'W-B',ctx:'Magic: The Gathering',sc:'You\'re kingmaking in a multiplayer game. Your next move decides who wins, and it\'s not going to be you.',r:[{t:'I attack the person who played dirtiest. Justice matters even in defeat.',c:'W'},{t:'I attack whoever didn\'t offer me anything. Should\'ve negotiated.',c:'B'}]},
  
  // MTG U-R Set 1
  {id:'MTG-UR-01',pair:'U-R',ctx:'Magic: The Gathering',sc:'You\'re playing a card game and your opponent plays something. You have a response in hand.',r:[{t:'I re-read their card. I re-read my card. I check what\'s happened so far. I ask them to confirm. I pick up my card. I put it back down. I ask "what\'s your life total" even though I know. I...',c:'U'},{t:'COUNTERSPELL. Wait, can I counter that? Whatever. COUNTERSPELL.',c:'R'}]},
  // MTG U-R Set 2
  {id:'MTG-UR-02',pair:'U-R',ctx:'Magic: The Gathering',sc:'You\'re building a deck and have a fun combo piece that only works 30% of the time.',r:[{t:'I ran the simulations. 30% is unacceptable. The slot goes to something consistent.',c:'U'},{t:'30% of the time it works EVERY time. She\'s going in.',c:'R'}]},
  
  // MTG G-U Set 1
  {id:'MTG-GU-01',pair:'G-U',ctx:'Magic: The Gathering',sc:'Someone asks why you\'re still playing that old deck you\'ve had forever.',r:[{t:'She\'s old. She\'s outdated. Half these cards aren\'t even good anymore. But she\'s *mine*.',c:'G'},{t:'I retired it. The new version has 47% better efficiency. I have a graph. Would you like to see the graph.',c:'U'}]},
  // MTG G-U Set 2
  {id:'MTG-GU-02',pair:'G-U',ctx:'Magic: The Gathering',sc:'Your cards are... not organised.',r:[{t:'I know where everything is. That pile is green. That pile is "probably green." It works.',c:'G'},{t:'I have a database. Cross-referenced by format, price history, and number of copies owned. Why are you looking at me like that.',c:'U'}]},
  
  // MTG W-R Set 1
  {id:'MTG-WR-01',pair:'W-R',ctx:'Magic: The Gathering',sc:'The game has gone 3 hours.',r:[{t:'I check the life totals. I verify the board state. I confirm everyone\'s hand size. I ask if anyone has responses. I move to my end step. I‚Äî',c:'W'},{t:'I AM GOING TO ATTACK SOMEONE OR I WILL FLIP THIS TABLE. I DON\'T CARE WHO. SOMEONE IS DYING.',c:'R'}]},
  // MTG W-R Set 2
  {id:'MTG-WR-02',pair:'W-R',ctx:'Magic: The Gathering',sc:'Someone at your game wants to use a proxy (substitute) for a card they don\'t own.',r:[{t:'If we allow one proxy, where does it end? Everyone should play with the cards they actually have.',c:'W'},{t:'WHO CARES. Let them play the deck they want. We\'re not at a tournament, we\'re in Dave\'s kitchen.',c:'R'}]},
  
  // MTG B-G Set 1
  {id:'MTG-BG-01',pair:'B-G',ctx:'Magic: The Gathering',sc:'An opponent asks why your discard pile has more cards than your deck.',r:[{t:'Every single one of them died for a reason. I killed them. On purpose. You\'re next.',c:'B'},{t:'It\'s not a graveyard, it\'s a waiting room. They\'ll be back. They always come back. *gently pats pile*',c:'G'}]},
  // MTG B-G Set 2
  {id:'MTG-BG-02',pair:'B-G',ctx:'Magic: The Gathering',sc:'An opponent is struggling. They\'re having bad luck and clearly not having fun.',r:[{t:'Unfortunate. Anyway, I attack them and knock them out. One less problem.',c:'B'},{t:'I\'ll attack someone else. They\'re already dead inside. Killing them now is just... wasteful.',c:'G'}]}
];

// ============================================================================
// POOL_ALLY: ALLY PAIR CALIBRATION QUESTIONS
// Tests pairs that Round 1 never tests (allies instead of enemies)
// Used in Round 2 to detect suppression and noise
// ============================================================================
const POOL_ALLY = [
  // WHITE vs BLUE (W-U) - Structure for fairness vs structure for optimization
  {id:'AL-WU-01',pair:'W-U',ctx:'Process Change',sc:'A new hire points out that several steps in your onboarding checklist seem redundant.',r:[{t:'Keep the current checklist‚Äîit ensures nothing gets missed and treats everyone consistently',c:'W'},{t:'Map out which steps are actually redundant and test a streamlined version',c:'U'}]},
  {id:'AL-WU-02',pair:'W-U',ctx:'Decision Making',sc:'Your team is debating a major direction change with strong opinions on both sides.',r:[{t:'Call a vote so everyone has equal say and the majority decides',c:'W'},{t:'Request each side present data and analysis before deciding based on evidence',c:'U'}]},
  {id:'AL-WU-03',pair:'W-U',ctx:'Quality Standards',sc:'A deliverable meets the documented requirements but you sense it could be better.',r:[{t:'Ship it‚Äîthe requirements exist for a reason and were met fairly',c:'W'},{t:'Hold it back to optimise further‚Äîmeeting minimum standards isn\'t the same as excellence',c:'U'}]},
  {id:'AL-WU-04',pair:'W-U',ctx:'Team Conflict',sc:'Two team members disagree on the right approach to a technical problem.',r:[{t:'Facilitate a discussion focused on finding a solution everyone can support',c:'W'},{t:'Ask both to document their approaches so you can evaluate them objectively',c:'U'}]},
  {id:'AL-WU-05',pair:'W-U',ctx:'Resource Allocation',sc:'You have budget to either give everyone a small raise or fund one person\'s advanced training.',r:[{t:'Give everyone the raise‚Äîit\'s fair and maintains team cohesion',c:'W'},{t:'Fund the training‚Äîit creates expertise that benefits everyone long-term',c:'U'}]},
  {id:'AL-WU-06',pair:'W-U',ctx:'Feedback Delivery',sc:'A colleague asks for your honest feedback on their presentation.',r:[{t:'Focus on what they did well and offer gentle suggestions for improvement',c:'W'},{t:'Provide specific, detailed critique on exactly what could be optimised',c:'U'}]},

  // BLUE vs BLACK (U-B) - Knowledge for understanding vs knowledge for leverage
  {id:'AL-UB-01',pair:'U-B',ctx:'Information Advantage',sc:'You discover a flaw in a competitor\'s strategy during your research.',r:[{t:'Document it thoroughly to understand the full implications before deciding what to do',c:'U'},{t:'Figure out how to exploit it for maximum advantage before anyone else notices',c:'B'}]},
  {id:'AL-UB-02',pair:'U-B',ctx:'Career Development',sc:'You have the opportunity to learn a new skill that isn\'t directly relevant to your current role.',r:[{t:'Take it‚Äîexpanding your knowledge base always has value eventually',c:'U'},{t:'Skip it‚Äîinvest your time only in skills that directly advance your position',c:'B'}]},
  {id:'AL-UB-03',pair:'U-B',ctx:'Project Timeline',sc:'You could deliver a project faster by cutting corners on documentation.',r:[{t:'Keep the documentation‚Äîfuture maintainability matters more than speed',c:'U'},{t:'Cut it‚Äîgetting results now matters more than theoretical future problems',c:'B'}]},
  {id:'AL-UB-04',pair:'U-B',ctx:'Negotiation Prep',sc:'You\'re preparing for a difficult negotiation with another department.',r:[{t:'Research all aspects thoroughly so you understand everyone\'s constraints and can find optimal solutions',c:'U'},{t:'Research their weaknesses and pressure points so you can extract the best deal for yourself',c:'B'}]},
  {id:'AL-UB-05',pair:'U-B',ctx:'Mistake Discovery',sc:'You discover you made an error that no one else has noticed yet.',r:[{t:'Analyze what went wrong to understand the root cause and prevent future occurrences',c:'U'},{t:'Quietly fix it and move on‚Äîno point drawing attention to your mistakes',c:'B'}]},
  {id:'AL-UB-06',pair:'U-B',ctx:'Meeting Strategy',sc:'You\'re attending a meeting where an important decision will be made.',r:[{t:'Come prepared with thorough analysis to contribute to the best possible outcome',c:'U'},{t:'Come prepared with talking points that position your preferred outcome favourably',c:'B'}]},

  // BLACK vs RED (B-R) - Calculated self-interest vs impulsive self-expression
  {id:'AL-BR-01',pair:'B-R',ctx:'Opportunity Cost',sc:'An exciting but risky opportunity comes up that could pay off big or fail completely.',r:[{t:'Calculate the expected value carefully before committing any resources',c:'B'},{t:'Jump on it‚Äîyou\'ll regret missing out more than you\'ll regret trying',c:'R'}]},
  {id:'AL-BR-02',pair:'B-R',ctx:'Confrontation',sc:'A colleague takes credit for your work in a meeting.',r:[{t:'Note it and find the right moment to address it strategically with leadership',c:'B'},{t:'Call it out right now‚Äîyou\'re not going to let that slide',c:'R'}]},
  {id:'AL-BR-03',pair:'B-R',ctx:'Relationship Building',sc:'You\'re at a networking event with potential career connections.',r:[{t:'Identify the highest-value contacts and focus your time on building those relationships',c:'B'},{t:'Talk to whoever seems interesting‚Äîgenuine connections matter more than strategic ones',c:'R'}]},
  {id:'AL-BR-04',pair:'B-R',ctx:'Risk Taking',sc:'You have a chance to pitch a bold idea that could make you look brilliant or foolish.',r:[{t:'Refine it until you\'re confident it won\'t backfire on you',c:'B'},{t:'Pitch it now while you\'re excited‚Äîyour passion will be convincing',c:'R'}]},
  {id:'AL-BR-05',pair:'B-R',ctx:'Work Style',sc:'You\'re behind on a project with a deadline approaching.',r:[{t:'Triage ruthlessly‚Äîcut scope to deliver something acceptable on time',c:'B'},{t:'Power through with intense focus‚Äîyou work best under pressure',c:'R'}]},
  {id:'AL-BR-06',pair:'B-R',ctx:'Disagreement',sc:'Your manager makes a decision you think is wrong.',r:[{t:'Document your concerns and pick the right moment to make your case',c:'B'},{t:'Voice your disagreement directly‚Äîyou can\'t pretend to support something you don\'t believe in',c:'R'}]},

  // RED vs GREEN (R-G) - Action and change vs acceptance and stability
  {id:'AL-RG-01',pair:'R-G',ctx:'Problem Solving',sc:'A system that\'s worked for years is showing signs of strain.',r:[{t:'This is the push we need to rebuild it properly from scratch',c:'R'},{t:'It\'s survived this long for good reasons‚Äîpatch it and let it continue',c:'G'}]},
  {id:'AL-RG-02',pair:'R-G',ctx:'Team Dynamics',sc:'Your team has settled into comfortable but perhaps stagnant patterns.',r:[{t:'Shake things up‚Äîintroduce new challenges to keep everyone engaged',c:'R'},{t:'Let them be‚Äîthey\'ve found a rhythm that works and stability has value',c:'G'}]},
  {id:'AL-RG-03',pair:'R-G',ctx:'Personal Growth',sc:'You\'re offered a role that would be a dramatic departure from your career path.',r:[{t:'Take it‚Äîlife is too short to stay in your comfort zone',c:'R'},{t:'Stay your course‚Äîyou\'ve built expertise here and change isn\'t always progress',c:'G'}]},
  {id:'AL-RG-04',pair:'R-G',ctx:'Conflict Approach',sc:'Tension has been building between two parts of the organisation.',r:[{t:'Force the issue into the open‚Äîsuppressed conflict just festers',c:'R'},{t:'Let it resolve naturally‚Äîmost tensions work themselves out over time',c:'G'}]},
  {id:'AL-RG-05',pair:'R-G',ctx:'Innovation',sc:'Someone proposes replacing a manual process with new technology.',r:[{t:'Yes! Embrace the future‚Äîautomation frees us for more interesting work',c:'R'},{t:'Not so fast‚Äîthe manual process has wisdom built into it that we might lose',c:'G'}]},
  {id:'AL-RG-06',pair:'R-G',ctx:'Life Decision',sc:'You\'re feeling restless in your current situation.',r:[{t:'That feeling is telling you something‚Äîmake a change before you stagnate',c:'R'},{t:'Restlessness passes‚Äîcontentment comes from accepting where you are',c:'G'}]},

  // GREEN vs WHITE (G-W) - Natural community vs organized community
  {id:'AL-GW-01',pair:'G-W',ctx:'Team Building',sc:'You\'re creating a new team culture from scratch.',r:[{t:'Let it develop organically‚Äîculture can\'t be forced, it has to grow',c:'G'},{t:'Define clear values and expectations from the start so everyone knows the standard',c:'W'}]},
  {id:'AL-GW-02',pair:'G-W',ctx:'Onboarding',sc:'A new team member is struggling to find their place.',r:[{t:'Give them time and space‚Äîthey\'ll find their natural role as relationships form',c:'G'},{t:'Assign them a buddy and structured checkpoints to ensure they\'re integrated properly',c:'W'}]},
  {id:'AL-GW-03',pair:'G-W',ctx:'Decision Rights',sc:'Your team needs to decide who has authority over a shared resource.',r:[{t:'Let influence flow to whoever naturally emerges as most invested and capable',c:'G'},{t:'Establish clear ownership and documented decision rights to avoid confusion',c:'W'}]},
  {id:'AL-GW-04',pair:'G-W',ctx:'Performance Issues',sc:'A team member is underperforming but has been with the team for years.',r:[{t:'Trust that their experience has value‚Äîfind a role where they can contribute naturally',c:'G'},{t:'Apply the same performance standards to everyone‚Äîtenure doesn\'t excuse underperformance',c:'W'}]},
  {id:'AL-GW-05',pair:'G-W',ctx:'Knowledge Sharing',sc:'Critical knowledge is concentrated in a few long-tenured people.',r:[{t:'This is natural‚Äîwisdom takes time to develop and resides in experienced people',c:'G'},{t:'Document and distribute it‚Äîthe organisation shouldn\'t depend on any individual',c:'W'}]},
  {id:'AL-GW-06',pair:'G-W',ctx:'Growth Strategy',sc:'Your team is deciding how quickly to expand.',r:[{t:'Grow slowly‚Äîsustainable growth lets culture and relationships develop properly',c:'G'},{t:'Staff to plan‚Äîwe have commitments to meet and should scale accordingly',c:'W'}]},

  // ============================================================================
  // MTG HUMOR QUESTIONS - ALLY PAIRS
  // ============================================================================
  
  // MTG W-U Set 1
  {id:'MTG-WU-01',pair:'W-U',ctx:'Magic: The Gathering',sc:'Someone at your game asks to see your deck list.',r:[{t:'Of course. It\'s in a shared spreadsheet. Sorted alphabetically. With a changelog. The changelog has a changelog.',c:'W'},{t:'Of course. It\'s sleeved in order. By colour. Then by cost. Then alphabetically. Then by set. I will now explain why.',c:'U'}]},
  // MTG W-U Set 2
  {id:'MTG-WU-02',pair:'W-U',ctx:'Magic: The Gathering',sc:'There\'s a rules disagreement. The wording is ambiguous.',r:[{t:'Let\'s check the rulebook. Then the official rulings. Then we\'ll take a vote to be fair.',c:'W'},{t:'Let\'s check the rulebook. Then the official rulings. Then I\'ll explain why I\'m right.',c:'U'}]},
  
  // MTG U-B Set 1
  {id:'MTG-UB-01',pair:'U-B',ctx:'Magic: The Gathering',sc:'You notice an opponent has missed something that would help them.',r:[{t:'I should tell them. It\'s important that we all play correctly. The game\'s integrity matters more than my advantage.',c:'U'},{t:'I should tell them. Later. Much later. Perhaps in the car park after they\'ve lost.',c:'B'}]},
  // MTG U-B Set 2
  {id:'MTG-UB-02',pair:'U-B',ctx:'Magic: The Gathering',sc:'You sit down to play and recognise your opponent. You know exactly what strategy they\'ll use.',r:[{t:'Interesting. I can prepare optimally now. I\'ll adjust my opening strategy accordingly.',c:'U'},{t:'Interesting. I\'ll pretend I don\'t know. I\'ll ask innocent questions. Then I\'ll crush them.',c:'B'}]},
  
  // MTG B-R Set 1
  {id:'MTG-BR-01',pair:'B-R',ctx:'Magic: The Gathering',sc:'Someone just destroyed your favourite piece.',r:[{t:'I make a note. I continue playing normally. Three turns from now they will understand what they did.',c:'B'},{t:'BLOOD FEUD. I don\'t care if they win. I don\'t care if I win. THEY HAVE TO LOSE.',c:'R'}]},
  // MTG B-R Set 2
  {id:'MTG-BR-02',pair:'B-R',ctx:'Magic: The Gathering',sc:'The same player has knocked you out first in the last three games.',r:[{t:'I\'ve adjusted my deck specifically to counter them. 14 cards. I\'ve been planning this for weeks.',c:'B'},{t:'I\'M KILLING THEM FIRST. EVERY GAME. FOREVER. I DON\'T NEED A PLAN I NEED THEM DEAD.',c:'R'}]},
  
  // MTG R-G Set 1
  {id:'MTG-RG-01',pair:'R-G',ctx:'Magic: The Gathering',sc:'A new expansion drops with a card that\'s perfect for your deck.',r:[{t:'I\'VE ALREADY BOUGHT FOUR. I\'M REBUILDING TONIGHT. THE OLD VERSION IS DEAD TO ME.',c:'R'},{t:'I\'ll think about it. Maybe next year. I\'ve had this list for six years. She\'s not ready for surgery.',c:'G'}]},
  // MTG R-G Set 2
  {id:'MTG-RG-02',pair:'R-G',ctx:'Magic: The Gathering',sc:'There\'s a card in your deck you love but it\'s objectively not very good.',r:[{t:'I DON\'T CARE. SHE STAYS. When she works, it\'s BEAUTIFUL. You don\'t understand our bond.',c:'R'},{t:'She\'s been in the deck since 2014. She\'ll be in the deck when I die. We\'ve been through too much together.',c:'G'}]},
  
  // MTG G-W Set 1
  {id:'MTG-GW-01',pair:'G-W',ctx:'Magic: The Gathering',sc:'Your playgroup is growing and getting hard to manage.',r:[{t:'It\'ll sort itself out. The people who want to play will keep showing up. Nature finds a way.',c:'G'},{t:'I\'ve made a Discord. There\'s a calendar. There are roles. There is a waiting list. Sign here.',c:'W'}]},
  // MTG G-W Set 2
  {id:'MTG-GW-02',pair:'G-W',ctx:'Magic: The Gathering',sc:'Someone new wants to join your game group.',r:[{t:'They\'ll figure it out. Throw them in. If they vibe, they vibe. If not, they\'ll stop coming.',c:'G'},{t:'I\'ve prepared a welcome document. It covers power levels, house rules, and the schedule. There\'s a quiz.',c:'W'}]}
];

const POOL_B = {
  AZORIUS:[{sc:'Your organisation needs new decision-making frameworks that work for everyone.',r:[{t:'Design comprehensive systematic processes ensuring both analytical rigor and equitable outcomes for all stakeholders',g:'AZORIUS'},{t:'Build inclusive community structures that allow people to develop shared approaches naturally over time',g:'SELESNYA'},{t:'Create analytical governance systems that strategically position your function for maximum influence',g:'DIMIR'}]},{sc:'You are implementing new policies that will affect how the entire team operates.',r:[{t:'Roll out systematic fair procedures with thorough documentation ensuring everyone understands and can apply them consistently',g:'AZORIUS'},{t:'Establish clear hierarchical protocols that serve organisational authority while maintaining fairness',g:'ORZHOV'},{t:'Let decision-making processes evolve organically based on what proves most effective in practice',g:'SIMIC'}]}],
  SELESNYA:[{sc:'Shaping how your team works together and develops.',r:[{t:'Foster inclusive environment where people naturally support each other and grow sustainably',g:'SELESNYA'},{t:'Design systematic fair processes ensuring coordinated development',g:'AZORIUS'},{t:'Allow organic growth while thoughtfully optimizing team effectiveness',g:'SIMIC'}]},{sc:'Two team members have tension affecting group harmony.',r:[{t:'Create supportive space for the relationship to heal naturally while protecting team cohesion',g:'SELESNYA'},{t:'Mediate fairly while clarifying authority and what serves the organisation',g:'ORZHOV'},{t:'Let them resolve it directly through authentic interaction',g:'GRUUL'}]}],
  ORZHOV:[{sc:'Designing governance for a cross-functional initiative.',r:[{t:'Create transparent fair hierarchy ensuring authority serves both team and strategic needs',g:'ORZHOV'},{t:'Build inclusive consensus-based structure from community values',g:'SELESNYA'},{t:'Design governance appearing fair while strategically positioning you',g:'DIMIR'}]},{sc:'Setting performance standards balancing consistency with pragmatism.',r:[{t:'Establish equitable standards fairly while making pragmatic exceptions when necessary',g:'ORZHOV'},{t:'Create systematic objective criteria ensuring consistent fair evaluation',g:'AZORIUS'},{t:'Set realistic bars and pragmatically cycle out underperformers',g:'GOLGARI'}]}],
  DIMIR:[{sc:'You have discovered valuable competitive information that could give you a significant advantage.',r:[{t:'Analyze it thoroughly and hold it strategically, only revealing when you can extract maximum positional advantage from the timing',g:'DIMIR'},{t:'Share it through appropriate channels while ensuring your role in discovering it is properly recognized by leadership',g:'ORZHOV'},{t:'Run rapid experiments to test what new approaches this information might enable for your work',g:'IZZET'}]},{sc:'You are deciding how much information to share with various stakeholders about your project progress and challenges.',r:[{t:'Share information selectively, revealing only what advances your strategic position while maintaining analytical understanding of impacts',g:'DIMIR'},{t:'Communicate progress thoughtfully and patiently, allowing stakeholders to naturally develop their own understanding over time',g:'SIMIC'},{t:'Be pragmatically transparent about what is working while letting less essential implementation details remain vague',g:'GOLGARI'}]}],
  IZZET:[{sc:'Developing a new solution to a complex problem.',r:[{t:'Try multiple rapid experiments learning what works through iteration',g:'IZZET'},{t:'Research systematically then execute with passionate commitment',g:'JESKAI'},{t:'Test boldly while directing energy toward strategic objectives',g:'GRIXIS'}]},{sc:'Your approach to innovation and improvement.',r:[{t:'Experiment rapidly with novel approaches and learn from results',g:'IZZET'},{t:'Design optimal systems through thorough analysis',g:'AZORIUS'},{t:'Thoughtfully enhance existing solutions through understanding patterns',g:'SIMIC'}]}],
  GRUUL:[{sc:'Your team is facing a high-stakes challenge that demands immediate powerful action.',r:[{t:'Apply overwhelming force directly, trusting the deep domain expertise and battle-tested approaches your team has proven over time',g:'GRUUL'},{t:'Trust your team\'s proven battle-tested instincts and apply overwhelming collective strength directly',g:'GRUUL'},{t:'Foster an inclusive supportive environment where people can contribute naturally, building collaborative solutions together patiently',g:'SELESNYA'}]},{sc:'Your team needs to deliver critical results while working under significant time pressure and resource constraints.',r:[{t:'Leverage your proven strength and instinctive expertise to apply overwhelming force where it matters most',g:'GRUUL'},{t:'Experiment with multiple different approaches rapidly, learning quickly from each attempt to find what actually works',g:'IZZET'},{t:'Focus pragmatically on the sustainable high-impact areas where you can extract maximum value without burning out',g:'GOLGARI'}]}],
  RAKDOS:[{sc:'Your organisation is stuck in comfortable patterns.',r:[{t:'Force immediate disruptive change to break free and create opportunities for yourself',g:'RAKDOS'},{t:'Position strategically to capitalize when the status quo inevitably shifts',g:'DIMIR'},{t:'Smash through restrictions directly using your strength',g:'GRUUL'}]},{sc:'An opportunity to advance requires breaking conventions.',r:[{t:'Seize it passionately regardless of rules limiting you',g:'RAKDOS'},{t:'Experiment boldly with unconventional methods',g:'IZZET'},{t:'Make pragmatic moves positioning you in emerging landscape',g:'GOLGARI'}]}],
  GOLGARI:[{sc:'Some organisational areas thrive while others decline.',r:[{t:'Harvest value from declining areas to sustainably fuel growing ones',g:'GOLGARI'},{t:'Analyze which to extract from and position in growth areas',g:'DIMIR'},{t:'Let natural evolution occur while optimizing what works',g:'SIMIC'}]},{sc:'Managing team at different career stages.',r:[{t:'Make pragmatic investment decisions while accepting natural career cycles',g:'GOLGARI'},{t:'Replace declining performers decisively to keep competitive',g:'RAKDOS'},{t:'Manage transitions fairly while ensuring organisational needs are met',g:'ORZHOV'}]}],
  SIMIC:[{sc:'Current processes work but could theoretically improve.',r:[{t:'Analyze carefully and evolve gradually without disrupting what works',g:'SIMIC'},{t:'Let improvements emerge naturally from community while maintaining harmony',g:'SELESNYA'},{t:'Design systematic optimization ensuring fair efficient outcomes',g:'AZORIUS'}]},{sc:'Deciding your approach to innovation.',r:[{t:'Thoughtfully enhance existing solutions through deep understanding of patterns',g:'SIMIC'},{t:'Trust powerful instincts proven through experience',g:'GRUUL'},{t:'Systematically innovate for competitive advantage',g:'DIMIR'}]}],
  BOROS:[{sc:'Leading a critical high-stakes initiative.',r:[{t:'Rally passionate coordinated commitment where everyone executes decisively together',g:'BOROS'},{t:'Drive powerful direct action based on proven approaches',g:'GRUUL'},{t:'Build inclusive supportive collaboration allowing natural contributions',g:'SELESNYA'}]},{sc:'Core values are challenged by external pressures.',r:[{t:'Fight passionately to defend what the community stands for with coordinated action',g:'BOROS'},{t:'Push back aggressively to protect your freedom and autonomy',g:'RAKDOS'},{t:'Systematically defend principles through proper procedures',g:'AZORIUS'}]}]
};
const POOL_C = {
  BANT:[{sc:'Leading a complex cross-functional team.',r:[{t:'Foster inclusive patient community with systematic analytical coordination',g:'BANT'},{t:'Build supportive harmonious team developing naturally together',g:'SELESNYA'},{t:'Create comprehensive fair processes with optimal systematic structure',g:'AZORIUS'},{t:'Allow organic team evolution while thoughtfully optimizing effectiveness',g:'SIMIC'}]},{sc:'Planning a major initiative requiring coordination, analysis, and sustainability.',r:[{t:'Design systematic inclusive approach allowing patient strategic development for everyone',g:'BANT'},{t:'Create analytically optimal fair procedures ensuring coordinated execution',g:'AZORIUS'},{t:'Build community-based strategy emerging naturally from collective wisdom',g:'SELESNYA'}]}],
  ESPER:[{sc:'Designing systems for maximum effectiveness and control.',r:[{t:'Create comprehensive calculated systems that are fair yet ruthlessly optimised for results',g:'ESPER'},{t:'Design systematic equitable processes ensuring analytical coordination',g:'AZORIUS'},{t:'Build fair hierarchy serving organisational power and strategic goals',g:'ORZHOV'},{t:'Develop analytical positioning systems serving competitive advantage',g:'DIMIR'}]},{sc:'Managing team performance with focus on efficiency.',r:[{t:'Implement fair systematic metrics making pragmatic calls on who delivers optimal outcomes',g:'ESPER'},{t:'Set equitable standards while making tough pragmatic decisions',g:'ORZHOV'},{t:'Create comprehensive analytical evaluation ensuring fair consistent assessment',g:'AZORIUS'}]}],
  GRIXIS:[{sc:'Developing strategy to dominate a competitive situation.',r:[{t:'Analyze systematically and execute aggressive ruthless moves that position you to win',g:'GRIXIS'},{t:'Position strategically through patient analytical intelligence',g:'DIMIR'},{t:'Disrupt aggressively and break constraints to advance your interests',g:'RAKDOS'},{t:'Experiment boldly with innovative approaches and iterate rapidly',g:'IZZET'}]},{sc:'Executing a turnaround requiring smart aggressive moves.',r:[{t:'Execute analytically ruthless decisions with immediate decisive action',g:'GRIXIS'},{t:'Try multiple bold approaches rapidly learning what works',g:'IZZET'},{t:'Act immediately and aggressively to force transformation',g:'RAKDOS'}]}],
  JUND:[{sc:'High-stakes competition requiring aggression and proven instincts.',r:[{t:'Trust battle-tested predatory instincts and pragmatically devour the competition',g:'JUND'},{t:'Attack immediately with disruptive aggressive action',g:'RAKDOS'},{t:'Make patient pragmatic extraction moves',g:'GOLGARI'},{t:'Apply overwhelming instinctive force',g:'GRUUL'}]},{sc:'Facing rivals for a critical resource.',r:[{t:'Leverage proven predatory instincts to ruthlessly outcompete',g:'JUND'},{t:'Attack immediately and disrupt their position aggressively',g:'RAKDOS'},{t:'Make patient pragmatic moves as they naturally weaken',g:'GOLGARI'}]}],
  NAYA:[{sc:'Rallying organisation around shared mission requiring collective strength.',r:[{t:'Mobilize passionate coordinated community action leveraging natural collective power',g:'NAYA'},{t:'Rally aggressive disciplined unified commitment to the mission',g:'BOROS'},{t:'Trust the group\'s powerful instincts and act forcefully together',g:'GRUUL'},{t:'Foster inclusive patient community building harmonious support',g:'SELESNYA'}]},{sc:'Defending community values through decisive coordinated action.',r:[{t:'Execute passionate unified action grounded in shared natural community strength',g:'NAYA'},{t:'Protect community values through inclusive patient collective support',g:'SELESNYA'},{t:'Fight aggressively with disciplined coordination for what the team stands for',g:'BOROS'}]}],
  ABZAN:[{sc:'Making decisions affecting your organisation for generations.',r:[{t:'Build enduring fair structures through pragmatic patient multi-generational thinking',g:'ABZAN'},{t:'Create inclusive sustainable community that develops naturally over time',g:'SELESNYA'},{t:'Establish fair hierarchy with pragmatic succession serving institutional power',g:'ORZHOV'},{t:'Make pragmatic investments in what survives natural cycles',g:'GOLGARI'}]},{sc:'Building capacity to endure through changing conditions.',r:[{t:'Create fair resilient systems through pragmatic acceptance of natural cycles',g:'ABZAN'},{t:'Build sustainability through pragmatic extraction and patient regeneration',g:'GOLGARI'},{t:'Design fair institutional frameworks serving long-term survival',g:'ORZHOV'}]}],
  JESKAI:[{sc:'Leading high-performance team requiring excellence and discipline.',r:[{t:'Drive passionate systematic excellence through disciplined coordinated mastery',g:'JESKAI'},{t:'Rally aggressive coordinated commitment with intense disciplined execution',g:'BOROS'},{t:'Create comprehensive systematic processes ensuring fair optimal performance',g:'AZORIUS'},{t:'Experiment passionately with analytical learning and rapid iteration',g:'IZZET'}]},{sc:'Mastering complex skills through practice.',r:[{t:'Train passionately with systematic discipline until technique becomes instinct',g:'JESKAI'},{t:'Execute aggressively with coordinated disciplined commitment',g:'BOROS'},{t:'Study analytically to optimise approaches systematically',g:'AZORIUS'}]}]
};

const ROUND2_SCENARIOS = {
  CRISIS: {
    id: 'CRISIS',
    context: 'A critical project is failing and needs immediate intervention to save it.',
    responses: {
      'MONO-W': 'Ensure fair treatment of all stakeholders affected by the crisis',
      'MONO-U': 'Analyze the situation systematically to identify root causes and implement the optimal solution',
      'MONO-B': 'Make pragmatic triage decisions about what to salvage versus cut',
      'MONO-R': 'Execute the turnaround with immediate aggressive action',
      'MONO-G': 'Draw on proven recovery patterns from similar past crises',
      'DIMIR': 'Analyze the situation strategically to make pragmatic decisions about what to salvage versus cut',
      'IZZET': 'Experiment rapidly through systematic testing to discover what actually works',
      'SIMIC': 'Study what makes current systems effective and evolve them incrementally through careful optimization',
      'SELESNYA': 'Support the team patiently, trusting that collective effort will naturally resolve the crisis',
      'GOLGARI': 'Focus pragmatically on what will survive long-term and invest there sustainably',
      'AZORIUS': 'Design comprehensive fair processes that systematically ensure optimal outcomes for everyone',
      'ORZHOV': 'Ensure fair treatment of all stakeholders while making pragmatic decisions about resource allocation',
      'RAKDOS': 'Make ruthless pragmatic triage decisions and execute aggressive immediate action',
      'BOROS': 'Rally the team into coordinated aggressive action to save what matters together',
      'GRUUL': 'Trust your instincts and act powerfully on gut feelings proven through experience',
      'GRIXIS': 'Ruthlessly analyse failure points to identify and execute an optimal aggressive turnaround immediately',
      'JUND': 'Attack the challenge aggressively using proven instincts, focusing pragmatically on what will survive and grow',
      'ESPER': 'Systematically assess the situation to make fair yet pragmatic decisions that optimise outcomes while respecting all stakeholders',
      'SULTAI': 'Analyze which capabilities will provide sustainable competitive advantage and position strategically for long-term value extraction',
      'BANT': 'Build systematic inclusive frameworks that allow people to develop naturally while coordinating analytically for collective success',
      'NAYA': 'Rally the team\'s natural strengths into passionate coordinated action, trusting collective instincts',
      'ABZAN': 'Ensure fair treatment through pragmatic patient decisions about sustainable long-term resource allocation',
      'JESKAI': 'Lead coordinated rapid experimentation through systematic bold innovation that serves the collective',
      'MARDU': 'Execute aggressive coordinated strikes while pragmatically ensuring fair distribution of both risks and rewards',
      'TEMUR': 'Create through systematic bold experimentation grounded in proven powerful patterns',
      'WITCH': 'Design fair systematic processes for aggressive pragmatic action that optimises outcomes rapidly while respecting stakeholders',
      'YORE': 'Build sustainable inclusive systems through patient pragmatic analysis ensuring fair long-term optimal outcomes',
      'DUNE': 'Rally collective strength for aggressive pragmatic action grounded in proven patterns while ensuring fair treatment',
      'GLINT': 'Execute ruthlessly optimised aggressive strategy drawing on proven patterns for sustainable competitive advantage',
      'INK': 'Lead systematic bold innovation through inclusive coordination while building on proven collective strengths',
      'WUBRG': 'Balance systematic analysis with pragmatic action, fair treatment, proven patterns, and aggressive innovation as the situation demands'
    }
  },
  PLANNING: {
    id: 'PLANNING',
    context: 'Developing strategy for your function over the next 2-3 years.',
    responses: {
      'MONO-W': 'Ensure inclusive process where everyone contributes to the strategy fairly',
      'MONO-U': 'Analyze trends systematically to design the optimal strategic roadmap',
      'MONO-B': 'Position to advance your competitive standing and capture opportunities',
      'MONO-R': 'Seize emerging opportunities with bold decisive moves',
      'MONO-G': 'Build on proven capabilities that will remain valuable long-term',
      'DIMIR': 'Analyze the competitive landscape methodically to position yourself for maximum strategic advantage',
      'IZZET': 'Experiment boldly with systematic innovation to discover breakthrough opportunities',
      'SIMIC': 'Study emerging trends to evolve proven capabilities incrementally and sustainably',
      'SELESNYA': 'Build strategy through inclusive patient process that develops naturally from collective strengths',
      'GOLGARI': 'Position strategically in areas that will provide sustainable competitive advantage long-term',
      'AZORIUS': 'Create comprehensive fair planning process with systematic analytical coordination ensuring optimal strategy for everyone',
      'ORZHOV': 'Ensure inclusive strategic process while pragmatically positioning for competitive advantage',
      'RAKDOS': 'Seize strategic opportunities aggressively, disrupting competitors to capture dominant position',
      'BOROS': 'Rally coordinated bold strategic action that serves collective objectives through decisive leadership',
      'GRUUL': 'Trust proven instincts to seize opportunities powerfully as they emerge naturally',
      'GRIXIS': 'Ruthlessly analyse the competitive landscape to position for maximum advantage through bold aggressive strategic moves',
      'JUND': 'Seize opportunities aggressively using proven instincts, focusing pragmatically on sustainable competitive growth',
      'ESPER': 'Design fair systematic strategy that optimises outcomes pragmatically while ensuring inclusive analytical process',
      'SULTAI': 'Analyze systematically which proven capabilities provide sustainable competitive advantage and position strategically for long-term value extraction',
      'BANT': 'Create systematic inclusive planning process ensuring patient analytical coordination for sustainable collective success',
      'NAYA': 'Rally collective proven strengths into bold coordinated strategic action through passionate inclusive leadership',
      'ABZAN': 'Build inclusive pragmatic strategy through patient systematic resource allocation ensuring sustainable long-term fairness',
      'JESKAI': 'Lead systematic bold innovation through fair coordinated experimentation that serves collective strategic objectives',
      'MARDU': 'Execute bold coordinated strategic strikes while pragmatically ensuring fair distribution of opportunities and risks',
      'TEMUR': 'Experiment boldly through systematic innovation grounded in proven powerful patterns and natural strengths',
      'WITCH': 'Design fair systematic strategy for aggressive pragmatic positioning that optimises rapid competitive advantage while including all stakeholders',
      'YORE': 'Build sustainable inclusive strategy through patient pragmatic systematic analysis ensuring fair long-term optimal development',
      'DUNE': 'Rally collective proven strengths for bold pragmatic positioning while ensuring fair treatment and sustainable competitive growth',
      'GLINT': 'Execute ruthlessly optimised aggressive strategy systematically, positioning in proven areas for sustainable competitive dominance',
      'INK': 'Lead systematic bold strategic innovation through inclusive fair coordination while building on proven collective capabilities',
      'WUBRG': 'Design comprehensive strategy through systematic analysis that balances bold innovation, pragmatic positioning, proven strengths, and fair inclusive development'
    }
  },
  TEAM: {
    id: 'TEAM',
    context: 'Shaping how your team collaborates and develops together over time.',
    responses: {
      'MONO-W': 'Create inclusive environment where everyone feels valued, supported, and connected as a team',
      'MONO-U': 'Design systematic processes for effective coordination and optimal collaboration',
      'MONO-B': 'Focus on what drives results and enables individual advancement',
      'MONO-R': 'Encourage passionate authentic expression and quick decisive action',
      'MONO-G': 'Allow relationships and trust to develop naturally over time',
      'DIMIR': 'Design systematic approaches focused on individual advancement through strategic capability development',
      'IZZET': 'Create environment for rapid systematic experimentation with passionate bold innovation',
      'SIMIC': 'Allow team dynamics to evolve naturally while thoughtfully optimizing coordination and effectiveness',
      'SELESNYA': 'Foster inclusive supportive space where relationships develop naturally and people feel genuinely connected',
      'GOLGARI': 'Focus on what provides sustainable individual growth while allowing natural development over time',
      'AZORIUS': 'Create comprehensive fair systematic framework ensuring optimal coordinated collaboration for everyone',
      'ORZHOV': 'Build inclusive supportive environment while pragmatically focusing on what drives individual and team results',
      'RAKDOS': 'Encourage aggressive authentic self-expression, focusing on individual advancement through bold action',
      'BOROS': 'Foster passionate collective commitment through coordinated decisive action and mutual support',
      'GRUUL': 'Trust authentic instinctive relationships to develop powerfully through natural organic interaction',
      'GRIXIS': 'Design systematic approaches focused on rapid individual advancement through aggressive competitive capability development',
      'JUND': 'Encourage aggressive authentic expression using proven instincts, focusing pragmatically on sustainable individual growth',
      'ESPER': 'Design fair systematic processes that optimise collaboration pragmatically while ensuring inclusive supportive coordination',
      'SULTAI': 'Design systematic approaches that enable sustainable individual advancement while allowing natural relationship development over time',
      'BANT': 'Create systematic inclusive framework enabling people to develop naturally while coordinating collaboration analytically for collective success',
      'NAYA': 'Foster passionate coordinated collaboration where collective natural strengths develop through authentic inclusive connection',
      'ABZAN': 'Build inclusive supportive environment through pragmatic patient focus on sustainable long-term individual and collective development',
      'JESKAI': 'Lead systematic bold innovation through coordinated passionate experimentation that serves inclusive collective growth',
      'MARDU': 'Foster passionate coordinated action while pragmatically ensuring fair distribution of advancement opportunities and collective support',
      'TEMUR': 'Create through systematic bold experimentation while allowing authentic natural team dynamics to develop powerfully',
      'WITCH': 'Design fair systematic processes for aggressive pragmatic collaboration that optimises rapid individual advancement while ensuring inclusive coordination',
      'YORE': 'Build sustainable inclusive environment through patient pragmatic systematic coordination ensuring fair long-term optimal development for everyone',
      'DUNE': 'Foster passionate collective strength through aggressive pragmatic action grounded in proven natural relationships while ensuring fair supportive treatment',
      'GLINT': 'Design systematic approaches for aggressive individual advancement drawing on proven patterns for sustainable competitive capability development',
      'INK': 'Lead systematic bold collaborative innovation through inclusive fair coordination while building on proven collective natural strengths',
      'WUBRG': 'Design systematic framework for passionate collaboration that enables aggressive individual advancement, patient relationship development, pragmatic results focus, and fair inclusive support flexibly'
    }
  },
  CHANGE: {
    id: 'CHANGE',
    context: 'Your organisation is implementing major changes affecting how your team operates.',
    responses: {
      'MONO-W': 'Ensure everyone is supported through the transition fairly and feels heard',
      'MONO-U': 'Analyze the changes systematically to optimise the implementation process',
      'MONO-B': 'Focus on how the changes affect your team\'s position and opportunities',
      'MONO-R': 'Embrace the changes immediately with bold decisive action',
      'MONO-G': 'Allow people to adapt at their natural pace through the transition',
      'DIMIR': 'Analyze the changes strategically to position your team for maximum advantage during the transition',
      'IZZET': 'Experiment boldly with systematic rapid iteration to discover what works in the new environment',
      'SIMIC': 'Allow organic adaptation while thoughtfully optimizing the transition process for sustainable effectiveness',
      'SELESNYA': 'Support everyone patiently through the transition, trusting collective adaptation will occur naturally',
      'GOLGARI': 'Focus pragmatically on what will survive the transition and position there for sustainable long-term advantage',
      'AZORIUS': 'Create comprehensive fair systematic support process ensuring optimal organized transition for everyone',
      'ORZHOV': 'Ensure fair inclusive support through the transition while pragmatically positioning for what the changes enable',
      'RAKDOS': 'Seize opportunities aggressively as old patterns disrupt, positioning ruthlessly for advantage in the chaos',
      'BOROS': 'Rally coordinated bold collective action to embrace change decisively while ensuring everyone is supported',
      'GRUUL': 'Trust powerful instincts to adapt naturally, acting decisively as gut feelings guide the transition',
      'GRIXIS': 'Analyze the changes ruthlessly to identify and seize opportunities aggressively during optimal transition moments',
      'JUND': 'Adapt aggressively using proven instincts, focusing pragmatically on what will survive and thrive after the changes',
      'ESPER': 'Design fair systematic transition that optimises outcomes pragmatically while ensuring inclusive analytical support for everyone',
      'SULTAI': 'Analyze systematically what provides sustainable advantage and position strategically while allowing natural patient adaptation',
      'BANT': 'Create systematic inclusive support process allowing patient natural adaptation while coordinating transition analytically for collective success',
      'NAYA': 'Rally collective natural adaptive capacity through passionate coordinated decisive action supporting everyone through transition',
      'ABZAN': 'Ensure inclusive fair support through pragmatic patient decisions about sustainable long-term adaptation and positioning',
      'JESKAI': 'Lead systematic bold adaptive innovation through coordinated rapid experimentation that supports collective transition',
      'MARDU': 'Execute bold coordinated adaptive action while pragmatically ensuring fair distribution of transition opportunities and support',
      'TEMUR': 'Adapt through systematic bold experimentation grounded in proven powerful instincts about what works naturally',
      'WITCH': 'Design fair systematic transition for aggressive pragmatic adaptation that optimises rapid positioning while ensuring inclusive support',
      'YORE': 'Build sustainable inclusive adaptation through patient pragmatic systematic analysis ensuring fair long-term optimal transition',
      'DUNE': 'Rally collective natural adaptive strength for bold pragmatic action while ensuring fair supportive treatment through transition',
      'GLINT': 'Execute ruthlessly optimised aggressive adaptation strategy drawing on proven patterns for sustainable competitive advantage',
      'INK': 'Lead systematic bold adaptive innovation through inclusive fair coordination while building on proven collective transition capacity',
      'WUBRG': 'Navigate transition through systematic analysis, fair support, pragmatic positioning, bold action, and patient adaptation as each situation demands'
    }
  },
  MTG_STALL: {
    id: 'MTG_STALL',
    context: 'You\'re in a competitive game (could be cards, board game, whatever). It\'s stalled for 40 minutes. Everyone has strong positions. Nobody wants to make the first move because it opens them up to counterattack. Everyone is just... waiting.',
    responses: {
      'MONO-W': 'I propose a formal rotation. Clockwise attacks. Everyone gets a turn to be aggressor. It\'s only fair.',
      'MONO-U': 'I\'m fine. Every draw step brings me closer to inevitability. You\'ll all understand eventually.',
      'MONO-B': 'I start making offers. Quietly. One by one. Someone at this table has a price.',
      'MONO-R': 'I attack. Into the full board. With everything. I will lose creatures. I don\'t care. SOMETHING HAS TO HAPPEN.',
      'MONO-G': 'I wait. The board will resolve itself. Boards always do. I\'ve been playing creatures for 40 minutes. I can play creatures for 40 more.',
      'AZORIUS': 'I\'ve drafted a non-binding resolution for structured aggression. Section 3 covers reparations for blocked creatures. Please review.',
      'DIMIR': 'I pass. I\'ve been passing for 40 minutes. What I haven\'t told anyone is that I\'ve been sculpting a hand that ends this in one turn.',
      'RAKDOS': 'I attack the player who\'s having the most fun. The game is boring and now they should be bored too.',
      'GRUUL': 'I ATTACK. They block? I don\'t care. They crack back? I don\'t care. Board goes sideways? GOOD. THINGS ARE HAPPENING.',
      'SELESNYA': 'I suggest we all just... talk. Why are we fighting? We could just enjoy each other\'s company. The real treasure was the friends we‚Äî',
      'ORZHOV': 'I start taking notes on who owes whom. This stall will end eventually. I intend to collect.',
      'IZZET': 'What if I just... cast this? I don\'t know what it does to the board. Let\'s find out together.',
      'GOLGARI': 'I\'m fine. While you\'ve been staring at your creatures, mine have been dying and coming back stronger. The graveyard grows.',
      'BOROS': 'COWARDS. ALL OF YOU. Fine. I\'ll break this stall MYSELF. CHARGE. FOR GLORY. FOR SOMETHING TO HAPPEN.',
      'SIMIC': 'I\'ve been quietly putting +1/+1 counters on things. Don\'t mind me. Keep stalling. Please. Take your time.',
      'BANT': 'I propose we form a temporary alliance against whoever has the strongest board. Democratically. With ranked choice voting.',
      'ESPER': 'The optimal play is to wait. I\'ve calculated that in 7 more turns, the board state favours me by 23%. I can wait.',
      'GRIXIS': 'I whisper to my left: "Attack right. I\'ll back you up." I whisper to my right: "They\'re about to attack you. Strike first."',
      'JUND': 'I attack the weakest player. Not because they\'re a threat. Because culling the herd is natural. Someone has to go.',
      'NAYA': 'I rally the table. "We\'re all friends here! Let\'s just agree to attack and see what happens! It\'ll be FUN!"',
      'ABZAN': 'I\'ve been here before. Stalls end. Players make mistakes. I outlast. My creatures outlast. Time is on my side.',
      'JESKAI': 'I have calculated exactly who should attack whom for optimal damage distribution. Here\'s a diagram. You\'re welcome.',
      'SULTAI': 'I wait. And watch. Someone will crack. When they do, I\'ll be ready to pick through the wreckage.',
      'MARDU': 'Enough. I\'m attacking you. Why? Because you\'re THERE. We\'ll sort out the rest after the dust settles.',
      'TEMUR': 'The board is a puzzle. Let me just... *turns all creatures sideways* THERE. Now it\'s a different puzzle.',
      'YORE': 'I have 17 artifacts. You have creatures. Let me explain why this stall ends in my favour. Do you have three hours?',
      'GLINT': 'The person to my right looks nervous. I\'m going to stare at them until they crack. I don\'t blink. I have time.',
      'DUNE': 'I stop thinking. I attack. Strategy is for people who don\'t have enough power. I have enough power.',
      'INK': 'What if we all just attacked at once? Same time? No takebacks? It\'d be chaos. Beautiful chaos.',
      'WITCH': 'I\'ve been advancing my board incrementally for 40 minutes. I can do this for 40 more. Can you?',
      'WUBRG': 'I have answers. I have threats. I have a plan. I have a backup plan. I have contingencies for the backup plan. I\'m fine. Are you fine? You don\'t look fine.'
    }
  }
};

// 50 random taglines for the welcome page
const RANDOM_TAGLINES = [
  // The absurd premise
  "Personality typing, but the research budget went to cardboard",
  "What if Jung had played more trading card games",
  "Turns out 30 years of wizard combat taught us something",
  "We built this instead of getting therapy",
  "The Sorting Hat for people with disposable income",
  "Somewhere, a psychometrician is furious",
  "Peer reviewed by exactly zero journals",
  "We can't believe this works either",
  "Based on a game about wizards fighting. Why is it accurate.",
  "A joke that stopped being funny when it started working",
  "We started this ironically",
  "Cardboard Freud",
  // Uncomfortable accuracy
  "You'll hate how accurate this is",
  "The results won't surprise your friends",
  "Confirming what your colleagues already whisper",
  "You already know. We're just going to say it.",
  "The colour pie sees you. It is not impressed.",
  "Find out what everyone else already noticed",
  "Your blind spots, in five colours",
  "The uncomfortable truth, in mana symbols",
  // Self-aware about being a personality test
  "Another personality test. But this one has dragons.",
  "You're going to share this result, aren't you",
  "Yes, you can blame your colour identity",
  "Finally, a new way to excuse your behaviour",
  "One more thing to put in your email signature",
  "Content for your next icebreaker",
  "Now with 73% more existential crisis",
  // British understatement/dry
  "Quite possibly nonsense. Quite possibly not.",
  "Scientifically questionable. Socially devastating.",
  "Not validated. Annoyingly accurate.",
  "Use responsibly. Or don't. We're not your manager.",
  "Results may cause unwanted self-awareness",
  "Side effects include mild existential discomfort",
  "You might not like this",
  "This will end well",
  // Specific to the format
  "Five colours. Thirty-one ways to be difficult.",
  "Three rounds to find out what kind of problem you are",
  "Forced choices, uncomfortable truths",
  "Discover which kind of difficult you are",
  "Your issues, sorted by colour"
];

const ARCHETYPE_EXAMPLES = [
  {id: 'DIMIR', name: 'DIMIR', colors: ['U', 'B'],
    normal: "They're strategic and focused on positioning for advantage.",
    banter: "Why do they know everything about everyone and never share what they know? Pretty sure they're BCCing leadership on literally every email."},
  {id: 'RAKDOS', name: 'RAKDOS', colors: ['B', 'R'], 
    normal: "They're bold and not afraid to shake things up to get results.", 
    banter: "They're legitimately chaotic. They'll burn down the whole project for the drama and then laugh while we put out fires. It's unhinged."},
  {id: 'GRUUL', name: 'GRUUL', colors: ['R', 'G'], 
    normal: "They're direct and rely on proven strength to solve problems head-on.", 
    banter: "Subtlety? Strategy? Never heard of it. They just smash through everything and ignore feedback like it doesn't exist."},
  {id: 'SELESNYA', name: 'SELESNYA', colors: ['W', 'G'], 
    normal: "They're really focused on team harmony and making sure everyone feels included.", 
    banter: "We cannot make a single decision without a team-building exercise. Everything has to be consensus and it takes forever."},
  {id: 'ORZHOV', name: 'ORZHOV', colors: ['W', 'B'], 
    normal: "They're good at navigating organisational politics while maintaining fairness.", 
    banter: "Every favour comes with interest later. They keep score on everything and weaponize policy the second it benefits them."},
  {id: 'IZZET', name: 'IZZET', colors: ['U', 'R'], 
    normal: "They're innovative and like to experiment with new approaches rapidly.", 
    banter: "Did they test this? No. They just experimented on production again. And now they're yelling SCIENCE while everything's broken."},
  {id: 'GOLGARI', name: 'GOLGARI', colors: ['B', 'G'], 
    normal: "They're good at extracting value from situations and working with long cycles.", 
    banter: "Why do they hoard every failed project? This workspace is a graveyard of ideas that died three years ago and won't stay buried."},
  {id: 'SIMIC', name: 'SIMIC', colors: ['G', 'U'], 
    normal: "They're thoughtful about improving existing systems without disrupting what works.", 
    banter: "They optimise everything to death. Six months to improve a two-week process and somehow it's worse now."},
  {id: 'BOROS', name: 'BOROS', colors: ['R', 'W'], 
    normal: "They're passionate about team goals and rally people around shared missions.", 
    banter: "Not everything is a crusade but they treat quarterly planning like D-Day. The intensity is just a lot."},
  {id: 'BANT', name: 'BANT', colors: ['W', 'U', 'G'], 
    normal: "They're balanced and strategic about building sustainable team outcomes.", 
    banter: "Great another two-hour planning session for a ten-minute task. Yes we all need to weigh in for the good of the team apparently."},
  {id: 'ESPER', name: 'ESPER', colors: ['W', 'U', 'B'], 
    normal: "They're systematic and effective at creating well-designed processes.", 
    banter: "Do they feel anything? Every conversation is like talking to a spreadsheet. Literally optimised the humanity out of this place."},
  {id: 'GRIXIS', name: 'GRIXIS', colors: ['U', 'B', 'R'], 
    normal: "They're strategically decisive and comfortable making bold moves.", 
    banter: "Pretty sure they create half the crises just to solve them dramatically. The evil laugh in the break room is not helping their case."},
  {id: 'JUND', name: 'JUND', colors: ['B', 'R', 'G'], 
    normal: "They're competitive and trust their proven instincts in high-stakes situations.", 
    banter: "Everything is a competition. They turn meetings into cage matches and dominate every single conversation. Exhausting."},
  {id: 'NAYA', name: 'NAYA', colors: ['R', 'G', 'W'], 
    normal: "They're enthusiastic team builders who bring a lot of energy to initiatives.", 
    banter: "Why does every task need pep talks and a literal marching band. We just needed to update a spreadsheet not plan a parade."},
  {id: 'ABZAN', name: 'ABZAN', colors: ['W', 'B', 'G'], 
    normal: "They're traditional and good at building enduring organisational structures.", 
    banter: "They block every new idea with We've always done it this way. Also they definitely keep a ledger of who owes them what."},
  {id: 'JESKAI', name: 'JESKAI', colors: ['U', 'R', 'W'], 
    normal: "They're skilled and pursue excellence through disciplined practice.", 
    banter: "So smug about their technique. Everything you do is basic and they make sure you feel it. Working with them is like being in a seminar you didn't sign up for."},
  {id: 'SULTAI', name: 'SULTAI', colors: ['B', 'G', 'U'], 
    normal: "They're patient strategists who build influence methodically over time.", 
    banter: "They co-opt your work and somehow it becomes part of their little empire. Very smooth about it. Very slimy."},
  {id: 'MARDU', name: 'MARDU', colors: ['R', 'W', 'B'], 
    normal: "They're intense about execution and will push hard to meet goals.", 
    banter: "Every deadline is life or death. They glorify burnout as dedication and yes they will flip tables if things aren't moving fast enough."},
  {id: 'TEMUR', name: 'TEMUR', colors: ['G', 'U', 'R'], 
    normal: "They're adaptive and combine creative thinking with strong instincts.", 
    banter: "Hold on tight because they'll pivot the entire strategy three times this week and you'll just have to deal with the whiplash."},
  {id: 'WITCH', name: 'FOUR-COLOR (No Red)', colors: ['W', 'U', 'B', 'G'], 
    normal: "They're comprehensive thinkers who approach things methodically without getting emotional.", 
    banter: "It's like they're running a simulation. Zero passion zero urgency just spreadsheets making Monday last all week."},
  {id: 'YORE', name: 'FOUR-COLOR (No Green)', colors: ['W', 'U', 'B', 'R'], 
    normal: "They're innovative and like to redesign things rather than use traditional approaches.", 
    banter: "They over-engineer everything. Simple solution? Nope needs seventeen moving parts and will break in two weeks requiring emergency fixes."},
  {id: 'GLINT', name: 'FOUR-COLOR (No White)', colors: ['U', 'B', 'R', 'G'], 
    normal: "They're creative and willing to work outside conventional boundaries.", 
    banter: "Rules are for suckers according to them. They hijack projects for fun and leave smoking wreckage of what used to be a plan."},
  {id: 'DUNE', name: 'FOUR-COLOR (No Blue)', colors: ['W', 'B', 'R', 'G'], 
    normal: "They're action-oriented and trust their gut feelings over extended analysis.", 
    banter: "They charge in on impulse every time. Planning never happens. Already yelling NO TIME NEXT while you're picking up pieces."},
  {id: 'INK', name: 'FOUR-COLOR (No Black)', colors: ['W', 'U', 'R', 'G'], 
    normal: "They're idealistic and genuinely want everyone to succeed.", 
    banter: "They're trying to help everyone at once and it's a circus. Unintended confetti explosions everywhere. So chaotic but they mean well I guess."},
  {id: 'WUBRG', name: 'FIVE-COLOR', colors: ['W', 'U', 'B', 'R', 'G'], 
    normal: "They're versatile and can work with pretty much any approach or person.", 
    banter: "They want everything at once. Kitchen sink in every project. I'm taking bets on which spinning plate crashes first."}
];

// ============================================================================
// COMMANDER ORACLE TEXT - ALL COMMANDERS
// ============================================================================
const COMMANDER_ORACLE = {
  // MONO-COLOR
  'Heliod, God of the Sun': {
    cost: '{3}{W}',
    pt: '5/6',
    text: ['Indestructible', 'As long as your devotion to white is less than five, Heliod isn\'t a creature.', 'Other creatures you control have vigilance.', '{2}{W}{W}: Create a 2/1 white Cleric enchantment creature token.']
  },
  'Urza, Lord High Artificer': {
    cost: '{2}{U}{U}',
    pt: '1/4',
    text: ['When Urza enters, create a 0/0 colorless Construct artifact creature token with "This creature gets +1/+1 for each artifact you control."', 'Tap an untapped artifact you control: Add {U}.', '{5}: Shuffle your library, then exile the top card. Until end of turn, you may play that card without paying its mana cost.']
  },
  "K'rrik, Son of Yawgmoth": {
    cost: '{4}{B/P}{B/P}{B/P}',
    pt: '2/2',
    text: ['({B/P} can be paid with either {B} or 2 life.)', 'Lifelink', 'For each {B} in a cost, you may pay 2 life rather than pay that mana.', 'Whenever you cast a black spell, put a +1/+1 counter on K\'rrik.']
  },
  'Krenko, Mob Boss': {
    cost: '{2}{R}{R}',
    pt: '3/3',
    text: ['{T}: Create X 1/1 red Goblin creature tokens, where X is the number of Goblins you control.']
  },
  'Omnath, Locus of Mana': {
    cost: '{2}{G}',
    pt: '1/1',
    text: ['You don\'t lose unspent green mana as steps and phases end.', 'Omnath gets +1/+1 for each unspent green mana you have.']
  },
  
  // TWO-COLOR GUILDS
  'Grand Arbiter Augustin IV': {
    cost: '{2}{W}{U}',
    pt: '2/3',
    text: ['White spells you cast cost {1} less to cast.', 'Blue spells you cast cost {1} less to cast.', 'Spells your opponents cast cost {1} more to cast.']
  },
  'Obzedat, Ghost Council': {
    cost: '{1}{W}{W}{B}{B}',
    pt: '5/5',
    text: ['When Obzedat enters, target opponent loses 2 life and you gain 2 life.', 'At the beginning of your end step, you may exile Obzedat. If you do, return it to the battlefield under your control at the beginning of your next upkeep. It gains haste.']
  },
  "Yuriko, the Tiger's Shadow": {
    cost: '{1}{U}{B}',
    pt: '1/3',
    text: ['Commander ninjutsu {U}{B} ({U}{B}, Return an unblocked attacker you control to hand: Put this card onto the battlefield from your hand or the command zone tapped and attacking.)', 'Whenever a Ninja you control deals combat damage to a player, reveal the top card of your library and put that card into your hand. Each opponent loses life equal to that card\'s mana value.']
  },
  'Niv-Mizzet, Parun': {
    cost: '{U}{U}{U}{R}{R}{R}',
    pt: '5/5',
    text: ['This spell can\'t be countered.', 'Flying', 'Whenever you draw a card, Niv-Mizzet deals 1 damage to any target.', 'Whenever a player casts an instant or sorcery spell, you draw a card.']
  },
  'Borborygmos Enraged': {
    cost: '{4}{R}{R}{G}{G}',
    pt: '7/6',
    text: ['Trample', 'Whenever Borborygmos Enraged deals combat damage to a player, reveal the top three cards of your library. Put all land cards revealed this way into your hand and the rest into your graveyard.', 'Discard a land card: Borborygmos Enraged deals 3 damage to any target.']
  },
  'Rakdos, Lord of Riots': {
    cost: '{B}{B}{R}{R}',
    pt: '6/6',
    text: ['You can\'t cast this spell unless an opponent lost life this turn.', 'Flying, trample', 'Creature spells you cast cost {1} less to cast for each 1 life your opponents have lost this turn.']
  },
  'Meren of Clan Nel Toth': {
    cost: '{2}{B}{G}',
    pt: '3/4',
    text: ['Whenever another creature you control dies, you get an experience counter.', 'At the beginning of your end step, choose target creature card in your graveyard. If that card\'s mana value is less than or equal to the number of experience counters you have, return it to the battlefield. Otherwise, put it into your hand.']
  },
  'Prime Speaker Vannifar': {
    cost: '{2}{G}{U}',
    pt: '2/4',
    text: ['{T}, Sacrifice another creature: Search your library for a creature card with mana value equal to 1 plus the sacrificed creature\'s mana value, put that card onto the battlefield, then shuffle. Activate only as a sorcery.']
  },
  'Aurelia, the Warleader': {
    cost: '{2}{R}{R}{W}{W}',
    pt: '3/4',
    text: ['Flying, vigilance, haste', 'Whenever Aurelia attacks for the first time each turn, untap all creatures you control. After this phase, there is an additional combat phase.']
  },
  "Trostani, Selesnya's Voice": {
    cost: '{G}{G}{W}{W}',
    pt: '2/5',
    text: ['Whenever another creature enters the battlefield under your control, you gain life equal to its toughness.', '{1}{G}{W}, {T}: Populate (Create a token that\'s a copy of a creature token you control.)']
  },
  
  // THREE-COLOR
  'Rafiq of the Many': {
    cost: '{1}{G}{W}{U}',
    pt: '3/3',
    text: ['Exalted (Whenever a creature you control attacks alone, that creature gets +1/+1 until end of turn.)', 'Whenever a creature you control attacks alone, it gains double strike until end of turn.']
  },
  'Oloro, Ageless Ascetic': {
    cost: '{3}{W}{U}{B}',
    pt: '4/5',
    text: ['At the beginning of your upkeep, if Oloro is on the battlefield, you gain 2 life.', 'At the beginning of your upkeep, if Oloro is in the command zone, you gain 2 life.', 'Pay 3 life: Draw a card.']
  },
  'Nekusar, the Mindrazer': {
    cost: '{2}{U}{B}{R}',
    pt: '2/4',
    text: ['At the beginning of each player\'s draw step, that player draws an additional card.', 'Whenever an opponent draws a card, Nekusar deals 1 damage to that player.']
  },
  'Prossh, Skyraider of Kher': {
    cost: '{3}{B}{R}{G}',
    pt: '5/5',
    text: ['When you cast this spell, create X 0/1 red Kobold creature tokens named Kobolds of Kher Keep, where X is the amount of mana spent to cast it.', 'Flying', 'Sacrifice another creature: Prossh gets +1/+0 until end of turn.']
  },
  'Samut, Voice of Dissent': {
    cost: '{3}{R}{G}{W}',
    pt: '3/4',
    text: ['Flash', 'Double strike, vigilance, haste', 'Other creatures you control have haste.', '{W}: Untap another target creature.']
  },
  'Anafenza, the Foremost': {
    cost: '{W}{B}{G}',
    pt: '4/4',
    text: ['Whenever Anafenza attacks, put a +1/+1 counter on another target tapped creature you control.', 'If a nontoken creature an opponent owns would die or a creature card not on the battlefield would be put into an opponent\'s graveyard, exile that card instead.']
  },
  'Narset, Enlightened Master': {
    cost: '{3}{U}{R}{W}',
    pt: '3/2',
    text: ['First strike, hexproof', 'Whenever Narset attacks, exile the top four cards of your library. Until end of turn, you may cast noncreature spells from among those cards without paying their mana costs.']
  },
  'Sidisi, Brood Tyrant': {
    cost: '{1}{B}{G}{U}',
    pt: '3/3',
    text: ['Whenever Sidisi enters or attacks, mill three cards.', 'Whenever one or more creature cards are put into your graveyard from your library, create a 2/2 black Zombie creature token.']
  },
  'Queen Marchesa': {
    cost: '{1}{R}{W}{B}',
    pt: '3/3',
    text: ['Deathtouch, haste', 'When Queen Marchesa enters, you become the monarch.', 'At the beginning of your upkeep, if an opponent is the monarch, create a 1/1 black Assassin creature token with deathtouch and haste.']
  },
  'Surrak Dragonclaw': {
    cost: '{2}{G}{U}{R}',
    pt: '6/6',
    text: ['Flash', 'This spell can\'t be countered.', 'Creature spells you control can\'t be countered.', 'Other creatures you control have trample.']
  },
  
  // FOUR-COLOR
  "Atraxa, Praetors' Voice": {
    cost: '{G}{W}{U}{B}',
    pt: '4/4',
    text: ['Flying', 'Vigilance', 'Deathtouch', 'Lifelink', 'At the beginning of your end step, proliferate. (Choose any number of permanents and/or players, then give each another counter of each kind already there.)']
  },
  'Breya, Etherium Shaper': {
    cost: '{W}{U}{B}{R}',
    pt: '4/4',
    text: ['When Breya enters, create two 1/1 blue Thopter artifact creature tokens with flying.', '{2}, Sacrifice two artifacts: Choose one ‚Äî', '‚Ä¢ Breya deals 3 damage to target player or planeswalker.', '‚Ä¢ Target creature gets -4/-4 until end of turn.', '‚Ä¢ You gain 5 life.']
  },
  'Yidris, Maelstrom Wielder': {
    cost: '{U}{B}{R}{G}',
    pt: '5/4',
    text: ['Trample', 'Whenever Yidris deals combat damage to a player, as you cast spells from your hand this turn, they gain cascade.']
  },
  'Saskia the Unyielding': {
    cost: '{B}{R}{G}{W}',
    pt: '3/4',
    text: ['Vigilance, haste', 'As Saskia enters, choose a player.', 'Whenever a creature you control deals combat damage to a player, it deals that much damage to the chosen player.']
  },
  'Kynaios and Tiro of Meletis': {
    cost: '{R}{G}{W}{U}',
    pt: '2/8',
    text: ['At the beginning of your end step, draw a card.', 'Each player may put a land card from their hand onto the battlefield, then each opponent who didn\'t draws a card.']
  },
  
  // FIVE-COLOR
  'Kenrith, the Returned King': {
    cost: '{4}{W}',
    pt: '5/5',
    text: ['{R}: All creatures gain trample and haste until end of turn.', '{1}{G}: Put a +1/+1 counter on target creature.', '{2}{W}: Target player gains 5 life.', '{3}{U}: Target player draws a card.', '{4}{B}: Put target creature card from a graveyard onto the battlefield under its owner\'s control.']
  }
};

// ============================================================================
// POOL D: MONO VS MULTI-COLOR DISCRIMINATION
// ============================================================================

const PROFILES = {
  'MONO-W':{
    name:'MONO-WHITE',
    tag:'Peace Through Structure',
    colors:['W'],
    desc:"You're someone who believes in community, fairness, and moral order. You build systems that protect everyone and ensure justice.",
    pubBanter:"You're an absolute stickler who bogs down every decision with rule-checking. Can we just make a decision without consulting the entire team?",
    cmd:'Heliod, God of the Sun',
    cmdDesc:'Protects the team through structure and moral authority, creating systems everyone follows',
    str:['Exceptional at building cohesive teams','Strong ethical compass guides decisions','Creates stable fair systems','Makes decisions everyone accepts as fair','Builds institutions that last'],
    weak:['Gets stuck enforcing rules rigidly','Struggles with moral gray areas','Can be naive about bad actors','Slow to adapt to change','Sometimes sacrifices efficiency for fairness'],
    roles:'HR Leadership, Master of Ceremonies, Compliance, Ethics, Community Management'
  },
  'MONO-U':{
    name:'MONO-BLUE',
    tag:'Perfection Through Knowledge',
    colors:['U'],
    desc:"You're someone who believes knowledge and analysis lead to optimal outcomes. You solve problems through systematic thinking and continuous improvement.",
    pubBanter:"You're an insufferable know-it-all. It's always Well actually before every decision. Can we stop analyzing and just DO something?",
    cmd:'Urza, Lord High Artificer',
    cmdDesc:'Solves every problem through analysis and systematic thinking, always optimizing',
    str:['Superior analytical and strategic thinking','Continuously learns and improves','Plans strategically before acting','Excellent at solving complex problems','Makes objective data-driven decisions'],
    weak:['Paralyzes through over-analysis','Comes across as emotionally distant','Over-complicates simple problems','Can be arrogant about intelligence','Struggles when there is no clear answer'],
    roles:'Strategy, Research, Minister of Inquiries, Analytics, Architecture'
  },
  'MONO-B':{
    name:'MONO-BLACK',
    tag:'Power Through Agency',
    colors:['B'],
    desc:"You're someone who believes in pragmatic self-interest and making hard calls. You achieve goals through clear-eyed assessment of reality.",
    pubBanter:"You're ruthlessly pragmatic and everything is transactional. Does everything have to be a calculation about what you get out of it?",
    cmd:"K'rrik, Son of Yawgmoth",
    cmdDesc:'Power at any cost‚Äîpays life for mana, ruthless ambition',
    str:['Takes decisive action','Clear about priorities and trade-offs','Politically savvy and strategic','Makes tough calls others avoid','Relentlessly results-oriented'],
    weak:['Amoral pragmatism','Has serious trust issues','Exploits people and situations','Focuses too much on short-term gains','Alienates people through self-interest'],
    roles:'Executive Leadership, Gravedigger, M&A, Private Equity, Strategy'
  },
  'MONO-R':{
    name:'MONO-RED',
    tag:'Freedom Through Action',
    colors:['R'],
    desc:"You're someone who believes in authentic expression and immediate action. You trust your instincts and act with passion.",
    pubBanter:"You're a complete loose cannon. Could you think about things for like five minutes first? We're always cleaning up after your impulsive decisions.",
    cmd:'Krenko, Mob Boss',
    cmdDesc:'Acts on instinct and passion immediately, creating chaotic momentum',
    str:['Executes incredibly fast','Engages authentically with real passion','Brings energizing disruptive presence','Comfortable taking big risks','Has strong bias toward action'],
    weak:['Makes impulsive poor decisions','Terrible at planning ahead','Creates chaos everywhere','Burns out quickly','Lacks strategic thinking completely'],
    roles:'Startups, Sales, Professional Face-Breaker, Crisis Response, Creative Roles'
  },
  'MONO-G':{
    name:'MONO-GREEN',
    tag:'Growth Through Acceptance',
    colors:['G'],
    desc:"You're someone who believes in natural growth, patience, and respecting what works. You trust proven patterns and organic development.",
    pubBanter:"You're a stubborn bulldozer who resists every change. Your entire argument is We've always done it this way. That's it. That's the whole argument.",
    cmd:'Omnath, Locus of Mana',
    cmdDesc:"Doesn't lose mana, grows from accumulated green‚Äîpatient compound power",
    str:['Patient with long-term development','Respects what has worked before','Builds sustainable lasting practices','Develops from existing strengths','Thinks long-term instinctively'],
    weak:['Resists necessary changes','Too passive about problems','Actively anti-innovation','Makes decisions painfully slowly','Gets stuck in the past'],
    roles:'Operations, Master Chef, Agriculture, Sustainability, Mentorship'
  },
  'AZORIUS':{
    name:'AZORIUS',
    tag:'Order Through Knowledge',
    colors:['W','U'],
    desc:"You're someone who combines moral order with logical perfection for systematic control. You build comprehensive rules fairly and efficiently applied.",
    pubBanter:"They become the walking pile of red tape who will cite chapter and verse of the rulebook to veto anything fun, turning even a trivial task into a drawn-out committee meeting that could have been an email.",
    cmd:'Grand Arbiter Augustin IV',
    cmdDesc:'Controls through comprehensive fair systems, combining law and logic',
    str:['Exceptional at governance and structure','Plans comprehensively before acting','Makes systematic fair decisions','Creates stable reliable environments','Thinks strategically'],
    weak:['Paralyzes through over-analysis','Bureaucratically slow at everything','Worships rules over actual outcomes','Stifles innovation and creativity','Needs the perfect plan before moving'],
    roles:'COO, Deputy of Detention, Compliance, Strategic Planning, Governance'
  },
  'SELESNYA':{
    name:'SELESNYA',
    tag:'Community Through Nature',
    colors:['W','G'],
    desc:"You're someone who combines organized community with organic interconnection for living harmony. Communities that are both alive and coordinated.",
    pubBanter:"You're an overbearing team-builder. Can we fire anyone? Ever? Every conflict needs healing and patience. Every 1-on-1 becomes a team retreat.",
    cmd:"Trostani, Selesnya's Voice",
    cmdDesc:'Builds living community where everyone grows together harmoniously',
    str:['Exceptional at building cohesive teams','Develops people and systems sustainably','Resolves conflicts naturally','Creates psychologically safe spaces','Patient mentor to everyone'],
    weak:['Seeks excessive consensus for everything','Can be naive about bad actors','Resists necessary accountability','Can become cult-like about team','Slow to cut obvious losses'],
    roles:'Chief People Officer, Centaur Peacemaker, HR, Culture & Values, Team Leads'
  },
  'ORZHOV':{
    name:'ORZHOV',
    tag:'Structure Through Power',
    colors:['W','B'],
    desc:"You're someone who combines systematic structure with self-interested ambition for organized extraction. Fair hierarchies serving strategic goals.",
    pubBanter:"They become a soul-sucking bureaucrat in a fancy suit, the type who enforces every policy to the letter when it benefits them, extorts favours under the guise of procedure, and generally taxes everyone time and energy like a one-person corporate vampire.",
    cmd:'Obzedat, Ghost Council',
    cmdDesc:'Extracts value through fair-seeming hierarchies and political leverage',
    str:['Building lasting institutions','Allocates resources pragmatically','Navigates politics expertly','Creates clear advancement paths','Balances ambition with sustainability'],
    weak:['Enables corruption and exploitation','Treats people as extractable resources','Creates Byzantine political games','Favors well-connected over capable people','Preserves genuinely unjust hierarchies'],
    roles:'COO, Finance, High Priest of Penance, Legal/Compliance, Senior Management'
  },
  'DIMIR':{
    name:'DIMIR',
    tag:'Intelligence Through Control',
    colors:['U','B'],
    desc:"You're someone who combines knowledge-seeking with power-seeking to weaponize information. You win through patient strategic positioning.",
    pubBanter:"You're an information hoarder. Why do you know that? Why won't you share what you know? Always playing 4D chess when we're playing checkers.",
    cmd:"Yuriko, the Tiger's Shadow",
    cmdDesc:'Wins through information control and patient strategic positioning',
    str:['Masters strategic positioning','Gathers information systematically','Reads situations and people expertly','Plays the long game patiently','Masters political maneuvering'],
    weak:['Has serious trust issues','Over-complicates everything unnecessarily','Alienates people through secrecy','Has serious ethical blind spots','Becomes paranoid easily'],
    roles:'Strategic Planning, Hostage Taker, M&A, Competitive Intelligence, VC/PE'
  },
  'IZZET':{
    name:'IZZET',
    tag:'Discovery Through Experimentation',
    colors:['U','R'],
    desc:"You're someone who combines analytical curiosity with experimental courage for mad science. You innovate through bold testing.",
    pubBanter:"You're a scatterbrained mad scientist. Did you test this? At all? You experiment on production and yell SCIENCE when it breaks.",
    cmd:'Niv-Mizzet, Parun',
    cmdDesc:'Innovates through rapid experimentation and bold testing',
    str:['Achieves genuine breakthrough innovation','Learns fast through rapid iteration','Solves problems creatively','Has high tolerance for failure','Brings energizing disruptive presence'],
    weak:['Experiments recklessly on people','Lacks follow-through completely','Has serious ethical blind spots','Creates exhausting chaos','Moves fast and breaks everything'],
    roles:'R&D, Goblin Electromancer, Innovation Labs, Product Development, Startups'
  },
  'GRUUL':{
    name:'GRUUL',
    tag:'Power Through Instinct',
    colors:['R','G'],
    desc:"You're someone who combines passionate action with primal strength for unstoppable force. You trust gut instinct and apply overwhelming power.",
    pubBanter:"You're a rampaging force of nature. Have you considered that not everything needs overwhelming force? Subtlety exists. You wouldn't know it from watching you.",
    cmd:'Borborygmos Enraged',
    cmdDesc:'Applies overwhelming direct force based on gut instinct',
    str:['Takes decisive action','Has physical and moral courage','Communicates with authentic directness','Fights hard for what matters','Cuts through complexity fast'],
    weak:['Anti-intellectual by default','Impatient with incremental progress','Terrible at long-term planning','Uncomfortable with any politics','Prefers force over finesse'],
    roles:'Operations, Sales, Grand Warlord Radha, Construction, Military, Crisis Response'
  },
  'RAKDOS':{
    name:'RAKDOS',
    tag:'Freedom Through Chaos',
    colors:['B','R'],
    desc:"You're someone who combines self-interest with passionate action for uninhibited pursuit. You do what you want without apology.",
    pubBanter:"You're the chaos-loving prankster who treats coworkers like an unwitting audience for destructive antics, gleefully burning down hours of work for the LOLs while everyone else scrambles to put out the fires.",
    cmd:'Rakdos, Lord of Riots',
    cmdDesc:'Pursues self-interest passionately without restraint or apology',
    str:['Takes decisive bold action','Engages authentically with real passion','Cuts through pretense instantly','Brings energizing disruptive presence','Breaks rules that actually need breaking'],
    weak:['Recklessly destroys things','Burns out everyone around them','Creates zero sustainability','Has serious ethical blind spots','Creates exhausting constant chaos'],
    roles:'Disruptive Startups, Master of Cruelties, Aggressive Sales, Entertainment, Activism'
  },
  'GOLGARI':{
    name:'GOLGARI',
    tag:'Growth Through Decay',
    colors:['B','G'],
    desc:"You're someone who combines use of death with acceptance of cycles for sustainable extraction. You harvest without killing the host.",
    pubBanter:"You're a morbid hoarder. Why is everything a metaphor about death and compost? You view layoffs as natural cycles which is unsettling.",
    cmd:'Meren of Clan Nel Toth',
    cmdDesc:'Extracts sustainable value from death and decay cycles',
    str:['Long-term patient building','Resource efficiency','Comfortable with endings','Builds sustainable lasting practices','Resilient through cycles'],
    weak:['Morbid focus on death','Can be parasitic','Passive about injustice','Slow to act','Fatalistic'],
    roles:'Sustainability, Deathrite Shaman, Turnaround/Restructuring, Operations'
  },
  'SIMIC':{
    name:'SIMIC',
    tag:'Evolution Through Design',
    colors:['G','U'],
    desc:"You're someone who combines organic growth with optimization for directed evolution. You carefully improve natural systems.",
    pubBanter:"You're an overzealous lab geek. Can we ship something that's 80 percent instead of waiting for perfect? You optimise everything to death.",
    cmd:'Prime Speaker Vannifar',
    cmdDesc:'Evolves systems through careful optimization and adaptation',
    str:['Innovates sustainably over time','Improves things patiently and thoughtfully','Respects and works with existing systems','Develops capabilities for the long-term','Experiments thoughtfully not recklessly'],
    weak:['Paralyzes through over-analysis','Arrogance about knowledge','Playing god','Too slow when urgent','Constant internal conflict'],
    roles:'Product Management, Coiling Oracle, Process Improvement, Biotech, UX Research'
  },
  'BOROS':{
    name:'BOROS',
    tag:'Justice Through Action',
    colors:['R','W'],
    desc:"You're someone who combines passionate action with moral purpose for zealous execution. You fight passionately for just causes.",
    pubBanter:"You're an overzealous drill sergeant. Not everything is a crusade. You treat quarterly planning like D-Day. The intensity is exhausting.",
    cmd:'Aurelia, the Warleader',
    cmdDesc:'Executes passionately for just causes with relentless force',
    str:['Takes decisive mission-driven action','Builds high-performing intense teams','Confronts problems courageously','Commits passionately to goals','Excellent in actual crisis situations'],
    weak:['Violence as only solution','Zealotry','Poor at subtle navigation','Struggles with patience','With us or against us'],
    roles:'Military, Sunhome Enforcer, Crisis Management, Mission Nonprofits, Sales Leadership'
  },
  'BANT':{
    name:'BANT',
    tag:'Harmony Through Structure',
    colors:['W','U','G'],
    desc:"You're someone who combines order, analysis, and natural growth for harmonious civilization. Patient coordinated excellence.",
    pubBanter:"They become the sanctimonious project manager who wraps micromanagement in a smiley for the good of the team blanket, relentlessly organizing, scheduling team yoga sessions, and smothering any creative spark under so many best practices and polite check-ins that you long for one un-scheduled hour to actually get work done.",
    cmd:'Rafiq of the Many',
    cmdDesc:'Coordinates patient strategic excellence through harmony',
    str:['Exceptional balanced leadership','Patient sustainable development','Strategic and people-focused','Psychologically safe environments','Combines three colors'],
    weak:['Excessively slow','Naive about conflict','Cannot make tough calls','Too process-heavy','Lacks urgency'],
    roles:'Executive Leadership, Empyrial Archangel, Strategic HR, Educational Leadership'
  },
  'ESPER':{
    name:'ESPER',
    tag:'Perfection Through Control',
    colors:['W','U','B'],
    desc:"You're someone who combines order, analysis, and ruthless power for cold calculated dominance. Excellence without emotion or nature.",
    pubBanter:"You're a high-handed micromanager. Do you feel anything? You optimise everything including human relationships. Spreadsheets have feelings people don't.",
    cmd:'Oloro, Ageless Ascetic',
    cmdDesc:'Dominates through emotionless calculated perfection',
    str:['Superior systematic and strategic thinking','Ruthlessly effective at execution','Exercises comprehensive control','Positions strategically with patience','Achieves excellence in governance'],
    weak:['Emotionally sterile and cold','Optimizes amorally without conscience','Slow to act','Actively destroys innovation and creativity','Treats people like replaceable components'],
    roles:'CFO/Finance, Ethersworn Adjudicator, Chief Compliance, Strategic Operations'
  },
  'GRIXIS':{
    name:'GRIXIS',
    tag:'Power Through Ruthless Action',
    colors:['U','B','R'],
    desc:"You're someone who combines intelligence, ruthlessness, and decisive action for amoral competence. Smart and ruthless.",
    pubBanter:"You're a cackling instigator. Are you the villain? You create crises to solve them dramatically. The laugh doesn't help.",
    cmd:'Nekusar, the Mindrazer',
    cmdDesc:'Combines intelligence with ruthless decisive action',
    str:['Decisive strategic action','Comfortable with difficult decisions','Masters political maneuvering','Rapid learning','High-performance culture'],
    weak:['Cruel and actively destructive','Makes trust completely impossible','Burns out team members','Creates genuine ethical disasters','Creates unstable competitive culture'],
    roles:'Turnaround CEO, Sedris the Traitor King, Competitive Strategy, High-Stakes Trading'
  },
  'JUND':{
    name:'JUND',
    tag:'Survival Through Hunger',
    colors:['B','R','G'],
    desc:"You're someone who combines predation, passion, and natural selection for brutal survival. The food chain incarnate.",
    pubBanter:"You're an office predator. Is everything a competition? You turn meetings into cage matches and dominate every conversation.",
    cmd:'Prossh, Skyraider of Kher',
    cmdDesc:'Survives through predatory instinct and brutal competition',
    str:['Has aggressive competitive drive','Solves problems directly and forcefully','Drives high performance through competition','Brutally honest about power dynamics','Has strong survivor mentality'],
    weak:['Brutal and actively exploitative','Creates zero sustainability','Practices actual social Darwinism','Completely lacks sophistication','Creates genuinely toxic competitive culture'],
    roles:'Aggressive Sales, Karrthus Tyrant of Jund, Competitive Industries, Startups, Sports, PE'
  },
  'NAYA':{
    name:'NAYA',
    tag:'Power Through Community',
    colors:['R','G','W'],
    desc:"You're someone who combines passion, strength, and community for exuberant collective power. Big hearts, big ideas.",
    pubBanter:"You're an overenthusiastic steamroller. Why does every task need to be an EPIC ADVENTURE? We just needed to update a spreadsheet.",
    cmd:'Samut, Voice of Dissent',
    cmdDesc:'Builds exuberant collective power through passionate community',
    str:['Provides inspiring genuine leadership','Creates high-energy enthusiastic teams','Builds strong vibrant communities','Launches bold ambitious initiatives','Engages with authentic real passion'],
    weak:['Exhausting enthusiasm','Lacks subtlety','Can be naive','Overwhelming','Ignores details'],
    roles:'Startups, Marketing, Atla Palani Nest Tender, Sales, Event Planning, Community Building'
  },
  'ABZAN':{
    name:'ABZAN',
    tag:'Endurance Through Tradition',
    colors:['W','B','G'],
    desc:"You're someone who combines community, pragmatism, and patience for lasting institutions. Traditional power that endures.",
    pubBanter:"You're an immovable curmudgeon. You block every new idea with We've always done it this way. Also you definitely keep a ledger of favours.",
    cmd:'Anafenza, the Foremost',
    cmdDesc:'Endures through traditional power structures and pragmatic loyalty',
    str:['Builds long-term lasting institutions','Politically resilient and savvy','Practices sustainable pragmatism','Creates loyal deep relationships','Has strong survivor mentality'],
    weak:['Resists necessary changes','Can be actively exploitative','Dangerously slow to innovate anything','Holds grudges forever','Creates Byzantine political games'],
    roles:'Family Businesses, Ghave Guru of Spores, Legal, Traditional Industries, Politics'
  },
  'JESKAI':{
    name:'JESKAI',
    tag:'Excellence Through Discipline',
    colors:['U','R','W'],
    desc:"You're someone who combines knowledge, passion, and order for disciplined excellence. Mastery through practice.",
    pubBanter:"You're a pretentious prodigy. Everything we do is basic apparently. You roll your eyes at our approach constantly. Very smug.",
    cmd:'Narset, Enlightened Master',
    cmdDesc:'Achieves disciplined excellence through practiced mastery',
    str:['Achieves balanced multi-faceted excellence','Masters technical details completely','Thinks strategically','Inspires others through personal example','Executes adaptively and flexibly'],
    weak:['Arrogant about their skill level','Dismissive of basics and fundamentals','Can be genuinely elitist','Perfectionist to an unhealthy degree','Impatient and dismissive with novices'],
    roles:'Consulting, Narset Enlightened Master, Teaching, Professional Services, Strategy'
  },
  'SULTAI':{
    name:'SULTAI',
    tag:'Growth Through Exploitation',
    colors:['B','G','U'],
    desc:"You're someone who combines ruthlessness, patience, and intelligence for patient empire-building. You cultivate power.",
    pubBanter:"You're a slimy empire-builder. You co-opt everyone's work as fertilizer for your success. Very friendly about it though. Very slimy.",
    cmd:'Sidisi, Brood Tyrant',
    cmdDesc:'Cultivates empire through patient intelligent exploitation',
    str:['Builds strategic empires methodically','Positions patiently for advantage','Masters resource extraction and use','Navigates politics expertly','Thinks long-term instinctively'],
    weak:['Has parasitic exploitative tendencies','Makes trust completely impossible','Morally dubious at best','Slow to act','Alienates people'],
    roles:'Private Equity, VC, Leovold Emissary of Trest, Corporate Development, Real Estate'
  },
  'MARDU':{
    name:'MARDU',
    tag:'Victory Through Sacrifice',
    colors:['R','W','B'],
    desc:"You're someone who combines passion, order, and ruthlessness for relentless execution. Glory through any means.",
    pubBanter:"You're a tyrannical taskmaster. Every deadline is life or death. You glorify burnout and will flip tables to make us move faster.",
    cmd:'Queen Marchesa',
    cmdDesc:'Achieves victory through passionate sacrifice and ruthless will',
    str:['Executes decisions decisively','Performs well under high pressure','Masters political warfare','Gets results at any cost','Inspires people under fire'],
    weak:['Burns out team members','Glorifies unhealthy sacrifice','Believes ends justify means','Exhausting to work with','Leaves casualties behind'],
    roles:'Turnarounds, Queen Marchesa, Crisis Management, Sales, Competitive Markets'
  },
  'TEMUR':{
    name:'TEMUR',
    tag:'Power Through Adaptation',
    colors:['G','U','R'],
    desc:"You're someone who combines strength, intelligence, and passion for adaptive innovation. Wild creativity.",
    pubBanter:"You're an erratic adrenaline junkie. The pivot whiplash is real. We're just constantly adapting to whatever idea pounced out this week.",
    cmd:'Surrak Dragonclaw',
    cmdDesc:"Cannot be countered, creatures cannot be countered, flash‚Äîunstoppable force",
    str:['Innovates adaptively in any situation','Solves problems creatively','Brings consistently high energy','Thrives in genuinely chaotic environments','Experiments boldly and fearlessly'],
    weak:['Executes chaotically and unpredictably','Creates exhausting constant pivots','Terrible at planning ahead','Completely unpredictable and unstable','Genuinely hard to work with'],
    roles:'Startups, Surrak Dragonclaw, Innovation, R&D, Creative Industries'
  },
  'WITCH':{
    name:'FOUR-COLOR (No Red)',
    tag:'Perfection Without Passion',
    colors:['W','U','B','G'],
    desc:"You're someone who combines order, knowledge, ambition, and growth without passion. Patient calculated excellence.",
    pubBanter:"You're an emotionless overlord running things like a spreadsheet simulation. You dismiss any passionate idea as inefficient. Joyless.",
    cmd:"Atraxa, Praetors' Voice",
    cmdDesc:'Pursues perfection through emotionless calculated patience',
    str:['Thinks comprehensively and strategically','Executes with genuine patience','Achieves systematic excellence','Grows things sustainably over time','Masters political maneuvering'],
    weak:['Emotionally sterile and cold','Lacks urgency','Joyless','Dismisses passion','Slow to act'],
    roles:'Operations, Atraxa Praetors Voice, Finance, Strategy, Long-term Planning'
  },
  'YORE':{
    name:'FOUR-COLOR (No Green)',
    tag:'Innovation Without Nature',
    colors:['W','U','B','R'],
    desc:"You're someone who combines order, knowledge, ambition, and passion without patience. Artificial perfection.",
    pubBanter:"You're an over-engineering fanatic. Simple solution? Nope. Needs seventeen moving parts that will require emergency fixes in two weeks.",
    cmd:'Breya, Etherium Shaper',
    cmdDesc:'Innovates through artificial systems and passionate disruption',
    str:['Achieves genuine breakthrough innovation','Builds and manages complex systems','Thinks strategically','Executes with genuine passion','Optimizes through artificial systems'],
    weak:['Over-engineers literally everything','Reflexively rejects simple solutions','Maintains completely unsustainable pace','Completely lacks patience for anything','Adds complexity purely for its own sake'],
    roles:'Tech Startups, Breya Etherium Shaper, Engineering, R&D, Disruption'
  },
  'GLINT':{
    name:'FOUR-COLOR (No White)',
    tag:'Power Without Morality',
    colors:['U','B','R','G'],
    desc:"You're someone who combines knowledge, ambition, passion, and growth without morality. Amoral excellence.",
    pubBanter:"You're an unmanageable rebel. Rules are for suckers apparently. You hijack projects for fun and leave smoking wreckage everywhere.",
    cmd:'Yidris, Maelstrom Wielder',
    cmdDesc:'Pursues power without moral constraint or accountability',
    str:['Innovates without any constraints','Executes rapidly and decisively','Adapts naturally to changing conditions','Politically savvy and strategic','Has absolutely no sacred cows'],
    weak:['Completely amoral in practice','Completely unreliable and unaccountable','Creates chaos everywhere','Alienates entire teams systematically','Has zero accountability to anyone'],
    roles:'Disruption, Yidris Maelstrom Wielder, Competitive Industries, High-Risk Ventures'
  },
  'DUNE':{
    name:'FOUR-COLOR (No Blue)',
    tag:'Action Without Analysis',
    colors:['W','B','R','G'],
    desc:"You're someone who combines order, ambition, passion, and growth without analysis. Instinctive execution.",
    pubBanter:"You're a bullheaded action hero. Planning? Never. Already yelling NO TIME NEXT while we're picking up pieces from the last impulse decision.",
    cmd:'Saskia the Unyielding',
    cmdDesc:'Executes through gut instinct without analysis or hesitation',
    str:['Takes decisive action','Instinctive execution','Brings consistently high energy','Builds strong vibrant communities','No overthinking'],
    weak:['Anti-intellectual by default','Terrible at planning ahead','Reckless in every execution','Completely dismisses all analysis','Leaves wreckage everywhere they go'],
    roles:'Sales, Saskia the Unyielding, Operations, Crisis Response, Military'
  },
  'INK':{
    name:'FOUR-COLOR (No Black)',
    tag:'Altruism Without Pragmatism',
    colors:['W','U','R','G'],
    desc:"You're someone who combines order, knowledge, passion, and growth without self-interest. Pure altruism.",
    pubBanter:"You're a chaotic do-gooder. Trying to help everyone at once. It's a circus. Unintended confetti explosions. So chaotic.",
    cmd:'Kynaios and Tiro of Meletis',
    cmdDesc:'Pursues altruism without pragmatism or self-interest',
    str:['Inspiring idealism','Thinks strategically','Brings energizing disruptive presence','Community focus','Solves problems creatively'],
    weak:['Dangerously naive about self-interest','Can be easily exploited','Executes chaotically and unpredictably','Too trusting of literally everyone','Completely lacks competitive edge'],
    roles:'Nonprofits, Kynaios and Tiro of Meletis, Education, Community Building, Social Enterprise'
  },
  'WUBRG':{
    name:'FIVE-COLOR',
    tag:'Chaos or Mastery',
    colors:['W','U','B','R','G'],
    desc:"You're someone who has access to everything‚Äîall strategies, all tools, all philosophies. Renaissance person or unfocused generalist.",
    pubBanter:"You're an overambitious jack-of-all-trades. Kitchen sink into every project. Taking bets on which spinning plate crashes first.",
    cmd:'Kenrith, the Returned King',
    cmdDesc:'Accesses every strategy and tool, either mastery or scattered chaos',
    str:['Has ultimate versatility and flexibility','Thinks adaptively about everything','Has comprehensive broad perspective','Works effectively with anyone','Has genuinely no blind spots'],
    weak:['Lacks focus completely','Master of absolutely none','Highly context-dependent in identity','Hard to pin down identity','May be genuinely scattered'],
    roles:'Consulting, General Tazri, Generalist Leadership, Facilitation, Portfolio Management'
  }
};

// ============================================================================
// ============================================================================
// ENHANCEMENT: Morphing Progress Bar
// ============================================================================
function updateProgressGradient() {
  if (state.stage !== 1 || state.qNum === 0) return 'linear-gradient(90deg, #FDE047 0% 20%, #93C5FD 20% 40%, #D1D5DB 40% 60%, #FCA5A5 60% 80%, #6EE7B7 80% 100%)';
  
  // Calculate current activation using pairwise scores
  const activation = {
    W: ((state.pairwise['W-B']?.W || 0) / 6 + (state.pairwise['W-R']?.W || 0) / 6) / 2,
    U: ((state.pairwise['U-R']?.U || 0) / 6 + (state.pairwise['G-U']?.U || 0) / 6) / 2,
    B: ((state.pairwise['W-B']?.B || 0) / 6 + (state.pairwise['B-G']?.B || 0) / 6) / 2,
    R: ((state.pairwise['U-R']?.R || 0) / 6 + (state.pairwise['W-R']?.R || 0) / 6) / 2,
    G: ((state.pairwise['G-U']?.G || 0) / 6 + (state.pairwise['B-G']?.G || 0) / 6) / 2
  };
  
  // Normalize to percentages
  const total = Object.values(activation).reduce((sum, val) => sum + val, 0);
  if (total === 0) return 'linear-gradient(90deg, #FDE047 0% 20%, #93C5FD 20% 40%, #D1D5DB 40% 60%, #FCA5A5 60% 80%, #6EE7B7 80% 100%)';
  
  const pcts = {
    W: (activation.W / total) * 100,
    U: (activation.U / total) * 100,
    B: (activation.B / total) * 100,
    R: (activation.R / total) * 100,
    G: (activation.G / total) * 100
  };
  
  // Create gradient based on percentages (W=yellow, U=blue, B=gray, R=red, G=green)
  const colors = [
    { color: '#FDE047', pct: pcts.W },  // Yellow for White
    { color: '#93C5FD', pct: pcts.U },  // Blue for Blue
    { color: '#D1D5DB', pct: pcts.B },  // Gray for Black
    { color: '#FCA5A5', pct: pcts.R },  // Red for Red
    { color: '#6EE7B7', pct: pcts.G }   // Green for Green
  ];
  
  // Build gradient stops
  let position = 0;
  const stops = [];
  colors.forEach((c, i) => {
    stops.push(`${c.color} ${position.toFixed(1)}%`);
    position += c.pct;
    stops.push(`${c.color} ${position.toFixed(1)}%`);
  });
  
  return `linear-gradient(90deg, ${stops.join(', ')})`;
}

// STATE & INITIALIZATION
// ============================================================================
let state = {
  stage: 1,
  qNum: 0,
  qTot: 30,
  mode: 'draft', // 'constructed' or 'draft'
  responses: [],
  colorScores: {W:0, U:0, B:0, R:0, G:0},
  pairwise: {
    'W-B': {W:0, B:0},
    'U-R': {U:0, R:0},
    'G-U': {G:0, U:0},
    'W-R': {W:0, R:0},
    'B-G': {B:0, G:0}
  },
  poolA: [],
  poolS2: [],
  s2Track: {appear: {}, select: {}},
  activationSorted: [],
  result: null,
  candidates: null,
  originalResult: null
};

function shuffleArray(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

// Easter egg confetti for when someone breaks the assessment
function createConfetti() {
  const colors = ['#FDE047', '#93C5FD', '#D1D5DB', '#FCA5A5', '#6EE7B7', '#a78bfa', '#f472b6'];
  const confettiCount = 150;
  
  for (let i = 0; i < confettiCount; i++) {
    setTimeout(() => {
      const confetti = document.createElement('div');
      confetti.style.cssText = `
        position: fixed;
        width: ${Math.random() * 10 + 5}px;
        height: ${Math.random() * 10 + 5}px;
        background: ${colors[Math.floor(Math.random() * colors.length)]};
        left: ${Math.random() * 100}vw;
        top: -20px;
        border-radius: ${Math.random() > 0.5 ? '50%' : '2px'};
        pointer-events: none;
        z-index: 9999;
        animation: confettiFall ${Math.random() * 3 + 2}s linear forwards;
        transform: rotate(${Math.random() * 360}deg);
      `;
      document.body.appendChild(confetti);
      
      // Remove after animation
      setTimeout(() => confetti.remove(), 5000);
    }, i * 20);
  }
  
  // Add the animation if it doesn't exist
  if (!document.getElementById('confetti-style')) {
    const style = document.createElement('style');
    style.id = 'confetti-style';
    style.textContent = `
      @keyframes confettiFall {
        0% { transform: translateY(0) rotate(0deg); opacity: 1; }
        100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
      }
    `;
    document.head.appendChild(style);
  }
}

function initArchetypeOfMonth() {
  // Set random tagline
  const taglineEl = document.getElementById('random-tagline');
  if (taglineEl) {
    taglineEl.textContent = RANDOM_TAGLINES[Math.floor(Math.random() * RANDOM_TAGLINES.length)];
  }
  
  const container = document.getElementById('archetype-of-month');
  
  const archetype = ARCHETYPE_EXAMPLES[Math.floor(Math.random() * ARCHETYPE_EXAMPLES.length)];
  
  const name1 = getRandomName();
  let name2 = getRandomName();
  while (name2 === name1) {
    name2 = getRandomName();
  }
  
  let symbolsHTML = '<div style="display: flex; justify-content: center; gap: 8px; margin: 20px 0;">';
  archetype.colors.forEach(c => {
    symbolsHTML += `<span class="mana-symbol mana-${c}" style="width: 48px; height: 48px; font-size: 24px;">${c}</span>`;
  });
  symbolsHTML += '</div>';
  
  // Randomize which quote appears on left vs right
  const normalFirst = Math.random() < 0.5;
  
  const normalQuote = `
    <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 10px; text-align: left;">
      <p style="font-size: 15px; line-height: 1.7; color: #d0d0d0; font-style: italic;">
        "${archetype.normal}"
      </p>
      <div style="text-align: right; margin-top: 8px; font-size: 13px; color: #a0a0b0;">‚Äî ${name1}</div>
    </div>
  `;
  
  const banterQuote = `
    <div style="background: rgba(245, 158, 11, 0.08); padding: 20px; border-radius: 10px; text-align: left;">
      <p style="font-size: 15px; line-height: 1.7; color: #d0a070; font-style: italic;">
        "${archetype.banter}"
      </p>
      <div style="text-align: right; margin-top: 8px; font-size: 13px; color: #d0a070;">‚Äî ${name2}</div>
    </div>
  `;
  
  container.innerHTML = `
    <div style="text-align: center; margin-bottom: 16px;">
      <div style="font-size: 14px; font-weight: 700; color: #a78bfa; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 16px;">üèÜ Employee of the Month üèÜ</div>
      <h3 style="font-size: 32px; font-weight: 800; margin-bottom: 12px; color: #e0e0e0;">${archetype.name}</h3>
      ${symbolsHTML}
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
      ${normalFirst ? normalQuote + banterQuote : banterQuote + normalQuote}
    </div>
  `;
}

// Initialize on load
window.addEventListener('DOMContentLoaded', function() {
  console.log('DOMContentLoaded fired');
  
  // Check for debug URL parameter
  const showDebug = window.location.search.includes('debug=1');
  if (showDebug) {
    const debugBtn = document.getElementById('debug-toggle-btn');
    if (debugBtn) debugBtn.style.display = 'inline-block';
    console.log('Debug mode enabled via URL parameter');
  }
  
  try {
    initArchetypeOfMonth();
    console.log('initArchetypeOfMonth completed successfully');
  } catch(e) {
    console.error('Error in initArchetypeOfMonth:', e);
    // Continue anyway so rest of page works
  }
});

console.log('Script file loaded successfully');

// ============================================================================
// MODE SELECTION
// ============================================================================
function selectMode(mode) {
  state.mode = mode;
  
  // Update visual selection
  const constructedCard = document.getElementById('mode-constructed');
  const draftCard = document.getElementById('mode-draft');
  const constructedCheck = document.getElementById('constructed-check');
  const draftCheck = document.getElementById('draft-check');
  const debugBtn = document.getElementById('debug-toggle-btn');
  
  if (mode === 'constructed') {
    constructedCard.style.border = '2px solid rgba(139, 92, 246, 0.8)';
    constructedCard.style.background = 'rgba(139, 92, 246, 0.15)';
    draftCard.style.border = '2px solid rgba(139, 92, 246, 0.3)';
    draftCard.style.background = 'rgba(255,255,255,0.05)';
    constructedCheck.style.display = 'flex';
    draftCheck.style.display = 'none';
    // Show debug button in constructed mode
    if (debugBtn) debugBtn.style.display = 'inline-block';
  } else {
    draftCard.style.border = '2px solid rgba(139, 92, 246, 0.8)';
    draftCard.style.background = 'rgba(139, 92, 246, 0.15)';
    constructedCard.style.border = '2px solid rgba(139, 92, 246, 0.3)';
    constructedCard.style.background = 'rgba(255,255,255,0.05)';
    draftCheck.style.display = 'flex';
    constructedCheck.style.display = 'none';
    // Hide debug button in draft mode UNLESS URL param override is set
    const debugUrlOverride = window.location.search.includes('debug=1');
    if (debugBtn && !debugUrlOverride) {
      debugBtn.style.display = 'none';
      // Also hide debug section if it was open
      const debugSection = document.getElementById('debug-section');
      if (debugSection) debugSection.style.display = 'none';
    }
  }
}

function startAssessment() {
  console.log('startAssessment called');
  console.log('POOL_A length:', POOL_A.length);
  
  // Select exactly 6 questions per enemy pair to ensure balanced scoring
  const enemyPairs = ['W-B', 'U-R', 'G-U', 'W-R', 'B-G'];
  const selectedQuestions = [];
  
  enemyPairs.forEach(pair => {
    const pairQuestions = POOL_A.filter(q => q.pair === pair);
    const shuffled = shuffleArray(pairQuestions);
    selectedQuestions.push(...shuffled.slice(0, 6));
  });
  
  // Shuffle the final selection
  state.poolA = shuffleArray(selectedQuestions);
  console.log('state.poolA selected and shuffled, length:', state.poolA.length);
  
  document.getElementById('screen-welcome').classList.add('hidden');
  document.getElementById('screen-assessment').classList.remove('hidden');
  
  // Hide header mana symbols in draft mode to prevent demand characteristics
  const headerSymbols = document.getElementById('header-mana-symbols');
  if (headerSymbols && state.mode === 'draft') {
    headerSymbols.style.display = 'none';
  }
  
  updateHeaderRoundIndicator(1);
  console.log('Screens toggled, calling showQ');
  showQ();
}

let debug = false;
function toggleDebug() {
  debug = !debug;
  const debugSection = document.getElementById('debug-section');
  if (debug) {
    debugSection.style.display = 'block';
    updateDebug();
  } else {
    debugSection.style.display = 'none';
  }
}

function updateDebug() {
  const debugSection = document.getElementById('debug-section');
  const debugContent = document.getElementById('debug-content');
  
  if (!debug) return;
  if (debugSection.style.display === 'none') return;
  
  let html = '';
  
  if (state.stage === 1) {
    html += '<div style="margin-bottom: 16px;"><strong style="color: #a78bfa;">ROUND 1: ENEMY PAIR TESTING</strong></div>';
    html += `<div style="margin-bottom: 12px; padding: 12px; background: rgba(139, 92, 246, 0.1); border-radius: 8px;">`;
    html += `<strong>Questions:</strong> ${state.qNum}/30<br>`;
    html += `<strong>Goal:</strong> Test enemy pairs to establish relative color ordering`;
    html += `</div>`;
    
    // Color Scores with visual bars
    html += '<div style="margin-top: 12px;"><strong>Color Scores (out of 12):</strong></div>';
    const colorScoresSorted = Object.entries(state.colorScores).sort((a,b) => b[1] - a[1]);
    colorScoresSorted.forEach(([c, s]) => {
      const pct = Math.round(s/12*100);
      const barColor = {W:'#FDE047', U:'#93C5FD', B:'#D1D5DB', R:'#FCA5A5', G:'#6EE7B7'}[c];
      html += `<div style="margin: 8px 0;">`;
      html += `<div style="display: flex; justify-content: space-between; margin-bottom: 4px;">`;
      html += `<span><strong>${c}</strong>: ${s}/12</span>`;
      html += `<span style="color: ${barColor};">${pct}%</span>`;
      html += `</div>`;
      html += `<div style="background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px;">`;
      html += `<div style="background: ${barColor}; width: ${pct}%; height: 100%; border-radius: 4px;"></div>`;
      html += `</div>`;
      html += `</div>`;
    });
    
    // Pairwise battles
    html += '<div style="margin-top: 16px;"><strong>Enemy Pair Battles:</strong></div>';
    html += '<div style="font-size: 12px; color: #a0a0b0; margin-bottom: 8px;">Testing which color wins in direct conflict</div>';
    Object.entries(state.pairwise).forEach(([pair, scores]) => {
      const [c1, c2] = pair.split('-');
      const c1Score = scores[c1];
      const c2Score = scores[c2];
      const c1Pct = Math.round((c1Score/6)*100);
      const c2Pct = Math.round((c2Score/6)*100);
      const winner = c1Score > c2Score ? c1 : c2Score > c1Score ? c2 : 'TIE';
      const winnerColor = winner === c1 ? '#10B981' : winner === c2 ? '#EF4444' : '#808090';
      html += `<div style="margin: 6px 0; padding: 8px; background: rgba(255,255,255,0.03); border-radius: 6px;">`;
      html += `<div style="font-weight: 600; color: ${winnerColor};">${pair}: ${c1}(${c1Score}) vs ${c2}(${c2Score}) ‚Üí ${winner}</div>`;
      html += `</div>`;
    });
    
    if (state.qNum >= 12) {
      html += '<div style="margin-top: 16px; padding: 12px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px;">';
      html += '<strong style="color: #10B981;">üéØ ACTIVATION STRENGTH (Predicted Colors):</strong><br>';
      html += '<div style="font-size: 12px; color: #a0a0b0; margin: 8px 0;">Combined from enemy pair wins</div>';
      const act = {
        W: (state.pairwise['W-B'].W / 6 + state.pairwise['W-R'].W / 6) / 2,
        U: (state.pairwise['U-R'].U / 6 + state.pairwise['G-U'].U / 6) / 2,
        B: (state.pairwise['W-B'].B / 6 + state.pairwise['B-G'].B / 6) / 2,
        R: (state.pairwise['U-R'].R / 6 + state.pairwise['W-R'].R / 6) / 2,
        G: (state.pairwise['G-U'].G / 6 + state.pairwise['B-G'].G / 6) / 2
      };
      const actSorted = Object.entries(act).sort((a,b) => b[1] - a[1]);
      
      // Show prediction
      const top = actSorted.slice(0, 3);
      const gaps = [];
      for (let i = 0; i < actSorted.length - 1; i++) {
        gaps.push({idx: i, gap: actSorted[i][1] - actSorted[i+1][1]});
      }
      gaps.sort((a,b) => b.gap - a.gap);
      const biggestGap = gaps[0];
      
      let prediction = '';
      if (biggestGap.gap > 0.25) {
        const numTop = biggestGap.idx + 1;
        const topColors = actSorted.slice(0, numTop).map(c => c[0]).join('');
        if (numTop === 1) prediction = `Predicting: MONO-${topColors}`;
        else if (numTop === 2) prediction = `Predicting: 2-color guild with ${topColors}`;
        else if (numTop === 3) prediction = `Predicting: 3-color with ${topColors}`;
        else if (numTop === 4) prediction = `Predicting: 4-color (missing ${actSorted[4][0]})`;
        else prediction = `Predicting: 5-color (all balanced)`;
      } else {
        prediction = `Close scores - need more questions`;
      }
      
      
      html += `<div style="font-weight: 700; color: #10B981; margin-bottom: 8px;">${prediction}</div>`;
      
      actSorted.forEach(([c, a], idx) => {
        const pct = Math.round(a*100);
        const isTop = idx <= biggestGap.idx;
        const color = isTop ? '#10B981' : '#808090';
        html += `<div style="color: ${color}; margin: 4px 0;">${idx + 1}. ${c}: ${pct}% activated</div>`;
      });
      html += '</div>';
    }
  }
  
  if (state.stage === 'calibration') {
    html += '<div style="margin-bottom: 16px;"><strong style="color: #F59E0B;">ROUND 2: ALLY PAIR CALIBRATION</strong></div>';
    html += `<div style="margin-bottom: 12px; padding: 12px; background: rgba(245, 158, 11, 0.1); border-radius: 8px;">`;
    html += `<strong>Questions:</strong> ${state.qNum}/${state.calibrationQuestions?.length || 0}<br>`;
    html += `<strong>Goal:</strong> Validate Round 1 by testing ally pairs (never tested in Round 1)`;
    html += `</div>`;
    
    // Show Round 1 summary first
    if (state.activationSorted && state.activationSorted.length > 0) {
      html += '<div style="margin-bottom: 16px; padding: 12px; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px;">';
      html += '<strong style="color: #a78bfa;">üìä Round 1 Results:</strong><br>';
      html += '<div style="font-size: 12px; color: #c0c0d0; margin-top: 8px;">';
      state.activationSorted.forEach(([c, v]) => {
        const pct = Math.round(v * 100);
        html += `${c}: ${pct}% `;
      });
      html += '</div></div>';
    }
    
    // Show why we're testing these pairs
    if (state.calibrationQuestions && state.qNum < state.calibrationQuestions.length) {
      const currentQ = state.calibrationQuestions[state.qNum];
      html += '<div style="margin-top: 12px; padding: 12px; background: rgba(245, 158, 11, 0.15); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 8px;">';
      html += `<strong style="color: #F59E0B;">Current Test:</strong> ${currentQ.pair}<br>`;
      html += `<strong>Type:</strong> ${currentQ.calibrationType}<br>`;
      html += `<div style="font-size: 12px; color: #c0c0d0; margin-top: 8px;">${currentQ.calibrationReason}</div>`;
      html += '</div>';
    }
    
    // Show ally pair results so far
    if (state.calibrationPairwise) {
      html += '<div style="margin-top: 16px;"><strong>Ally Pair Results:</strong></div>';
      html += '<div style="font-size: 12px; color: #a0a0b0; margin-bottom: 8px;">Testing pairs Round 1 never tested</div>';
      
      Object.entries(state.calibrationPairwise).forEach(([pair, scores]) => {
        const [c1, c2] = pair.split('-');
        const c1Score = scores[c1];
        const c2Score = scores[c2];
        const total = c1Score + c2Score;
        
        if (total > 0) {
          const winner = c1Score > c2Score ? c1 : c2Score > c1Score ? c2 : 'TIE';
          const winnerColor = winner === c1 ? '#10B981' : winner === c2 ? '#EF4444' : '#808090';
          html += `<div style="margin: 6px 0; padding: 8px; background: rgba(255,255,255,0.03); border-radius: 6px;">`;
          html += `<div style="font-weight: 600; color: ${winnerColor};">ALLY ${pair}: ${c1}(${c1Score}) vs ${c2}(${c2Score}) ‚Üí ${winner}</div>`;
          html += `</div>`;
        }
      });
    }
    
    // Show what we're trying to detect
    html += '<div style="margin-top: 16px; padding: 12px; background: rgba(139, 92, 246, 0.1); border-radius: 8px;">';
    html += '<strong style="color: #a78bfa;">Why Ally Pairs Matter:</strong>';
    html += '<div style="font-size: 12px; color: #c0c0d0; margin-top: 8px;">';
    html += '‚Ä¢ <strong>Suppression Detection:</strong> If W lost to B 6-0, is W at 0% or 49%?<br>';
    html += '‚Ä¢ <strong>Noise Detection:</strong> If U won its pairs, is U truly active or just noise?<br>';
    html += '‚Ä¢ <strong>Ally Tests:</strong> Testing W vs U (allies) reveals their relative ordering';
    html += '</div>';
    html += '</div>';
  }
  
  if (state.stage === 2 || state.stage === 3) {
    html += '<div style="margin-bottom: 16px;"><strong style="color: #a78bfa;">ROUND 3: FINAL DETERMINATION</strong></div>';
    
    // Tournament-specific debug info
    if (state.tournament) {
      const tournament = state.tournament;
      const matchup = tournament.currentMatchup;
      
      html += `<div style="margin-bottom: 12px; padding: 12px; background: rgba(139, 92, 246, 0.1); border-radius: 8px;">`;
      html += `<strong>Tournament:</strong> Question ${tournament.questionCount + 1}/${tournament.maxQuestions}<br>`;
      html += `<strong>Mode:</strong> Adaptive forced-choice`;
      html += `</div>`;
      
      // Current standings
      html += '<div style="margin-bottom: 16px;">';
      html += '<div style="color: #a78bfa; font-weight: 700; margin-bottom: 8px;">TOURNAMENT STANDINGS</div>';
      
      const sortedCandidates = [...tournament.candidates].sort((a, b) => {
        const aScore = a.wins - a.losses;
        const bScore = b.wins - b.losses;
        if (bScore !== aScore) return bScore - aScore;
        return b.combinedScore - a.combinedScore;
      });
      
      sortedCandidates.forEach((c, idx) => {
        const isLeader = idx === 0;
        const eliminated = c.losses >= 2;
        const color = eliminated ? '#EF4444' : (isLeader ? '#10B981' : '#d0d0d0');
        html += `<div style="color: ${color}; padding: 2px 0;">`;
        html += `${isLeader ? 'üëë ' : '   '}${c.id}: ${c.wins}W-${c.losses}L`;
        html += ` (R1+R2: ${Math.round(c.combinedScore*100)}%)`;
        if (eliminated) html += ' [ELIMINATED]';
        html += '</div>';
      });
      html += '</div>';
      
      // Current matchup
      if (matchup) {
        html += '<div style="margin-bottom: 16px;">';
        html += '<div style="color: #F59E0B; font-weight: 700; margin-bottom: 8px;">CURRENT MATCHUP</div>';
        html += `<div>${matchup.a.id} vs ${matchup.b.id}</div>`;
        html += `<div style="color: #808090;">Type: ${matchup.type}</div>`;
        html += '</div>';
      }
      
      // Match history
      if (tournament.matchHistory.length > 0) {
        html += '<div>';
        html += '<div style="color: #3B82F6; font-weight: 700; margin-bottom: 8px;">MATCH HISTORY</div>';
        tournament.matchHistory.forEach((m, i) => {
          html += `<div style="padding: 2px 0;">`;
          html += `Q${i+1}: ${m.winner.id} defeats ${m.loser.id} <span style="color: #808090;">(${m.type})</span>`;
          html += '</div>';
        });
        html += '</div>';
      }
    } else {
      // Legacy ranking debug
      html += `<div style="margin-bottom: 12px; padding: 12px; background: rgba(139, 92, 246, 0.1); border-radius: 8px;">`;
      html += `<strong>Questions:</strong> ${state.qNum}/${state.qTot}<br>`;
      html += `<strong>Goal:</strong> Confirm final identity from calibrated candidates`;
      html += `</div>`;
    }
    
    // Show Round 1 summary
    if (state.activationSorted && state.activationSorted.length > 0) {
      html += '<div style="margin-top: 12px; padding: 12px; background: rgba(139, 92, 246, 0.08); border: 1px solid rgba(139, 92, 246, 0.2); border-radius: 8px;">';
      html += '<strong style="color: #c4b5fd;">üìä Round 1 Results:</strong><br>';
      html += '<div style="font-size: 12px; color: #c0c0d0; margin-top: 8px;">';
      state.activationSorted.forEach(([c, v]) => {
        const pct = Math.round(v * 100);
        const barColor = {W:'#FDE047', U:'#93C5FD', B:'#D1D5DB', R:'#FCA5A5', G:'#6EE7B7'}[c];
        html += `<span style="color: ${barColor}; font-weight: 600;">${c}: ${pct}%</span> `;
      });
      html += '</div></div>';
    }
    
    // Show calibration results if available
    if (state.calibrationAnswers && state.calibrationAnswers.length > 0) {
      html += '<div style="margin-top: 12px; padding: 12px; background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 8px;">';
      html += '<strong style="color: #F59E0B;">üìä Round 2 Calibration Results:</strong><br>';
      html += '<div style="font-size: 12px; color: #c0c0d0; margin-top: 8px;">';
      if (state.calibrationPairwise) {
        Object.entries(state.calibrationPairwise).forEach(([pair, scores]) => {
          const [c1, c2] = pair.split('-');
          const total = scores[c1] + scores[c2];
          if (total > 0) {
            const winner = scores[c1] > scores[c2] ? c1 : scores[c2] > scores[c1] ? c2 : 'TIE';
            html += `${pair}: ${c1}(${scores[c1]}) vs ${c2}(${scores[c2]}) ‚Üí ${winner}<br>`;
          }
        });
      }
      html += '</div>';
      html += '</div>';
    }
    
    if (state.candidates) {
      html += '<div style="margin-top: 12px;"><strong>Testing These Candidates:</strong></div>';
      html += '<div style="font-size: 12px; color: #a0a0b0; margin-bottom: 8px;">Determining which colors are truly active</div>';
      state.candidates.forEach((cand, idx) => {
        const colors = PROFILES[cand.id]?.colors || [];
        const colorSymbols = colors.map(c => `<span style="color: ${{W:'#FDE047',U:'#93C5FD',B:'#D1D5DB',R:'#FCA5A5',G:'#6EE7B7'}[c]};font-weight:700;">${c}</span>`).join('');
        html += `<div style="margin: 6px 0; padding: 8px; background: rgba(139, 92, 246, ${idx === 0 ? 0.15 : 0.05}); border-radius: 6px;">`;
        html += `<strong>${idx + 1}. ${cand.id}</strong> [${colorSymbols}] (Round 1: ${Math.round(cand.s1*100)}%)`;
        html += `</div>`;
      });
    }
    
    // Show pattern preferences from Pool D
    if (state.s2Track.patternPref && Object.values(state.s2Track.patternPref).some(v => v > 0)) {
      html += '<div style="margin-top: 16px; padding: 12px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px;">';
      html += '<strong style="color: #10B981;">üìä Pattern Preference (Pool D):</strong><br>';
      html += '<div style="font-size: 12px; color: #a0a0b0; margin: 8px 0;">Which complexity level you gravitate to</div>';
      
      const total = (state.s2Track.patternPref.MONO || 0) + 
                    (state.s2Track.patternPref.GUILD || 0) + 
                    (state.s2Track.patternPref.THREE || 0);
      
      if (total > 0) {
        ['MONO', 'GUILD', 'THREE'].forEach(pattern => {
          const count = state.s2Track.patternPref[pattern] || 0;
          const pct = Math.round((count / total) * 100);
          const color = pct > 50 ? '#10B981' : '#808090';
          html += `<div style="color: ${color}; margin: 4px 0;">${pattern}: ${count}/${total} (${pct}%)</div>`;
        });
      }
      html += '</div>';
    }
    
    // Show color frequency in selections
    if (state.s2Track.colorFreq && Object.values(state.s2Track.colorFreq).some(v => v > 0)) {
      html += '<div style="margin-top: 16px;"><strong style="color: #a78bfa;">üé® Color Frequency in Your Selections:</strong></div>';
      html += '<div style="font-size: 12px; color: #a0a0b0; margin-bottom: 8px;">Which colors appear most in what you chose</div>';
      
      const sortedFreq = Object.entries(state.s2Track.colorFreq)
        .sort((a,b) => b[1] - a[1])
        .filter(([c, v]) => v > 0);
      
      sortedFreq.forEach(([color, freq]) => {
        const rate = state.qNum > 0 ? Math.round((freq / state.qNum) * 100) : 0;
        const barColor = {W:'#FDE047', U:'#93C5FD', B:'#D1D5DB', R:'#FCA5A5', G:'#6EE7B7'}[color];
        const isActive = rate >= 70;
        
        html += `<div style="margin: 8px 0;">`;
        html += `<div style="display: flex; justify-content: space-between; margin-bottom: 4px;">`;
        html += `<span><strong style="color: ${barColor};">${color}</strong>: ${freq}/${state.qNum} selections</span>`;
        html += `<span style="color: ${isActive ? '#10B981' : '#808090'}; font-weight: 600;">${rate}%${isActive ? ' ‚úì ACTIVE' : ''}</span>`;
        html += `</div>`;
        html += `<div style="background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px;">`;
        html += `<div style="background: ${barColor}; width: ${rate}%; height: 100%; border-radius: 4px;"></div>`;
        html += `</div>`;
        html += `</div>`;
      });
      
      // Show threshold line
      html += '<div style="margin-top: 8px; font-size: 12px; color: #10B981; font-style: italic;">Colors appearing in >70% of selections = ACTIVE</div>';
    }
    
    html += '<div style="margin-top: 16px;"><strong>Identity Selections:</strong></div>';
    html += '<div style="font-size: 12px; color: #a0a0b0; margin-bottom: 8px;">Which specific identities you chose</div>';
    const s2Sorted = Object.entries(state.s2Track.select).sort((a,b) => {
      const rateA = (state.s2Track.appear[a[0]] || 0) > 0 ? a[1] / state.s2Track.appear[a[0]] : 0;
      const rateB = (state.s2Track.appear[b[0]] || 0) > 0 ? b[1] / state.s2Track.appear[b[0]] : 0;
      return rateB - rateA;
    });
    
    if (s2Sorted.length > 0) {
      s2Sorted.forEach(([guild, count]) => {
        const appeared = state.s2Track.appear[guild] || 0;
        const rate = appeared > 0 ? Math.round((count/appeared)*100) : 0;
        const colors = PROFILES[guild]?.colors || [];
        const colorSymbols = colors.map(c => `<span style="color: ${{W:'#FDE047',U:'#93C5FD',B:'#D1D5DB',R:'#FCA5A5',G:'#6EE7B7'}[c]};font-weight:700;">${c}</span>`).join('');
        html += `<div style="margin: 6px 0; padding: 8px; background: rgba(255,255,255,0.03); border-radius: 6px;">`;
        html += `<div style="display: flex; justify-content: space-between;">`;
        html += `<span><strong>${guild}</strong> [${colorSymbols}]</span>`;
        html += `<span style="color: ${rate > 50 ? '#10B981' : '#808090'}; font-weight: 600;">${count}/${appeared} (${rate}%)</span>`;
        html += `</div>`;
        html += `</div>`;
      });
    } else {
      html += '<div style="color: #808090; font-style: italic;">No identity selections yet</div>';
    }
  }
  
  debugContent.innerHTML = html;
}

function showQ() {
  console.log('showQ called, stage:', state.stage, 'qNum:', state.qNum);
  const q = state.stage === 1 ? state.poolA[state.qNum] : state.poolS2[state.qNum];
  console.log('Question:', q);
  
  if (!q) {
    console.error('No question available at index', state.qNum);
    alert('Error: No question found. Check console.');
    return;
  }
  
  document.getElementById('q-num').textContent = state.qNum + 1;
  document.getElementById('q-tot').textContent = state.qTot;
  
  if (state.stage === 1) {
    document.getElementById('stage-label').textContent = 'Round 1: Enemy Pairs';
    const pct = Math.round((state.qNum / 30) * 100);
    const progBar = document.getElementById('prog-s1');
    const prog2Bar = document.getElementById('prog-s2');
    const prog3Bar = document.getElementById('prog-s3');
    
    progBar.style.width = pct + '%';
    progBar.style.opacity = '1';
    prog2Bar.style.width = '0%';
    prog2Bar.style.opacity = '0';
    if (prog3Bar) {
      prog3Bar.style.width = '0%';
      prog3Bar.style.opacity = '0';
    }
    
    // ENHANCEMENT: Apply morphing gradient and shimmer effect
    if (state.qNum > 0) {
      progBar.style.background = updateProgressGradient();
      if (!progBar.classList.contains('progress-shimmer')) {
        progBar.classList.add('progress-shimmer', 'progress-opalescent');
      }
    }
  } else if (state.stage === 3) {
    // Round 3 is now handled by tournament system - this shouldn't be called
    // but if it is, redirect to tournament question
    if (state.tournament) {
      showTournamentQuestion();
      return;
    }
    // Legacy fallback
    document.getElementById('stage-label').textContent = 'Round 3: Final Determination';
    return;
  } else {
    // Fallback for any other stage (shouldn't happen normally)
    document.getElementById('stage-label').textContent = 'Round 2';
    const prog1Bar = document.getElementById('prog-s1');
    const prog2Bar = document.getElementById('prog-s2');
    
    // Fade out Stage 1 bar, fade in Stage 2 bar
    prog1Bar.style.opacity = '0';
    prog2Bar.style.opacity = '1';
    prog2Bar.style.width = '0%';
    
    const pct = Math.round((state.qNum / state.qTot) * 100);
    setTimeout(() => {
      prog2Bar.style.width = pct + '%';
    }, 50);
    
    // STAGE 2: Show ranking interface
    document.getElementById('ctx').textContent = '';
    document.getElementById('scenario').textContent = q.context;
    document.getElementById('instr').innerHTML = '<strong>Rank these approaches</strong> from most like you to least like you.';
    document.getElementById('choices').innerHTML = buildRankingInterface(q);
    setTimeout(() => initRanking(), 100);
    return;
  }
  
  document.getElementById('ctx').textContent = q.ctx || 'Context';
  
  // Build scenario with mana symbols for Stage 1 (only in constructed mode)
  const scenarioText = q.sc || q.scenario || 'Scenario';
  
  // Get context hint (MTG, team, budget, etc.) - only show if scenario needs one
  const contextHint = getContextHint(scenarioText, q.id);
  const hintHTML = contextHint 
    ? `<div style="font-size: 13px; color: #a0a0b0; margin-top: 16px; font-style: italic; text-align: center; padding: 10px 16px; background: rgba(255,255,255,0.03); border-radius: 8px; line-height: 1.5;">
        üí° ${contextHint}
       </div>`
    : '';
  
  if (state.stage === 1 && q.pair && state.mode === 'constructed') {
    const pair = q.pair;
    const colors = pair.split('-');
    let symbolsHTML = '<div style="display: flex; gap: 8px; justify-content: center; margin: 16px 0;">';
    colors.forEach(c => {
      symbolsHTML += `<span class="mana-symbol mana-${c}" style="width: 32px; height: 32px; font-size: 16px;">${c}</span>`;
    });
    symbolsHTML += '</div>';
    
    document.getElementById('scenario').innerHTML = scenarioText + symbolsHTML + hintHTML;
  } else {
    document.getElementById('scenario').innerHTML = scenarioText + hintHTML;
  }
  
  document.getElementById('instr').innerHTML = 'Choose the response <strong>more like you</strong>.';

  // Track Stage 2 appearances (both guilds and Pool D patterns)
  if (state.stage === 2 && state.s2Track && q.r) {
    q.r.forEach(resp => {
      const guild = resp.g || resp.guild;
      if (guild) {
        state.s2Track.appear[guild] = (state.s2Track.appear[guild] || 0) + 1;
      }
      
      // Track pattern appearances for Pool D scenarios
      const pattern = resp.pattern;
      if (pattern) {
        if (!state.s2Track.patternAppear) {
          state.s2Track.patternAppear = {MONO: 0, GUILD: 0, THREE: 0};
        }
        state.s2Track.patternAppear[pattern]++;
      }
    });
  }
  
  const choicesDiv = document.getElementById('choices');
  choicesDiv.innerHTML = '';
  
  const shuffled = shuffleArray(q.r);
  shuffled.forEach(resp => {
    const btn = document.createElement('button');
    btn.className = 'choice-button';
    
    // Get color(s) for this response
    let symbolColors = [];
    if (state.stage === 1 && resp.c) {
      // Stage 1: Single color
      symbolColors = [resp.c];
    } else if (state.stage === 2 && resp.g) {
      // Stage 2: Use universal function to get colors (handles guild, three-color, four-color)
      symbolColors = getIdentityColors(resp.g);
    }
    
    // Add mana symbols and identity name (only in constructed mode)
    if (state.mode === 'constructed' && symbolColors.length > 0) {
      // Create a wrapper for symbols and name
      const symbolWrapper = document.createElement('div');
      symbolWrapper.style.cssText = 'display: flex; flex-direction: column; align-items: center; gap: 4px; margin-right: 12px;';
      
      // Symbols row
      const symbolRow = document.createElement('div');
      symbolRow.style.cssText = 'display: flex; gap: 4px;';
      symbolColors.forEach(color => {
        const symbolSpan = document.createElement('span');
        symbolSpan.className = `mana-symbol mana-${color}`;
        symbolSpan.style.cssText = 'width: 24px; height: 24px; font-size: 12px; flex-shrink: 0;';
        symbolSpan.textContent = color;
        symbolRow.appendChild(symbolSpan);
      });
      
      // Identity name label (only if guild/three/four/five)
      if (state.stage === 2 && resp.g) {
        const nameLabel = document.createElement('div');
        nameLabel.style.cssText = 'font-size: 10px; font-weight: 700; color: #a78bfa; text-transform: uppercase; letter-spacing: 0.5px;';
        nameLabel.textContent = resp.g;
        symbolWrapper.appendChild(symbolRow);
        symbolWrapper.appendChild(nameLabel);
      } else {
        symbolWrapper.appendChild(symbolRow);
      }
      
      btn.appendChild(symbolWrapper);
    }
    
    const contentDiv = document.createElement('div');
    contentDiv.style.cssText = 'flex: 1; text-align: left;';
    contentDiv.textContent = resp.t || resp.text;
    btn.appendChild(contentDiv);
    
    btn.onclick = () => answerQ(resp);
    choicesDiv.appendChild(btn);
  });
  
  // Add "Neither" option for Stage 1 (Round 1) only
  if (state.stage === 1) {
    const neitherBtn = document.createElement('button');
    neitherBtn.className = 'choice-button neither-button';
    neitherBtn.style.cssText = 'background: rgba(80, 80, 95, 0.08); border: 1px solid rgba(120, 120, 140, 0.25); color: #808090; font-size: 13px; margin-top: 16px; padding: 12px 20px;';
    neitherBtn.textContent = 'Neither feels like me';
    neitherBtn.onclick = () => answerNeither(q);
    choicesDiv.appendChild(neitherBtn);
  }
}

function answerQ(resp) {
  state.responses.push(resp);
  
  // Stage 1: Track color scores and pairwise
  if (state.stage === 1) {
    state.colorScores[resp.c]++;
    
    const q = state.poolA[state.qNum];
    const pair = q.pair;
    const color = resp.c;
    state.pairwise[pair][color]++;
  }
  
  // Stage 2: Track guild selections AND Pool D pattern selections
  if (state.stage === 2) {
    const guild = resp.g || resp.guild;
    const pattern = resp.pattern; // Pool D responses have pattern: 'MONO', 'GUILD', or 'THREE'
    let colors = resp.colors; // Pool D has explicit colors array
    
    // If no explicit colors but has guild ID, derive colors
    if (!colors && guild) {
      colors = getIdentityColors(guild);
    }
    
    if (guild) {
      state.s2Track.select[guild] = (state.s2Track.select[guild] || 0) + 1;
    }
    
    // Track pattern preferences (Pool D)
    if (pattern) {
      if (!state.s2Track.patternPref) {
        state.s2Track.patternPref = {MONO: 0, GUILD: 0, THREE: 0};
      }
      state.s2Track.patternPref[pattern]++;
      console.log(`Pattern selected: ${pattern} (total: ${state.s2Track.patternPref[pattern]})`);
    }
    
    // CRITICAL: Track color frequency in selections
    if (colors && Array.isArray(colors)) {
      if (!state.s2Track.colorFreq) {
        state.s2Track.colorFreq = {W: 0, U: 0, B: 0, R: 0, G: 0};
      }
      
      colors.forEach(color => {
        state.s2Track.colorFreq[color]++;
      });
      
      console.log(`Colors in selection: [${colors.join(',')}] - Updated freq:`, state.s2Track.colorFreq);
    }
    
    // Track color appearances in all options (for rate calculation)
    const q = state.poolS2[state.qNum];
    if (q && q.r) {
      q.r.forEach(option => {
        let optionColors = option.colors;
        // Derive from guild ID if not explicit
        if (!optionColors && (option.g || option.guild)) {
          optionColors = getIdentityColors(option.g || option.guild);
        }
        
        if (optionColors && Array.isArray(optionColors)) {
          if (!state.s2Track.colorAppear) {
            state.s2Track.colorAppear = {W: 0, U: 0, B: 0, R: 0, G: 0};
          }
          optionColors.forEach(color => {
            state.s2Track.colorAppear[color]++;
          });
        }
      });
    }
  }
  
  state.qNum++;
  
  
  // ENHANCEMENT: Update morphing progress bar
  if (state.stage === 1) {
    const progBar = document.getElementById('prog-s1');
    if (progBar) {
      progBar.style.background = updateProgressGradient();
      progBar.classList.add('progress-opalescent', 'progress-shimmer');
    }
  }
  updateDebug();
  
  if (state.qNum < state.qTot) {
    showQ();
  } else if (state.stage === 1) {
    finishS1();
  } else {
    finishS2();
  }
}

function answerNeither(q) {
  // Track that user selected "neither" for this question
  if (!state.neitherCount) state.neitherCount = 0;
  state.neitherCount++;
  
  // Track neither per pair
  if (!state.pairwiseNeither) {
    state.pairwiseNeither = {'W-B': 0, 'U-R': 0, 'B-G': 0, 'G-U': 0, 'W-R': 0};
  }
  const pair = q.pair;
  if (pair) {
    state.pairwiseNeither[pair]++;
    
    // Record as SKIP - neither color gets points
    // If neither resonates, we shouldn't inflate both colors
    // This maintains the pair relationship but doesn't add to either score
  }
  
  // Store a placeholder response
  state.responses.push({ c: 'NEITHER', pair: pair, text: 'Neither selected (skipped)' });
  
  console.log(`Neither selected for ${pair} (no points awarded). Total neithers: ${state.neitherCount}`);
  
  // Advance to next question
  state.qNum++;
  
  // Update progress bar
  if (state.stage === 1) {
    const progBar = document.getElementById('prog-s1');
    if (progBar) {
      progBar.style.background = updateProgressGradient();
      progBar.classList.add('progress-opalescent', 'progress-shimmer');
    }
  }
  updateDebug();
  
  if (state.qNum < state.qTot) {
    showQ();
  } else if (state.stage === 1) {
    finishS1();
  } else {
    finishS2();
  }
}

// ============================================================================
// ENHANCEMENT: Adaptive Assessment Helper Functions
// ============================================================================

function getCandidateType(id) {
  if (id.startsWith('MONO-')) return 'MONO';
  if (id === 'WUBRG') return 'FIVE';
  // Check if it's a guild (2 colors)
  const guildNames = ['AZORIUS','DIMIR','RAKDOS','GRUUL','SELESNYA','ORZHOV','IZZET','GOLGARI','SIMIC','BOROS'];
  if (guildNames.includes(id)) return 'GUILD';
  // Otherwise three-color or four-color
  if (PROFILES[id]?.colors?.length === 3) return 'THREE';
  if (PROFILES[id]?.colors?.length === 4) return 'FOUR';
  return 'UNKNOWN';
}

function determineClassificationType(candidates) {
  if (!candidates || candidates.length === 0) return 'UNKNOWN';
  const primaryType = getCandidateType(candidates[0].id);
  return primaryType;
}

function calculateRound1Confidence(activationSorted) {
  const colorNames = {W:'White', U:'Blue', B:'Black', R:'Red', G:'Green'};
  const pct = v => Math.round(v * 100);
  
  const [top, second, third, fourth] = activationSorted.slice(0, 4);
  
  // MONO confidence check: One color clearly dominant
  if (top[1] >= 0.75 && (top[1] - second[1]) >= 0.30) {
    const monoId = 'MONO-' + top[0].toUpperCase();
    return {
      type: 'MONO',
      identity: monoId,
      confidence: 0.90,
      needsRound2: false,
      message: `You clearly prefer ${colorNames[top[0]]} (${pct(top[1])}%) over other approaches‚Äîsignificantly higher than your next color (${pct(second[1])}%). This is a strong mono-color result.`
    };
  }
  
  // GUILD confidence check: Two colors clearly ahead
  if (top[1] >= 0.70 && second[1] >= 0.65 && (second[1] - third[1]) >= 0.25) {
    const guildId = getGuild([top[0], second[0]].sort().join(''));
    const guildProf = PROFILES[guildId];
    return {
      type: 'GUILD',
      identity: guildId,
      confidence: 0.85,
      needsRound2: false,
      message: `You clearly blend ${colorNames[top[0]]} (${pct(top[1])}%) and ${colorNames[second[0]]} (${pct(second[1])}%), both significantly higher than other colors. This indicates a clear ${guildProf?.name || guildId} identity.`
    };
  }
  
  // THREE-COLOR confidence check: Top 3 clustered with clear gap to 4th
  if (top[1] >= 0.65 && second[1] >= 0.60 && third[1] >= 0.55 && 
      (top[1] - third[1]) < 0.15 && (third[1] - fourth[1]) >= 0.20) {
    const threeId = getThree([top[0], second[0], third[0]].sort().join(''));
    const threeProf = PROFILES[threeId];
    return {
      type: 'THREE',
      identity: threeId,
      confidence: 0.80,
      needsRound2: false,
      message: `Your top three colors cluster together (${pct(top[1])}%, ${pct(second[1])}%, ${pct(third[1])}%) with a clear gap to your fourth (${pct(fourth[1])}%). This indicates a ${threeProf?.name || threeId} identity.`
    };
  }
  
  // NEEDS ROUND 2
  return {
    type: 'UNCLEAR',
    confidence: 0.60,
    needsRound2: true,
    message: null
  };
}

function showEarlyTerminationOffer(confidenceData) {
  // Store for later use
  window.earlyConfidenceData = confidenceData;
  
  document.getElementById('screen-interstitial').classList.add('hidden');
  document.getElementById('screen-early-offer').classList.remove('hidden');
  
  const prof = PROFILES[confidenceData.identity];
  
  // Set identity display
  document.getElementById('early-result-name').textContent = prof.name;
  document.getElementById('early-result-tag').textContent = prof.tag;
  
  // Update confidence badge to be more informational
  const confPct = Math.round(confidenceData.confidence * 100);
  const confText = confPct >= 85 ? 'Strong Signal' : confPct >= 70 ? 'Good Signal' : 'Emerging Pattern';
  document.getElementById('early-confidence').textContent = confText;
  document.getElementById('early-confidence').className = `confidence-badge confidence-${confPct >= 85 ? 'HIGH' : confPct >= 70 ? 'MODERATE' : 'LOW'}`;
  
  document.getElementById('early-message').textContent = confidenceData.message;
  
  // Set mana symbols
  const syms = document.getElementById('early-symbols');
  syms.innerHTML = '';
  prof.colors.forEach(c => {
    const s = document.createElement('span');
    s.className = `mana-symbol mana-${c}`;
    s.textContent = c;
    s.style.width = '36px';
    s.style.height = '36px';
    s.style.fontSize = '18px';
    syms.appendChild(s);
  });
  
  window.scrollTo({top: 0, behavior: 'smooth'});
}

function showResultsEarly() {
  const data = window.earlyConfidenceData;
  
  // Set result without Round 2 data
  state.result = {
    identity: data.identity,
    confidence: data.confidence >= 0.90 ? 'HIGH' : 'MODERATE',
    earlyTermination: true,
    allResults: [],
    s2Data: null
  };
  
  showCalculating();
}

function continueToRound2() {
  // User chose to continue from early offer
  document.getElementById('screen-early-offer').classList.add('hidden');
  document.getElementById('screen-assessment').classList.remove('hidden');
  
  // Start calibration round (Round 2)
  startCalibration(state.round1Analysis);
}

function calculateCombinedScore(candidateId, data) {
  const candidateType = getCandidateType(candidateId);
  const classification = state.classification || 'UNCLEAR';
  
  let weight_r1, weight_r2;
  
  // CASE 1: Testing same category (guild vs guild, three vs three)
  if (classification === candidateType) {
    // Round 1 is fairly reliable for this
    weight_r1 = 0.70;
    weight_r2 = 0.30;
  }
  // CASE 2: Testing mono vs multi (fundamentally different)
  else if (classification === 'MONO' && candidateType !== 'MONO') {
    // Round 2 Pool D directly tests this - weight it heavily
    weight_r1 = 0.40;
    weight_r2 = 0.60;
  }
  else if (classification !== 'MONO' && candidateType === 'MONO') {
    // Reverse case - still weight Round 2 heavily
    weight_r1 = 0.40;
    weight_r2 = 0.60;
  }
  // CASE 3: Testing guild vs three-color
  else if ((classification === 'GUILD' && candidateType === 'THREE') ||
           (classification === 'THREE' && candidateType === 'GUILD')) {
    // Round 2 is important but Round 1 still informative
    weight_r1 = 0.55;
    weight_r2 = 0.45;
  }
  // CASE 4: Unclear or other
  else {
    // Default balanced weighting
    weight_r1 = 0.60;
    weight_r2 = 0.40;
  }
  
  const combined = data.s1 * weight_r1 + data.s2 * weight_r2;
  
  console.log(`${candidateId}: weights ${Math.round(weight_r1*100)}/${Math.round(weight_r2*100)}, s1=${Math.round(data.s1*100)}%, s2=${Math.round(data.s2*100)}%, combined=${Math.round(combined*100)}%`);
  
  return combined;
}


// === PAIRWISE PATTERN ANALYSIS ===
function calculateUncertainty(winsArray) {
  const total = winsArray.reduce((sum, w) => sum + w, 0);
  if (total === 0) return 0;
  let entropy = 0;
  winsArray.forEach(wins => {
    if (wins > 0) {
      const p = wins / total;
      entropy -= p * Math.log2(p);
    }
  });
  return entropy;
}

function analyseGapBasedPatterns() {
  const pairwise = state.pairwise;
  
  const colorData = {
    W: {
      wins: [pairwise['W-B'].W, pairwise['W-R'].W],
      total: pairwise['W-B'].W + pairwise['W-R'].W,
      enemies: ['B', 'R']
    },
    U: {
      wins: [pairwise['U-R'].U, pairwise['G-U'].U],
      total: pairwise['U-R'].U + pairwise['G-U'].U,
      enemies: ['R', 'G']
    },
    B: {
      wins: [pairwise['W-B'].B, pairwise['B-G'].B],
      total: pairwise['W-B'].B + pairwise['B-G'].B,
      enemies: ['W', 'G']
    },
    R: {
      wins: [pairwise['U-R'].R, pairwise['W-R'].R],
      total: pairwise['U-R'].R + pairwise['W-R'].R,
      enemies: ['U', 'W']
    },
    G: {
      wins: [pairwise['G-U'].G, pairwise['B-G'].G],
      total: pairwise['G-U'].G + pairwise['B-G'].G,
      enemies: ['U', 'B']
    }
  };
  
  ['W','U','B','R','G'].forEach(c => {
    const data = colorData[c];
    data.winRate = data.total / 12;
    data.uncertainty = calculateUncertainty(data.wins);
  });
  
  const sorted = Object.entries(colorData)
    .map(([color, data]) => ({color, ...data}))
    .sort((a, b) => b.total - a.total);
  
  const gaps = [];
  for (let i = 0; i < 4; i++) {
    gaps.push({
      index: i,
      gap: sorted[i].total - sorted[i+1].total,
      before: sorted[i].color,
      after: sorted[i+1].color
    });
  }
  
  const GAP_THRESHOLD = 1.5;
  const clusters = [];
  let currentCluster = [sorted[0]];
  
  for (let i = 0; i < 4; i++) {
    if (gaps[i].gap <= GAP_THRESHOLD) {
      currentCluster.push(sorted[i+1]);
    } else {
      clusters.push(currentCluster);
      currentCluster = [sorted[i+1]];
    }
  }
  clusters.push(currentCluster);
  
  console.log('=== GAP-BASED ANALYSIS ===');
  console.log('Sorted:', sorted.map(c => `${c.color}:${c.total}`).join(', '));
  console.log('Gaps:', gaps.map(g => `${g.gap} after ${g.before}`).join(', '));
  console.log('Clusters:', clusters.map(cl => cl.map(c => c.color).join('-')).join(' | '));
  
  return {sorted, gaps, clusters, colorData};
}

function getAllies(color) {
  const allyMap = {
    W: ['U', 'G'], U: ['W', 'B'], B: ['U', 'R'], R: ['B', 'G'], G: ['R', 'W']
  };
  return allyMap[color] || [];
}

function areAllies(c1, c2) {
  return getAllies(c1).includes(c2);
}

function generateCandidatesGapBased(analysis) {
  const {sorted, gaps, clusters} = analysis;
  const MIN_CANDIDATES = 4;
  const MAX_CANDIDATES = 6;
  
  console.log('=== CLUSTER-MATCH CANDIDATE GENERATION ===');
  console.log('Sorted:', sorted.map(c => `${c.color}:${Math.round(c.winRate*100)}%`).join(', '));
  
  // Step 1: Analyze gap structure to find natural cluster size
  const gapAnalysis = [];
  for (let i = 0; i < sorted.length - 1; i++) {
    gapAnalysis.push({
      position: i + 1,
      gap: sorted[i].winRate - sorted[i + 1].winRate,
      from: sorted[i].color,
      to: sorted[i + 1].color
    });
  }
  
  // Find the largest gap
  const largestGap = gapAnalysis.reduce((max, g) => g.gap > max.gap ? g : max, gapAnalysis[0]);
  
  // CRITICAL: If largest gap is very small (<12%), treat as all-colors cluster
  // This handles the five-color case where no color stands out
  const naturalClusterSize = largestGap.gap < 0.12 ? 5 : largestGap.position;
  
  // The colors IN the natural cluster
  const clusterColors = sorted.slice(0, naturalClusterSize).map(c => c.color);
  
  console.log('Gap analysis:', gapAnalysis.map(g => `${g.from}‚Üí${g.to}: ${Math.round(g.gap*100)}%`).join(', '));
  console.log(`Largest gap: ${Math.round(largestGap.gap*100)}% after position ${largestGap.position}`);
  console.log(`Natural cluster: [${clusterColors.join(', ')}] (size ${naturalClusterSize})`);
  
  // ========================================
  // CLUSTER-MATCH SCORING
  // Score reflects how well candidate matches the observed cluster structure
  // ========================================
  function calculateClusterMatchScore(candidateColors) {
    const candidateSize = candidateColors.length;
    
    // How many candidate colors are IN the cluster?
    const colorsInCluster = candidateColors.filter(c => clusterColors.includes(c)).length;
    
    // How many candidate colors are OUTSIDE the cluster?
    const colorsOutsideCluster = candidateSize - colorsInCluster;
    
    // 1. SIZE MATCH (0 to 0.30)
    // Perfect size match to cluster = 0.30
    // Off by 1 = 0.15, Off by 2+ = 0.05
    const sizeDiff = Math.abs(candidateSize - naturalClusterSize);
    const sizeBonus = sizeDiff === 0 ? 0.30 : sizeDiff === 1 ? 0.15 : 0.05;
    
    // 2. CLUSTER COVERAGE (0 to 0.35)
    // What fraction of the natural cluster does this candidate cover?
    const clusterCoverage = (colorsInCluster / naturalClusterSize) * 0.35;
    
    // 3. PURITY (0 to -0.15)
    // Penalty for including colors outside the cluster
    const purityPenalty = candidateSize > 0 ? (colorsOutsideCluster / candidateSize) * -0.15 : 0;
    
    // 4. COLOR STRENGTH (0 to 0.25)
    // Average win rate of candidate's colors
    const avgWinRate = candidateColors.reduce((sum, c) => {
      const colorData = sorted.find(s => s.color === c);
      return sum + (colorData ? colorData.winRate : 0);
    }, 0) / Math.max(1, candidateSize);
    const strengthScore = avgWinRate * 0.25;
    
    // 5. GAP CONFIDENCE MULTIPLIER (0.75 to 1.0)
    // For 1-4 color clusters: Stronger gap = more confidence
    // For 5-color: SMALL gap = high confidence (inverted)
    let gapConfidence;
    if (naturalClusterSize === 5) {
      // Five-color case: smaller gaps mean MORE confidence
      gapConfidence = 0.80 + (0.20 * (1 - largestGap.gap / 0.12));
    } else {
      // Normal case: larger gaps mean more confidence
      gapConfidence = 0.75 + Math.min(0.25, largestGap.gap);
    }
    
    const rawScore = sizeBonus + clusterCoverage + purityPenalty + strengthScore;
    const finalScore = Math.max(0.10, rawScore * gapConfidence);
    
    console.log(`  ${candidateColors.join('-')}: size=${sizeBonus.toFixed(2)}, coverage=${clusterCoverage.toFixed(2)}, purity=${purityPenalty.toFixed(2)}, strength=${strengthScore.toFixed(2)}, gap=${gapConfidence.toFixed(2)} ‚Üí ${Math.round(finalScore*100)}%`);
    
    return finalScore;
  }
  
  // ========================================
  // Build candidate list with cluster-match scoring
  // ========================================
  const allCandidates = [];
  const seen = new Set();
  
  const addCandidate = (id, colors, reasoning, type) => {
    if (!seen.has(id)) {
      const score = calculateClusterMatchScore(colors);
      allCandidates.push({ id, s1: score, reasoning, type, colors });
      seen.add(id);
    }
  };
  
  // ========================================
  // RELATIVE THRESHOLD CALCULATION
  // Colors must be within a reasonable % of the top color to form multi-color identities
  // This adapts to both peaked and flat profiles
  // ========================================
  const topWinRate = sorted[0]?.winRate || 0;
  const bottomWinRate = sorted[4]?.winRate || 0;
  const totalSpread = topWinRate - bottomWinRate;
  
  // RELATIVE_THRESHOLD: A color is "eligible" if it's within 60% of the spread from the top
  // Example: Top=58%, Bottom=13%, Spread=45% ‚Üí Threshold = 58% - (45% * 0.6) = 31%
  // Example: Top=35%, Bottom=25%, Spread=10% ‚Üí Threshold = 35% - (10% * 0.6) = 29%
  // Minimum threshold of 15% to avoid truly negligible colors
  const RELATIVE_DROPOFF = 0.60;
  const MIN_ABSOLUTE_THRESHOLD = 0.15;
  const relativeThreshold = Math.max(MIN_ABSOLUTE_THRESHOLD, topWinRate - (totalSpread * RELATIVE_DROPOFF));
  
  // Eligible colors for multi-color identities
  const eligibleColors = sorted.filter(c => c.winRate >= relativeThreshold).map(c => c.color);
  
  console.log(`Threshold calculation: top=${Math.round(topWinRate*100)}%, spread=${Math.round(totalSpread*100)}%, threshold=${Math.round(relativeThreshold*100)}%`);
  console.log(`Guild-eligible colors (‚â•${Math.round(relativeThreshold*100)}%): [${eligibleColors.join(', ')}]`);
  
  // ========================================
  // FIVE-COLOR DETECTION
  // If the spread is very small, consider WUBRG
  // ========================================
  const isFlatProfile = totalSpread < 0.20; // Top to bottom within 20%
  const allGapsSmall = largestGap.gap < 0.12;
  
  if (isFlatProfile || allGapsSmall) {
    console.log(`Flat profile detected: spread=${Math.round(totalSpread*100)}%, largestGap=${Math.round(largestGap.gap*100)}%`);
    addCandidate('WUBRG', ['W','U','B','R','G'], 'All colors balanced', 'FIVE');
  }
  
  // ========================================
  // ADD MONO CANDIDATES
  // Top 3 colors always get MONOs, but only if they're above minimum viability
  // ========================================
  const MONO_MIN_VIABILITY = 0.20; // Need at least 20% to be a viable mono identity
  sorted.slice(0, 3).forEach((c, idx) => {
    if (c.winRate >= MONO_MIN_VIABILITY) {
      addCandidate('MONO-' + c.color, [c.color], `#${idx + 1} color`, 'MONO');
    } else {
      console.log(`Skipping MONO-${c.color}: ${Math.round(c.winRate*100)}% below ${Math.round(MONO_MIN_VIABILITY*100)}% viability threshold`);
    }
  });
  
  // ========================================
  // ADD GUILD CANDIDATES
  // Only from eligible colors (within relative threshold)
  // ========================================
  const guildEligibleColors = eligibleColors.slice(0, 4); // Max 4 colors for guild combos
  
  for (let i = 0; i < guildEligibleColors.length; i++) {
    for (let j = i + 1; j < guildEligibleColors.length; j++) {
      const c1 = guildEligibleColors[i], c2 = guildEligibleColors[j];
      const guildKey = [c1, c2].sort().join('');
      const guildId = getGuild(guildKey);
      if (guildId) {
        const relation = areAllies(c1, c2) ? 'allies' : 'enemies';
        addCandidate(guildId, [c1, c2], `${c1}-${c2} guild (${relation})`, 'GUILD');
      }
    }
  }
  
  // ========================================
  // ADD THREE-COLOR CANDIDATES
  // ========================================
  if ((naturalClusterSize >= 3 || (sorted[2]?.winRate >= 0.40)) && eligibleColors.length >= 3) {
    const top3Eligible = eligibleColors.slice(0, 3);
    const threeKey = [...top3Eligible].sort().join('');
    const threeId = getThree(threeKey);
    if (threeId && !seen.has(threeId)) {
      addCandidate(threeId, top3Eligible, `Three-color from top eligible`, 'THREE');
    }
  }
  
  // ========================================
  // ADD FOUR-COLOR CANDIDATES
  // ========================================
  if ((naturalClusterSize >= 4 || (sorted[3]?.winRate >= relativeThreshold)) && eligibleColors.length >= 4) {
    const absentColor = sorted[4].color;
    const fourId = getFour(absentColor);
    if (fourId && !seen.has(fourId)) {
      const fourColors = eligibleColors.slice(0, 4);
      addCandidate(fourId, fourColors, `Four-color (no ${absentColor})`, 'FOUR');
    }
  }
  
  // Sort by cluster-match score
  allCandidates.sort((a, b) => b.s1 - a.s1);
  
  // ========================================
  // ENSURE MINIMUM CANDIDATES
  // If we don't have enough, add more but with viability checks
  // ========================================
  if (allCandidates.length < MIN_CANDIDATES) {
    console.log(`Only ${allCandidates.length} candidates, adding more`);
    
    // Add remaining MONOs (with lower threshold for backup)
    const BACKUP_MONO_THRESHOLD = 0.15;
    sorted.forEach(c => {
      if (allCandidates.length >= MIN_CANDIDATES) return;
      const monoId = 'MONO-' + c.color;
      if (!seen.has(monoId) && c.winRate >= BACKUP_MONO_THRESHOLD) {
        addCandidate(monoId, [c.color], 'Added for discrimination', 'MONO');
      }
    });
    
    // Add more guilds if needed - from eligible colors only
    for (let i = 0; i < eligibleColors.length && allCandidates.length < MIN_CANDIDATES; i++) {
      for (let j = i + 1; j < eligibleColors.length && allCandidates.length < MIN_CANDIDATES; j++) {
        const c1 = eligibleColors[i], c2 = eligibleColors[j];
        const guildKey = [c1, c2].sort().join('');
        const guildId = getGuild(guildKey);
        if (guildId && !seen.has(guildId)) {
          addCandidate(guildId, [c1, c2], 'Added for discrimination', 'GUILD');
        }
      }
    }
    
    // Re-sort
    allCandidates.sort((a, b) => b.s1 - a.s1);
  }
  
  // Limit to max candidates
  let final = allCandidates;
  if (allCandidates.length > MAX_CANDIDATES) {
    final = allCandidates.slice(0, MAX_CANDIDATES);
    
    // Ensure we have diversity (at least one mono, one multi)
    const hasMono = final.some(c => c.type === 'MONO');
    const hasMulti = final.some(c => c.type !== 'MONO');
    
    if (!hasMono) {
      const mono = allCandidates.find(c => c.type === 'MONO');
      if (mono) final[MAX_CANDIDATES - 1] = mono;
    }
    if (!hasMulti) {
      const multi = allCandidates.find(c => c.type !== 'MONO');
      if (multi) final[MAX_CANDIDATES - 2] = multi;
    }
    
    final.sort((a, b) => b.s1 - a.s1);
  }
  
  console.log(`=== FINAL ${final.length} CANDIDATES ===`);
  console.log(final.map(c => `${c.id}: ${Math.round(c.s1*100)}%`).join(' | '));
  
  return final;
}

function finishS1() {
  // NEW: Use gap-based analysis
  const analysis = analyseGapBasedPatterns();
  const candidates = generateCandidatesGapBased(analysis);
  
  // Calculate activation strength for display
  const activation = {
    W: (state.pairwise['W-B'].W / 6 + state.pairwise['W-R'].W / 6) / 2,
    U: (state.pairwise['U-R'].U / 6 + state.pairwise['G-U'].U / 6) / 2,
    B: (state.pairwise['W-B'].B / 6 + state.pairwise['B-G'].B / 6) / 2,
    R: (state.pairwise['U-R'].R / 6 + state.pairwise['W-R'].R / 6) / 2,
    G: (state.pairwise['G-U'].G / 6 + state.pairwise['B-G'].G / 6) / 2
  };
  
  const sorted = Object.entries(activation).sort((a,b) => b[1] - a[1]);
  state.activationSorted = sorted;
  
  console.log('=== ROUND 1 COMPLETE ===');
  console.log('Activation:', sorted.map(([c,v]) => `${c}:${Math.round(v*100)}%`).join(', '));
  console.log('Candidates:', candidates.map(c => c.id).join(', '));
  
  // Determine confidence
  const topCandidate = candidates[0];
  const secondCandidate = candidates[1];
  
  let confidence = 'MODERATE';
  if (topCandidate.s1 >= 0.85 && (!secondCandidate || topCandidate.s1 - secondCandidate.s1 >= 0.25)) {
    confidence = 'HIGH';
  } else if (topCandidate.s1 < 0.60 || (secondCandidate && topCandidate.s1 - secondCandidate.s1 < 0.10)) {
    confidence = 'LOW';
  }
  
  console.log('Confidence:', confidence);
  
  // Store analysis for calibration
  state.round1Analysis = analysis;
  state.round1Candidates = candidates;
  
  if (confidence === 'HIGH' && candidates.length === 1) {
    // Clear result - offer early termination
    state.pendingCandidates = candidates;
    const confidenceCheck = {
      identity: topCandidate.id,
      confidence: 'HIGH',
      needsRound2: false,
      activation: activation,
      sorted: sorted
    };
    showEarlyTerminationOffer(confidenceCheck);
  } else {
    // Need calibration round first - show transition
    showRoundTransition(1, 2, () => {
      document.getElementById('screen-assessment').classList.remove('hidden');
      startCalibration(analysis);
    });
  }
}

// ============================================================================
// ROUND 2: ALLY PAIR CALIBRATION
// Tests ally pairs to detect suppression and noise from Round 1
// ============================================================================

function generateCalibrationQuestions(analysis) {
  const {sorted, gaps, clusters, colorData} = analysis;
  const questions = [];
  const pairwise = state.pairwise;
  
  console.log('=== GENERATING CALIBRATION QUESTIONS ===');
  
  // ALLY PAIRS (pairs Round 1 never tested)
  const ALLY_PAIRS = [
    {pair: 'W-U', colors: ['W', 'U'], name: 'White-Blue'},
    {pair: 'U-B', colors: ['U', 'B'], name: 'Blue-Black'},
    {pair: 'B-R', colors: ['B', 'R'], name: 'Black-Red'},
    {pair: 'R-G', colors: ['R', 'G'], name: 'Red-Green'},
    {pair: 'G-W', colors: ['G', 'W'], name: 'Green-White'}
  ];
  
  // Get ally pair questions from POOL_ALLY
  const getQuestionsForPair = (pairId) => {
    return POOL_ALLY.filter(q => q.pair === pairId);
  };
  
  // Generate calibration questions based on what we need to test
  const questionsToAsk = [];
  
  // PRIORITY: If top 2 colors are allies, ALWAYS test them first
  // This is the most critical discrimination (e.g., MONO-G vs GRUUL)
  const top2 = sorted.slice(0, 2).map(c => c.color);
  if (areAllies(top2[0], top2[1])) {
    const topAllyPair = ALLY_PAIRS.find(ap => 
      (ap.colors[0] === top2[0] && ap.colors[1] === top2[1]) ||
      (ap.colors[1] === top2[0] && ap.colors[0] === top2[1])
    );
    if (topAllyPair) {
      questionsToAsk.push({
        type: 'TOP_PAIR',
        colors: top2,
        pairId: topAllyPair.pair,
        reason: `Critical: Determine ordering between top 2 colors (${top2[0]} vs ${top2[1]}) for MONO vs GUILD distinction`
      });
      console.log(`PRIORITY: Top 2 colors (${top2.join(', ')}) are allies - must test ${topAllyPair.pair}`);
    }
  }
  
  // SECONDARY PRIORITY: Test ally pairs within top 3 (for 3-color detection)
  const top3 = sorted.slice(0, 3).map(c => c.color);
  [[0,2], [1,2]].forEach(([i,j]) => {
    if (areAllies(top3[i], top3[j])) {
      const pair = ALLY_PAIRS.find(ap => 
        (ap.colors[0] === top3[i] && ap.colors[1] === top3[j]) ||
        (ap.colors[1] === top3[i] && ap.colors[0] === top3[j])
      );
      if (pair && !questionsToAsk.find(q => q.pairId === pair.pair)) {
        questionsToAsk.push({
          type: 'TOP3_PAIR',
          colors: [top3[i], top3[j]],
          pairId: pair.pair,
          reason: `Important: Test ${top3[i]} vs ${top3[j]} for 3-color detection`
        });
        console.log(`SECONDARY: Top 3 ally pair ${pair.pair} added`);
      }
    }
  });
  
  // TYPE A: SUPPRESSION DETECTION
  // For close enemy matchups (margin ‚â§ 2), test the loser against their ally
  // to see if they're truly suppressed or just slightly behind
  
  const ENEMY_PAIRS = [
    {pair: 'W-B', colors: ['W', 'B']},
    {pair: 'U-R', colors: ['U', 'R']},
    {pair: 'G-U', colors: ['G', 'U']},
    {pair: 'W-R', colors: ['W', 'R']},
    {pair: 'B-G', colors: ['B', 'G']}
  ];
  
  const closeMatchups = [];
  ENEMY_PAIRS.forEach(ep => {
    const [c1, c2] = ep.colors;
    const c1Wins = pairwise[ep.pair][c1];
    const c2Wins = pairwise[ep.pair][c2];
    const margin = Math.abs(c1Wins - c2Wins);
    
    if (margin <= 2) { // Close matchup (4-2, 3-3, 5-1)
      const loser = c1Wins < c2Wins ? c1 : c2;
      const winner = c1Wins >= c2Wins ? c1 : c2;
      closeMatchups.push({
        pair: ep.pair,
        winner: winner,
        loser: loser,
        margin: margin,
        reason: 'suppression_check'
      });
      console.log(`Close matchup: ${ep.pair} (${winner} beat ${loser} by ${margin}) - need suppression check`);
    }
  });
  
  // TYPE B: NOISE DETECTION
  // For colors that won their enemy pairs but might be noise
  // (because user doesn't actually care about those pairs)
  
  // Identify likely dominant colors (top cluster)
  const topCluster = clusters[0].map(c => c.color);
  const bottomColors = sorted.slice(-2).map(c => c.color);
  
  // Colors that won but aren't in top cluster might be noise
  const potentialNoise = [];
  sorted.forEach((c, idx) => {
    if (idx > 0 && idx < sorted.length - 1) { // Middle colors
      if (!topCluster.includes(c.color) && c.total >= 4) {
        // This color won some matchups but isn't in dominant cluster
        potentialNoise.push({
          color: c.color,
          wins: c.total,
          reason: 'noise_check'
        });
        console.log(`Potential noise: ${c.color} (${c.total} wins but not in top cluster)`);
      }
    }
  });
  
  // For suppression checks: test loser against their allies
  closeMatchups.forEach(cm => {
    const loser = cm.loser;
    const loserAllies = getAllies(loser);
    
    loserAllies.forEach(ally => {
      const allyPairId = [loser, ally].sort().join('-');
      // Find the correct ally pair ID format
      const matchingPair = ALLY_PAIRS.find(ap => 
        (ap.colors[0] === loser && ap.colors[1] === ally) ||
        (ap.colors[1] === loser && ap.colors[0] === ally)
      );
      
      if (matchingPair) {
        questionsToAsk.push({
          type: 'SUPPRESSION',
          targetColor: loser,
          allyColor: ally,
          pairId: matchingPair.pair,
          reason: `Test if ${loser} is truly suppressed or just slightly behind ${cm.winner}`
        });
      }
    });
  });
  
  // For noise checks: test potential noise color against dominant colors
  potentialNoise.forEach(pn => {
    const noiseColor = pn.color;
    
    // Test against top cluster colors that are allies
    topCluster.forEach(dominant => {
      if (areAllies(noiseColor, dominant)) {
        const matchingPair = ALLY_PAIRS.find(ap => 
          (ap.colors[0] === noiseColor && ap.colors[1] === dominant) ||
          (ap.colors[1] === noiseColor && ap.colors[0] === dominant)
        );
        
        if (matchingPair) {
          questionsToAsk.push({
            type: 'NOISE',
            targetColor: noiseColor,
            dominantColor: dominant,
            pairId: matchingPair.pair,
            reason: `Test if ${noiseColor} is real signal or noise from irrelevant pairs`
          });
        }
      }
    });
  });
  
  // If we don't have enough specific tests, add general ally pair tests
  // to get more information about relative ordering
  if (questionsToAsk.length < 4) {
    // Test ally pairs between top colors
    const topColors = sorted.slice(0, 3).map(c => c.color);
    topColors.forEach((c1, i) => {
      topColors.slice(i+1).forEach(c2 => {
        if (areAllies(c1, c2)) {
          const matchingPair = ALLY_PAIRS.find(ap => 
            (ap.colors[0] === c1 && ap.colors[1] === c2) ||
            (ap.colors[1] === c1 && ap.colors[0] === c2)
          );
          
          if (matchingPair && !questionsToAsk.find(q => q.pairId === matchingPair.pair)) {
            questionsToAsk.push({
              type: 'ORDERING',
              colors: [c1, c2],
              pairId: matchingPair.pair,
              reason: `Determine relative ordering between ${c1} and ${c2} (allies, never tested)`
            });
          }
        }
      });
    });
  }
  
  // Remove duplicates and limit to reasonable number
  const uniquePairs = new Set();
  const finalQuestions = [];
  
  questionsToAsk.forEach(q => {
    if (!uniquePairs.has(q.pairId) && finalQuestions.length < 6) {
      uniquePairs.add(q.pairId);
      
      // Get questions for this pair
      const pairQuestions = getQuestionsForPair(q.pairId);
      if (pairQuestions.length > 0) {
        // Pick 2 questions per pair for reliability
        const selected = shuffleArray([...pairQuestions]).slice(0, 2);
        selected.forEach(sq => {
          finalQuestions.push({
            ...sq,
            calibrationType: q.type,
            calibrationReason: q.reason
          });
        });
      }
    }
  });
  
  // If still not enough, fill with general coverage
  if (finalQuestions.length < 6) {
    const missingPairs = ALLY_PAIRS.filter(ap => !uniquePairs.has(ap.pair));
    for (const mp of missingPairs) {
      if (finalQuestions.length >= 8) break;
      const pairQuestions = getQuestionsForPair(mp.pair);
      if (pairQuestions.length > 0) {
        const selected = shuffleArray([...pairQuestions]).slice(0, 1);
        selected.forEach(sq => {
          finalQuestions.push({
            ...sq,
            calibrationType: 'COVERAGE',
            calibrationReason: `General ally pair coverage for ${mp.pair}`
          });
        });
        uniquePairs.add(mp.pair);
      }
    }
  }
  
  console.log(`Generated ${finalQuestions.length} calibration questions`);
  finalQuestions.forEach((q, i) => {
    console.log(`  ${i+1}. ${q.pair}: ${q.calibrationType} - ${q.calibrationReason}`);
  });
  
  return finalQuestions;
}

function startCalibration(analysis) {
  console.log('=== ROUND 2: ALLY PAIR CALIBRATION ===');
  
  const questions = generateCalibrationQuestions(analysis);
  
  if (questions.length === 0) {
    // No calibration needed, skip to interstitial
    console.log('No calibration questions needed, skipping to interstitial');
    showInterstitial(state.round1Candidates);
    return;
  }
  
  // Initialize calibration state
  state.stage = 'calibration';
  state.calibrationQuestions = questions;
  state.calibrationAnswers = [];
  state.calibrationPairwise = {}; // Track ally pair results
  
  // Initialize ally pair tracking
  const ALLY_PAIRS = ['W-U', 'U-B', 'B-R', 'R-G', 'G-W'];
  ALLY_PAIRS.forEach(pair => {
    const [c1, c2] = pair.split('-');
    state.calibrationPairwise[pair] = {[c1]: 0, [c2]: 0};
  });
  
  state.qNum = 0;
  state.qTot = questions.length;
  
  // Update UI
  document.getElementById('stage-label').textContent = 'Round 2: Calibration';
  document.getElementById('q-tot').textContent = questions.length;
  updateHeaderRoundIndicator(2);
  
  updateDebug();
  showCalibrationQuestion();
}

function showCalibrationQuestion() {
  const q = state.calibrationQuestions[state.qNum];
  
  document.getElementById('q-num').textContent = state.qNum + 1;
  document.getElementById('ctx').textContent = q.ctx || 'Ally Pair Test';
  
  // Build scenario - add mana symbols for constructed mode only (same as Round 1)
  const scenarioText = q.sc;
  
  // Get context hint (MTG, team, budget, etc.)
  const contextHint = getContextHint(scenarioText, q.id);
  const hintHTML = contextHint 
    ? `<div style="font-size: 13px; color: #a0a0b0; margin-top: 16px; font-style: italic; text-align: center; padding: 10px 16px; background: rgba(255,255,255,0.03); border-radius: 8px; line-height: 1.5;">
        üí° ${contextHint}
       </div>`
    : '';
  
  if (state.mode === 'constructed' && q.pair) {
    const colors = q.pair.split('-');
    let symbolsHTML = '<div style="display: flex; gap: 8px; justify-content: center; margin: 16px 0;">';
    colors.forEach(c => {
      symbolsHTML += `<span class="mana-symbol mana-${c}" style="width: 32px; height: 32px; font-size: 16px;">${c}</span>`;
    });
    symbolsHTML += '</div>';
    document.getElementById('scenario').innerHTML = scenarioText + symbolsHTML + hintHTML;
  } else {
    document.getElementById('scenario').innerHTML = scenarioText + hintHTML;
  }
  
  document.getElementById('instr').innerHTML = 'Choose the response <strong>more like you</strong>.';
  
  // Update progress bar - dim R1, show calibration progress on prog-s2
  const pct = ((state.qNum + 1) / state.calibrationQuestions.length) * 100;
  const prog1 = document.getElementById('prog-s1');
  const prog2 = document.getElementById('prog-s2');
  const prog3 = document.getElementById('prog-s3');
  
  prog1.style.width = '100%'; // R1 complete
  prog1.style.opacity = '0.3'; // Dim it
  prog2.style.width = `${pct}%`;
  prog2.style.opacity = '1';
  if (prog3) {
    prog3.style.width = '0%';
    prog3.style.opacity = '0';
  }
  
  // Build choices - SAME FORMAT AS ROUND 1 with mana symbols
  const choicesDiv = document.getElementById('choices');
  choicesDiv.innerHTML = '';
  
  // Randomize option order
  const options = shuffleArray([...q.r]);
  
  options.forEach((opt, i) => {
    const btn = document.createElement('button');
    btn.className = 'choice-button';
    btn.onclick = () => selectCalibrationChoice(opt.c, q.pair);
    
    // Add mana symbol in constructed mode (like Round 1)
    if (state.mode === 'constructed') {
      const symbolWrapper = document.createElement('div');
      symbolWrapper.style.cssText = 'display: flex; flex-direction: column; align-items: center; gap: 4px; margin-right: 12px;';
      
      const symbolSpan = document.createElement('span');
      symbolSpan.className = `mana-symbol mana-${opt.c}`;
      symbolSpan.style.cssText = 'width: 24px; height: 24px; font-size: 12px; flex-shrink: 0;';
      symbolSpan.textContent = opt.c;
      symbolWrapper.appendChild(symbolSpan);
      
      btn.appendChild(symbolWrapper);
    } else {
      // Blind draft: just show letter
      const letterSpan = document.createElement('span');
      letterSpan.style.cssText = 'font-weight: 700; color: #808090; font-size: 14px; margin-right: 12px;';
      letterSpan.textContent = String.fromCharCode(65 + i);
      btn.appendChild(letterSpan);
    }
    
    const textSpan = document.createElement('span');
    textSpan.textContent = opt.t;
    btn.appendChild(textSpan);
    
    choicesDiv.appendChild(btn);
  });
  
  // Add "Neither" option for calibration (like Round 1)
  const neitherBtn = document.createElement('button');
  neitherBtn.className = 'choice-button neither-button';
  neitherBtn.style.cssText = 'background: rgba(80, 80, 95, 0.08); border: 1px solid rgba(120, 120, 140, 0.25); color: #808090; font-size: 13px; margin-top: 16px; padding: 12px 20px;';
  neitherBtn.textContent = 'Neither feels like me';
  neitherBtn.onclick = () => selectCalibrationNeither(q.pair);
  choicesDiv.appendChild(neitherBtn);
  
  // Update debug
  updateDebug();
  
  window.scrollTo({top: 0, behavior: 'smooth'});
}

function selectCalibrationChoice(color, pair) {
  console.log(`Calibration Q${state.qNum + 1}: Selected ${color} for pair ${pair}`);
  
  // Record the choice
  state.calibrationAnswers.push({
    questionId: state.calibrationQuestions[state.qNum].id,
    pair: pair,
    choice: color,
    type: state.calibrationQuestions[state.qNum].calibrationType
  });
  
  // Update ally pairwise counts
  if (state.calibrationPairwise[pair]) {
    state.calibrationPairwise[pair][color]++;
  }
  
  state.qNum++;
  
  if (state.qNum < state.calibrationQuestions.length) {
    showCalibrationQuestion();
  } else {
    finishCalibration();
  }
}

function selectCalibrationNeither(pair) {
  console.log(`Calibration Q${state.qNum + 1}: Selected NEITHER for pair ${pair} (no points awarded)`);
  
  // Track neither count
  if (!state.calibrationNeitherCount) state.calibrationNeitherCount = 0;
  state.calibrationNeitherCount++;
  
  // Record as neither - no points to either color
  state.calibrationAnswers.push({
    questionId: state.calibrationQuestions[state.qNum].id,
    pair: pair,
    choice: 'NEITHER',
    type: state.calibrationQuestions[state.qNum].calibrationType
  });
  
  // Neither color gets points - if neither resonates, we don't inflate both
  
  state.qNum++;
  
  if (state.qNum < state.calibrationQuestions.length) {
    showCalibrationQuestion();
  } else {
    finishCalibration();
  }
}

function finishCalibration() {
  console.log('=== CALIBRATION COMPLETE ===');
  console.log('Ally pair results:', state.calibrationPairwise);
  
  // Analyze calibration results and adjust activation estimates
  const adjustedActivation = calculateCalibratedActivation();
  
  // Recalculate candidates with calibrated data
  const calibratedCandidates = recalculateCandidates(adjustedActivation);
  
  state.pendingCandidates = calibratedCandidates;
  
  // Show transition then interstitial
  showRoundTransition(2, 3, () => {
    showInterstitial(calibratedCandidates);
  });
}

function calculateCalibratedActivation() {
  const original = state.activationSorted;
  const allyResults = state.calibrationPairwise;
  
  console.log('=== CALCULATING CALIBRATED ACTIVATION ===');
  console.log('Original activation:', original.map(c => `${c[0]}:${Math.round(c[1]*100)}%`).join(', '));
  
  // Start with original activation from Round 1
  const activation = {};
  original.forEach(([color, value]) => {
    activation[color] = value;
  });
  
  // Adjust based on ally pair results
  // The key insight: Round 1 tells us about enemy relationships
  // Calibration tells us about ally relationships (which R1 never tests)
  
  Object.entries(allyResults).forEach(([pair, results]) => {
    const [c1, c2] = pair.split('-');
    const c1Wins = results[c1];
    const c2Wins = results[c2];
    const totalQuestions = c1Wins + c2Wins;
    
    if (totalQuestions === 0) return;
    
    const c1Rate = c1Wins / totalQuestions;
    const c2Rate = c2Wins / totalQuestions;
    
    console.log(`  ${pair}: ${c1}=${c1Wins}, ${c2}=${c2Wins}`);
    
    // Adjustment factor - calibrated to give R2 ally pair data meaningful impact
    // Increased from 0.15 to 0.22 so ally pair results move the needle more
    const adjustmentWeight = 0.22;
    
    // If one ally dominates the other, adjust relative positioning
    if (Math.abs(c1Rate - c2Rate) >= 0.3) {
      // Significant difference in ally pair
      const winner = c1Rate > c2Rate ? c1 : c2;
      const loser = c1Rate > c2Rate ? c2 : c1;
      const winnerRate = Math.max(c1Rate, c2Rate);
      
      // Boost winner slightly, reduce loser slightly
      activation[winner] = Math.min(1, activation[winner] + adjustmentWeight * winnerRate);
      activation[loser] = Math.max(0, activation[loser] - adjustmentWeight * (1 - winnerRate));
      
      console.log(`    Adjusted: ${winner} up, ${loser} down`);
    }
  });
  
  // Normalize to keep relative ordering meaningful
  const total = Object.values(activation).reduce((a, b) => a + b, 0);
  const scale = original.reduce((sum, c) => sum + c[1], 0) / total;
  
  Object.keys(activation).forEach(c => {
    activation[c] *= scale;
  });
  
  // Sort by new activation
  const sorted = Object.entries(activation).sort((a, b) => b[1] - a[1]);
  
  console.log('Calibrated activation:', sorted.map(c => `${c[0]}:${Math.round(c[1]*100)}%`).join(', '));
  
  // Update state
  state.activationSorted = sorted;
  
  return {activation, sorted};
}

function recalculateCandidates(calibratedData) {
  const {sorted} = calibratedData;
  
  console.log('=== RECALCULATING CANDIDATES WITH CALIBRATED DATA ===');
  console.log('Calibrated activation:', sorted.map(([c, v]) => `${c}:${Math.round(v*100)}%`).join(', '));
  
  // Build analysis object for generateCandidatesGapBased
  // Only need sorted with color and winRate - the function calculates its own gaps
  const analysis = {
    sorted: sorted.map(([color, rate]) => ({
      color: color,
      winRate: rate,
      total: rate * 12  // For backward compatibility with any code that uses total
    })),
    gaps: [],     // Not used - generateCandidatesGapBased recalculates
    clusters: []  // Not used - generateCandidatesGapBased recalculates
  };
  
  return generateCandidatesGapBased(analysis);
}
  
function showInterstitial(candidates) {
  state.pendingCandidates = candidates;
  
  document.getElementById('screen-assessment').classList.add('hidden');
  document.getElementById('screen-interstitial').classList.remove('hidden');
  
  const sorted = state.activationSorted;
  
  // Check if calibration was done
  const wasCalibrated = state.calibrationAnswers && state.calibrationAnswers.length > 0;
  
  // EASTER EGG: Check if user broke the assessment by selecting "neither" too much
  // This catches: all calibration neithers, all R1 neithers, or any combo that produces NaN/zero
  const allCalibrationNeither = wasCalibrated && 
    state.calibrationAnswers.every(a => a.choice === 'NEITHER');
  const allValuesZeroOrNaN = sorted.every(([c, act]) => isNaN(act) || act === 0 || act === undefined);
  
  if (allCalibrationNeither || allValuesZeroOrNaN) {
    // They broke it! Show the confetti screen
    const scoresDiv = document.getElementById('inter-scores');
    scoresDiv.innerHTML = '';
    scoresDiv.style.cssText = 'text-align: center; padding: 40px 20px;';
    
    scoresDiv.innerHTML = `
      <div style="font-size: 48px; margin-bottom: 16px;">üéâ</div>
      <div style="font-size: 28px; font-weight: 800; color: #a78bfa; margin-bottom: 12px;">Congratulations!</div>
      <div style="font-size: 20px; color: #e0e0e0; margin-bottom: 8px;">You broke the internet.</div>
      <div style="font-size: 14px; color: #808090; line-height: 1.6;">
        By refusing to commit to anything, you've achieved a mathematically impossible result.<br><br>
        This is either a profound statement about the limitations of forced-choice assessments, or you just really didn't want to play along.<br><br>
        Either way, we respect it.
      </div>
    `;
    
    // Spray confetti
    createConfetti();
    
    // Update title
    const titleEl = document.querySelector('#screen-interstitial h2');
    if (titleEl) {
      titleEl.textContent = 'üéä Achievement Unlocked üéä';
    }
    
    // Hide the continue button and explanations
    document.getElementById('inter-explanation').textContent = '';
    document.getElementById('inter-next').textContent = '';
    
    // Replace the continue button with a restart option
    const continueBtn = document.querySelector('#screen-interstitial .btn-primary');
    if (continueBtn) {
      continueBtn.textContent = 'Try Again (With Actual Choices)';
      continueBtn.onclick = () => location.reload();
    }
    
    // Hide the subtitle
    const subtitle = document.querySelector('#screen-interstitial .btn-primary + p');
    if (subtitle) subtitle.style.display = 'none';
    
    window.scrollTo({top: 0, behavior: 'smooth'});
    return; // Don't continue with normal flow
  }
  
  // Update interstitial title based on what was completed
  const titleEl = document.querySelector('#screen-interstitial h2');
  if (titleEl) {
    titleEl.textContent = wasCalibrated ? 'Calibration Complete' : 'Round 1 Complete';
  }
  
  // Show ALL 5 colors with visual strength bars
  const scoresDiv = document.getElementById('inter-scores');
  scoresDiv.innerHTML = '';
  scoresDiv.style.cssText = 'display: flex; flex-direction: column; gap: 10px; max-width: 400px; margin: 0 auto 20px auto;';
  
  const maxRate = sorted[0][1] || 1; // Highest for scaling bars, fallback to 1 to prevent division by 0
  
  sorted.forEach(([c, act], idx) => {
    // Handle NaN or undefined values
    const safeAct = isNaN(act) || act === undefined ? 0 : act;
    const pctValue = Math.round(safeAct * 100);
    const barWidth = Math.max(8, (safeAct / maxRate) * 100); // Scale relative to max
    
    const row = document.createElement('div');
    row.style.cssText = 'display: flex; align-items: center; gap: 12px;';
    
    // Mana symbol
    const sym = document.createElement('span');
    sym.className = `mana-symbol mana-${c}`;
    sym.textContent = c;
    sym.style.cssText = 'width: 36px; height: 36px; font-size: 18px; flex-shrink: 0;';
    row.appendChild(sym);
    
    // Bar container
    const barContainer = document.createElement('div');
    barContainer.style.cssText = 'flex: 1; height: 24px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; position: relative;';
    
    // Filled bar
    const bar = document.createElement('div');
    bar.style.cssText = `height: 100%; width: ${barWidth}%; background: rgba(167, 139, 250, 0.7); border-radius: 4px; transition: width 0.5s ease;`;
    barContainer.appendChild(bar);
    
    row.appendChild(barContainer);
    
    // Percentage
    const pctLabel = document.createElement('span');
    pctLabel.style.cssText = 'font-size: 14px; font-weight: 600; min-width: 40px; text-align: right; color: #e0e0e0;';
    pctLabel.textContent = `${pctValue}%`;
    row.appendChild(pctLabel);
    
    scoresDiv.appendChild(row);
  });
  
  // Neutral explanation - don't predict, just describe the data
  const calibrationNote = wasCalibrated 
    ? `We've refined your color activations based on how you navigate allied values. `
    : '';
  
  const explanation = `${calibrationNote}These are your relative color strengths based on your answers so far.`;
  const nextStep = `In the final round, we'll present scenarios with two approaches. Pick whichever feels more like you‚Äîthere's no "neither" option, so go with your gut even if it's close.`;
  
  document.getElementById('inter-explanation').textContent = explanation;
  document.getElementById('inter-next').textContent = nextStep;
  
  window.scrollTo({top: 0, behavior: 'smooth'});
}

function continueToStage2() {
  document.getElementById('screen-interstitial').classList.add('hidden');
  document.getElementById('screen-assessment').classList.remove('hidden');
  startRound3(state.pendingCandidates);
}


// ============================================================================
// ROUND 3: FINAL DETERMINATION (ADAPTIVE TOURNAMENT SYSTEM)
// Mobile-friendly forced-choice pairwise comparisons
// ============================================================================

// Tournament helper functions
function initTournament(candidates) {
  return {
    candidates: candidates.map(c => ({
      ...c,
      wins: 0,
      losses: 0,
      opponents: []
    })),
    matchHistory: [],
    currentMatchup: null,
    questionCount: 0,
    maxQuestions: 4,
    terminated: false,
    termReason: null
  };
}

function getTournamentCandidateType(id) {
  if (id.startsWith('MONO-')) return 'MONO';
  if (['AZORIUS','DIMIR','RAKDOS','GRUUL','SELESNYA','ORZHOV','IZZET','GOLGARI','BOROS','SIMIC'].includes(id)) return 'GUILD';
  if (['ESPER','GRIXIS','JUND','NAYA','BANT','ABZAN','JESKAI','SULTAI','MARDU','TEMUR'].includes(id)) return 'THREE';
  if (['YORE','GLINT','DUNE','INK','WITCH'].includes(id)) return 'FOUR';
  if (id === 'WUBRG') return 'FIVE';
  return 'UNKNOWN';
}

function findTournamentLeader(tournament) {
  const validCandidates = tournament.candidates.filter(c => c.losses < 2);
  if (validCandidates.length === 0) return tournament.candidates[0];
  
  return validCandidates.reduce((best, c) => {
    const cWinRate = c.wins / Math.max(1, c.wins + c.losses);
    const bestWinRate = best.wins / Math.max(1, best.wins + best.losses);
    
    if (cWinRate > bestWinRate) return c;
    if (cWinRate === bestWinRate && c.combinedScore > best.combinedScore) return c;
    return best;
  }, validCandidates[0]);
}

function tournamentHasPlayed(c1, c2, matchHistory) {
  return matchHistory.some(m => 
    (m.a.id === c1.id && m.b.id === c2.id) ||
    (m.a.id === c2.id && m.b.id === c1.id)
  );
}

function selectNextMatchup(tournament) {
  const { candidates, matchHistory } = tournament;
  const leader = findTournamentLeader(tournament);
  
  if (!leader) return null;
  
  const contenders = candidates.filter(c => c.losses < 2 && c.id !== leader.id);
  
  if (contenders.length === 0) return null;
  
  // Priority 1: Width challenge (different type)
  const leaderType = getTournamentCandidateType(leader.id);
  const widthChallenger = contenders.find(c => 
    getTournamentCandidateType(c.id) !== leaderType && 
    !tournamentHasPlayed(leader, c, matchHistory)
  );
  if (widthChallenger) {
    console.log(`MATCHUP: Width challenge - ${leader.id} (${leaderType}) vs ${widthChallenger.id} (${getTournamentCandidateType(widthChallenger.id)})`);
    return { a: leader, b: widthChallenger, type: 'WIDTH' };
  }
  
  // Priority 2: Same-type competitor
  const sameTypeChallenger = contenders.find(c =>
    getTournamentCandidateType(c.id) === leaderType &&
    !tournamentHasPlayed(leader, c, matchHistory)
  );
  if (sameTypeChallenger) {
    console.log(`MATCHUP: Same-type - ${leader.id} vs ${sameTypeChallenger.id} (both ${leaderType})`);
    return { a: leader, b: sameTypeChallenger, type: 'SAME_TYPE' };
  }
  
  // Priority 3: Any unplayed contender
  const anyChallenger = contenders.find(c => !tournamentHasPlayed(leader, c, matchHistory));
  if (anyChallenger) {
    console.log(`MATCHUP: General - ${leader.id} vs ${anyChallenger.id}`);
    return { a: leader, b: anyChallenger, type: 'GENERAL' };
  }
  
  // Priority 4: Runoff between other contenders
  for (let i = 0; i < contenders.length; i++) {
    for (let j = i + 1; j < contenders.length; j++) {
      if (!tournamentHasPlayed(contenders[i], contenders[j], matchHistory)) {
        console.log(`MATCHUP: Runoff - ${contenders[i].id} vs ${contenders[j].id}`);
        return { a: contenders[i], b: contenders[j], type: 'RUNOFF' };
      }
    }
  }
  
  return null;
}

function shouldTerminateEarly(tournament) {
  // Never terminate before asking at least 2 questions
  if (tournament.questionCount < 2) {
    return { terminate: false };
  }
  
  const leader = findTournamentLeader(tournament);
  if (!leader) return { terminate: false };
  
  const { candidates, matchHistory } = tournament;
  
  const contenders = candidates
    .filter(c => c.id !== leader.id && c.losses < 2)
    .sort((a, b) => {
      const aRate = a.wins / Math.max(1, a.wins + a.losses);
      const bRate = b.wins / Math.max(1, b.wins + b.losses);
      return bRate - aRate;
    });
  
  const secondPlace = contenders[0];
  const initialGap = leader.combinedScore - (secondPlace?.combinedScore || 0);
  
  // Condition 1: Only one candidate left with < 2 losses (everyone else eliminated)
  if (contenders.length === 0) {
    return { 
      terminate: true, 
      reason: 'LAST_STANDING',
      message: `${leader.id} eliminated all challengers`
    };
  }
  
  // Condition 2: All possible matchups exhausted
  const nextMatch = selectNextMatchup(tournament);
  if (!nextMatch) {
    return { 
      terminate: true, 
      reason: 'EXHAUSTED',
      message: 'All relevant matchups completed'
    };
  }
  
  // Condition 3: Leader is dominant (2+ wins, no losses)
  // If they also entered with a big gap, note that in the message
  if (leader.wins >= 2 && leader.losses === 0) {
    const hasInitialGap = initialGap > 0.15;
    return { 
      terminate: true, 
      reason: hasInitialGap ? 'CONFIRMED_FRONTRUNNER' : 'DOMINANT',
      message: hasInitialGap 
        ? `${leader.id} confirmed strong R1/R2 signal with ${leader.wins} wins`
        : `${leader.id} won ${leader.wins} consecutive matchups`
    };
  }
  
  return { terminate: false };
}

function recordTournamentResult(tournament, winnerId) {
  const matchup = tournament.currentMatchup;
  const winner = matchup.a.id === winnerId ? matchup.a : matchup.b;
  const loser = matchup.a.id === winnerId ? matchup.b : matchup.a;
  
  const winnerCandidate = tournament.candidates.find(c => c.id === winner.id);
  const loserCandidate = tournament.candidates.find(c => c.id === loser.id);
  
  winnerCandidate.wins++;
  winnerCandidate.opponents.push(loser.id);
  loserCandidate.losses++;
  loserCandidate.opponents.push(winner.id);
  
  tournament.matchHistory.push({
    a: matchup.a,
    b: matchup.b,
    winner: winner,
    loser: loser,
    type: matchup.type,
    questionNum: tournament.questionCount
  });
  
  tournament.questionCount++;
  
  console.log(`RESULT: ${winner.id} defeats ${loser.id} (${matchup.type})`);
  console.log(`  ${winnerCandidate.id}: ${winnerCandidate.wins}W-${winnerCandidate.losses}L`);
  console.log(`  ${loserCandidate.id}: ${loserCandidate.wins}W-${loserCandidate.losses}L`);
  
  return tournament;
}

function getTournamentWinner(tournament) {
  const leader = findTournamentLeader(tournament);
  
  let confidence = 'MODERATE';
  let gap = 0;
  
  const contenders = tournament.candidates
    .filter(c => c.id !== leader.id)
    .sort((a, b) => (b.wins - b.losses) - (a.wins - a.losses));
  
  const runnerUp = contenders[0];
  
  if (runnerUp) {
    const leaderScore = leader.wins - leader.losses;
    const runnerUpScore = runnerUp.wins - runnerUp.losses;
    gap = leaderScore - runnerUpScore;
    
    if (gap >= 2 || (leader.wins >= 2 && leader.losses === 0)) {
      confidence = 'HIGH';
    } else if (gap <= 0) {
      confidence = 'LOW';
    }
  } else {
    confidence = 'HIGH';
  }
  
  return {
    winner: leader,
    runnerUp: runnerUp,
    confidence: confidence,
    gap: gap,
    totalQuestions: tournament.questionCount,
    matchHistory: tournament.matchHistory
  };
}

function startRound3(candidates) {
  console.log('=== ROUND 3: ADAPTIVE TOURNAMENT ===');
  console.log('Incoming candidates:', candidates.map(c => `${c.id} (${Math.round(c.s1*100)}%)`).join(', '));
  
  // Candidates come pre-scored from R1/R2 - use them directly
  // Add combinedScore field for tournament compatibility (same as s1 since calibration already applied)
  const tournamentCandidates = candidates.map(c => ({
    ...c,
    combinedScore: c.s1
  }));
  
  // Take top 5 candidates for tournament
  const topCandidates = tournamentCandidates.slice(0, Math.min(5, tournamentCandidates.length));
  
  // Initialize tournament
  state.tournament = initTournament(topCandidates);
  state.stage = 3;
  state.candidates = topCandidates;  // Keep for debug panel and explanation
  state.qNum = 0;
  state.qTot = 4; // Maximum questions
  
  // Update UI
  document.getElementById('stage-label').textContent = 'Round 3: Final Determination';
  updateHeaderRoundIndicator(3);
  
  // Get first matchup
  const firstMatchup = selectNextMatchup(state.tournament);
  if (!firstMatchup) {
    // No matchups needed - use R1/R2 result directly
    console.log('No matchups needed, using R1/R2 result');
    finishRound3Tournament();
    return;
  }
  
  state.tournament.currentMatchup = firstMatchup;
  showTournamentQuestion();
}

function showTournamentQuestion() {
  const tournament = state.tournament;
  const matchup = tournament.currentMatchup;
  
  // Pick a scenario - rotate through available ones
  // MTG humor scenario only appears in constructed mode (where users opted into MTG elements)
  const baseScenarios = ['CRISIS', 'PLANNING', 'TEAM', 'CHANGE'];
  const scenarioIds = state.mode === 'constructed' 
    ? [...baseScenarios, 'MTG_STALL'] 
    : baseScenarios;
  const scenarioId = scenarioIds[tournament.questionCount % scenarioIds.length];
  const scenario = ROUND2_SCENARIOS[scenarioId];
  
  // Update progress display
  document.getElementById('q-num').textContent = tournament.questionCount + 1;
  document.getElementById('q-tot').textContent = tournament.maxQuestions;
  document.getElementById('stage-label').textContent = 'Round 3: Final Determination';
  
  // Update progress bar
  const pct = ((tournament.questionCount + 1) / tournament.maxQuestions) * 100;
  const prog1 = document.getElementById('prog-s1');
  const prog2 = document.getElementById('prog-s2');
  const prog3 = document.getElementById('prog-s3');
  
  prog1.style.opacity = '0.3';
  prog2.style.opacity = '0.3';
  if (prog3) {
    prog3.style.opacity = '1';
    prog3.style.width = `${pct}%`;
  }
  
  // Build the question UI
  // Get context hint for tournament scenarios
  const tournamentHint = getContextHint(scenario.context, scenarioId);
  const hintHTML = tournamentHint 
    ? `<div style="font-size: 13px; color: #a0a0b0; margin-top: 16px; font-style: italic; text-align: center; padding: 10px 16px; background: rgba(255,255,255,0.03); border-radius: 8px; line-height: 1.5;">
        üí° ${tournamentHint}
       </div>`
    : '';
  
  document.getElementById('ctx').textContent = scenario.context;
  document.getElementById('scenario').innerHTML = scenario.context + hintHTML;
  document.getElementById('instr').innerHTML = 'Choose the response <strong>more like you</strong>.';
  
  // Build the two choices
  const choicesDiv = document.getElementById('choices');
  choicesDiv.innerHTML = '';
  
  // Randomise order
  const options = Math.random() > 0.5 
    ? [matchup.a, matchup.b] 
    : [matchup.b, matchup.a];
  
  options.forEach((candidate, i) => {
    const profile = PROFILES[candidate.id];
    const colors = profile?.colors || [];
    const responseText = scenario.responses[candidate.id] || `[Response for ${candidate.id}]`;
    
    const btn = document.createElement('button');
    btn.className = 'choice-button';
    btn.style.cssText = 'flex-direction: column; align-items: flex-start; padding: 20px;';
    btn.onclick = () => selectTournamentChoice(candidate.id);
    
    // Header with mana symbols (constructed mode only) or letter (draft mode)
    const headerDiv = document.createElement('div');
    headerDiv.style.cssText = 'display: flex; align-items: center; gap: 12px; margin-bottom: 12px; width: 100%;';
    
    if (state.mode === 'constructed') {
      // Show mana symbols and name
      const symbolsDiv = document.createElement('div');
      symbolsDiv.style.cssText = 'display: flex; gap: 6px;';
      colors.forEach(c => {
        const symbol = document.createElement('span');
        symbol.className = `mana-symbol mana-${c}`;
        symbol.style.cssText = 'width: 28px; height: 28px; font-size: 14px;';
        symbol.textContent = c;
        symbolsDiv.appendChild(symbol);
      });
      headerDiv.appendChild(symbolsDiv);
      
      const nameSpan = document.createElement('span');
      nameSpan.style.cssText = 'font-weight: 700; font-size: 14px; color: #a78bfa; text-transform: uppercase; letter-spacing: 0.5px;';
      nameSpan.textContent = profile?.name || candidate.id;
      headerDiv.appendChild(nameSpan);
      
      btn.appendChild(headerDiv);
    }
    // Draft mode: no header, just the response text (consistent with R1/R2)
    
    // Response text
    const textDiv = document.createElement('div');
    textDiv.style.cssText = 'font-size: 15px; line-height: 1.6; color: #e0e0e0;';
    textDiv.textContent = responseText;
    btn.appendChild(textDiv);
    
    choicesDiv.appendChild(btn);
  });
  
  updateDebug();
  // Scroll to question card for better mobile experience
  const scenarioEl = document.getElementById('scenario');
  if (scenarioEl) {
    scenarioEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
  } else {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
}

function selectTournamentChoice(winnerId) {
  console.log(`Tournament Q${state.tournament.questionCount + 1}: Selected ${winnerId}`);
  
  // Record result
  recordTournamentResult(state.tournament, winnerId);
  
  // Check for early termination
  const termCheck = shouldTerminateEarly(state.tournament);
  if (termCheck.terminate) {
    console.log(`EARLY TERMINATION: ${termCheck.reason} - ${termCheck.message}`);
    state.tournament.terminated = true;
    state.tournament.termReason = termCheck;
    finishRound3Tournament();
    return;
  }
  
  // Check max questions
  if (state.tournament.questionCount >= state.tournament.maxQuestions) {
    console.log('MAX QUESTIONS reached');
    finishRound3Tournament();
    return;
  }
  
  // Get next matchup
  const nextMatchup = selectNextMatchup(state.tournament);
  if (!nextMatchup) {
    console.log('No more matchups available');
    finishRound3Tournament();
    return;
  }
  
  state.tournament.currentMatchup = nextMatchup;
  showTournamentQuestion();
}

function finishRound3Tournament() {
  console.log('=== ROUND 3 TOURNAMENT COMPLETE ===');
  
  const result = getTournamentWinner(state.tournament);
  
  console.log('Winner:', result.winner.id);
  console.log('Runner-up:', result.runnerUp?.id);
  console.log('Confidence:', result.confidence);
  console.log('Questions asked:', result.totalQuestions);
  console.log('Match history:', result.matchHistory.map(m => `${m.winner.id} > ${m.loser.id}`).join(', '));
  
  // Build allResults from tournament candidates, sorted by performance
  const sortedCandidates = [...state.tournament.candidates].sort((a, b) => {
    // Primary: win-loss differential
    const aDiff = a.wins - a.losses;
    const bDiff = b.wins - b.losses;
    if (bDiff !== aDiff) return bDiff - aDiff;
    // Secondary: win rate
    const aRate = a.wins / Math.max(1, a.wins + a.losses);
    const bRate = b.wins / Math.max(1, b.wins + b.losses);
    if (bRate !== aRate) return bRate - aRate;
    // Tertiary: original combined score
    return (b.combinedScore || 0) - (a.combinedScore || 0);
  });
  
  const allResults = sortedCandidates.map(c => [c.id, {
    s1: c.combinedScore || 0,
    s2: (c.wins - c.losses + 2) / 4, // Normalize tournament performance to 0-1
    combined: c.combinedScore || 0,
    wins: c.wins,
    losses: c.losses,
    isTournament: true
  }]);
  
  console.log('allResults for display:', allResults.map(a => `${a[0]}(${a[1].wins}W-${a[1].losses}L)`).join(', '));
  
  // Store result in format compatible with existing results display
  state.result = {
    identity: result.winner.id,
    confidence: result.confidence,
    allResults: allResults,
    round3Data: {
      allScores: state.tournament.candidates.map(c => ({
        id: c.id,
        wins: c.wins,
        losses: c.losses,
        combinedScore: c.combinedScore
      })).sort((a, b) => (b.wins - b.losses) - (a.wins - a.losses)),
      gap: result.gap,
      runnerUp: result.runnerUp ? {
        id: result.runnerUp.id,
        wins: result.runnerUp.wins,
        losses: result.runnerUp.losses
      } : null,
      matchHistory: result.matchHistory,
      terminated: state.tournament.terminated,
      termReason: state.tournament.termReason,
      isTournament: true
    }
  };
  
  // Show transition then results
  showRoundTransition(3, 4, () => {
    showCalculating();
  });
}

// Alias for backward compatibility
function startS2(candidates) {
  startRound3(candidates);
}

// refineWithCalibration REMOVED - calibration is now applied once in calculateCalibratedActivation
// Candidates from recalculateCandidates go directly to tournament

function identifyNeededDiscriminations(candidates) {
  const discriminations = [];
  
  if (candidates.length < 2) {
    return ['CONFIRM'];
  }
  
  const top = candidates[0];
  const second = candidates[1];
  const gap = top.combinedScore - second.combinedScore;
  
  // What kind of discrimination do we need?
  const topType = getCandidateType(top.id);
  const secondType = getCandidateType(second.id);
  
  // Close race between same types
  if (gap < 0.15 && topType === secondType) {
    discriminations.push(`${topType}_VS_${topType}`);
  }
  
  // Need to determine width (mono vs guild vs three)
  if (topType !== secondType) {
    discriminations.push('WIDTH');
  }
  
  // Check if calibration revealed anything we need to verify
  if (state.calibrationAnswers) {
    const suppressionChecks = state.calibrationAnswers.filter(a => a.type === 'SUPPRESSION');
    const noiseChecks = state.calibrationAnswers.filter(a => a.type === 'NOISE');
    
    if (suppressionChecks.length > 0) {
      discriminations.push('SUPPRESSION_VERIFY');
    }
    if (noiseChecks.length > 0) {
      discriminations.push('NOISE_VERIFY');
    }
  }
  
  // Default
  if (discriminations.length === 0) {
    discriminations.push('GENERAL');
  }
  
  return discriminations;
}

function buildRankingInterface(question) {
  let html = '<div style="max-width: 700px; margin: 0 auto;">';
  
  html += '<div class="ranking-instructions">';
  html += '<p style="font-size: 15px; color: #e0e0e0; margin-bottom: 12px;">We\'ve pre-ranked these based on your earlier answers. <strong>Does this feel right?</strong></p>';
  html += '<p style="color: #a0a0b0;"><strong>Drag to reorder</strong> if something feels off. Put your most natural response at #1.</p>';
  html += '<p style="font-size: 13px; color: #808090; margin-top: 12px; font-style: italic;">No pressure to change anything‚Äîif it looks right, just hit Continue.</p>';
  html += '</div>';
  
  html += '<div class="ranking-list" id="ranking-list">';
  
  question.options.forEach((opt, idx) => {
    const colors = PROFILES[opt.id]?.colors || [];
    
    html += `<div class="rank-item" draggable="true" data-option-id="${opt.id}" data-original-index="${idx}">`;
    html += `<div class="rank-number">${idx + 1}</div>`;
    
    // Add mana symbols in constructed mode
    if (state.mode === 'constructed' && colors.length > 0) {
      html += '<div style="display: flex; flex-direction: column; align-items: center; gap: 4px; margin-right: 16px; min-width: 60px;">';
      html += '<div style="display: flex; gap: 4px;">';
      colors.forEach(c => {
        html += `<span class="mana-symbol mana-${c}" style="width: 24px; height: 24px; font-size: 12px;">${c}</span>`;
      });
      html += '</div>';
      // Add identity name below symbols
      html += `<div style="font-size: 10px; font-weight: 700; color: #a78bfa; text-transform: uppercase; letter-spacing: 0.5px;">${opt.id}</div>`;
      html += '</div>';
    }
    
    html += '<div style="flex: 1;">';
    html += `<div class="rank-text">${opt.text}</div>`;
    html += '</div>';
    html += '</div>';
  });
  
  html += '</div>';
  html += '<button class="btn-primary" style="width: 100%; margin-top: 24px;" onclick="submitRanking()">Continue</button>';
  html += '</div>';
  
  return html;
}

function initRanking() {
  const items = document.querySelectorAll('.rank-item');
  
  items.forEach(item => {
    item.addEventListener('dragstart', e => {
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', e.target.dataset.optionId);
      e.target.classList.add('dragging');
    });
    
    item.addEventListener('dragend', e => {
      e.target.classList.remove('dragging');
    });
    
    item.addEventListener('dragover', e => {
      e.preventDefault();
      const dragging = document.querySelector('.dragging');
      const list = e.currentTarget.parentNode;
      const afterElement = getDragAfterElement(list, e.clientY);
      
      if (afterElement == null) {
        list.appendChild(dragging);
      } else {
        list.insertBefore(dragging, afterElement);
      }
      
      updateRankNumbers();
    });
  });
}

function getDragAfterElement(container, y) {
  const draggableElements = [...container.querySelectorAll('.rank-item:not(.dragging)')];
  
  return draggableElements.reduce((closest, child) => {
    const box = child.getBoundingClientRect();
    const offset = y - box.top - box.height / 2;
    
    if (offset < 0 && offset > closest.offset) {
      return { offset: offset, element: child };
    } else {
      return closest;
    }
  }, { offset: Number.NEGATIVE_INFINITY }).element;
}

function updateRankNumbers() {
  const items = document.querySelectorAll('.rank-item');
  items.forEach((item, idx) => {
    item.querySelector('.rank-number').textContent = idx + 1;
  });
}

function submitRanking() {
  const items = document.querySelectorAll('.rank-item');
  const rankings = {};
  
  items.forEach((item, idx) => {
    const optionId = item.dataset.optionId;
    rankings[optionId] = idx + 1; // Rank 1-N
  });
  
  // Store rankings - use round3Rankings if available, fall back to round2Rankings
  const rankingsStore = state.round3Rankings || state.round2Rankings;
  Object.entries(rankings).forEach(([id, rank]) => {
    if (rankingsStore[id]) {
      rankingsStore[id].push(rank);
    }
  });
  
  console.log('Round 3 Q' + (state.qNum + 1) + ' rankings:', rankings);
  
  state.qNum++;
  if (state.qNum < state.qTot) {
    showQ();
  } else {
    finishRound3();
  }
}

function finishRound3() {
  console.log('=== ROUND 3 COMPLETE ===');
  
  // Use round3Rankings if available, fall back to round2Rankings
  const rankingsStore = state.round3Rankings || state.round2Rankings;
  
  // Track what was EXPECTED going into Round 3 (top candidate by combinedScore)
  const expectedWinner = state.candidates?.[0];
  const expectedType = expectedWinner ? getCandidateType(expectedWinner.id) : null;
  console.log('Expected winner going into R3:', expectedWinner?.id, '(type:', expectedType, ')');
  
  // Calculate average rank per candidate (lower = better)
  const candidateScores = Object.entries(rankingsStore).map(([id, ranks]) => {
    // Find the candidate's combined score from earlier rounds
    let priorScore = 0;
    const candidate = state.candidates?.find(c => c.id === id);
    if (candidate) {
      priorScore = candidate.combinedScore || candidate.s1 || 0;
    }
    
    return {
      id: id,
      ranks: ranks,
      avgRank: ranks.length > 0 ? ranks.reduce((a,b) => a+b, 0) / ranks.length : 5,
      bestRank: ranks.length > 0 ? Math.min(...ranks) : 5,
      worstRank: ranks.length > 0 ? Math.max(...ranks) : 5,
      priorScore: priorScore
    };
  }).sort((a,b) => a.avgRank - b.avgRank); // Sort by average rank (ascending)
  
  console.log('Average ranks:', candidateScores.map(c => `${c.id}:${c.avgRank.toFixed(2)}`).join(', '));
  
  const winner = candidateScores[0];
  const runnerUp = candidateScores[1];
  const actualType = getCandidateType(winner.id);
  
  // Detect "width shift" - when R3 rankings chose a different identity width than expected
  // Examples: expected MONO but chose GUILD, expected FOUR but chose THREE
  let widthShift = false;
  let shiftDirection = null;
  
  if (expectedType && actualType && expectedType !== actualType) {
    const typeOrder = {'MONO': 1, 'GUILD': 2, 'THREE': 3, 'FOUR': 4, 'FIVE': 5};
    const expectedWidth = typeOrder[expectedType] || 0;
    const actualWidth = typeOrder[actualType] || 0;
    
    if (expectedWidth !== actualWidth) {
      widthShift = true;
      shiftDirection = actualWidth > expectedWidth ? 'wider' : 'narrower';
      console.log(`WIDTH SHIFT DETECTED: Expected ${expectedType} (${expectedWidth}), got ${actualType} (${actualWidth}) - shifted ${shiftDirection}`);
    }
  }
  
  // Calculate confidence based on winner consistency AND gap
  const gap = runnerUp ? (runnerUp.avgRank - winner.avgRank) : 2;
  const numCandidates = candidateScores.length;
  
  // Calculate how consistently winner was ranked #1
  const winnerRanks = winner.ranks || [];
  const timesRankedFirst = winnerRanks.filter(r => r === 1).length;
  const totalRankings = winnerRanks.length || 4;
  const winnerConsistency = timesRankedFirst / totalRankings;
  
  // Also check variance - low variance in winner's ranks = high confidence
  const winnerVariance = winnerRanks.length > 0 
    ? winnerRanks.reduce((sum, r) => sum + Math.pow(r - winner.avgRank, 2), 0) / winnerRanks.length
    : 1;
  
  let confidence;
  
  // PRIMARY: If winner was ranked #1 on 75%+ of scenarios, that's HIGH confidence
  if (winnerConsistency >= 0.75) {
    confidence = 'HIGH';
  }
  // SECONDARY: If winner was ranked #1 on 50%+ AND has low variance, that's MODERATE+
  else if (winnerConsistency >= 0.5 && winnerVariance < 1) {
    confidence = 'MODERATE';
  }
  // TERTIARY: Fall back to gap-based calculation
  else {
    const maxPossibleGap = numCandidates - 1;
    const normalizedGap = gap / Math.max(1, maxPossibleGap);
    
    if (normalizedGap >= 0.5) confidence = 'HIGH';
    else if (normalizedGap >= 0.25) confidence = 'MODERATE';
    else confidence = 'LOW';
  }
  
  // BOOST: If Round 1 showed 20+ percentage point gap, boost MODERATE ‚Üí HIGH
  // BUT only if there was no width shift
  if (state.activationSorted && state.activationSorted.length >= 2 && confidence === 'MODERATE' && !widthShift) {
    const topRate = state.activationSorted[0][1];
    const secondRate = state.activationSorted[1][1];
    const r1Gap = topRate - secondRate;
    if (r1Gap >= 0.20) {
      confidence = 'HIGH';
    }
  }
  
  // WIDTH SHIFT PENALTY: If user's R3 choices shifted to a different width, cap at MODERATE
  // This indicates the scoring predicted one thing but the user's preferences showed another
  if (widthShift && confidence === 'HIGH') {
    confidence = 'MODERATE';
    console.log('Confidence capped at MODERATE due to width shift');
  }
  
  console.log('Winner consistency:', winnerConsistency, 'variance:', winnerVariance.toFixed(2));
  
  console.log('Winner:', winner.id, 'avg rank:', winner.avgRank.toFixed(2));
  console.log('Runner-up:', runnerUp?.id, 'avg rank:', runnerUp?.avgRank.toFixed(2));
  console.log('Gap:', gap.toFixed(2), 'Confidence:', confidence);
  
  // Build allResults combining all three rounds
  const allResults = candidateScores.map(cand => {
    const r3Score = Math.max(0, (4 - cand.avgRank) / 3); // Round 3 ranking score
    const r1Score = cand.priorScore || 0; // Includes Round 1 + calibration
    
    // Weight: R1+R2 calibration gets 60%, R3 ranking gets 40%
    const combined = r1Score * 0.6 + r3Score * 0.4;
    
    return [cand.id, {
      s1: r1Score,
      s2: r3Score,
      combined: combined,
      calibrationApplied: state.calibrationAnswers?.length > 0
    }];
  });
  
  state.result = {
    identity: winner.id,
    confidence: confidence,
    profile: PROFILES[winner.id],
    allResults: allResults,
    round3Data: {
      allScores: candidateScores,
      gap: gap,
      runnerUp: runnerUp,
      calibrationUsed: state.calibrationAnswers?.length > 0,
      discriminationsNeeded: state.discriminationsNeeded,
      // NEW: Track divergence between expected and actual
      expectedWinner: expectedWinner?.id,
      expectedType: expectedType,
      actualType: actualType,
      widthShift: widthShift,
      shiftDirection: shiftDirection
    }
  };
  
  // Show transition to results
  showRoundTransition(3, 4, () => {
    showResults();
  });
}

// Alias for backward compatibility
function finishS2() {
  finishRound3();
}

function showCalculating() {
  document.getElementById('screen-assessment').classList.add('hidden');
  document.getElementById('screen-calculating').classList.remove('hidden');
  
  // Show calculating for 2 seconds then show results
  setTimeout(() => {
    document.getElementById('screen-calculating').classList.add('hidden');
    showResults();
  }, 2000);
}

function showRoundTransition(fromRound, toRound, callback) {
  const transitionScreen = document.getElementById('screen-round-transition');
  const indicator = document.getElementById('transition-round-indicator');
  const title = document.getElementById('transition-title');
  const subtitle = document.getElementById('transition-subtitle');
  
  // Hide all other screens
  document.getElementById('screen-assessment').classList.add('hidden');
  document.getElementById('screen-interstitial').classList.add('hidden');
  
  // Build round indicator with progressively saturating colors
  const roundColors = [
    { bg: 'rgba(139, 92, 246, 0.25)', border: 'rgba(139, 92, 246, 0.4)', text: '#a78bfa' },
    { bg: 'rgba(168, 85, 247, 0.35)', border: 'rgba(168, 85, 247, 0.5)', text: '#c084fc' },
    { bg: 'rgba(192, 132, 252, 0.45)', border: 'rgba(192, 132, 252, 0.6)', text: '#d8b4fe' },
    { bg: 'linear-gradient(135deg, rgba(232, 121, 249, 0.6), rgba(244, 114, 182, 0.6))', border: 'rgba(232, 121, 249, 0.8)', text: '#fdf4ff' }
  ];
  
  let indicatorHTML = '';
  for (let i = 1; i <= 4; i++) {
    const color = roundColors[i - 1];
    const isComplete = i <= fromRound;
    const isCurrent = i === toRound;
    const isFuture = i > toRound;
    
    // Connecting line (except after last)
    if (i > 1) {
      const lineColor = isComplete || isCurrent ? 'rgba(192, 132, 252, 0.5)' : 'rgba(255, 255, 255, 0.1)';
      indicatorHTML += `<div style="width: 24px; height: 2px; background: ${lineColor}; margin: 0 -4px;"></div>`;
    }
    
    // Round circle
    if (i === 4) {
      // Results - star symbol
      indicatorHTML += `<div class="round-number-complete" style="background: ${isComplete ? color.bg : 'rgba(255,255,255,0.05)'}; border: 2px solid ${isComplete ? color.border : 'rgba(255,255,255,0.2)'}; color: ${isComplete ? color.text : '#606070'}; ${isCurrent ? 'box-shadow: 0 0 16px rgba(232, 121, 249, 0.5);' : ''}">‚ú¶</div>`;
    } else {
      indicatorHTML += `<div class="round-number-complete" style="background: ${isComplete ? color.bg : 'rgba(255,255,255,0.05)'}; border: 2px solid ${isComplete ? color.border : 'rgba(255,255,255,0.2)'}; color: ${isComplete ? color.text : '#606070'}; ${isCurrent ? 'box-shadow: 0 0 16px rgba(168, 85, 247, 0.5);' : ''}">${i}</div>`;
    }
  }
  
  indicator.innerHTML = indicatorHTML;
  
  // Set text
  const roundNames = {
    1: 'Enemy Pairs',
    2: 'Calibration',
    3: 'Final Determination',
    4: 'Results'
  };
  
  title.textContent = `Round ${fromRound} Complete`;
  subtitle.innerHTML = `<span style="color: #c084fc;">Round ${toRound}: ${roundNames[toRound]}</span> loading...`;
  
  transitionScreen.classList.remove('hidden');
  
  // Wait then proceed
  setTimeout(() => {
    transitionScreen.classList.add('hidden');
    if (callback) callback();
  }, 1500);
}

function updateHeaderRoundIndicator(currentRound) {
  // Update dots
  for (let i = 1; i <= 4; i++) {
    const dot = document.getElementById(`round-dot-${i}`);
    if (!dot) continue;
    
    dot.classList.remove('active', 'complete');
    if (i < currentRound) {
      dot.classList.add('complete');
    } else if (i === currentRound) {
      dot.classList.add('active');
    }
  }
  
  // Update connectors
  for (let i = 1; i <= 3; i++) {
    const connector = document.getElementById(`connector-${i}-${i+1}`);
    if (!connector) continue;
    
    connector.classList.remove('active', 'complete');
    if (i < currentRound - 1) {
      connector.classList.add('complete');
    } else if (i === currentRound - 1) {
      connector.classList.add('active');
    }
  }
  
  // Update labels
  const leftLabel = document.getElementById('round-label-left');
  const rightLabel = document.getElementById('round-label-right');
  
  const roundNames = {
    1: 'Round 1: Enemy Pairs',
    2: 'Round 2: Calibration', 
    3: 'Round 3: Final Determination',
    4: 'Results'
  };
  
  if (leftLabel) {
    leftLabel.textContent = roundNames[currentRound] || '';
  }
  
  if (rightLabel) {
    const remaining = [];
    for (let i = currentRound + 1; i <= 4; i++) {
      remaining.push(roundNames[i]);
    }
    rightLabel.textContent = remaining.length > 0 ? '‚Üí ' + remaining.join(' ‚Üí ') : '';
    rightLabel.style.opacity = remaining.length > 0 ? '0.5' : '0';
  }
}

function generateIdentityExplanation(identity, activationSorted) {
  const pct = (act) => Math.round(act * 100);
  const colorName = {W:'White', U:'Blue', B:'Black', R:'Red', G:'Green'};
  
  // Get guild/three-color/etc colors
  let idColors = [];
  if (identity.startsWith('MONO-')) {
    idColors = [identity.split('-')[1]];
  } else if (PROFILES[identity]) {
    idColors = PROFILES[identity].colors;
  }
  
  // Get confidence and round 3 data for context
  const confidence = state.result?.confidence || 'MODERATE';
  const round3Data = state.result?.round3Data;
  const wasConsistent = round3Data?.allScores?.[0]?.ranks?.filter(r => r === 1).length >= 3;
  
  // Generate explanation based on pattern AND how we got there
  if (identity.startsWith('MONO-')) {
    const color = idColors[0];
    const topPct = pct(activationSorted[0][1]);
    
    if (wasConsistent) {
      return `${colorName[color]} dominated your choices across all three rounds. You consistently picked ${colorName[color]}-aligned approaches over alternatives.`;
    } else if (confidence === 'HIGH') {
      return `${colorName[color]} emerged clearly as your primary driver. The gap between ${colorName[color]} and other colors was consistent throughout.`;
    } else {
      return `${colorName[color]} came out on top, though you showed some flexibility. You lean ${colorName[color]} but aren't rigid about it.`;
    }
  }
  else if (idColors.length === 2) {
    const c1 = idColors[0], c2 = idColors[1];
    const c1Name = colorName[c1], c2Name = colorName[c2];
    
    if (wasConsistent) {
      return `You consistently chose ${identity} approaches over mono-color and other guild options. The ${c1Name}-${c2Name} combination resonates with how you actually think.`;
    } else if (confidence === 'HIGH') {
      return `The ${c1Name}-${c2Name} combination emerged clearly. You blend both colors rather than leaning heavily into just one.`;
    } else if (confidence === 'MODERATE') {
      return `${c1Name} and ${c2Name} both showed up strongly, and you preferred their combination over single-color approaches. The balance between them may shift by context.`;
    } else {
      return `You landed on ${identity}, but it was close. You have ${c1Name}-${c2Name} tendencies, but could plausibly operate in adjacent modes too.`;
    }
  }
  else if (idColors.length === 3) {
    const names = idColors.map(c => colorName[c]);
    
    if (wasConsistent) {
      return `You consistently preferred three-color approaches over simpler options. ${names.join(', ')} work together in how you operate‚Äîyou're not easily reduced to two colors.`;
    } else if (confidence === 'HIGH') {
      return `Three colors emerged as genuinely active: ${names.join(', ')}. You blend all three rather than focusing on a pair.`;
    } else {
      return `${names.join(', ')} all showed up in your choices. You operate across this three-color space, though which colors dominate may vary by situation.`;
    }
  }
  else if (idColors.length === 4) {
    const absent = ['W','U','B','R','G'].find(c => !idColors.includes(c));
    const absentName = colorName[absent];
    
    return `Four colors are active for you‚Äîeverything except ${absentName}. You're versatile but have a clear blind spot or disinterest in ${absentName} approaches.`;
  }
  else {
    if (confidence === 'HIGH') {
      return `All five colors showed up meaningfully. You're genuinely versatile, drawing on different approaches as situations demand.`;
    } else {
      return `You spread across all five colors without a clear dominant pattern. You may be highly adaptable, or your style shifts significantly by context.`;
    }
  }
}

// ============================================================================
// ENHANCEMENT: Pattern Testing Display (Stage 2 only)
// ============================================================================

function displayStage1Explanation() {
  const container = document.getElementById('stage1-explanation-content');
  if (!container) return;
  
  // Get activation from state
  let activation;
  if (state.activationSorted && state.activationSorted.length > 0) {
    activation = {};
    state.activationSorted.forEach(([color, value]) => {
      activation[color] = value;
    });
  } else {
    // Recalculate if not available
    activation = {
      W: (state.pairwise['W-B'].W / 6 + state.pairwise['W-R'].W / 6) / 2,
      U: (state.pairwise['U-R'].U / 6 + state.pairwise['G-U'].U / 6) / 2,
      B: (state.pairwise['W-B'].B / 6 + state.pairwise['B-G'].B / 6) / 2,
      R: (state.pairwise['U-R'].R / 6 + state.pairwise['W-R'].R / 6) / 2,
      G: (state.pairwise['G-U'].G / 6 + state.pairwise['B-G'].G / 6) / 2
    };
  }
  
  const sorted = Object.entries(activation).sort((a,b) => b[1] - a[1]);
  
  let html = '';
  
  // Show activation bars
  html += '<div style="margin-bottom: 24px;">';
  html += '<div style="font-size: 14px; font-weight: 600; color: #e0e0e0; margin-bottom: 12px;">Color Activation Strength</div>';
  html += '<div style="font-size: 13px; color: #a0a0b0; margin-bottom: 16px;">Based on 30 forced-choice questions testing enemy color pairs</div>';
  
  const colorNames = { W: 'WHITE', U: 'BLUE', B: 'BLACK', R: 'RED', G: 'GREEN' };
  const barColors = {W:'#FDE047', U:'#93C5FD', B:'#D1D5DB', R:'#FCA5A5', G:'#6EE7B7'};
  
  sorted.forEach(([color, value], idx) => {
    const pct = Math.round(value * 100);
    const isActive = PROFILES[state.result.identity]?.colors?.includes(color);
    
    html += '<div style="margin: 12px 0; padding: 12px; background: rgba(255,255,255,' + (isActive ? '0.05' : '0.02') + '); border: 1px solid rgba(255,255,255,' + (isActive ? '0.2' : '0.1') + '); border-radius: 8px;">';
    html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">';
    html += '<div style="display: flex; align-items: center; gap: 12px;">';
    html += '<span class="mana-symbol mana-' + color + '" style="width: 24px; height: 24px; font-size: 12px;">' + color + '</span>';
    html += '<span style="font-weight: 600; font-size: 15px; color: ' + (isActive ? '#e0e0e0' : '#808090') + ';">' + colorNames[color] + '</span>';
    if (isActive) {
      html += '<span style="font-size: 12px; color: #10B981; font-weight: 600;">‚úì IN YOUR IDENTITY</span>';
    }
    html += '</div>';
    html += '<span style="font-weight: 600; font-size: 16px; color: ' + barColors[color] + ';">' + pct + '%</span>';
    html += '</div>';
    html += '<div style="background: rgba(255,255,255,0.1); height: 12px; border-radius: 6px; overflow: hidden;">';
    html += '<div style="background: ' + barColors[color] + '; width: ' + pct + '%; height: 100%; border-radius: 6px; transition: width 0.8s;"></div>';
    html += '</div>';
    html += '</div>';
  });
  
  html += '</div>';
  
  // Explain the gap detection
  const topColors = PROFILES[state.result.identity]?.colors || [];
  const numColors = topColors.length;
  
  html += '<div style="padding: 16px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 10px; margin-top: 16px;">';
  html += '<div style="font-weight: 700; color: #10B981; margin-bottom: 8px;">üéØ Gap Detection Logic</div>';
  html += '<div style="font-size: 14px; color: #c0d0c0; line-height: 1.7;">';
  
  if (numColors === 1) {
    html += 'We found a <strong>large gap</strong> after the top color (' + Math.round(sorted[0][1] * 100) + '% vs ' + Math.round(sorted[1][1] * 100) + '%). ';
    html += 'This indicates <strong>mono-color</strong>: one dominant philosophy.';
  } else if (numColors === 2) {
    html += 'The top 2 colors scored significantly higher (' + Math.round(sorted[0][1] * 100) + '% and ' + Math.round(sorted[1][1] * 100) + '%) with a gap before the third (' + Math.round(sorted[2][1] * 100) + '%). ';
    html += 'This indicates <strong>two-color guild</strong>: two complementary philosophies.';
  } else if (numColors === 3) {
    html += 'The top 3 colors clustered together (' + Math.round(sorted[0][1] * 100) + '%, ' + Math.round(sorted[1][1] * 100) + '%, ' + Math.round(sorted[2][1] * 100) + '%) with a gap before the fourth (' + Math.round(sorted[3][1] * 100) + '%). ';
    html += 'This indicates <strong>three-color</strong>: three interacting philosophies.';
  } else if (numColors === 4) {
    html += 'The top 4 colors were all strong (' + Math.round(sorted[0][1] * 100) + '%-' + Math.round(sorted[3][1] * 100) + '%) with ' + colorNames[sorted[4][0]] + ' clearly weaker (' + Math.round(sorted[4][1] * 100) + '%). ';
    html += 'This indicates <strong>four-color</strong>: defined by what\'s missing.';
  } else {
    html += 'All 5 colors scored within a narrow range (' + Math.round(sorted[0][1] * 100) + '%-' + Math.round(sorted[4][1] * 100) + '%). ';
    html += 'This indicates <strong>five-color</strong>: balanced across all philosophies.';
  }
  
  html += '</div>';
  html += '</div>';
  
  container.innerHTML = html;
}

function displayRound2Bars() {
  // Show the Round 2 section
  const round2Section = document.getElementById('round2-unified-section');
  if (!round2Section) {
    console.log('Round 2 section element not found');
    return;
  }
  
  // Check if we have Round 2 data
  if (!state.result.round2Data || !state.result.round2Data.allScores) {
    round2Section.style.display = 'none';
    return;
  }
  
  round2Section.style.display = 'block';
  
  const allScores = state.result.round2Data.allScores;
  const winnerIdentity = state.result.identity;
  const gap = state.result.round2Data.gap;
  const runnerUp = state.result.round2Data.runnerUp;
  const numQuestions = state.qTot || 4;
  
  // Update question count
  const qCountEl = document.getElementById('round2-question-count');
  if (qCountEl) qCountEl.textContent = `${numQuestions} ranking scenarios`;
  
  // INTRO: Explain what Round 2 tested
  const introDiv = document.getElementById('round2-intro-text');
  if (introDiv) {
    let introHTML = '<p style="margin-bottom: 12px;">';
    introHTML += 'Your Round 1 pattern activated multiple colors, creating ambiguity about your exact identity. ';
    introHTML += 'We generated <strong>' + allScores.length + ' candidate identities</strong> based on possible color combinations:</p>';
    introHTML += '<div style="display: flex; flex-wrap: wrap; gap: 8px; margin: 16px 0;">';
    allScores.forEach(cand => {
      const prof = PROFILES[cand.id];
      if (prof) {
        const isWinner = cand.id === winnerIdentity;
        introHTML += '<div style="padding: 6px 12px; background: rgba(' + (isWinner ? '16,185,129' : '255,255,255') + ', 0.08); border: 1px solid rgba(' + (isWinner ? '16,185,129' : '255,255,255') + ', 0.2); border-radius: 20px; font-size: 12px; display: flex; align-items: center; gap: 6px;">';
        prof.colors.forEach(c => {
          introHTML += '<span class="mana-symbol mana-' + c + '" style="width: 16px; height: 16px; font-size: 9px;">' + c + '</span>';
        });
        introHTML += '<span style="font-weight: 600;">' + prof.name + '</span>';
        if (isWinner) introHTML += ' <span style="color: #10B981;">‚úì</span>';
        introHTML += '</div>';
      }
    });
    introHTML += '</div>';
    introHTML += '<p>We presented workplace scenarios and asked you to <strong>rank</strong> how each identity would respond. ';
    introHTML += 'Your rankings revealed which decision-making style feels most natural.</p>';
    
    introDiv.innerHTML = introHTML;
  }
  
  // RANKINGS: Show how each candidate ranked
  const r2Bars = document.getElementById('round2-bars');
  if (!r2Bars) return;
  
  let barsHTML = '<div style="margin: 24px 0;">';
  barsHTML += '<div style="font-size: 15px; font-weight: 700; color: #e0e0e0; margin-bottom: 12px;">How Each Identity Ranked</div>';
  barsHTML += '<div style="font-size: 13px; color: #a0a0b0; margin-bottom: 16px;">Lower average rank = better fit (1st place is best)</div>';
  
  allScores.forEach((cand, idx) => {
    const isWinner = cand.id === winnerIdentity;
    const prof = PROFILES[cand.id];
    const avgRank = cand.avgRank.toFixed(2);
    const barWidth = Math.max(5, (5 - cand.avgRank) / 4 * 100);
    
    const bgColor = isWinner ? 'rgba(16, 185, 129, 0.1)' : 'rgba(255,255,255,0.02)';
    const borderColor = isWinner ? 'rgba(16, 185, 129, 0.4)' : 'rgba(255,255,255,0.08)';
    const barColor = isWinner ? 'linear-gradient(90deg, #10B981, #6EE7B7)' : 'rgba(139, 92, 246, 0.25)';
    
    barsHTML += '<div style="margin: 12px 0; padding: 14px; background: ' + bgColor + '; border: 1px solid ' + borderColor + '; border-radius: 10px;">';
    barsHTML += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">';
    barsHTML += '<div style="display: flex; align-items: center; gap: 12px;">';
    
    // Rank badge
    barsHTML += '<div style="background: rgba(' + (isWinner ? '16,185,129' : '139,92,246') + ', 0.2); color: ' + (isWinner ? '#10B981' : '#a78bfa') + '; font-weight: 700; font-size: 16px; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">' + (idx + 1) + '</div>';
    
    // Identity info
    barsHTML += '<div>';
    if (prof) {
      barsHTML += '<div style="display: flex; align-items: center; gap: 4px; margin-bottom: 4px;">';
      prof.colors.forEach(c => {
        barsHTML += '<span class="mana-symbol mana-' + c + '" style="width: 18px; height: 18px; font-size: 10px;">' + c + '</span>';
      });
      barsHTML += '</div>';
      barsHTML += '<div style="font-weight: ' + (isWinner ? '700' : '600') + '; color: ' + (isWinner ? '#e0e0e0' : '#a0a0b0') + '; font-size: 14px;">';
      if (isWinner) barsHTML += '‚úì ';
      barsHTML += prof.name + '</div>';
    }
    barsHTML += '</div>';
    
    barsHTML += '</div>';
    barsHTML += '<span style="color: ' + (isWinner ? '#10B981' : '#909090') + '; font-weight: 700; font-size: 15px;">Avg: ' + avgRank + '</span>';
    barsHTML += '</div>';
    
    // Visual bar
    barsHTML += '<div style="background: rgba(255,255,255,0.06); height: 8px; border-radius: 4px; overflow: hidden;">';
    barsHTML += '<div style="background: ' + barColor + '; width: ' + barWidth + '%; height: 100%; border-radius: 4px; transition: width 0.6s;"></div>';
    barsHTML += '</div>';
    barsHTML += '</div>';
  });
  
  barsHTML += '<div style="font-size: 12px; color: #808090; margin-top: 12px; font-style: italic;">';
  barsHTML += 'Each identity was ranked in ' + numQuestions + ' scenarios. Lower average = more natural fit.';
  barsHTML += '</div>';
  barsHTML += '</div>';
  
  r2Bars.innerHTML = barsHTML;
  
  // EXPLANATION: Why this identity won
  const explanation = document.getElementById('round2-testing-explanation');
  if (!explanation) return;
  
  let explainHTML = '<div style="padding: 20px; background: rgba(16, 185, 129, 0.08); border-left: 4px solid #10B981; border-radius: 8px;">';
  explainHTML += '<div style="font-weight: 700; color: #10B981; margin-bottom: 12px; font-size: 15px;">‚úì Why ' + (PROFILES[winnerIdentity] ? PROFILES[winnerIdentity].name : winnerIdentity) + '</div>';
  explainHTML += '<div style="font-size: 14px; color: #d0d0d0; line-height: 1.7;">';
  
  if (runnerUp) {
    explainHTML += '<p style="margin-bottom: 12px;">You ranked <strong>' + (PROFILES[winnerIdentity] ? PROFILES[winnerIdentity].name : winnerIdentity) + '</strong> responses highest with an average rank of <strong>' + allScores[0].avgRank.toFixed(2) + '</strong>. ';
    explainHTML += 'The runner-up was <strong>' + (PROFILES[runnerUp.id] ? PROFILES[runnerUp.id].name : runnerUp.id) + '</strong> at <strong>' + runnerUp.avgRank.toFixed(2) + '</strong>.</p>';
    
    if (gap >= 1.2) {
      explainHTML += '<p style="color: #10B981; font-weight: 600;">Gap: ' + gap.toFixed(2) + ' ranks ‚Äî This is a clear, confident match. The way this identity approaches decisions genuinely resonates with you.</p>';
    } else if (gap >= 0.75) {
      explainHTML += '<p style="color: #60A5FA; font-weight: 600;">Gap: ' + gap.toFixed(2) + ' ranks ‚Äî Moderate confidence. You lean toward this identity but may share some traits with the alternatives.</p>';
    } else {
      explainHTML += '<p style="color: #F59E0B; font-weight: 600;">Gap: ' + gap.toFixed(2) + ' ranks ‚Äî Close call. You may genuinely bridge multiple identities or shift based on context.</p>';
    }
  } else {
    explainHTML += '<p>You consistently ranked <strong>' + (PROFILES[winnerIdentity] ? PROFILES[winnerIdentity].name : winnerIdentity) + '</strong> as the best fit across all scenarios.</p>';
  }
  
  explainHTML += '</div>';
  explainHTML += '</div>';
  
  explanation.innerHTML = explainHTML;
}

// Populate the simple always-visible mana pool bars
function populateManaPoolBars() {
  const container = document.getElementById('mana-pool-bars');
  if (!container) return;
  
  const activation = {};
  if (state.activationSorted && state.activationSorted.length > 0) {
    state.activationSorted.forEach(([color, value]) => {
      activation[color] = value;
    });
  } else {
    activation.W = (state.pairwise['W-B'].W / 6 + state.pairwise['W-R'].W / 6) / 2;
    activation.U = (state.pairwise['U-R'].U / 6 + state.pairwise['G-U'].U / 6) / 2;
    activation.B = (state.pairwise['W-B'].B / 6 + state.pairwise['B-G'].B / 6) / 2;
    activation.R = (state.pairwise['U-R'].R / 6 + state.pairwise['W-R'].R / 6) / 2;
    activation.G = (state.pairwise['G-U'].G / 6 + state.pairwise['B-G'].G / 6) / 2;
  }
  
  const sorted = Object.entries(activation).sort((a,b) => b[1] - a[1]);
  const colorNames = {W:'White', U:'Blue', B:'Black', R:'Red', G:'Green'};
  const barColors = {W:'#FDE047', U:'#93C5FD', B:'#D1D5DB', R:'#FCA5A5', G:'#6EE7B7'};
  const identityColors = PROFILES[state.result.identity]?.colors || [];
  
  let html = '';
  sorted.forEach(([color, value]) => {
    const pct = Math.round(value * 100);
    const isInIdentity = identityColors.includes(color);
    
    html += '<div style="display: flex; align-items: center; gap: 12px; padding: 10px; background: rgba(255,255,255,' + (isInIdentity ? '0.05' : '0.02') + '); border-radius: 8px; border: 1px solid rgba(255,255,255,' + (isInIdentity ? '0.15' : '0.05') + ');">';
    html += '<span class="mana-symbol mana-' + color + '" style="width: 28px; height: 28px; font-size: 14px;">' + color + '</span>';
    html += '<div style="flex: 1;">';
    html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">';
    html += '<span style="font-weight: 600; color: ' + (isInIdentity ? '#e0e0e0' : '#808090') + ';">' + colorNames[color] + '</span>';
    html += '<span style="font-weight: 700; font-size: 16px; color: ' + barColors[color] + ';">' + pct + '%</span>';
    html += '</div>';
    html += '<div style="background: rgba(255,255,255,0.1); height: 6px; border-radius: 3px; overflow: hidden;">';
    html += '<div style="background: ' + barColors[color] + '; width: ' + pct + '%; height: 100%; transition: width 0.5s;"></div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
  });
  
  container.innerHTML = html;
}

// Update displayRoundPatterns to properly show Round 2

function displayPairwiseMatchups(container) {
  const colorNames = {W:'White', U:'Blue', B:'Black', R:'Red', G:'Green'};
  const barColors = {W:'#FDE047', U:'#93C5FD', B:'#D1D5DB', R:'#FCA5A5', G:'#6EE7B7'};
  
  let html = '<div style="font-size: 14px; font-weight: 600; color: #e0e0e0; margin-bottom: 12px;">Head-to-Head Matchups</div>';
  html += '<div style="font-size: 13px; color: #a0a0b0; margin-bottom: 16px;">Your choices in each enemy-color pairing:</div>';
  
  const pairs = [
    {name: 'W-B', colors: ['W', 'B']},
    {name: 'U-R', colors: ['U', 'R']},
    {name: 'G-U', colors: ['G', 'U']},
    {name: 'W-R', colors: ['W', 'R']},
    {name: 'B-G', colors: ['B', 'G']}
  ];
  
  pairs.forEach(pair => {
    const scores = state.pairwise[pair.name];
    const c1 = pair.colors[0];
    const c2 = pair.colors[1];
    const c1Score = scores[c1];
    const c2Score = scores[c2];
    const c1Pct = Math.round((c1Score / 6) * 100);
    const c2Pct = Math.round((c2Score / 6) * 100);
    
    html += '<div style="margin: 14px 0; padding: 14px; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 8px;">';
    html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">';
    html += '<div style="display: flex; align-items: center; gap: 10px;">';
    html += '<span class="mana-symbol mana-' + c1 + '" style="width: 26px; height: 26px; font-size: 14px;">' + c1 + '</span>';
    html += '<span style="font-size: 14px; font-weight: 600; color: #d0d0d0;">' + colorNames[c1] + '</span>';
    html += '<span style="font-size: 13px; color: #606070; margin: 0 6px;">vs</span>';
    html += '<span class="mana-symbol mana-' + c2 + '" style="width: 26px; height: 26px; font-size: 14px;">' + c2 + '</span>';
    html += '<span style="font-size: 14px; font-weight: 600; color: #d0d0d0;">' + colorNames[c2] + '</span>';
    html += '</div>';
    html += '<span style="font-size: 15px; font-weight: 700; color: #c4b5fd;">' + c1Score + '‚Äì' + c2Score + '</span>';
    html += '</div>';
    html += '<div style="display: flex; gap: 2px; height: 16px; border-radius: 8px; overflow: hidden;">';
    html += '<div style="flex: ' + c1Score + '; background: ' + barColors[c1] + '; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; color: rgba(0,0,0,0.8);">' + (c1Score > 0 ? c1Score : '') + '</div>';
    html += '<div style="flex: ' + c2Score + '; background: ' + barColors[c2] + '; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; color: rgba(0,0,0,0.8);">' + (c2Score > 0 ? c2Score : '') + '</div>';
    html += '</div>';
    html += '</div>';
  });
  
  container.innerHTML = html;
}

function displayCandidateTesting() {
  const intro = document.getElementById('round2-intro-text');
  const bars = document.getElementById('round2-bars');
  const questionCount = document.getElementById('round2-question-count');
  
  if (!intro || !bars || !state.result.round2Data) return;
  
  const allScores = state.result.round2Data.allScores;
  const gap = state.result.round2Data.gap;
  const winnerIdentity = state.result.identity;
  const numQuestions = state.qTot || 4;
  
  questionCount.textContent = numQuestions + ' scenario rankings';
  
  // Intro explaining what was tested
  let introHTML = '<p>Round 1 patterns suggested <strong>' + allScores.length + ' possible identities</strong>. ';
  introHTML += 'Round 2 presented ' + numQuestions + ' scenarios, each with identity-specific responses. ';
  introHTML += 'You ranked which approach felt most like you.</p>';
  intro.innerHTML = introHTML;
  
  // Rankings display
  let html = '<div style="margin-top: 16px;">';
  html += '<div style="font-size: 14px; font-weight: 600; color: #e0e0e0; margin-bottom: 14px;">Results by Identity</div>';
  
  allScores.forEach((cand, idx) => {
    const isWinner = cand.id === winnerIdentity;
    const prof = PROFILES[cand.id];
    
    html += '<div style="margin: 10px 0; padding: 14px; background: ' + (isWinner ? 'rgba(16, 185, 129, 0.08)' : 'rgba(255,255,255,0.02)') + '; border: 1px solid ' + (isWinner ? 'rgba(16, 185, 129, 0.3)' : 'rgba(255,255,255,0.08)') + '; border-radius: 8px;">';
    html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">';
    html += '<div style="display: flex; align-items: center; gap: 10px;">';
    
    if (prof && prof.colors) {
      prof.colors.forEach(c => {
        html += '<span class="mana-symbol mana-' + c + '" style="width: 20px; height: 20px; font-size: 11px;">' + c + '</span>';
      });
    }
    
    html += '<span style="font-weight: ' + (isWinner ? '700' : '500') + '; color: ' + (isWinner ? '#e0e0e0' : '#a0a0a0') + ';">';
    if (isWinner) html += '‚úì ';
    html += (prof ? prof.name : cand.id) + '</span>';
    html += '</div>';
    html += '<span style="font-weight: 700; font-size: 16px; color: ' + (isWinner ? '#10B981' : '#808090') + ';">Rank: ' + cand.avgRank.toFixed(2) + '</span>';
    html += '</div>';
    
    const barPct = Math.max(5, (allScores.length + 1 - cand.avgRank) / allScores.length * 100);
    html += '<div style="background: rgba(255,255,255,0.05); height: 10px; border-radius: 5px;">';
    html += '<div style="background: ' + (isWinner ? 'linear-gradient(90deg, #10B981, #6EE7B7)' : 'rgba(139, 92, 246, 0.4)') + '; width: ' + barPct + '%; height: 100%; border-radius: 5px; transition: width 0.5s;"></div>';
    html += '</div>';
    html += '</div>';
  });
  
  html += '</div>';
  
  // Verdict
  html += '<div style="margin-top: 20px; padding: 18px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 10px;">';
  html += '<div style="font-size: 14px; font-weight: 600; color: #10B981; margin-bottom: 10px;">üí° The Verdict</div>';
  html += '<div style="font-size: 14px; color: #d0d0d0; line-height: 1.7;">';
  
  if (allScores.length > 1) {
    const winner = allScores[0];
    const runnerUp = allScores[1];
    const runnerUpProf = PROFILES[runnerUp.id];
    
    html += '<strong>' + (PROFILES[winnerIdentity] ? PROFILES[winnerIdentity].name : winnerIdentity) + '</strong> consistently ranked best (avg: ' + winner.avgRank.toFixed(2) + ') ';
    html += 'vs ' + (runnerUpProf ? runnerUpProf.name : runnerUp.id) + ' (' + runnerUp.avgRank.toFixed(2) + '). ';
    
    if (gap >= 1.0) {
      html += '<span style="color: #10B981;">Clear match.</span>';
    } else {
      html += '<span style="color: #F59E0B;">Close‚Äîyou may blend these identities.</span>';
    }
  }
  
  html += '</div>';
  html += '</div>';
  
  bars.innerHTML = html;
}

function displayRoundPatterns() {
  // Populate the simple bars first (always visible)
  populateManaPoolBars();
  
  // Populate unified breakdown (expandable section)
  populateUnifiedBreakdown();
}

function populateUnifiedBreakdown() {
  // ROUND 1: Show pairwise matchups
  const stage1Content = document.getElementById('stage1-explanation-content');
  if (stage1Content) {
    displayPairwiseMatchups(stage1Content);
  }
  
  // ROUND 2: Show calibration results if it happened
  const hasCalibration = state.calibrationAnswers && state.calibrationAnswers.length > 0;
  if (hasCalibration) {
    document.getElementById('round2-unified-section').style.display = 'block';
    document.getElementById('round2-question-count').textContent = state.calibrationAnswers.length + ' ally pair questions';
    displayCalibrationResults();
  } else {
    document.getElementById('round2-unified-section').style.display = 'none';
  }
  
  // ROUND 3: Show final determination if it happened  
  const hasRound3 = state.result.round3Data && state.result.round3Data.allScores;
  if (hasRound3) {
    document.getElementById('round3-unified-section').style.display = 'block';
    displayFinalDetermination();
  } else {
    document.getElementById('round3-unified-section').style.display = 'none';
  }
}

function displayCalibrationResults() {
  const introText = document.getElementById('round2-intro-text');
  const resultsDiv = document.getElementById('round2-calibration-results');
  
  if (!introText || !resultsDiv) return;
  
  // Explain why calibration was done
  let introHTML = '<p style="margin-bottom: 12px;">';
  introHTML += 'Round 1 only tested <strong>enemy pairs</strong> (colors that oppose each other). ';
  introHTML += 'Round 2 tested <strong>ally pairs</strong> to calibrate your scores‚Äîdetecting if any colors were suppressed or inflated by noise.';
  introHTML += '</p>';
  introText.innerHTML = introHTML;
  
  // Show ally pair results
  let html = '<div style="font-size: 14px; font-weight: 600; color: #e0e0e0; margin-bottom: 16px;">Ally Pair Results</div>';
  
  const barColors = {W:'#FDE047', U:'#93C5FD', B:'#D1D5DB', R:'#FCA5A5', G:'#6EE7B7'};
  
  if (state.calibrationPairwise) {
    Object.entries(state.calibrationPairwise).forEach(([pair, scores]) => {
      const [c1, c2] = pair.split('-');
      const c1Score = scores[c1];
      const c2Score = scores[c2];
      const total = c1Score + c2Score;
      
      if (total > 0) {
        const c1Pct = Math.round((c1Score / total) * 100);
        const c2Pct = Math.round((c2Score / total) * 100);
        
        html += '<div style="margin: 12px 0; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px;">';
        html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">';
        html += '<div style="display: flex; align-items: center; gap: 8px;">';
        html += '<span class="mana-symbol mana-' + c1 + '" style="width: 20px; height: 20px; font-size: 10px;">' + c1 + '</span>';
        html += '<span style="font-size: 14px; color: #808090;">vs</span>';
        html += '<span class="mana-symbol mana-' + c2 + '" style="width: 20px; height: 20px; font-size: 10px;">' + c2 + '</span>';
        html += '<span style="font-size: 11px; color: #a0a0b0; margin-left: 8px;">(allies)</span>';
        html += '</div>';
        html += '<span style="font-size: 12px; color: #a0a0b0;">' + c1Score + '-' + c2Score + '</span>';
        html += '</div>';
        html += '<div style="display: flex; gap: 4px; height: 8px;">';
        html += '<div style="flex: ' + c1Score + '; background: ' + barColors[c1] + '; border-radius: 4px;"></div>';
        html += '<div style="flex: ' + c2Score + '; background: ' + barColors[c2] + '; border-radius: 4px;"></div>';
        html += '</div>';
        html += '</div>';
      }
    });
  }
  
  resultsDiv.innerHTML = html;
}

function displayFinalDetermination() {
  const introText = document.getElementById('round3-intro-text');
  const barsDiv = document.getElementById('round3-bars');
  const explanationDiv = document.getElementById('round3-testing-explanation');
  const questionCount = document.getElementById('round3-question-count');
  
  if (!introText || !barsDiv) return;
  
  const data = state.result.round3Data;
  
  // Check if this is tournament data
  if (data.isTournament) {
    // Tournament format display
    const numQuestions = data.matchHistory?.length || 0;
    questionCount.textContent = numQuestions + ' tournament matchup' + (numQuestions !== 1 ? 's' : '');
    
    // Intro text
    let introHTML = '<p style="margin-bottom: 12px;">';
    introHTML += 'We tested <strong>' + data.allScores.length + ' candidate identities</strong> through head-to-head matchups. ';
    introHTML += 'Each question forced you to choose between two approaches to the same situation.';
    introHTML += '</p>';
    
    if (data.terminated && data.termReason) {
      introHTML += '<p style="color: #10B981; font-style: italic; margin-bottom: 12px;">';
      introHTML += 'Early termination: ' + data.termReason.message;
      introHTML += '</p>';
    }
    introText.innerHTML = introHTML;
    
    // Show match history as bracket
    let html = '';
    
    if (data.matchHistory && data.matchHistory.length > 0) {
      html += '<div style="font-size: 14px; font-weight: 600; color: #e0e0e0; margin-bottom: 16px;">Tournament Results</div>';
      
      data.matchHistory.forEach((match, i) => {
        const winnerProf = PROFILES[match.winner.id];
        const loserProf = PROFILES[match.loser.id];
        
        html += '<div style="display: flex; align-items: center; gap: 12px; margin: 12px 0; padding: 12px; background: rgba(255,255,255,0.03); border-radius: 8px;">';
        
        // Question number
        html += '<div style="background: rgba(139,92,246,0.2); color: #a78bfa; font-weight: 700; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px;">Q' + (i+1) + '</div>';
        
        // Winner
        html += '<div style="flex: 1; display: flex; align-items: center; gap: 8px;">';
        if (winnerProf?.colors) {
          winnerProf.colors.forEach(c => {
            html += '<span class="mana-symbol mana-' + c + '" style="width: 20px; height: 20px; font-size: 10px;">' + c + '</span>';
          });
        }
        html += '<span style="color: #10B981; font-weight: 600;">' + (winnerProf?.name || match.winner.id) + '</span>';
        html += '<span style="color: #10B981;">‚úì</span>';
        html += '</div>';
        
        // vs
        html += '<div style="color: #808090; font-size: 12px;">vs</div>';
        
        // Loser
        html += '<div style="flex: 1; display: flex; align-items: center; gap: 8px; opacity: 0.6;">';
        if (loserProf?.colors) {
          loserProf.colors.forEach(c => {
            html += '<span class="mana-symbol mana-' + c + '" style="width: 20px; height: 20px; font-size: 10px;">' + c + '</span>';
          });
        }
        html += '<span style="color: #a0a0a0;">' + (loserProf?.name || match.loser.id) + '</span>';
        html += '</div>';
        
        html += '</div>';
      });
    }
    
    // Final standings - only show candidates that were actually tested
    const testedCandidates = data.allScores.filter(c => c.wins > 0 || c.losses > 0);
    
    if (testedCandidates.length > 0) {
      html += '<div style="margin-top: 24px;">';
      html += '<div style="font-size: 14px; font-weight: 600; color: #e0e0e0; margin-bottom: 16px;">Final Standings</div>';
      
      testedCandidates.forEach((c, idx) => {
        const isWinner = c.id === state.result.identity;
        const prof = PROFILES[c.id];
        
        html += '<div style="display: flex; align-items: center; gap: 12px; margin: 8px 0; padding: 12px; background: rgba(' + (isWinner ? '16,185,129' : '255,255,255') + ', 0.05); border: 1px solid rgba(' + (isWinner ? '16,185,129' : '255,255,255') + ', 0.1); border-radius: 8px;">';
        
        // Rank
        html += '<div style="font-weight: 700; color: ' + (isWinner ? '#10B981' : '#808090') + '; font-size: 16px;">#' + (idx + 1) + '</div>';
        
        // Identity
        html += '<div style="flex: 1; display: flex; align-items: center; gap: 8px;">';
        if (prof?.colors) {
          prof.colors.forEach(col => {
            html += '<span class="mana-symbol mana-' + col + '" style="width: 22px; height: 22px; font-size: 11px;">' + col + '</span>';
          });
        }
        html += '<span style="font-weight: ' + (isWinner ? '700' : '500') + '; color: ' + (isWinner ? '#e0e0e0' : '#a0a0a0') + ';">' + (prof?.name || c.id) + '</span>';
        if (isWinner) html += '<span style="color: #10B981; margin-left: 8px; font-size: 12px; font-weight: 600;">WINNER</span>';
        html += '</div>';
        
        // Record
        html += '<div style="font-weight: 600; color: ' + (isWinner ? '#10B981' : '#808090') + ';">' + c.wins + 'W-' + c.losses + 'L</div>';
        
        html += '</div>';
      });
      
      html += '</div>';
    }
    
    barsDiv.innerHTML = html;
    
    // Explanation
    if (explanationDiv) {
      let expHTML = '<div style="padding: 16px; background: rgba(16, 185, 129, 0.05); border-radius: 8px; border: 1px solid rgba(16, 185, 129, 0.2); margin-top: 16px;">';
      expHTML += '<p style="font-size: 13px; color: #d0d0d0; margin: 0; line-height: 1.6;">';
      const winner = data.allScores[0];
      expHTML += '<strong style="color: #10B981;">' + state.result.identity + '</strong> finished with the best record (' + winner.wins + 'W-' + winner.losses + 'L)';
      if (data.runnerUp) {
        expHTML += ', ahead of <strong>' + data.runnerUp.id + '</strong> (' + data.runnerUp.wins + 'W-' + data.runnerUp.losses + 'L).';
      } else {
        expHTML += '.';
      }
      expHTML += '</p>';
      expHTML += '</div>';
      explanationDiv.innerHTML = expHTML;
    }
    
  } else {
    // Legacy ranking format display
    const numQuestions = state.qTot || 4;
    questionCount.textContent = numQuestions + ' scenario rankings';
    
    // Explain what was tested
    let introHTML = '<p style="margin-bottom: 12px;">';
    introHTML += 'After calibration, we identified <strong>' + data.allScores.length + ' candidate identities</strong>. ';
    introHTML += 'You ranked ' + numQuestions + ' workplace scenarios to determine which approach felt most natural.';
    introHTML += '</p>';
    introText.innerHTML = introHTML;
    
    // Show candidate rankings
    const barColors = {W:'#FDE047', U:'#93C5FD', B:'#D1D5DB', R:'#FCA5A5', G:'#6EE7B7'};
    let html = '<div style="font-size: 14px; font-weight: 600; color: #e0e0e0; margin-bottom: 16px;">Final Rankings</div>';
    
    data.allScores.forEach((score, idx) => {
      const isWinner = score.id === state.result.identity;
      const colors = PROFILES[score.id]?.colors || [];
      const avgRank = score.avgRank?.toFixed(1) || 'N/A';
      
      html += '<div style="margin: 8px 0; padding: 12px; background: ' + (isWinner ? 'rgba(16, 185, 129, 0.1)' : 'rgba(255,255,255,0.03)') + '; border-radius: 8px; border: ' + (isWinner ? '2px solid rgba(16, 185, 129, 0.4)' : '1px solid transparent') + ';">';
      html += '<div style="display: flex; justify-content: space-between; align-items: center;">';
      html += '<div style="display: flex; align-items: center; gap: 8px;">';
      colors.forEach(c => {
        html += '<span class="mana-symbol mana-' + c + '" style="width: 20px; height: 20px; font-size: 10px;">' + c + '</span>';
      });
      html += '<span style="font-size: 13px; font-weight: 600; color: ' + (isWinner ? '#10B981' : '#e0e0e0') + ';">' + score.id + '</span>';
      if (isWinner) {
        html += '<span style="font-size: 10px; background: rgba(16, 185, 129, 0.3); color: #10B981; padding: 2px 6px; border-radius: 4px; font-weight: 700;">WINNER</span>';
      }
      html += '</div>';
      html += '<span style="font-size: 12px; color: #a0a0b0;">Avg rank: ' + avgRank + '</span>';
      html += '</div>';
      html += '</div>';
    });
    
    barsDiv.innerHTML = html;
    
    // Explanation
    if (explanationDiv) {
      let expHTML = '<div style="padding: 16px; background: rgba(16, 185, 129, 0.05); border-radius: 8px; border: 1px solid rgba(16, 185, 129, 0.2); margin-top: 16px;">';
      expHTML += '<p style="font-size: 13px; color: #d0d0d0; margin: 0; line-height: 1.6;">';
      expHTML += '<strong style="color: #10B981;">' + state.result.identity + '</strong> had the best average rank (' + (data.allScores[0]?.avgRank?.toFixed(2) || 'N/A') + '), ';
      if (data.runnerUp) {
        expHTML += 'beating <strong>' + data.runnerUp.id + '</strong> (avg rank ' + (data.runnerUp.avgRank?.toFixed(2) || 'N/A') + ') ';
        expHTML += 'by a margin of ' + (data.gap?.toFixed(2) || 'N/A') + ' positions.';
      }
      expHTML += '</p>';
      expHTML += '</div>';
      explanationDiv.innerHTML = expHTML;
    }
  }
}

function displayRound1Breakdown() {
  const container = document.getElementById('stage1-explanation-content');
  if (!container) return;
  
  // Get activation percentages
  let activation;
  if (state.activationSorted && state.activationSorted.length > 0) {
    activation = {};
    state.activationSorted.forEach(([color, value]) => {
      activation[color] = value;
    });
  } else {
    activation = {
      W: (state.pairwise['W-B'].W / 6 + state.pairwise['W-R'].W / 6) / 2,
      U: (state.pairwise['U-R'].U / 6 + state.pairwise['G-U'].U / 6) / 2,
      B: (state.pairwise['W-B'].B / 6 + state.pairwise['B-G'].B / 6) / 2,
      R: (state.pairwise['U-R'].R / 6 + state.pairwise['W-R'].R / 6) / 2,
      G: (state.pairwise['G-U'].G / 6 + state.pairwise['B-G'].G / 6) / 2
    };
  }
  
  const sorted = Object.entries(activation).sort((a,b) => b[1] - a[1]);
  const colorNames = {W:'White', U:'Blue', B:'Black', R:'Red', G:'Green'};
  const barColors = {W:'#FDE047', U:'#93C5FD', B:'#D1D5DB', R:'#FCA5A5', G:'#6EE7B7'};
  
  let html = '';
  
  // Show pairwise win/loss patterns (not just activation bars again)
  html += '<div style="font-size: 14px; font-weight: 600; color: #e0e0e0; margin-bottom: 16px;">Your Color Preferences by Matchup</div>';
  html += '<div style="font-size: 13px; color: #a0a0b0; margin-bottom: 20px;">How you chose when forced to pick between enemy colors:</div>';
  
  const pairs = [
    {name: 'W-B', label: 'White vs Black', colors: ['W', 'B']},
    {name: 'U-R', label: 'Blue vs Red', colors: ['U', 'R']},
    {name: 'G-U', label: 'Green vs Blue', colors: ['G', 'U']},
    {name: 'W-R', label: 'White vs Red', colors: ['W', 'R']},
    {name: 'B-G', label: 'Black vs Green', colors: ['B', 'G']}
  ];
  
  pairs.forEach(pair => {
    const scores = state.pairwise[pair.name];
    const c1 = pair.colors[0];
    const c2 = pair.colors[1];
    const c1Score = scores[c1];
    const c2Score = scores[c2];
    const c1Pct = Math.round((c1Score / 6) * 100);
    const c2Pct = Math.round((c2Score / 6) * 100);
    
    html += '<div style="margin: 16px 0; padding: 16px; background: rgba(255,255,255,0.03); border-radius: 8px;">';
    html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">';
    html += '<div style="display: flex; align-items: center; gap: 12px;">';
    html += '<span class="mana-symbol mana-' + c1 + '" style="width: 24px; height: 24px; font-size: 12px;">' + c1 + '</span>';
    html += '<span style="font-size: 16px; color: #808090;">vs</span>';
    html += '<span class="mana-symbol mana-' + c2 + '" style="width: 24px; height: 24px; font-size: 12px;">' + c2 + '</span>';
    html += '</div>';
    html += '<span style="font-size: 13px; color: #a0a0b0;">' + c1Score + '-' + c2Score + '</span>';
    html += '</div>';
    html += '<div style="display: flex; gap: 8px; height: 12px;">';
    html += '<div style="flex: ' + c1Score + '; background: ' + barColors[c1] + '; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; color: rgba(0,0,0,0.7);">' + (c1Score > 0 ? c1Pct + '%' : '') + '</div>';
    html += '<div style="flex: ' + c2Score + '; background: ' + barColors[c2] + '; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 700; color: rgba(0,0,0,0.7);">' + (c2Score > 0 ? c2Pct + '%' : '') + '</div>';
    html += '</div>';
    html += '</div>';
  });
  
  container.innerHTML = html;
}

function displayRound2Breakdown() {
  const intro = document.getElementById('round2-intro-text');
  const bars = document.getElementById('round2-bars');
  const questionCount = document.getElementById('round2-question-count');
  
  if (!intro || !bars || !state.result.round2Data) return;
  
  const allScores = state.result.round2Data.allScores;
  const gap = state.result.round2Data.gap;
  const winnerIdentity = state.result.identity;
  const numQuestions = state.qTot || 4;
  
  // Set question count
  questionCount.textContent = numQuestions + ' scenario rankings';
  
  // Introduction explaining what was tested
  let introHTML = '<p style="margin-bottom: 12px;">';
  introHTML += 'Round 1 identified <strong>' + allScores.length + ' possible identities</strong> that could match your color pattern. ';
  introHTML += 'Round 2 showed you ' + numQuestions + ' workplace scenarios, each with responses written for these candidate identities. ';
  introHTML += 'You ranked which approach felt most natural.';
  introHTML += '</p>';
  intro.innerHTML = introHTML;
  
  // Show candidate rankings
  let barsHTML = '<div style="margin-top: 20px;">';
  barsHTML += '<div style="font-size: 14px; font-weight: 600; color: #e0e0e0; margin-bottom: 16px;">Candidate Identity Rankings</div>';
  barsHTML += '<div style="font-size: 13px; color: #a0a0b0; margin-bottom: 16px;">Average rank across ' + numQuestions + ' scenarios (1 = best fit, ' + allScores.length + ' = worst fit):</div>';
  
  allScores.forEach((cand, idx) => {
    const isWinner = cand.id === winnerIdentity;
    const prof = PROFILES[cand.id];
    const avgRank = cand.avgRank.toFixed(2);
    const bgColor = isWinner ? 'rgba(16, 185, 129, 0.1)' : 'rgba(255,255,255,0.02)';
    const borderColor = isWinner ? 'rgba(16, 185, 129, 0.3)' : 'rgba(255,255,255,0.08)';
    
    barsHTML += '<div style="margin: 12px 0; padding: 16px; background: ' + bgColor + '; border: 1px solid ' + borderColor + '; border-radius: 10px;">';
    barsHTML += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">';
    barsHTML += '<div style="display: flex; align-items: center; gap: 12px;">';
    
    // Show identity symbols
    if (prof && prof.colors) {
      prof.colors.forEach(c => {
        barsHTML += '<span class="mana-symbol mana-' + c + '" style="width: 22px; height: 22px; font-size: 12px;">' + c + '</span>';
      });
    }
    
    barsHTML += '<span style="font-weight: ' + (isWinner ? '700' : '500') + '; font-size: 16px; color: ' + (isWinner ? '#e0e0e0' : '#a0a0a0') + ';">';
    if (isWinner) barsHTML += '‚úì ';
    barsHTML += (prof ? prof.name : cand.id) + '</span>';
    if (isWinner) barsHTML += '<span style="margin-left: 8px; font-size: 12px; color: #10B981; font-weight: 600;">YOUR MATCH</span>';
    barsHTML += '</div>';
    barsHTML += '<div style="text-align: right;">';
    barsHTML += '<div style="font-size: 18px; font-weight: 700; color: ' + (isWinner ? '#10B981' : '#808090') + ';">Rank ' + avgRank + '</div>';
    barsHTML += '<div style="font-size: 11px; color: #808090;">avg across ' + numQuestions + ' scenarios</div>';
    barsHTML += '</div>';
    barsHTML += '</div>';
    
    // Visual ranking bar (inverse - lower rank = better = longer bar)
    const barWidth = Math.max(5, (allScores.length + 1 - cand.avgRank) / allScores.length * 100);
    const barColor = isWinner ? 'linear-gradient(90deg, #10B981, #6EE7B7)' : 'rgba(139, 92, 246, 0.3)';
    barsHTML += '<div style="background: rgba(255,255,255,0.05); height: 14px; border-radius: 7px; overflow: hidden;">';
    barsHTML += '<div style="background: ' + barColor + '; width: ' + barWidth + '%; height: 100%; border-radius: 7px; transition: width 0.6s;"></div>';
    barsHTML += '</div>';
    barsHTML += '</div>';
  });
  
  barsHTML += '</div>';
  
  // Explanation of the result
  barsHTML += '<div style="margin-top: 24px; padding: 20px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px;">';
  barsHTML += '<div style="font-size: 14px; font-weight: 700; color: #10B981; margin-bottom: 10px;">üéØ Why ' + (PROFILES[winnerIdentity] ? PROFILES[winnerIdentity].name : winnerIdentity) + '?</div>';
  barsHTML += '<div style="font-size: 14px; color: #d0d0d0; line-height: 1.7;">';
  
  if (allScores.length > 1) {
    const runnerUp = allScores[1];
    const runnerUpProf = PROFILES[runnerUp.id];
    barsHTML += 'You consistently ranked ' + (PROFILES[winnerIdentity] ? PROFILES[winnerIdentity].name : winnerIdentity) + ' responses higher (avg rank: <strong>' + allScores[0].avgRank.toFixed(2) + '</strong>) ';
    barsHTML += 'than ' + (runnerUpProf ? runnerUpProf.name : runnerUp.id) + ' (avg rank: <strong>' + runnerUp.avgRank.toFixed(2) + '</strong>). ';
    
    if (gap >= 1.5) {
      barsHTML += '<span style="color: #10B981; font-weight: 600;">The gap is significant‚Äîthis is a clear match.</span>';
    } else if (gap >= 0.75) {
      barsHTML += '<span style="color: #3B82F6; font-weight: 600;">The gap is moderate‚Äîthis is your primary identity, though you may share traits with alternatives.</span>';
    } else {
      barsHTML += '<span style="color: #F59E0B; font-weight: 600;">The gap is small‚Äîyou genuinely bridge multiple identities.</span>';
    }
  } else {
    barsHTML += 'You ranked ' + (PROFILES[winnerIdentity] ? PROFILES[winnerIdentity].name : winnerIdentity) + ' as the clear match across all scenarios.';
  }
  
  barsHTML += '</div>';
  barsHTML += '</div>';
  
  bars.innerHTML = barsHTML;
}


// ============================================================================
// ENHANCEMENT: Modal Deep Dive System  
// ============================================================================
function openModal(id) {
  const profile = PROFILES[id];
  if (!profile) {
    console.error('Profile not found:', id);
    return;
  }
  
  // Populate header
  let headerHTML = '<div style="display: flex; justify-content: center; gap: 12px; margin-bottom: 16px;">';
  profile.colors.forEach(c => {
    headerHTML += `<span class="mana-symbol mana-${c}" style="width: 36px; height: 36px; font-size: 18px;">${c}</span>`;
  });
  headerHTML += '</div>';
  headerHTML += `<h2 style="font-size: 32px; font-weight: 800; text-align: center; margin-bottom: 8px; color: #e0e0e0;">${profile.name}</h2>`;
  headerHTML += `<p style="font-size: 18px; color: #a78bfa; text-align: center; font-style: italic;">${profile.tag}</p>`;
  
  document.getElementById('modal-header').innerHTML = headerHTML;
  
  // Populate all tab contents
  document.getElementById('tab-overview').innerHTML = getOverviewContent(id);
  document.getElementById('tab-philosophy').innerHTML = getPhilosophyContent(id);
  document.getElementById('tab-workplace').innerHTML = getWorkplaceContent(id);
  document.getElementById('tab-stress').innerHTML = getStressContent(id);
  document.getElementById('tab-development').innerHTML = getDevelopmentContent(id);
  
  // Reset to overview tab
  document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-overview').classList.remove('hidden');
  document.querySelector('.tab-btn').classList.add('active');
  
  // Show modal
  document.getElementById('modal-overlay').classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}

function closeModal() {
  document.getElementById('modal-overlay').classList.add('hidden');
  document.body.style.overflow = 'auto';
}

function switchModalTab(event, tabName) {
  // Hide all tabs
  document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  
  // Show selected tab
  document.getElementById('tab-' + tabName).classList.remove('hidden');
  event.target.classList.add('active');
}

function showDeepDive(type, id) {
  // Now just opens modal with all tabs, starting on overview
  openModal(id);
}

// ============================================================================
// MODAL CONTENT GENERATION - All 5 Tabs with Rich Content
// ============================================================================

function getOverviewContent(id) {
  const profile = PROFILES[id];
  if (!profile) return '<p>Content not available</p>';
  
  const type = getCandidateType(id);
  let html = '';
  
  // Core philosophy
  html += `<div class="info-box" style="border-left-color: #a78bfa;">
    <div class="box-header">
      <span style="font-size: 20px;">üîÆ</span>
      <h4>Core Philosophy</h4>
    </div>
    <div class="box-content">
      <p style="font-size: 15px; line-height: 1.8;">${profile.desc}</p>
    </div>
  </div>`;
  
  // Quick Facts for multi-color
  if (type === 'GUILD' || type === 'THREE') {
    html += getQuickFacts(id, profile, type);
  }
  
  // Top 3 Strengths
  html += `<div class="info-box strength">
    <div class="box-header">
      <span style="font-size: 20px;">‚öîÔ∏è</span>
      <h4>Top Strengths</h4>
    </div>
    <div class="box-content">
      <ul>`;
  profile.str.slice(0, 3).forEach(s => {
    html += `<li>‚Ä¢ ${s}</li>`;
  });
  html += `</ul>
      <p style="font-size: 13px; color: #808090; margin-top: 12px; font-style: italic;">See Workplace tab for all ${profile.str.length} strengths</p>
    </div>
  </div>`;
  
  // Top 3 Shadows
  html += `<div class="info-box shadow">
    <div class="box-header">
      <span style="font-size: 20px;">‚ö†Ô∏è</span>
      <h4>Top Shadows</h4>
    </div>
    <div class="box-content">
      <ul>`;
  profile.weak.slice(0, 3).forEach(w => {
    html += `<li>‚Ä¢ ${w}</li>`;
  });
  html += `</ul>
      <p style="font-size: 13px; color: #808090; margin-top: 12px; font-style: italic;">See Workplace tab for all ${profile.weak.length} shadows</p>
    </div>
  </div>`;
  
  html += `<p style="font-size: 13px; color: #808090; text-align: center; margin-top: 32px; font-style: italic;">
    Click the tabs above to explore philosophy, workplace patterns, stress responses, and development paths.
  </p>`;
  
  return html;
}

function getQuickFacts(id, profile, type) {
  const colorNames = {W:'White', U:'Blue', B:'Black', R:'Red', G:'Green'};
  let html = `<div class="info-box" style="border-left-color: #60A5FA;">
    <div class="box-header">
      <span style="font-size: 20px;">üìä</span>
      <h4>Quick Facts</h4>
    </div>
    <div class="box-content">`;
  
  if (type === 'GUILD') {
    const colors = profile.colors;
    const absent = ['W','U','B','R','G'].filter(c => !colors.includes(c));
    
    html += `<div class="quick-fact">
      <strong>Partnership:</strong>
      <p style="margin: 0; color: #d0d0d0;">${colorNames[colors[0]]} + ${colorNames[colors[1]]} combine for unique synergy.</p>
    </div>`;
    
    html += `<div class="quick-fact">
      <strong>What's Absent:</strong>
      <p style="margin: 0; color: #d0d0d0;">No ${absent.map(c => colorNames[c]).join(', ')}. This shapes your approach as much as what you have.</p>
    </div>`;
    
    const isAllied = isAlliedPair(colors);
    html += `<div class="quick-fact">
      <strong>${isAllied ? 'Allied Pair' : 'Enemy Pair'}:</strong>
      <p style="margin: 0; color: #d0d0d0;">${isAllied ? 'Colors reinforce each other smoothly' : 'Productive tension between opposing values'}.</p>
    </div>`;
    
  } else if (type === 'THREE') {
    const colors = profile.colors;
    const absent = ['W','U','B','R','G'].filter(c => !colors.includes(c));
    
    html += `<div class="quick-fact">
      <strong>Three-Color Identity:</strong>
      <p style="margin: 0; color: #d0d0d0;">Versatile and complete‚Äîonly lacks 2 colors instead of 3 or 4.</p>
    </div>`;
    
    html += `<div class="quick-fact">
      <strong>Common Enemies:</strong>
      <p style="margin: 0; color: #d0d0d0;">${absent.map(c => colorNames[c]).join(' and ')}. Your identity is defined by lacking these two.</p>
    </div>`;
  }
  
  html += `</div></div>`;
  return html;
}

function isAlliedPair(colors) {
  if (colors.length !== 2) return false;
  const alliedPairs = [['W','U'], ['U','B'], ['B','R'], ['R','G'], ['G','W']];
  const sorted = [colors[0], colors[1]].sort().join('');
  return alliedPairs.some(p => p.join('') === sorted);
}

function getPhilosophyContent(id) {
  const profile = PROFILES[id];
  if (!profile) return '<p>Content not available</p>';
  
  const type = getCandidateType(id);
  let html = '';
  
  if (type === 'GUILD') {
    html += getGuildPhilosophy(id, profile);
  } else if (type === 'THREE') {
    html += getThreeColorPhilosophy(id, profile);
  } else if (type === 'MONO') {
    html += getMonoPhilosophy(id, profile);
  } else {
    html += `<div class="info-box">
      <div class="box-content">
        <p style="font-size: 15px; line-height: 1.8;">${profile.desc}</p>
      </div>
    </div>`;
  }
  
  return html;
}

function getGuildPhilosophy(id, profile) {
  const colorNames = {W:'White', U:'Blue', B:'Black', R:'Red', G:'Green'};
  const colors = profile.colors;
  const absent = ['W','U','B','R','G'].filter(c => !colors.includes(c));
  
  let html = '';
  
  html += `<div class="info-box">
    <div class="box-header">
      <span style="font-size: 20px;">ü§ù</span>
      <h4>What ${colorNames[colors[0]]} & ${colorNames[colors[1]]} Share</h4>
    </div>
    <div class="box-content">
      <p>Both colors value certain approaches, and when combined, these shared values get <strong>EMPHASIZED</strong>.</p>
      <p style="margin-top: 16px; padding: 16px; background: rgba(139,92,246,0.1); border-radius: 8px;">
        <strong style="color: #c4b5fd;">Together:</strong> They reinforce each other's core philosophy, creating something stronger than either alone.
      </p>
    </div>
  </div>`;
  
  html += `<div class="info-box">
    <div class="box-header">
      <span style="font-size: 20px;">‚öñÔ∏è</span>
      <h4>The Productive Tension</h4>
    </div>
    <div class="box-content">
      <p>While ${colorNames[colors[0]]} and ${colorNames[colors[1]]} share core values, they <strong>DISAGREE</strong> on key points.</p>
      <p style="margin-top: 16px; font-style: italic; color: #d0d0d0;">
        This tension creates the unique character of ${profile.name}‚Äîyou balance two different perspectives.
      </p>
    </div>
  </div>`;
  
  html += `<div class="info-box">
    <div class="box-header">
      <span style="font-size: 20px;">‚ú®</span>
      <h4>What Emerges Uniquely</h4>
    </div>
    <div class="box-content">
      <p>${profile.name} creates patterns that <strong>neither color alone produces</strong>.</p>
      <p style="margin-top: 12px;">This isn't just "${colorNames[colors[0]]} AND ${colorNames[colors[1]]}"‚Äîit's a genuine fusion with emergent properties.</p>
    </div>
  </div>`;
  
  html += `<div class="info-box shadow">
    <div class="box-header">
      <span style="font-size: 20px;">üö´</span>
      <h4>What's Absent & Why It Matters</h4>
    </div>
    <div class="box-content">
      <p><strong>No ${absent.map(c => colorNames[c]).join(', ')}:</strong></p>
      <ul style="margin-top: 12px;">`;
  
  const absentMeanings = {
    W: {impact: 'No community focus or moral framework', result: 'Must work through efficiency, self-interest, or natural patterns'},
    U: {impact: 'No analytical depth or strategic planning', result: 'Must rely on instinct, tradition, passion, or pragmatism'},
    B: {impact: 'No self-interest or ruthless pragmatism', result: 'Naive about power dynamics, struggles with tough calls'},
    R: {impact: 'No passion, urgency, or emotional authenticity', result: 'Everything calm, measured, potentially too slow'},
    G: {impact: 'No patience, organic growth, or respect for tradition', result: 'Everything active, engineered, potentially unsustainable'}
  };
  
  absent.forEach(c => {
    const meaning = absentMeanings[c];
    html += `<li><strong>${colorNames[c]}:</strong> ${meaning.impact}
      <div style="font-size: 13px; color: #a0a0b0; margin-top: 4px;">‚Üí ${meaning.result}</div>
    </li>`;
  });
  
  html += `</ul>
      <p style="margin-top: 16px; padding: 12px; background: rgba(239,68,68,0.1); border-radius: 8px; border-left: 3px solid #EF4444;">
        <strong style="color: #EF4444;">Key insight:</strong> Your approach is defined by what you CAN'T do as much as what you can.
      </p>
    </div>
  </div>`;
  
  return html;
}

function getThreeColorPhilosophy(id, profile) {
  const colorNames = {W:'White', U:'Blue', B:'Black', R:'Red', G:'Green'};
  const colors = profile.colors;
  const absent = ['W','U','B','R','G'].filter(c => !colors.includes(c));
  
  let html = '';
  
  html += `<div class="info-box">
    <div class="box-header">
      <span style="font-size: 20px;">üéØ</span>
      <h4>What All Three Colors Seek</h4>
    </div>
    <div class="box-content">
      <p>${colorNames[colors[0]]}, ${colorNames[colors[1]]}, and ${colorNames[colors[2]]} all share philosophical common ground.</p>
      <p style="margin-top: 16px; padding: 16px; background: rgba(139,92,246,0.1); border-radius: 8px;">
        When three colors align, they create a <strong style="color: #c4b5fd;">complete and versatile identity</strong> with only minor blind spots (just 2 absent colors).
      </p>
    </div>
  </div>`;
  
  html += `<div class="info-box shadow">
    <div class="box-header">
      <span style="font-size: 20px;">‚öîÔ∏è</span>
      <h4>Common Enemies</h4>
    </div>
    <div class="box-content">
      <p><strong>${absent.map(c => colorNames[c]).join(' and ')}:</strong> All three of your colors oppose these two.</p>
      <p style="margin-top: 12px;">This shared opposition defines your blind spots:</p>
      <ul style="margin-top: 12px;">`;
  
  const absentMeanings = {
    W: 'No community focus‚Äîindividual or collective but not "fair for all"',
    U: 'No analytical optimization‚Äîinstinct and tradition guide you',
    B: 'No self-interest‚Äîeverything serves collective or natural order',
    R: 'No passion or urgency‚Äîcalm, measured, patient',
    G: 'No organic patience‚Äîeverything active and engineered'
  };
  
  absent.forEach(c => {
    html += `<li>‚Ä¢ ${absentMeanings[c]}</li>`;
  });
  
  html += `</ul>
    </div>
  </div>`;
  
  html += `<div class="info-box development">
    <div class="box-header">
      <span style="font-size: 20px;">üîÆ</span>
      <h4>Why Three-Color Is Different</h4>
    </div>
    <div class="box-content">
      <p><strong>You're more complete than simpler identities:</strong></p>
      <ul style="margin-top: 12px;">
        <li>‚Ä¢ Mono-color lacks 4 colors (major limitations)</li>
        <li>‚Ä¢ Two-color lacks 3 colors (significant gaps)</li>
        <li>‚Ä¢ <strong>Three-color lacks only 2 colors</strong> (minor blind spots)</li>
      </ul>
      <p style="margin-top: 16px;">This makes you versatile and adaptable, able to handle diverse situations. The trade-off: less focused than simpler identities.</p>
    </div>
  </div>`;
  
  return html;
}

function getMonoPhilosophy(id, profile) {
  const colorNames = {W:'White', U:'Blue', B:'Black', R:'Red', G:'Green'};
  const color = profile.colors[0];
  const others = ['W','U','B','R','G'].filter(c => c !== color);
  
  let html = '';
  
  html += `<div class="info-box">
    <div class="box-header">
      <span style="font-size: 20px;">üéØ</span>
      <h4>Pure ${colorNames[color]} Philosophy</h4>
    </div>
    <div class="box-content">
      <p style="font-size: 15px; line-height: 1.8;">${profile.desc}</p>
      <p style="margin-top: 16px; padding: 16px; background: rgba(139,92,246,0.1); border-radius: 8px;">
        <strong style="color: #c4b5fd;">Mono-color means:</strong> You're strongly focused in one philosophical direction. This gives you depth and clarity, but limits your range.
      </p>
    </div>
  </div>`;
  
  html += `<div class="info-box shadow">
    <div class="box-header">
      <span style="font-size: 20px;">üö´</span>
      <h4>What You Lack (Four Colors Absent)</h4>
    </div>
    <div class="box-content">
      <p>As a mono-color identity, you lack the perspectives and approaches of <strong>FOUR other colors:</strong></p>
      <ul style="margin-top: 12px;">
        ${others.map(c => `<li>‚Ä¢ No ${colorNames[c]}‚Äîmissing that entire dimension</li>`).join('')}
      </ul>
      <p style="margin-top: 16px; font-style: italic; color: #a0a0b0;">
        This is your biggest development opportunity. See Development tab for how to add other colors.
      </p>
    </div>
  </div>`;
  
  return html;
}

function getWorkplaceContent(id) {
  const profile = PROFILES[id];
  if (!profile) return '<p>Content not available</p>';
  
  let html = '';
  
  html += `<div class="info-box strength">
    <div class="box-header">
      <span style="font-size: 20px;">‚öîÔ∏è</span>
      <h4>Strengths</h4>
    </div>
    <div class="box-content">
      <p style="margin-bottom: 12px; color: #6b9080; font-style: italic;">These are probably strengths you have</p>
      <ul>`;
  profile.str.forEach(s => {
    html += `<li>‚Ä¢ ${s}</li>`;
  });
  html += `</ul>
    </div>
  </div>`;
  
  html += `<div class="info-box shadow">
    <div class="box-header">
      <span style="font-size: 20px;">‚ö†Ô∏è</span>
      <h4>Shadows</h4>
    </div>
    <div class="box-content">
      <p style="margin-bottom: 12px; color: #9b6b6b; font-style: italic;">Risks of this type‚Äîyou may not have these, or may have them and manage them well</p>
      <ul>`;
  profile.weak.forEach(w => {
    html += `<li>‚Ä¢ ${w}</li>`;
  });
  html += `</ul>
    </div>
  </div>`;
  
  html += `<div class="info-box">
    <div class="box-header">
      <span style="font-size: 20px;">üìã</span>
      <h4>Where You Thrive</h4>
    </div>
    <div class="box-content">
      <p><strong>Stereotypical roles for this identity:</strong></p>
      <p style="margin-top: 12px; font-size: 15px; line-height: 1.6;">${profile.roles}</p>
      <p style="margin-top: 16px; font-size: 13px; color: #a0a0b0; font-style: italic;">
        These aren't limitations‚Äîthey're where this identity naturally excels. You can succeed anywhere, but these roles play to your strengths.
      </p>
    </div>
  </div>`;
  
  if (profile.pubBanter) {
    html += `<div class="info-box stress">
      <div class="box-header">
        <span style="font-size: 20px;">üç∫</span>
        <h4>What They Say Behind Your Back</h4>
      </div>
      <div class="box-content">
        <p style="font-style: italic; color: #d0a070; font-size: 15px; line-height: 1.6;">"${profile.pubBanter}"</p>
        <p style="margin-top: 16px; font-size: 13px; color: #a0a0b0;">
          The unvarnished truth. This is your shadow side from others' perspective.
        </p>
      </div>
    </div>`;
  }
  
  return html;
}

function getStressContent(id) {
  const profile = PROFILES[id];
  if (!profile) return '<p>Content not available</p>';
  
  let html = '';
  
  html += `<div class="info-box stress">
    <div class="box-header">
      <span style="font-size: 20px;">‚ö†Ô∏è</span>
      <h4>Under Pressure</h4>
    </div>
    <div class="box-content">
      <p><strong>When ${profile.name} is stressed, watch for:</strong></p>
      <ul style="margin-top: 12px;">`;
  
  const stressPatterns = getStressPatterns(id);
  stressPatterns.forEach(pattern => {
    html += `<li>‚Ä¢ ${pattern}</li>`;
  });
  
  html += `</ul>
      <p style="margin-top: 16px; padding: 12px; background: rgba(245,158,11,0.1); border-radius: 8px; border-left: 3px solid #F59E0B;">
        <strong style="color: #F59E0B;">For teams:</strong> If these patterns intensify, this identity is stressed and needs support.
      </p>
    </div>
  </div>`;
  
  html += `<div class="info-box development">
    <div class="box-header">
      <span style="font-size: 20px;">üîß</span>
      <h4>Recovery Strategies</h4>
    </div>
    <div class="box-content">
      <p><strong>For yourself:</strong></p>
      <ul style="margin-top: 8px; margin-bottom: 16px;">
        <li>‚Ä¢ Recognize the stress pattern early</li>
        <li>‚Ä¢ Channel opposite colors deliberately</li>
        <li>‚Ä¢ Set external accountability and deadlines</li>
        <li>‚Ä¢ Focus on outcomes, not comfortable patterns</li>
        <li>‚Ä¢ Practice the missing colors intentionally</li>
      </ul>
      <p><strong>For your team:</strong></p>
      <ul style="margin-top: 8px;">
        <li>‚Ä¢ Inject missing colors (pair with complementary identities)</li>
        <li>‚Ä¢ Provide structure or freedom as needed</li>
        <li>‚Ä¢ Challenge patterns gently but firmly</li>
        <li>‚Ä¢ Remind them of mission over method</li>
      </ul>
    </div>
  </div>`;
  
  return html;
}

function getStressPatterns(id) {
  const patterns = {
    'AZORIUS': ['Withdraws into process design, avoiding decisions', 'Creates bureaucracy to delay action', 'Condescending about "proper procedure"', 'Dismisses urgency as "lack of planning"', 'Paralyzed between fairness and efficiency'],
    'DIMIR': ['Hoards information more aggressively', 'Paranoid about being outmaneuvered', 'Manipulates situations to regain control', 'Trusts no one', 'Withdraws into strategic scheming'],
    'RAKDOS': ['Explosively destructive', 'Reckless gratification-seeking', 'Burns bridges impulsively', 'Creates chaos deliberately', 'Lashes out at all constraints'],
    'IZZET': ['Scattered across too many experiments', 'Reckless with resources and testing', 'Ignores practical constraints', 'Blows things up (literally or figuratively)', 'Excited by chaos'],
    'GRUUL': ['Increasingly aggressive and hostile', 'Smashes obstacles without thinking', 'Rejects all subtlety completely', 'Hostile to any complexity', 'Pure force over all finesse'],
    'SELESNYA': ['Enables dysfunction through acceptance', 'Sacrifices too much for false harmony', 'Avoids all necessary conflict', 'Toxic positivity', 'Won\'t address real problems'],
    'ORZHOV': ['Increasingly extractive and exploitative', 'Rigid hierarchy enforcement', 'Debt collection mentality', 'Political manipulation intensifies', 'Everything becomes transactional'],
    'GOLGARI': ['Fatalistic acceptance of decay', 'Exploits death and failure coldly', 'Patient to point of complete passivity', 'Cynical about all improvement', 'Waiting for things to die'],
    'SIMIC': ['Over-optimises organic systems destructively', 'Experiments on people without consent', 'Perfectionism paralysis', 'Loses sight of "good enough"', 'Hubris about improvement capability'],
    'BOROS': ['Zealous to dangerous fault', 'Aggressively enforces "right" way', 'Burnout from unsustainable intensity', 'Rigid about honor code', 'Cult-like fervor'],
    'MONO-W': ['Rigidly rule-bound', 'Excessive self-sacrifice', 'Martyr complex', 'Slow consensus-seeking', 'Judges others harshly for rule-breaking'],
    'MONO-U': ['Analysis paralysis worsens', 'Condescending intellectualism', 'Avoids action completely', 'Designs over-complex solutions', 'Dismisses all emotions'],
    'MONO-B': ['Ruthlessly transactional with everyone', 'Cuts people off easily', 'Increasingly amoral decisions', 'Paranoid about exploitation', 'Hoards everything'],
    'MONO-R': ['Explosively emotional', 'Recklessly impulsive', 'Quits/destroys when frustrated', 'Refuses all planning', 'Completely chaotic and scattered'],
    'MONO-G': ['Increasingly passive', 'Fatalistic resignation', 'Stubbornly repetitive despite failure', 'Nostalgic for "good old days"', 'Enables dysfunction through acceptance']
  };
  
  return patterns[id] || [
    'Intensifies characteristic patterns',
    'Shadow behaviors emerge more strongly',
    'Becomes less balanced and flexible',
    'May withdraw or become rigid',
    'Struggles with rapid adaptation'
  ];
}

function getDevelopmentContent(id) {
  const profile = PROFILES[id];
  if (!profile) return '<p>Content not available</p>';
  
  const type = getCandidateType(id);
  const colorNames = {W:'White', U:'Blue', B:'Black', R:'Red', G:'Green'};
  
  let html = '';
  
  html += `<div style="margin-bottom: 24px; padding: 20px; background: rgba(139,92,246,0.08); border-radius: 12px; border-left: 4px solid #a78bfa;">
    <p style="font-size: 15px; color: #d0d0d0; line-height: 1.7;">
      <strong style="color: #c4b5fd;">Development path:</strong> Add colors you're weak in. Each color you add transforms your identity and unlocks new capabilities.
    </p>
  </div>`;
  
  const hasColors = profile.colors;
  const missing = ['W','U','B','R','G'].filter(c => !hasColors.includes(c));
  
  missing.forEach(color => {
    const newIdentity = getNewIdentity(id, color);
    html += `<div class="info-box development">
      <div class="box-header">
        <span class="mana-symbol mana-${color}" style="width: 24px; height: 24px; font-size: 12px;">${color}</span>
        <h4>Adding ${colorNames[color]}</h4>
      </div>
      <div class="box-content">
        ${getDevelopmentPath(id, color, colorNames[color], newIdentity)}
      </div>
    </div>`;
  });
  
  return html;
}

function getNewIdentity(currentId, addingColor) {
  const profile = PROFILES[currentId];
  if (!profile) return null;
  
  const newColors = [...profile.colors, addingColor].sort();
  
  for (const [id, prof] of Object.entries(PROFILES)) {
    if (prof.colors && prof.colors.length === newColors.length) {
      const profColorsSorted = [...prof.colors].sort();
      if (profColorsSorted.every((c, i) => c === newColors[i])) {
        return prof.name;
      }
    }
  }
  
  return null;
}

function getDevelopmentPath(id, color, colorName, newIdentity) {
  const developments = {
    W: {
      what: 'Community focus, fairness, systematic coordination',
      why: 'Adds stakeholder thinking and moral framework',
      how: ['Volunteer for team coordination roles', 'Ask "what\'s best for the team?" before deciding', 'Build one process that helps everyone', 'Practice sacrificing something small for group benefit']
    },
    U: {
      what: 'Analytical depth, strategic thinking, optimization',
      why: 'Adds evidence-based planning and long-term thinking',
      how: ['Analyze before acting‚Äîask "why?" more often', 'Read research on problems before solving', 'Map out consequences 3-5 steps ahead', 'Practice systematic optimization']
    },
    B: {
      what: 'Pragmatism, self-advocacy, tough decisions',
      why: 'Adds agency and ability to make hard calls',
      how: ['Negotiate explicitly for what you need', 'Practice saying no to protect your interests', 'Make one tough call per month', 'Evaluate personal benefit honestly']
    },
    R: {
      what: 'Passion, urgency, decisive action, authenticity',
      why: 'Adds energy and bias toward action',
      how: ['Act on 70% information sometimes', 'Express emotions more openly in meetings', 'Run quick experiments instead of extensive planning', 'Practice "ship it and iterate"']
    },
    G: {
      what: 'Patience, sustainability, organic growth, accumulated wisdom',
      why: 'Adds long-term thinking and respect for what works',
      how: ['Give initiatives time to develop naturally', 'Learn from precedent and experience', 'Practice patience with development timelines', 'Trust proven patterns and tradition']
    }
  };
  
  const dev = developments[color];
  if (!dev) return '<p>Development path information coming soon.</p>';
  
  let html = `
    <p><strong>What ${colorName} adds:</strong> ${dev.what}</p>
    <p style="margin-top: 8px;"><strong>Why you need it:</strong> ${dev.why}</p>
    <p style="margin-top: 12px;"><strong>How to develop:</strong></p>
    <ul style="margin-top: 8px;">`;
  
  dev.how.forEach(h => {
    html += `<li>‚Ä¢ ${h}</li>`;
  });
  
  html += `</ul>`;
  
  if (newIdentity) {
    html += `<p style="margin-top: 16px; padding: 12px; background: rgba(139,92,246,0.1); border-radius: 8px;">
      <strong style="color: #c4b5fd;">What you become:</strong> ${newIdentity}
    </p>`;
  }
  
  return html;
}

function getInteractionsContent(id) {
  return '<p style="color: #e0e0e0;">Interaction content coming soon.</p>';
}

function showResults() {

  // DEFENSIVE: Ensure activationSorted is set
  if (!state.activationSorted || state.activationSorted.length === 0) {
    console.error('CRITICAL: activationSorted not set, recalculating');
    const activation = {
      W: (state.pairwise['W-B'].W / 6 + state.pairwise['W-R'].W / 6) / 2,
      U: (state.pairwise['U-R'].U / 6 + state.pairwise['G-U'].U / 6) / 2,
      B: (state.pairwise['W-B'].B / 6 + state.pairwise['B-G'].B / 6) / 2,
      R: (state.pairwise['U-R'].R / 6 + state.pairwise['W-R'].R / 6) / 2,
      G: (state.pairwise['G-U'].G / 6 + state.pairwise['B-G'].G / 6) / 2
    };
    state.activationSorted = Object.entries(activation).sort((a,b) => b[1] - a[1]);
  }
  
  document.getElementById('screen-assessment').classList.add('hidden');
  document.getElementById('screen-round-transition').classList.add('hidden');
  document.getElementById('screen-interstitial').classList.add('hidden');
  document.getElementById('screen-results').classList.remove('hidden');
  
  const p = PROFILES[state.result.identity];
  
  document.getElementById('res-id').textContent = p.name;
  document.getElementById('res-tag').textContent = p.tag;
  
  // ENHANCEMENT: Detect PRIMARY color in multi-color combinations
  const primaryIndicator = document.getElementById('primary-color-indicator');
  const isCombination = !state.result.identity.startsWith('MONO-');
  if (isCombination && state.activationSorted && state.activationSorted.length >= 2) {
    const topColor = state.activationSorted[0];
    const secondColor = state.activationSorted[1];
    const gap = Math.round((topColor[1] - secondColor[1]) * 100);
    
    // Show primary indicator if gap is ‚â•15%
    if (gap >= 15) {
      const colorNames = { W: 'WHITE', U: 'BLUE', B: 'BLACK', R: 'RED', G: 'GREEN' };
      const primaryName = colorNames[topColor[0]];
      primaryIndicator.querySelector('p').textContent = `${primaryName} is your primary color within this combination (+${gap}% higher than next)`;
      primaryIndicator.style.display = 'block';
    } else {
      primaryIndicator.style.display = 'none';
    }
  } else {
    primaryIndicator.style.display = 'none';
  }
  
  // Calculate total questions across all rounds (excluding "neither" selections)
  const r1Questions = state.responses?.length || 30;
  const r2Questions = state.calibrationAnswers?.length || 0;
  // R3 questions: use tournament match count if available, otherwise fall back to 4
  const r3Questions = state.result?.round3Data?.matchHistory?.length || 
                      (state.result?.round3Data?.allScores ? 4 : 0);
  const totalNeithers = (state.neitherCount || 0) + (state.calibrationNeitherCount || 0);
  const totalQuestions = r1Questions + r2Questions + r3Questions;
  
  // Show which mode was used
  const modeText = state.mode === 'constructed' ? 'Constructed (mana symbols visible)' : 'Blind Draft (pure instinct)';
  document.getElementById('mode-used').textContent = modeText;
  
  // Set restart button text for assessment results
  document.getElementById('restart-btn').textContent = 'Take It Again';
  document.getElementById('restart-text').textContent = 'Retake it to get the result you wanted instead of who you actually are?';
  document.getElementById('explorer-hint').textContent = '';
  
  const badge = document.getElementById('conf-badge');
  badge.textContent = state.result.confidence + ' CONFIDENCE';
  badge.className = 'confidence-badge confidence-' + state.result.confidence;
  
  const expl = {
    HIGH: 'Clear, consistent pattern across stages.',
    MODERATE: 'Strong pattern with some variation.',
    LOW: 'Less clear‚Äîbalanced or context-dependent.'
  };
  document.getElementById('conf-exp').textContent = expl[state.result.confidence];
  
  // Generate identity explanation
  const sorted = state.activationSorted || [];
  const id = state.result.identity;
  const idExp = generateIdentityExplanation(id, sorted);
  document.getElementById('identity-exp').textContent = idExp;
  
  const syms = document.getElementById('res-syms');
  syms.innerHTML = '';
  
  // ENHANCEMENT: Display Round 1 and Round 2 patterns
  displayRoundPatterns();
  p.colors.forEach(c => {
    const s = document.createElement('span');
    s.className = `mana-symbol mana-${c}`;
    s.textContent = c;
    s.style.width = '44px';
    s.style.height = '44px';
    s.style.fontSize = '22px';
    syms.appendChild(s);
  });
  
  document.getElementById('res-desc').textContent = p.desc;
  document.getElementById('res-counter').textContent = p.pubBanter || '';
  
  // Show alternatives for LOW or MODERATE confidence if borderline
  const allResults = state.result.allResults || [];
  // sorted already defined above
  console.log('=== DISPLAYING ALTERNATIVES ===');
  console.log('Confidence:', state.result.confidence);
  console.log('allResults:', allResults.map(a => a[0]).join(', '));
  console.log('allResults.length:', allResults.length);
  
  // Check if top colors are borderline (pattern-specific checks)
  let colorsTied = false;
  const isGuild = state.result.identity && (state.result.identity.length === 2 || 
    ['AZORIUS','SELESNYA','ORZHOV','DIMIR','IZZET','SIMIC','RAKDOS','GOLGARI','GRUUL','BOROS'].includes(state.result.identity));
  const isThreeColor = state.result.identity && 
    ['BANT','ESPER','GRIXIS','JUND','NAYA','ABZAN','JESKAI','SULTAI','MARDU','TEMUR'].includes(state.result.identity);
  
  if (isGuild && sorted.length >= 2) {
    // For guild: check if top 2 colors very close
    colorsTied = Math.abs(sorted[0][1] - sorted[1][1]) < 0.05;
  } else if (isThreeColor && sorted.length >= 3) {
    // For three-color: check if spread across top 3 is small
    const spread = sorted[0][1] - sorted[2][1];
    colorsTied = spread < 0.08;
  } else if (sorted.length >= 3) {
    // For other patterns: check if 2nd and 3rd are tied
    colorsTied = Math.abs(sorted[1][1] - sorted[2][1]) < 0.08;
  }
  
  // Always show alternatives for MODERATE or LOW confidence
  if ((state.result.confidence === 'MODERATE' || state.result.confidence === 'LOW') && allResults.length === 0) {
    colorsTied = true; // Force display if no allResults but confidence not HIGH
  }
  
  console.log('colorsTied:', colorsTied);
  console.log('isGuild:', isGuild, 'isThreeColor:', isThreeColor);
  
  // Check for width shift (expected one type but got another)
  const r3Data = state.result.round3Data || {};
  const hasWidthShift = r3Data.widthShift === true;
  console.log('hasWidthShift:', hasWidthShift, 'shiftDirection:', r3Data.shiftDirection);
  
  // Show if (LOW or MODERATE confidence) AND (colors are tied OR we have actual alternatives OR width shift)
  const shouldShowAlternatives = (state.result.confidence === 'LOW' || state.result.confidence === 'MODERATE') && 
                                  (colorsTied || allResults.length > 1 || hasWidthShift);
  
  if (shouldShowAlternatives) {
    document.getElementById('alternative-results').style.display = 'block';
    
    let whyText = '';
    
    if (allResults.length > 1) {
      const winner = allResults[0];
      const topAlt = allResults[1];
      const winnerData = winner[1];
      const altData = topAlt[1];
      
      // Special messaging for width shift
      if (hasWidthShift && r3Data.expectedWinner) {
        const expectedProfile = PROFILES[r3Data.expectedWinner];
        const expectedName = expectedProfile ? expectedProfile.name : r3Data.expectedWinner;
        
        if (r3Data.shiftDirection === 'wider') {
          whyText = `Your initial patterns suggested ${expectedName}, but your scenario choices revealed a broader identity. We're calling you ${state.result.identity} because you consistently preferred responses that draw on more colors. `;
        } else {
          whyText = `Your initial patterns suggested ${expectedName}, but your scenario choices revealed a more focused identity. We're calling you ${state.result.identity} because you consistently preferred more targeted responses. `;
        }
        whyText += `That said, you're between these identities:`;
      } else {
        whyText = `We're calling you ${state.result.identity} because `;
        
        if (winnerData.s1 > altData.s1 && winnerData.s2 > altData.s2) {
          whyText += `it scored higher in both phases (Round 1: ${Math.round(winnerData.s1*100)}% vs ${Math.round(altData.s1*100)}%, Round 3: ${Math.round(winnerData.s2*100)}% vs ${Math.round(altData.s2*100)}%).`;
        } else if (winnerData.s1 > altData.s1) {
          whyText += `your color pattern in Round 1 pointed more strongly to it (${Math.round(winnerData.s1*100)}% vs ${Math.round(altData.s1*100)}%), and earlier rounds carry more weight.`;
        } else if (winnerData.s2 > altData.s2) {
          whyText += `you picked it more consistently in Round 3 (${Math.round(winnerData.s2*100)}% vs ${Math.round(altData.s2*100)}%).`;
        } else {
          whyText += `the overall pattern across all rounds pointed to it.`;
        }
        
        whyText += ` That said, you're borderline‚Äîyou could legitimately be any of these:`;
      }
    } else {
      whyText = 'Your pattern was borderline. You could legitimately be any of these:';
    }
    
    document.getElementById('why-explanation').textContent = whyText;
    
    const altList = document.getElementById('alternatives-list');
    altList.innerHTML = '';
    
    console.log('=== ALTERNATIVE SELECTION ===');
    console.log('allResults.length:', allResults.length);
    if (allResults.length > 0) {
      console.log('allResults[0] (winner):', allResults[0][0], Math.round((allResults[0][1].combined || allResults[0][1].s1)*100) + '%');
      console.log('state.result.identity (displayed):', state.result.identity);
      console.log('Match?', allResults[0][0] === state.result.identity);
    }
    console.log('Full allResults:', allResults.map(a => `${a[0]}(${Math.round((a[1].combined || a[1].s1)*100)}%)`).join(', '));
    
    // Get alternatives from allResults (ranked Stage 2 results), excluding winner
    let alternatives = allResults.slice(1, 4);
    console.log('Alternatives after slice(1,4):', alternatives.map(a => a[0]).join(', '));
    
    // If there was a width shift, ensure the expected winner is in alternatives
    if (hasWidthShift && r3Data.expectedWinner && r3Data.expectedWinner !== state.result.identity) {
      const expectedInAlts = alternatives.some(a => a[0] === r3Data.expectedWinner);
      if (!expectedInAlts) {
        // Find expected winner in allResults
        const expectedEntry = allResults.find(a => a[0] === r3Data.expectedWinner);
        if (expectedEntry) {
          // Insert at the front of alternatives
          alternatives.unshift(expectedEntry);
          // Keep max 4 alternatives
          if (alternatives.length > 4) alternatives = alternatives.slice(0, 4);
          console.log('Added expected winner to alternatives:', r3Data.expectedWinner);
        }
      }
    }
    console.log('Final alternatives:', alternatives.map(a => a[0]).join(', '));
    console.log('==============================');
    
    // If we have no alternatives but LOW/MODERATE confidence, show guidance
    if (alternatives.length === 0) {
      const guidanceDiv = document.createElement('div');
      guidanceDiv.style.cssText = 'background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 10px; padding: 20px;';
      
      if (state.result.confidence === 'LOW') {
        guidanceDiv.innerHTML = `
          <div style="font-size: 16px; font-weight: 600; color: #F59E0B; margin-bottom: 12px;">‚ö†Ô∏è Pattern Not Clear</div>
          <div style="font-size: 14px; color: #c0c0d0; line-height: 1.6;">
            Your colour distribution doesn't show strong clustering. You might be genuinely balanced across approaches,
            or the assessment questions may not have captured enough nuance.
            <br><br>
            <strong>Your result is still valid</strong> ‚Äî this identity represents your strongest signal, even if confidence is lower.
          </div>
        `;
      } else {
        guidanceDiv.innerHTML = `
          <div style="font-size: 14px; color: #c0c0d0; line-height: 1.6;">
            Your pattern points most strongly to <strong>${state.result.identity}</strong>, 
            though confidence is moderate. The balance between your top colours may shift by context.
          </div>
        `;
      }
      altList.appendChild(guidanceDiv);
    } else {
      // Render actual alternatives
      alternatives.forEach(alt => {
      console.log('Processing alternative:', alt[0]);
      
      // Handle GUIDANCE type
      if (alt[0] === 'GUIDANCE') {
        const guidanceDiv = document.createElement('div');
        guidanceDiv.style.cssText = 'background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 10px; padding: 16px; margin-bottom: 12px;';
        guidanceDiv.innerHTML = `
          <div style="font-weight: 600; margin-bottom: 8px; color: #F59E0B;">üìã Recommendation</div>
          <div style="font-size: 14px; color: #c0c0d0;">${alt[1].note}</div>
        `;
        altList.appendChild(guidanceDiv);
        return;
      }
      
      const altProfile = PROFILES[alt[0]];
      console.log('Profile found for', alt[0], ':', !!altProfile);
      if (!altProfile) {
        console.warn('No profile found for:', alt[0]);
        return;
      }
      
      const altCard = document.createElement('div');
      altCard.style.cssText = 'background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 10px; padding: 16px; cursor: pointer; transition: all 0.2s;';
      altCard.onmouseover = () => altCard.style.background = 'rgba(139, 92, 246, 0.15)';
      altCard.onmouseout = () => altCard.style.background = 'rgba(139, 92, 246, 0.1)';
      altCard.onclick = () => switchToAlternative(alt[0]);
      
      const symbolsDiv = document.createElement('div');
      symbolsDiv.style.cssText = 'display: flex; gap: 6px; margin-bottom: 12px;';
      altProfile.colors.forEach(c => {
        const sym = document.createElement('span');
        sym.className = `mana-symbol mana-${c}`;
        sym.textContent = c;
        sym.style.width = '24px';
        sym.style.height = '24px';
        sym.style.fontSize = '12px';
        symbolsDiv.appendChild(sym);
      });
      
      const nameDiv = document.createElement('div');
      nameDiv.style.cssText = 'font-weight: 700; font-size: 16px; margin-bottom: 8px;';
      nameDiv.textContent = altProfile.name;
      
      const descDiv = document.createElement('div');
      descDiv.style.cssText = 'font-size: 13px; color: #c0c0d0; line-height: 1.6;';
      descDiv.textContent = altProfile.tag;
      
      altCard.appendChild(symbolsDiv);
      altCard.appendChild(nameDiv);
      altCard.appendChild(descDiv);
      altList.appendChild(altCard);
    });
    } // Close else block for alternatives rendering
  } else {
    // Hide alternatives if not genuinely borderline
    document.getElementById('alternative-results').style.display = 'none';
  }
  
  // Display commander with conditional formatting
  const oracleData = COMMANDER_ORACLE[p.cmd];
  
  if (oracleData) {
    // Show full card frame
    document.getElementById('cmd-card-frame').style.display = 'block';
    document.getElementById('cmd-simple').style.display = 'none';
    
    // Populate card frame
    document.getElementById('cmd-name-card').textContent = p.cmd;
    document.getElementById('cmd-desc-card').textContent = p.cmdDesc;
    
    const costDiv = document.getElementById('cmd-cost');
    costDiv.innerHTML = renderManaCost(oracleData.cost);
    
    const ptDiv = document.getElementById('cmd-pt');
    ptDiv.textContent = oracleData.pt;
    
    const oracleText = document.getElementById('cmd-oracle-text');
    oracleText.innerHTML = oracleData.text.map(line => 
      `<div style="margin-bottom: 8px;">${line}</div>`
    ).join('');
  } else {
    // Show simple reference
    document.getElementById('cmd-card-frame').style.display = 'none';
    document.getElementById('cmd-simple').style.display = 'block';
    
    document.getElementById('cmd-name-simple').textContent = p.cmd;
    document.getElementById('cmd-desc-simple').textContent = p.cmdDesc;
  }
  
  // Strengths
  const strList = document.getElementById('strengths');
  strList.innerHTML = '';
  p.str.forEach(s => {
    const li = document.createElement('li');
    li.style.cssText = 'padding: 6px 0; color: #10B981; font-size: 14px;';
    li.textContent = '‚Ä¢ ' + s;
    strList.appendChild(li);
  });
  
  // Weaknesses
  const weakList = document.getElementById('weaknesses');
  weakList.innerHTML = '';
  p.weak.forEach(w => {
    const li = document.createElement('li');
    li.style.cssText = 'padding: 6px 0; color: #EF4444; font-size: 14px;';
    li.textContent = '‚Ä¢ ' + w;
    weakList.appendChild(li);
  });
  
  document.getElementById('roles').textContent = p.roles;
  
  // Color breakdown - use ACTIVATION scores, not raw colorScores
  const names = {W:'White',U:'Blue',B:'Black',R:'Red',G:'Green'};
  const grads = {
    W:'linear-gradient(90deg, #FDE047, #F59E0B)',
    U:'linear-gradient(90deg, #93C5FD, #3B82F6)',
    B:'linear-gradient(90deg, #D1D5DB, #6B7280)',
    R:'linear-gradient(90deg, #FCA5A5, #EF4444)',
    G:'linear-gradient(90deg, #6EE7B7, #10B981)'
  };
  
  // DEBUG: Log scores before display
  console.log('=== SCORE DISPLAY DEBUG ===');
  console.log('Identity:', state.result.identity);
  console.log('Expected colors:', PROFILES[state.result.identity].colors);
  console.log('activationSorted:', state.activationSorted);
  console.log('========================');
  
  const bd = document.getElementById('breakdown');
  bd.innerHTML = '';
  
  // Use activationSorted (the actual scores used for identity determination)
  state.activationSorted.forEach(([color, activation]) => {
    const pct = Math.round(activation * 100);
    
    const bar = document.createElement('div');
    bar.style.cssText = 'margin: 16px 0;';
    bar.innerHTML = `
      <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: 600;">
        <div style="display: flex; align-items: center; gap: 12px;">
          <span class="mana-symbol mana-${color}" style="width: 28px; height: 28px; font-size: 14px;">${color}</span>
          <span>${names[color]}</span>
        </div>
        <span style="font-size: 20px; font-weight: 800;">${pct}%</span>
      </div>
      <div style="width: 100%; height: 12px; background: rgba(255,255,255,0.1); border-radius: 6px; overflow: hidden;">
        <div style="height: 100%; width: ${pct}%; background: ${grads[color]}; border-radius: 6px; transition: width 0.5s;"></div>
      </div>
    `;
    bd.appendChild(bar);
  });
  
  window.scrollTo({top: 0, behavior: 'smooth'});
}

function switchToAlternative(altIdentity) {
  // Find current result and selected alternative in allResults
  if (!state.result.allResults || state.result.allResults.length === 0) {
    console.error('No allResults available for switching');
    return;
  }
  
  const currentIdentity = state.result.identity;
  const allResults = state.result.allResults;
  
  // Find indices of current and alternative
  const currentIdx = allResults.findIndex(r => r[0] === currentIdentity);
  const altIdx = allResults.findIndex(r => r[0] === altIdentity);
  
  if (currentIdx === -1 || altIdx === -1) {
    console.error('Could not find identities in allResults', {currentIdentity, altIdentity, allResults});
    return;
  }
  
  // Swap positions in array
  [allResults[currentIdx], allResults[altIdx]] = [allResults[altIdx], allResults[currentIdx]];
  
  // Update state to new identity
  state.result.identity = altIdentity;
  
  // Re-render entire results page with updated allResults
  showResults();
  
  window.scrollTo({top: 0, behavior: 'smooth'});
}

function restart() {
  // Reset state completely
  state = {
    stage: 1,
    qNum: 0,
    qTot: 30,
    mode: 'draft', // Reset to default mode
    responses: [],
    colorScores: {W:0, U:0, B:0, R:0, G:0},
    pairwise: {
      'W-B': {W:0, B:0},
      'U-R': {U:0, R:0},
      'G-U': {G:0, U:0},
      'W-R': {W:0, R:0},
      'B-G': {B:0, G:0}
    },
    poolA: [],
    poolS2: [],
    s2Track: {appear: {}, select: {}},
    activationSorted: [],
    result: null,
    candidates: null,
    originalResult: null
  };
  
  document.getElementById('screen-results').classList.add('hidden');
  document.getElementById('screen-welcome').classList.remove('hidden');
  window.scrollTo({top: 0});
  
  // Reinitialize front page
  initArchetypeOfMonth();
  
  // Reset mode selection to draft
  selectMode('draft');
}

// ============================================================================
// EXPLORER FUNCTIONS
// ============================================================================
function showExplorer() {
  // Hide current screen
  document.getElementById('screen-welcome').classList.add('hidden');
  document.getElementById('screen-results').classList.add('hidden');
  document.getElementById('screen-explorer').classList.remove('hidden');
  
  // Populate explorer cards
  populateExplorer();
  window.scrollTo({top: 0, behavior: 'smooth'});
}

function closeExplorer() {
  document.getElementById('screen-explorer').classList.add('hidden');
  
  // Return to previous screen
  if (state.result && !state.result.isExplorer) {
    document.getElementById('screen-results').classList.remove('hidden');
  } else {
    document.getElementById('screen-welcome').classList.remove('hidden');
  }
  
  window.scrollTo({top: 0, behavior: 'smooth'});
}

function populateExplorer() {
  const monoIds = ['MONO-W', 'MONO-U', 'MONO-B', 'MONO-R', 'MONO-G'];
  const guildIds = ['AZORIUS', 'DIMIR', 'RAKDOS', 'GRUUL', 'SELESNYA', 'ORZHOV', 'IZZET', 'GOLGARI', 'SIMIC', 'BOROS'];
  const threeIds = ['BANT', 'ESPER', 'GRIXIS', 'JUND', 'NAYA', 'ABZAN', 'JESKAI', 'SULTAI', 'MARDU', 'TEMUR'];
  const fourIds = ['WITCH', 'YORE', 'GLINT', 'DUNE', 'INK'];
  const fiveIds = ['WUBRG'];
  
  document.getElementById('explorer-mono').innerHTML = monoIds.map(id => createExplorerCard(id)).join('');
  document.getElementById('explorer-guilds').innerHTML = guildIds.map(id => createExplorerCard(id)).join('');
  document.getElementById('explorer-three').innerHTML = threeIds.map(id => createExplorerCard(id)).join('');
  document.getElementById('explorer-four').innerHTML = fourIds.map(id => createExplorerCard(id)).join('');
  document.getElementById('explorer-five').innerHTML = fiveIds.map(id => createExplorerCard(id)).join('');
}

function createExplorerCard(id) {
  const p = PROFILES[id];
  if (!p) return '';
  
  const symbolsHTML = p.colors.map(c => 
    `<span class="mana-symbol mana-${c}" style="width: 24px; height: 24px; font-size: 12px;">${c}</span>`
  ).join('');
  
  return `
    <div id="card-${id}" onclick="showDetail('${id}')" style="
      background: rgba(255,255,255,0.03);
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 12px;
    " 
    onmouseover="this.style.background='rgba(139, 92, 246, 0.1)'; this.style.borderColor='rgba(139, 92, 246, 0.4)';"
    onmouseout="if(!this.classList.contains('selected')) { this.style.background='rgba(255,255,255,0.03)'; this.style.borderColor='rgba(255,255,255,0.1)'; }">
      
      <div style="display: flex; gap: 4px;">
        ${symbolsHTML}
      </div>
      
      <div style="flex: 1; min-width: 0;">
        <div style="font-size: 14px; font-weight: 700; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${p.name}</div>
        <div style="font-size: 11px; color: #a0a0b0; font-style: italic; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${p.tag}</div>
      </div>
    </div>
  `;
}

function showDetail(id) {
  const p = PROFILES[id];
  if (!p) return;
  
  // Clear previous selection
  document.querySelectorAll('[id^="card-"]').forEach(card => {
    card.classList.remove('selected');
    card.style.background = 'rgba(255,255,255,0.03)';
    card.style.borderColor = 'rgba(255,255,255,0.1)';
  });
  
  // Highlight selected card
  const selectedCard = document.getElementById(`card-${id}`);
  if (selectedCard) {
    selectedCard.classList.add('selected');
    selectedCard.style.background = 'rgba(139, 92, 246, 0.15)';
    selectedCard.style.borderColor = 'rgba(139, 92, 246, 0.6)';
  }
  
  // Hide placeholder, show content
  document.getElementById('detail-placeholder').style.display = 'none';
  document.getElementById('detail-content').style.display = 'block';
  
  // Populate detail panel
  const symbolsDiv = document.getElementById('detail-symbols');
  symbolsDiv.innerHTML = '';
  p.colors.forEach(c => {
    const s = document.createElement('span');
    s.className = `mana-symbol mana-${c}`;
    s.style.cssText = 'width: 40px; height: 40px; font-size: 20px;';
    s.textContent = c;
    symbolsDiv.appendChild(s);
  });
  
  document.getElementById('detail-name').textContent = p.name;
  document.getElementById('detail-tag').textContent = p.tag;
  document.getElementById('detail-desc').textContent = p.desc;
  
  // Get archetype example descriptions
  const example = ARCHETYPE_EXAMPLES.find(e => e.id === id);
  document.getElementById('detail-normal').textContent = example ? example.normal : p.desc;
  document.getElementById('detail-banter').textContent = example ? example.banter : p.pubBanter;
  
  // Commander
  document.getElementById('detail-cmd-name').textContent = p.cmd;
  document.getElementById('detail-cmd-desc').textContent = p.cmdDesc;
  
  // Strengths (show first 3)
  const strList = document.getElementById('detail-strengths');
  strList.innerHTML = '';
  p.str.slice(0, 3).forEach(s => {
    const li = document.createElement('li');
    li.style.cssText = 'padding: 4px 0; font-size: 13px;';
    li.textContent = '‚Ä¢ ' + s;
    strList.appendChild(li);
  });
  
  // Shadows (show first 3)
  const shadowList = document.getElementById('detail-shadows');
  shadowList.innerHTML = '';
  p.weak.slice(0, 3).forEach(w => {
    const li = document.createElement('li');
    li.style.cssText = 'padding: 4px 0; font-size: 13px;';
    li.textContent = '‚Ä¢ ' + w;
    shadowList.appendChild(li);
  });
  
  document.getElementById('detail-roles').textContent = p.roles;
  
  // Scroll detail panel to top
  document.getElementById('detail-panel').scrollTop = 0;
}

// ============================================================================
// INTERACTIONS GUIDE FUNCTIONS
// ============================================================================
function showInteractions() {
  // Hide current screen
  document.getElementById('screen-welcome').classList.add('hidden');
  document.getElementById('screen-results').classList.add('hidden');
  document.getElementById('screen-explorer').classList.add('hidden');
  document.getElementById('screen-interactions').classList.remove('hidden');
  
  // If coming from results (user has an identity), personalize it
  if (state.result && !state.result.isExplorer) {
    personalizeInteractions();
  } else {
    // Generic view
    document.getElementById('your-colors-section').style.display = 'none';
  }
  
  window.scrollTo({top: 0, behavior: 'smooth'});
}

function closeInteractions() {
  document.getElementById('screen-interactions').classList.add('hidden');
  
  // Return to previous screen
  if (state.result && !state.result.isExplorer) {
    document.getElementById('screen-results').classList.remove('hidden');
  } else {
    document.getElementById('screen-welcome').classList.remove('hidden');
  }
  
  window.scrollTo({top: 0, behavior: 'smooth'});
}

function personalizeInteractions() {
  const p = PROFILES[state.result.identity];
  if (!p) return;
  
  // Show and populate "Your Colors" section
  document.getElementById('your-colors-section').style.display = 'block';
  
  // Populate your symbols
  const symsDiv = document.getElementById('interactions-your-symbols');
  symsDiv.innerHTML = '';
  p.colors.forEach(c => {
    const s = document.createElement('span');
    s.className = `mana-symbol mana-${c}`;
    s.style.cssText = 'width: 36px; height: 36px; font-size: 18px;';
    s.textContent = c;
    symsDiv.appendChild(s);
  });
  
  document.getElementById('interactions-your-name').textContent = p.name;
  document.getElementById('interactions-your-tag').textContent = p.tag;
  
  // Generate personalized interaction guidance
  const yourContent = document.getElementById('interactions-your-content');
  let content = '<div style="font-size: 14px; color: #d0d0d0; line-height: 1.7;">';
  
  content += '<p style="margin-bottom: 16px;"><strong>Your strongest colors are:</strong> ';
  content += p.colors.map(c => ['White','Blue','Black','Red','Green'][['W','U','B','R','G'].indexOf(c)]).join(' and ');
  content += '.</p>';
  
  content += '<p style="margin-bottom: 12px;"><strong>This means you naturally:</strong></p>';
  content += '<ul style="list-style: none; padding-left: 0; margin-bottom: 16px;">';
  
  // Add natural tendencies based on colors
  const colorTraits = {
    W: 'Value team coordination and fairness',
    U: 'Seek optimal strategies through analysis',
    B: 'Prioritize results and self-advocacy',
    R: 'Trust your instincts and act quickly',
    G: 'Prefer proven approaches and patience'
  };
  
  p.colors.forEach(c => {
    content += `<li style="padding: 4px 0;">‚Ä¢ ${colorTraits[c]}</li>`;
  });
  
  content += '</ul>';
  content += '<p><strong>Scroll down to see how to work with people who think differently from you.</strong></p>';
  content += '</div>';
  
  yourContent.innerHTML = content;
}

// HELPER FUNCTIONS
function getGuild(c) {
  const m = {UW:'AZORIUS',WU:'AZORIUS',UB:'DIMIR',BU:'DIMIR',BR:'RAKDOS',RB:'RAKDOS',RG:'GRUUL',GR:'GRUUL',GW:'SELESNYA',WG:'SELESNYA',WB:'ORZHOV',BW:'ORZHOV',UR:'IZZET',RU:'IZZET',BG:'GOLGARI',GB:'GOLGARI',GU:'SIMIC',UG:'SIMIC',RW:'BOROS',WR:'BOROS'};
  return m[c] || 'AZORIUS';
}

function getThree(c) {
  const m = {GUW:'BANT',GWU:'BANT',UGW:'BANT',UWG:'BANT',WGU:'BANT',WUG:'BANT',UWB:'ESPER',UBW:'ESPER',WUB:'ESPER',WBU:'ESPER',BUW:'ESPER',BWU:'ESPER',UBR:'GRIXIS',URB:'GRIXIS',BUR:'GRIXIS',BRU:'GRIXIS',RUB:'GRIXIS',RBU:'GRIXIS',BRG:'JUND',BGR:'JUND',RBG:'JUND',RGB:'JUND',GBR:'JUND',GRB:'JUND',RGW:'NAYA',RWG:'NAYA',GRW:'NAYA',GWR:'NAYA',WRG:'NAYA',WGR:'NAYA',WBG:'ABZAN',WGB:'ABZAN',BWG:'ABZAN',BGW:'ABZAN',GWB:'ABZAN',GBW:'ABZAN',URW:'JESKAI',UWR:'JESKAI',RUW:'JESKAI',RWU:'JESKAI',WUR:'JESKAI',WRU:'JESKAI',BGU:'SULTAI',BUG:'SULTAI',GBU:'SULTAI',GUB:'SULTAI',UBG:'SULTAI',UGB:'SULTAI',RWB:'MARDU',RBW:'MARDU',WRB:'MARDU',WBR:'MARDU',BRW:'MARDU',BWR:'MARDU',GUR:'TEMUR',GRU:'TEMUR',UGR:'TEMUR',URG:'TEMUR',RGU:'TEMUR',RUG:'TEMUR'};
  return m[c] || 'BANT';
}

function getFour(absent) {
  const m = {R:'WITCH',G:'YORE',W:'GLINT',U:'DUNE',B:'INK'};
  return m[absent] || 'WITCH';
}

// NEW: Helper functions for improved classification
function getEnemies(color) {
  const enemyMap = {
    W: ['B', 'R'],
    U: ['R', 'G'],
    B: ['W', 'G'],
    R: ['U', 'W'],
    G: ['U', 'B']
  };
  return enemyMap[color] || [];
}

function areEnemies(color1, color2) {
  const enemyPairs = [
    ['W', 'B'], ['B', 'W'],
    ['U', 'R'], ['R', 'U'],
    ['G', 'U'], ['U', 'G'],
    ['W', 'R'], ['R', 'W'],
    ['B', 'G'], ['G', 'B']
  ];
  return enemyPairs.some(pair => 
    (pair[0] === color1 && pair[1] === color2) ||
    (pair[0] === color2 && pair[1] === color1)
  );
}

function generateThreeColorCombos(fourColors) {
  const combos = [];
  for (let i = 0; i < 4; i++) {
    for (let j = i+1; j < 4; j++) {
      for (let k = j+1; k < 4; k++) {
        const combo = [fourColors[i], fourColors[j], fourColors[k]].sort().join('');
        const threeId = getThree(combo);
        if (threeId) combos.push(threeId);
      }
    }
  }
  return combos;
}

function getGuildColors(guild) {
  const m = {AZORIUS:['W','U'],SELESNYA:['W','G'],ORZHOV:['W','B'],DIMIR:['U','B'],IZZET:['U','R'],SIMIC:['U','G'],RAKDOS:['B','R'],GOLGARI:['B','G'],GRUUL:['R','G'],BOROS:['R','W']};
  return m[guild] || ['W','U'];
}

// NEW: Universal function to get colors for ANY identity (mono, guild, three, four, five)
function getIdentityColors(identityId) {
  // First check if it's in PROFILES (handles everything)
  if (PROFILES[identityId] && PROFILES[identityId].colors) {
    return PROFILES[identityId].colors;
  }
  
  // Fallback to getGuildColors for two-color
  if (getGuildColors(identityId)) {
    return getGuildColors(identityId);
  }
  
  // Last resort: return empty array
  return [];
}

function findAdjacentGuilds(colors, exclude) {
  const all = ['AZORIUS','SELESNYA','ORZHOV','DIMIR','IZZET','SIMIC','RAKDOS','GOLGARI','GRUUL','BOROS'];
  return all.filter(g => {
    if (g === exclude) return false;
    const gc = getGuildColors(g);
    return (gc.includes(colors[0]) || gc.includes(colors[1])) && !(gc.includes(colors[0]) && gc.includes(colors[1]));
  });
}

function findGuildsWithColor(color) {
  const all = ['AZORIUS','SELESNYA','ORZHOV','DIMIR','IZZET','SIMIC','RAKDOS','GOLGARI','GRUUL','BOROS'];
  return all.filter(g => getGuildColors(g).includes(color));
}

// ============================================================================
// TEST HARNESS - 31 canonical test cases
// Access via: runTestHarness() in console or ?test=1 URL param
// ============================================================================

const TEST_CASES = [
  // MONO colors (5)
  { name: 'MONO-W', scores: {W:0.85, U:0.55, B:0.45, R:0.40, G:0.60}, desc: 'White dominant' },
  { name: 'MONO-U', scores: {W:0.40, U:0.88, B:0.52, R:0.35, G:0.48}, desc: 'Blue dominant' },
  { name: 'MONO-B', scores: {W:0.35, U:0.45, B:0.90, R:0.55, G:0.42}, desc: 'Black dominant' },
  { name: 'MONO-R', scores: {W:0.42, U:0.38, B:0.48, R:0.92, G:0.55}, desc: 'Red dominant' },
  { name: 'MONO-G', scores: {W:0.50, U:0.35, B:0.40, R:0.52, G:0.88}, desc: 'Green dominant' },
  
  // Allied guilds (5)
  { name: 'AZORIUS', scores: {W:0.78, U:0.75, B:0.35, R:0.30, G:0.45}, desc: 'W-U allies' },
  { name: 'DIMIR', scores: {W:0.30, U:0.80, B:0.77, R:0.42, G:0.35}, desc: 'U-B allies' },
  { name: 'RAKDOS', scores: {W:0.25, U:0.38, B:0.76, R:0.79, G:0.40}, desc: 'B-R allies' },
  { name: 'GRUUL', scores: {W:0.40, U:0.30, B:0.35, R:0.77, G:0.80}, desc: 'R-G allies' },
  { name: 'SELESNYA', scores: {W:0.78, U:0.35, B:0.28, R:0.42, G:0.76}, desc: 'G-W allies' },
  
  // Enemy guilds (5)
  { name: 'ORZHOV', scores: {W:0.75, U:0.40, B:0.78, R:0.35, G:0.38}, desc: 'W-B enemies' },
  { name: 'IZZET', scores: {W:0.35, U:0.80, B:0.42, R:0.77, G:0.30}, desc: 'U-R enemies' },
  { name: 'GOLGARI', scores: {W:0.38, U:0.32, B:0.76, R:0.40, G:0.79}, desc: 'B-G enemies' },
  { name: 'BOROS', scores: {W:0.77, U:0.30, B:0.35, R:0.80, G:0.42}, desc: 'R-W enemies' },
  { name: 'SIMIC', scores: {W:0.40, U:0.78, B:0.32, R:0.35, G:0.75}, desc: 'G-U enemies' },
  
  // Shards (5)
  { name: 'ESPER', scores: {W:0.72, U:0.75, B:0.70, R:0.30, G:0.28}, desc: 'W-U-B shard' },
  { name: 'GRIXIS', scores: {W:0.25, U:0.73, B:0.75, R:0.71, G:0.30}, desc: 'U-B-R shard' },
  { name: 'JUND', scores: {W:0.28, U:0.30, B:0.70, R:0.74, G:0.72}, desc: 'B-R-G shard' },
  { name: 'NAYA', scores: {W:0.71, U:0.28, B:0.25, R:0.73, G:0.75}, desc: 'R-G-W shard' },
  { name: 'BANT', scores: {W:0.74, U:0.72, B:0.25, R:0.30, G:0.70}, desc: 'G-W-U shard' },
  
  // Wedges (5)
  { name: 'ABZAN', scores: {W:0.73, U:0.28, B:0.70, R:0.30, G:0.72}, desc: 'W-B-G wedge' },
  { name: 'JESKAI', scores: {W:0.70, U:0.75, B:0.28, R:0.72, G:0.30}, desc: 'U-R-W wedge' },
  { name: 'SULTAI', scores: {W:0.25, U:0.71, B:0.74, R:0.30, G:0.70}, desc: 'B-G-U wedge' },
  { name: 'MARDU', scores: {W:0.72, U:0.30, B:0.70, R:0.73, G:0.28}, desc: 'R-W-B wedge' },
  { name: 'TEMUR', scores: {W:0.28, U:0.70, B:0.30, R:0.72, G:0.74}, desc: 'G-U-R wedge' },
  
  // Four-color (5)
  { name: 'YORE', scores: {W:0.68, U:0.70, B:0.67, R:0.65, G:0.25}, desc: 'No Green' },
  { name: 'GLINT', scores: {W:0.22, U:0.68, B:0.70, R:0.66, G:0.67}, desc: 'No White' },
  { name: 'DUNE', scores: {W:0.67, U:0.20, B:0.68, R:0.70, G:0.66}, desc: 'No Blue' },
  { name: 'INK', scores: {W:0.68, U:0.66, B:0.22, R:0.70, G:0.67}, desc: 'No Black' },
  { name: 'WITCH', scores: {W:0.67, U:0.70, B:0.68, R:0.20, G:0.66}, desc: 'No Red' },
  
  // Five-color (1)
  { name: 'WUBRG', scores: {W:0.52, U:0.50, B:0.48, R:0.51, G:0.49}, desc: 'All balanced' }
];

function scoresToAnalysis(scores) {
  const sorted = Object.entries(scores)
    .map(([color, winRate]) => ({ color, winRate, total: Math.round(winRate * 12) }))
    .sort((a, b) => b.winRate - a.winRate);
  
  const gaps = [];
  for (let i = 0; i < sorted.length - 1; i++) {
    gaps.push(sorted[i].winRate - sorted[i + 1].winRate);
  }
  
  // Simple clustering
  const clusters = [[]];
  sorted.forEach((colorData, idx) => {
    clusters[clusters.length - 1].push(colorData);
    if (gaps[idx] && gaps[idx] > 0.10) clusters.push([]);
  });
  if (clusters[clusters.length - 1].length === 0) clusters.pop();
  
  return { sorted, gaps, clusters };
}

function runSingleTest(testCase) {
  const analysis = scoresToAnalysis(testCase.scores);
  const candidates = generateCandidatesGapBased(analysis);
  
  const winner = candidates[0];
  const inTop3 = candidates.slice(0, 3).some(c => c.id === testCase.name);
  const position = candidates.findIndex(c => c.id === testCase.name);
  
  return {
    expected: testCase.name,
    actual: winner?.id,
    pass: winner?.id === testCase.name,
    inTop3,
    position: position >= 0 ? position + 1 : null,
    candidates: candidates.map(c => c.id)
  };
}

function runTestHarness() {
  console.log('=== MANA COLORS TEST HARNESS ===');
  console.log('Running 31 canonical test cases...\n');
  
  let passed = 0;
  let inTop3 = 0;
  const failures = [];
  
  TEST_CASES.forEach(tc => {
    const result = runSingleTest(tc);
    
    if (result.pass) {
      passed++;
      console.log(`‚úì ${tc.name}: PASS`);
    } else {
      if (result.inTop3) inTop3++;
      failures.push({ ...tc, result });
      console.log(`‚úó ${tc.name}: FAIL - got ${result.actual} (expected at #${result.position || 'N/A'})`);
      console.log(`  Candidates: ${result.candidates.join(', ')}`);
    }
  });
  
  console.log('\n=== SUMMARY ===');
  console.log(`Passed: ${passed}/${TEST_CASES.length} (${Math.round(passed/TEST_CASES.length*100)}%)`);
  console.log(`In Top 3: ${passed + inTop3}/${TEST_CASES.length}`);
  
  if (failures.length > 0) {
    console.log('\n=== FAILURES ===');
    failures.forEach(f => {
      console.log(`${f.name} (${f.desc}): got ${f.result.actual}`);
    });
  }
  
  return { passed, total: TEST_CASES.length, failures };
}

// Check for ?test=1 URL param
if (window.location.search.includes('test=1')) {
  setTimeout(() => {
    const results = runTestHarness();
    alert(`Test Results: ${results.passed}/${results.total} passed`);
  }, 500);
}

// Export to window for console access
window.runTestHarness = runTestHarness;
window.TEST_CASES = TEST_CASES;
window.runSingleTest = runSingleTest;

console.log('=== SCRIPT END - All functions defined ===');
console.log('Test harness available: runTestHarness() or add ?test=1 to URL');
</script>
</body>
</html>