<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Mana Colors Assessment</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Inter', sans-serif;
  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
  color: #e0e0e0;
  min-height: 100vh;
  padding: 20px;
}

.container { max-width: 900px; margin: 0 auto; }

.mana-symbol {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 36px;
  height: 36px;
  border-radius: 50%;
  font-weight: 800;
  font-size: 18px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  border: 2px solid;
}

.mana-W { background: linear-gradient(135deg, #FEF3C7, #FDE047); color: #713F12; border-color: #F59E0B; }
.mana-U { background: linear-gradient(135deg, #DBEAFE, #93C5FD); color: #1E3A8A; border-color: #3B82F6; }
.mana-B { background: linear-gradient(135deg, #E5E7EB, #D1D5DB); color: #1F2937; border-color: #6B7280; }
.mana-R { background: linear-gradient(135deg, #FEE2E2, #FCA5A5); color: #7F1D1D; border-color: #EF4444; }
.mana-G { background: linear-gradient(135deg, #D1FAE5, #6EE7B7); color: #064E3B; border-color: #10B981; }

.card {
  background: rgba(30, 30, 46, 0.95);
  border: 2px solid rgba(255, 255, 255, 0.1);
  border-radius: 16px;
  padding: 32px;
  margin-bottom: 24px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
}

.choice-button {
  width: 100%;
  padding: 24px;
  margin: 12px 0;
  background: rgba(255, 255, 255, 0.05);
  border: 2px solid rgba(255, 255, 255, 0.1);
  border-radius: 12px;
  color: #e0e0e0;
  font-size: 16px;
  text-align: left;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 16px;
}

.choice-button:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(255, 255, 255, 0.3);
  transform: translateY(-2px);
}

.mode-card {
  padding: 20px;
  background: rgba(255,255,255,0.05);
  border: 2px solid rgba(139, 92, 246, 0.3);
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s;
}

.mode-card:hover {
  background: rgba(139, 92, 246, 0.1);
  border-color: rgba(139, 92, 246, 0.5);
  transform: translateY(-2px);
}

.explorer-btn {
  background: rgba(255,255,255,0.05);
  border: 2px solid rgba(139, 92, 246, 0.3);
  color: #a78bfa;
  padding: 12px 24px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
}

.explorer-btn:hover {
  background: rgba(139, 92, 246, 0.15);
  border-color: rgba(139, 92, 246, 0.6);
  transform: translateY(-2px);
}

.btn-primary {
  background: linear-gradient(135deg, #6366f1, #8b5cf6);
  color: white;
  padding: 16px 32px;
  border: none;
  border-radius: 12px;
  font-size: 18px;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s;
  box-shadow: 0 4px 16px rgba(99, 102, 241, 0.4);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(99, 102, 241, 0.6);
}

.hidden { display: none !important; }

.result-card {
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
  border: 2px solid rgba(139, 92, 246, 0.3);
  padding: 40px;
  border-radius: 20px;
  margin: 24px 0;
}

.confidence-badge {
  display: inline-block;
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 14px;
  font-weight: 700;
  text-transform: uppercase;
}

.confidence-HIGH { background: rgba(16, 185, 129, 0.2); color: #10B981; border: 1px solid #10B981; }
.confidence-MODERATE { background: rgba(59, 130, 246, 0.2); color: #3B82F6; border: 1px solid #3B82F6; }
.confidence-LOW { background: rgba(245, 158, 11, 0.2); color: #F59E0B; border: 1px solid #F59E0B; }

.fade-in { animation: fadeIn 0.5s ease-in; }
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.bounce-symbol {
  animation: bounce 1s ease-in-out infinite;
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-20px); }
}

.archetype-plaque {
  background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(99, 102, 241, 0.15));
  border: 3px solid rgba(139, 92, 246, 0.4);
  border-radius: 16px;
  padding: 32px;
  margin: 32px 0;
  box-shadow: 0 8px 24px rgba(139, 92, 246, 0.2);
  position: relative;
}

.archetype-plaque::before {
  content: '';
  position: absolute;
  top: -2px;
  left: -2px;
  right: -2px;
  bottom: -2px;
  background: linear-gradient(45deg, rgba(139, 92, 246, 0.3), rgba(99, 102, 241, 0.3));
  border-radius: 18px;
  z-index: -1;
}

@media (max-width: 768px) {
  body { padding: 12px; }
  .card { padding: 20px; }
  .choice-button { padding: 16px; font-size: 14px; }
  .strengths-grid { grid-template-columns: 1fr !important; }
  #archetype-of-month > div[style*="grid-template-columns"] { grid-template-columns: 1fr !important; }
  .mode-card { padding: 16px !important; }
  #mode-constructed, #mode-draft { grid-column: span 1; }
  #explorer-mono, #explorer-guilds, #explorer-three, #explorer-four, #explorer-five {
    grid-template-columns: 1fr !important;
  }
  /* Stack explorer columns on mobile */
  #screen-explorer > div:nth-child(2) {
    grid-template-columns: 1fr !important;
  }
  #detail-panel {
    position: static !important;
    margin-top: 20px;
  }
  /* Stack pub descriptions on mobile */
  #detail-content > div:nth-child(3),
  #detail-content > div:nth-child(5) {
    grid-template-columns: 1fr !important;
  }
}

/* ==================================================================== */
/* ENHANCEMENTS: Shimmer, Glow, Modal, Round Display */
/* ==================================================================== */

.progress-shimmer { position: relative; overflow: hidden; }
.progress-shimmer::before {
  content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
  background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.15) 50%, transparent 70%);
  animation: shimmer 3s infinite; pointer-events: none;
}
@keyframes shimmer {
  0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
  100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
}
.progress-opalescent { box-shadow: inset 0 1px 2px rgba(255,255,255,0.4), inset 0 -1px 2px rgba(0,0,0,0.3), 0 2px 8px rgba(0,0,0,0.2); }
.dominant-glow { animation: pulse-glow 2s infinite; }
@keyframes pulse-glow {
  0%, 100% { box-shadow: 0 0 10px rgba(167,139,250,0.5), inset 0 0 10px rgba(167,139,250,0.2); }
  50% { box-shadow: 0 0 20px rgba(167,139,250,0.8), inset 0 0 15px rgba(167,139,250,0.4); }
}
#modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.90); z-index: 1000; display: flex; align-items: center; justify-content: center; padding: 20px; }
.modal-content-wrapper { max-width: 900px; max-height: 90vh; width: 100%; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 2px solid rgba(139,92,246,0.4); border-radius: 20px; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.8); animation: slideUp 0.4s; }
@keyframes slideUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }
.modal-close { position: sticky; top: 16px; float: right; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #e0e0e0; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; line-height: 38px; text-align: center; cursor: pointer; transition: all 0.2s; margin: 16px; }
.modal-close:hover { background: rgba(255,255,255,0.2); transform: rotate(90deg); }
.deep-dive-btn { width: 100%; background: rgba(139,92,246,0.1); border: 1px solid rgba(139,92,246,0.3); color: #c4b5fd; padding: 18px 24px; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s; margin: 10px 0; text-align: left; display: block; }
.deep-dive-btn:hover { background: rgba(139,92,246,0.2); border-color: rgba(139,92,246,0.5); transform: translateX(6px); color: #e9d5ff; }
.round-section { background: rgba(30,30,46,0.5); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 24px; margin: 20px 0; }

/* Modal Tab System */
.modal-tabs { display: flex; gap: 8px; border-bottom: 2px solid rgba(255,255,255,0.1); margin-bottom: 32px; flex-wrap: wrap; }
.tab-btn { background: none; border: none; color: #a0a0b0; padding: 12px 20px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; border-bottom: 3px solid transparent; margin-bottom: -2px; }
.tab-btn.active { color: #c4b5fd; border-bottom-color: #a78bfa; }
.tab-btn:hover { color: #d0d0e0; }
.tab-content { display: block; }
.tab-content.hidden { display: none; }

/* Info Boxes Within Tabs */
.info-box { background: rgba(30, 30, 46, 0.6); border: 1px solid rgba(255, 255, 255, 0.1); border-left: 4px solid #a78bfa; border-radius: 12px; padding: 24px; margin: 20px 0; }
.info-box.strength { border-left-color: #10B981; }
.info-box.shadow { border-left-color: #EF4444; }
.info-box.stress { border-left-color: #F59E0B; }
.info-box.development { border-left-color: #3B82F6; }
.box-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
.box-header h4 { font-size: 16px; font-weight: 700; color: #e0e0e0; text-transform: uppercase; letter-spacing: 1px; margin: 0; }
.box-content { font-size: 14px; line-height: 1.7; color: #d0d0d0; }
.box-content ul { list-style: none; padding: 0; margin: 0; }
.box-content li { padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
.box-content li:last-child { border-bottom: none; }
.quick-fact { background: rgba(139,92,246,0.08); padding: 16px; border-radius: 8px; margin: 12px 0; border-left: 3px solid #a78bfa; }
.quick-fact strong { color: #c4b5fd; display: block; margin-bottom: 6px; font-size: 13px; }

</style>
</head>
<body>
<!-- ENHANCEMENT: Modal Overlay -->
<div id="modal-overlay" class="hidden" onclick="closeModal()">
  <div class="modal-content-wrapper" onclick="event.stopPropagation()">
    <button class="modal-close" onclick="closeModal()">‚úï</button>
    <div style="padding: 32px 48px 48px 48px;">
      <div id="modal-header" style="margin-bottom: 24px;">
        <!-- Identity name, tagline, symbols go here -->
      </div>
      
      <div class="modal-tabs" style="display: flex; gap: 8px; border-bottom: 2px solid rgba(255,255,255,0.1); margin-bottom: 32px;">
        <button class="tab-btn active" onclick="switchModalTab(event, 'overview')">Overview</button>
        <button class="tab-btn" onclick="switchModalTab(event, 'philosophy')">Philosophy</button>
        <button class="tab-btn" onclick="switchModalTab(event, 'workplace')">Workplace</button>
        <button class="tab-btn" onclick="switchModalTab(event, 'stress')">Stress</button>
        <button class="tab-btn" onclick="switchModalTab(event, 'development')">Development</button>
      </div>
      
      <div id="modal-body" style="min-height: 400px;">
        <div id="tab-overview" class="tab-content"><!-- Overview --></div>
        <div id="tab-philosophy" class="tab-content hidden"><!-- Philosophy --></div>
        <div id="tab-workplace" class="tab-content hidden"><!-- Workplace --></div>
        <div id="tab-stress" class="tab-content hidden"><!-- Stress --></div>
        <div id="tab-development" class="tab-content hidden"><!-- Development --></div>
      </div>
    </div>
  </div>
</div>


<div class="container">
  <div id="screen-welcome" class="fade-in">
    <div class="card" style="text-align: center;">
      <div style="display: flex; justify-content: center; gap: 12px; margin-bottom: 24px;">
        <span class="mana-symbol mana-W">W</span>
        <span class="mana-symbol mana-U">U</span>
        <span class="mana-symbol mana-B">B</span>
        <span class="mana-symbol mana-R">R</span>
        <span class="mana-symbol mana-G">G</span>
      </div>
      
      <h1 style="font-size: 48px; margin-bottom: 16px;">THE MANA CURVE</h1>
      <p style="font-size: 24px; color: #a0a0b0; margin-bottom: 8px; font-weight: 600;">Workplace Personality Framework</p>
      <p style="font-size: 16px; color: #808090; margin-bottom: 40px;">Because you remember your first mythic rare, but forgot your personality type</p>
      
      <div style="background: rgba(255,255,255,0.05); padding: 32px; border-radius: 12px; margin-bottom: 32px; text-align: left;">
        <p style="margin-bottom: 16px; line-height: 1.6;">Many successful personality frameworks use colors. DISC uses four. True Colors uses four. Colors tend to be more memorable than 4 letters or a few numbers.</p>
        <p style="margin-bottom: 16px; line-height: 1.6;">If you've done one or more of these you might have noticed, like us, that those colors bear an awful resemblance to a certain trading card game...</p>
        <p style="margin-bottom: 16px; line-height: 1.6;">So we asked ourselves‚Äîcould we create a personality framework using <strong style="color: #93C5FD;">five colors from Magic: The Gathering?</strong> We started this as a joke, but the more we looked at it the more it made sense!</p>
        <p style="margin-bottom: 16px; line-height: 1.6;">We're not here to say it's science, but over 30+ years, millions of players have raged at control-freak Blue players, gotten stomped by massive Green creatures, watched White go wide with tokens, felt Black's ruthless plays, and experienced Red's chaotic aggression. The way we play relates to how we think about the world.</p>
        <p style="margin-bottom: 0; line-height: 1.6;"><strong>We think the game accidentally created a workplace psychology framework. So we turned it into one.</strong></p>
      </div>
      
      <!-- Mana Archetype of the Month -->
      <div id="archetype-of-month" class="archetype-plaque" style="text-align: left;"></div>
      
      <div style="background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); padding: 24px; border-radius: 12px; margin-bottom: 32px; text-align: left;">
        <h3 style="font-size: 18px; margin-bottom: 16px; color: #a78bfa;">How This Works</h3>
        <div style="display: grid; gap: 12px;">
          <div style="display: flex; gap: 12px; align-items: start;">
            <div style="background: rgba(139, 92, 246, 0.3); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-weight: 700;">1</div>
            <div>
              <strong>Round 1: The Gauntlet</strong> (30 questions, ~10 min)<br>
              <span style="color: #a0a0b0; font-size: 14px;">Pick between two terrible options. We measure all five colors.</span>
            </div>
          </div>
          <div style="display: flex; gap: 12px; align-items: start;">
            <div style="background: rgba(139, 92, 246, 0.2); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; font-weight: 700; color: #a0a0b0;">2</div>
            <div>
              <strong style="color: #a0a0b0;">Round 2: The Tiebreaker</strong> (5-12 questions, maybe)<br>
              <span style="color: #808090; font-size: 14px;">Only if your pattern is ambiguous. We test specific combinations.</span>
            </div>
          </div>
        </div>
      </div>
      
      <div style="margin: 24px 0; padding: 20px; background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 12px;">
        <p style="font-size: 12px; color: #F59E0B; font-weight: 600; margin-bottom: 8px;">‚ö†Ô∏è WARNING: NOT FOR OFFICIAL USE</p>
        <p style="font-size: 11px; color: #d0a070; line-height: 1.6; margin-bottom: 6px;">Do not use this for hiring, firing, promoting, demoting, or any decision affecting actual humans.</p>
        <p style="font-size: 11px; color: #d0a070; line-height: 1.6; margin-bottom: 6px;">This is a personality framework based on a trading card game about wizards fighting each other.</p>
        <p style="font-size: 11px; color: #c09060; line-height: 1.6; font-style: italic;">Is this a joke? Unclear. But it's 30 years of game design about strategic philosophy, so it's not nothing.</p>
      </div>
      
      <!-- Mode Selection -->
      <div style="margin: 32px 0; padding: 24px; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 12px;">
        <h3 style="font-size: 18px; margin-bottom: 16px; color: #a78bfa;">Choose Your Format</h3>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
          <!-- Constructed Mode -->
          <div id="mode-constructed" onclick="selectMode('constructed')" class="mode-card">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <div style="width: 24px; height: 24px; border: 2px solid rgba(139, 92, 246, 0.5); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <div id="constructed-check" style="width: 12px; height: 12px; background: rgba(139, 92, 246, 0.8); border-radius: 50%; display: none;"></div>
              </div>
              <div style="font-size: 16px; font-weight: 700; color: #e0e0e0;">üèóÔ∏è Constructed</div>
            </div>
            <p style="font-size: 13px; color: #a0a0b0; line-height: 1.5; margin-bottom: 8px;">See the mana symbols for each choice. Understand exactly what colors you're picking.</p>
            <p style="font-size: 12px; color: #808090; font-style: italic;">For people who want to know what they're selecting.</p>
          </div>
          
          <!-- Draft Mode -->
          <div id="mode-draft" onclick="selectMode('draft')" class="mode-card" style="border: 2px solid rgba(139, 92, 246, 0.8); background: rgba(139, 92, 246, 0.15);">
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
              <div style="width: 24px; height: 24px; border: 2px solid rgba(139, 92, 246, 0.5); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                <div id="draft-check" style="width: 12px; height: 12px; background: rgba(139, 92, 246, 0.8); border-radius: 50%;"></div>
              </div>
              <div style="font-size: 16px; font-weight: 700; color: #e0e0e0;">üì¶ Blind Draft</div>
            </div>
            <p style="font-size: 13px; color: #a0a0b0; line-height: 1.5; margin-bottom: 8px;">Make choices blind. No mana symbols shown. The test as it's meant to be played.</p>
            <p style="font-size: 12px; color: #808090; font-style: italic;">Recommended: Reveals your actual decision-making patterns.</p>
          </div>
        </div>
        
        <p style="font-size: 12px; color: #808090; text-align: center; font-style: italic;">You can always retake it in the other mode.</p>
      </div>
      
      <button class="btn-primary" onclick="startAssessment()">Enter the Arena</button>
      <p style="margin-top: 16px; color: #808090; font-size: 14px;">~13-15 minutes ‚Ä¢ You'll actually remember this one</p>
      <p style="margin-top: 8px; color: #606070; font-size: 12px;">31 possible results because limiting yourself to 16 personality types is for cowards</p>
      
      <div style="margin-top: 24px; text-align: center;">
        <button onclick="showExplorer()" class="explorer-btn">
          üìö Explore All 31 Personality Types
        </button>
      </div>
      
      <div style="margin-top: 12px; text-align: center;">
        <button onclick="showInteractions()" class="explorer-btn">
          ü§ù How Colors Interact
        </button>
      </div>
    </div>
  </div>

  <div id="screen-assessment" class="hidden">
    <div class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <div style="display: flex; gap: 8px;">
          <span class="mana-symbol mana-W" style="width: 28px; height: 28px; font-size: 14px;">W</span>
          <span class="mana-symbol mana-U" style="width: 28px; height: 28px; font-size: 14px;">U</span>
          <span class="mana-symbol mana-B" style="width: 28px; height: 28px; font-size: 14px;">B</span>
          <span class="mana-symbol mana-R" style="width: 28px; height: 28px; font-size: 14px;">R</span>
          <span class="mana-symbol mana-G" style="width: 28px; height: 28px; font-size: 14px;">G</span>
        </div>
        <div style="display: flex; gap: 12px; align-items: center;">
          <button onclick="toggleDebug()" style="background: rgba(139, 92, 246, 0.2); border: 1px solid rgba(139, 92, 246, 0.4); color: #a78bfa; padding: 4px 12px; border-radius: 6px; font-size: 11px; cursor: pointer; text-transform: uppercase; font-weight: 600;">Debug</button>
          <div style="text-align: right;">
            <div style="font-weight: 700; font-size: 14px;">Question <span id="q-num">1</span> of <span id="q-tot">30</span></div>
            <div style="font-size: 12px; color: #808090;" id="stage-label">Stage 1</div>
          </div>
        </div>
      </div>
      
      <div style="margin-bottom: 8px;">
        <div style="display: flex; justify-content: space-between; font-size: 11px; color: #606070; margin-bottom: 4px;">
          <span>Stage 1: Initial (30q)</span>
          <span id="s2-hint" style="opacity: 0.5;">Stage 2: Refinement (varies)</span>
        </div>
        <div style="position: relative; height: 12px; overflow: hidden;">
          <div style="position: absolute; width: 100%; height: 12px; background: rgba(255,255,255,0.05); border-radius: 6px;"></div>
          <div id="prog-s1" style="position: absolute; height: 12px; background: linear-gradient(90deg, #FDE047, #93C5FD, #D1D5DB, #FCA5A5, #6EE7B7); border-radius: 6px; transition: all 0.3s; width: 0%;"></div>
          <div id="prog-s2" style="position: absolute; height: 12px; background: rgba(139, 92, 246, 0.6); border-radius: 6px; transition: all 0.3s; width: 0%; opacity: 0;"></div>
        </div>
      </div>
    </div>
    
    <div class="card" style="min-height: 280px; display: flex; flex-direction: column;">
      <div style="font-size: 12px; text-transform: uppercase; color: #808090; margin-bottom: 8px;" id="ctx">Context</div>
      <h2 style="font-size: 24px; margin-bottom: 24px; line-height: 1.4; flex-grow: 1;" id="scenario">Scenario</h2>
      <p style="color: #a0a0b0; margin-bottom: 24px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1);" id="instr">Choose the response <strong>more like you</strong>.</p>
      <div id="choices"></div>
    </div>
    
    <div id="debug-section" class="card" style="background: rgba(139, 92, 246, 0.05); border-color: rgba(139, 92, 246, 0.2); display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
        <h4 style="font-size: 14px; color: #a78bfa; text-transform: uppercase; letter-spacing: 1px;">üîç Debug Info</h4>
        <button onclick="document.getElementById('debug-section').style.display='none'" style="background: none; border: none; color: #808090; cursor: pointer; font-size: 20px; padding: 0 8px;">√ó</button>
      </div>
      <div id="debug-content" style="font-family: monospace; font-size: 12px; color: #d0d0d0; line-height: 1.8;"></div>
    </div>
  </div>

  <div id="screen-interstitial" class="hidden">
    <div class="card fade-in" style="text-align: center;">
      <div style="display: flex; justify-content: center; gap: 12px; margin-bottom: 24px;">
        <span class="mana-symbol mana-W">W</span>
        <span class="mana-symbol mana-U">U</span>
        <span class="mana-symbol mana-B">B</span>
        <span class="mana-symbol mana-R">R</span>
        <span class="mana-symbol mana-G">G</span>
      </div>
      
      <h2 style="font-size: 36px; margin-bottom: 24px;">Stage 1 Complete</h2>
      
      <div style="background: rgba(255,255,255,0.05); padding: 32px; border-radius: 12px; margin-bottom: 32px; text-align: left;">
        <p style="font-size: 18px; margin-bottom: 20px; font-weight: 600; text-align: center;">We've identified your strongest colors</p>
        
        <div style="margin: 20px 0; padding: 20px; background: rgba(139, 92, 246, 0.1); border-radius: 8px; text-align: center;">
          <div id="inter-scores" style="font-size: 15px; line-height: 1.8; color: #d0d0d0;"></div>
        </div>
        
        <p style="line-height: 1.8; margin-bottom: 20px; font-size: 15px; color: #d0d0d0;" id="inter-explanation">Explanation</p>
        <p style="line-height: 1.8; font-size: 15px; color: #a0a0b0; font-weight: 500;" id="inter-next">Next step</p>
      </div>
      
      <button class="btn-primary" onclick="continueToStage2()">Continue to Refinement</button>
      <p style="margin-top: 16px; color: #808090; font-size: 13px;">A few more questions to clarify your exact combination</p>
    </div>
  </div>

  <div id="screen-early-offer" class="hidden">
    <div class="card fade-in" style="text-align: center;">
      <div style="display: flex; justify-content: center; gap: 12px; margin-bottom: 24px;">
        <span class="mana-symbol mana-W">W</span>
        <span class="mana-symbol mana-U">U</span>
        <span class="mana-symbol mana-B">B</span>
        <span class="mana-symbol mana-R">R</span>
        <span class="mana-symbol mana-G">G</span>
      </div>
      
      <h2 style="font-size: 36px; margin-bottom: 16px;">üéØ Round 1 Complete: Clear Result</h2>
      <p style="color: #a0a0b0; margin-bottom: 32px;">Based on 30 workplace decisions, you appear to be:</p>
      
      <div style="background: rgba(139, 92, 246, 0.1); border: 2px solid rgba(139, 92, 246, 0.4); border-radius: 16px; padding: 32px; margin: 24px auto; max-width: 500px;">
        <div style="display: flex; justify-content: center; gap: 12px; margin-bottom: 16px;" id="early-symbols"></div>
        <h3 style="font-size: 32px; margin-bottom: 12px;" id="early-result-name">IDENTITY</h3>
        <p style="font-size: 18px; color: #a0a0b0; margin-bottom: 16px;" id="early-result-tag">Tagline</p>
        <span class="confidence-badge confidence-HIGH" id="early-confidence">90% CONFIDENCE</span>
        <p style="margin-top: 16px; font-size: 14px; color: #d0d0d0; line-height: 1.6;" id="early-message">Explanation message</p>
      </div>
      
      <div style="display: grid; gap: 16px; max-width: 600px; margin: 32px auto;">
        <button onclick="showResultsEarly()" style="background: linear-gradient(135deg, #a78bfa 0%, #ec4899 100%); border: none; color: #fff; padding: 20px 32px; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);">
          See My Results Now
          <div style="font-size: 13px; font-weight: 400; margin-top: 6px; opacity: 0.9;">Skip Round 2 ‚Äî I'm confident this is accurate</div>
        </button>
        
        <button onclick="continueToRound2()" style="background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.2); color: #e0e0e0; padding: 20px 32px; border-radius: 12px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
          Continue to Round 2
          <div style="font-size: 13px; font-weight: 400; margin-top: 6px; color: #a0a0b0;">12 more questions to verify and refine (recommended)</div>
        </button>
      </div>
      
      <p style="font-size: 13px; color: #808090; margin-top: 24px; font-style: italic; max-width: 500px; margin-left: auto; margin-right: auto;">Recommendation: Round 2 adds precision and tests edge cases. Takes about 5 minutes. Most people continue to get the most accurate result.</p>
    </div>
  </div>

  <div id="screen-calculating" class="hidden">
    <div class="card fade-in" style="text-align: center; min-height: 400px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
      <h2 style="font-size: 36px; margin-bottom: 32px;">Calculating Your Mana Curve...</h2>
      
      <div id="bouncing-symbols" style="display: flex; gap: 16px; margin-bottom: 32px;">
        <span class="mana-symbol mana-W bounce-symbol" style="animation-delay: 0s;">W</span>
        <span class="mana-symbol mana-U bounce-symbol" style="animation-delay: 0.1s;">U</span>
        <span class="mana-symbol mana-B bounce-symbol" style="animation-delay: 0.2s;">B</span>
        <span class="mana-symbol mana-R bounce-symbol" style="animation-delay: 0.3s;">R</span>
        <span class="mana-symbol mana-G bounce-symbol" style="animation-delay: 0.4s;">G</span>
      </div>
      
      <p style="color: #808090; font-size: 14px;">Analyzing your color distribution...</p>
    </div>
  </div>

  <div id="screen-results" class="hidden">
    <div class="card fade-in" style="text-align: center;">
      <div style="display: flex; justify-content: center; gap: 12px; margin-bottom: 24px;">
        <span class="mana-symbol mana-W">W</span>
        <span class="mana-symbol mana-U">U</span>
        <span class="mana-symbol mana-B">B</span>
        <span class="mana-symbol mana-R">R</span>
        <span class="mana-symbol mana-G">G</span>
      </div>
      <h1 style="font-size: 42px; margin-bottom: 16px;">Your Color Identity</h1>
      <p style="color: #a0a0b0;">Based on <span id="tot-q">30</span> workplace decisions</p>
      <p style="color: #808090; font-size: 13px; margin-top: 8px; font-style: italic;" id="mode-used"></p>
    </div>
    
    <div class="result-card fade-in">
      <div style="text-align: center;">
        <div style="display: flex; justify-content: center; gap: 12px; margin-bottom: 24px;" id="res-syms"></div>
        <h2 style="font-size: 48px; margin-bottom: 12px;" id="res-id">IDENTITY</h2>
        <p style="font-size: 24px; color: #a0a0b0; margin-bottom: 16px;" id="res-tag">Tagline</p>
        <span class="confidence-badge" id="conf-badge">CONFIDENCE</span>
        <p style="margin-top: 12px; font-size: 13px; color: #808090; font-style: italic;" id="conf-exp">Explanation</p>

      </div>
      
      <!-- LOW confidence alternatives - shown right here if LOW -->
      <div id="alternative-results" style="display: none; margin-top: 24px; padding-top: 24px; border-top: 1px solid rgba(255,255,255,0.1);">
        <div style="font-size: 14px; font-weight: 600; color: #a78bfa; margin-bottom: 16px;">üîÄ You're borderline. Based on your choices, you could also be:</div>
        <div style="background: rgba(139, 92, 246, 0.15); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
          <p style="font-size: 14px; color: #e0e0e0; line-height: 1.6;" id="why-explanation">Explanation</p>
        </div>
        <div id="alternatives-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px;"></div>
      </div>
      
      <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid rgba(255,255,255,0.1);">
        <div style="font-size: 13px; font-weight: 600; color: #a0a0b0; margin-bottom: 8px;">Why this identity:</div>
        <p style="font-size: 14px; line-height: 1.6; color: #d0d0d0;" id="identity-exp">Explanation</p>
      </div>
    </div>
    
    <div class="card fade-in">
      <h3 style="font-size: 24px; margin-bottom: 8px;">Your Profile</h3>
      <p style="font-size: 13px; color: #808090; margin-bottom: 24px; font-style: italic;">What your colleagues already know but are too polite to say.</p>
      
      <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px; margin-bottom: 16px; border-left: 3px solid rgba(99, 102, 241, 0.5);">
        <div style="font-size: 11px; font-weight: 600; color: #6366f1; text-transform: uppercase; margin-bottom: 8px;">üíº How Magic players might describe you to your face</div>
        <p style="line-height: 1.8; font-size: 16px;" id="res-desc">Description</p>
      </div>
      
      <div style="background: rgba(245, 158, 11, 0.08); padding: 20px; border-radius: 10px; margin-bottom: 24px; border-left: 3px solid rgba(245, 158, 11, 0.5);">
        <div style="font-size: 11px; font-weight: 600; color: #F59E0B; text-transform: uppercase; margin-bottom: 8px;">üç∫ How they describe you behind your back</div>
        <p style="line-height: 1.6; font-size: 14px; color: #d0a070; font-style: italic;" id="res-counter">Counter description</p>
      </div>
      
      <div style="background: rgba(255,255,255,0.05); padding: 24px; border-radius: 12px; margin: 24px 0; border: 1px solid rgba(255,255,255,0.1);" id="cmd-container">
        <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #808090; margin-bottom: 12px;">‚ö° Legendary Commander</div>
        
        <!-- Card Frame (only if oracle data exists) -->
        <div id="cmd-card-frame" style="background: linear-gradient(135deg, #2a2a3e 0%, #1f1f2e 100%); border: 3px solid rgba(139, 92, 246, 0.4); border-radius: 12px; padding: 16px; max-width: 500px; display: none;">
          
          <!-- Name and Mana Cost (top bar) -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding: 8px 12px; background: rgba(0,0,0,0.3); border-radius: 6px;">
            <div style="font-size: 18px; font-weight: 700; color: #fff;" id="cmd-name-card">Commander</div>
            <div id="cmd-cost" style="display: flex; gap: 3px;"></div>
          </div>
          
          <!-- Type Line -->
          <div style="padding: 6px 12px; background: rgba(0,0,0,0.2); border-radius: 4px; margin-bottom: 12px;">
            <div style="font-size: 13px; color: #d0d0d0; font-weight: 600;">Legendary Creature</div>
          </div>
          
          <!-- Card Text Box -->
          <div style="background: rgba(0,0,0,0.25); padding: 16px; padding-bottom: 48px; border-radius: 6px; min-height: 180px; position: relative;">
            <!-- Flavor text (our description) -->
            <p style="color: #b0b0c0; font-size: 13px; font-style: italic; line-height: 1.5; margin-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px;" id="cmd-desc-card">Description</p>
            
            <!-- Oracle text (abilities) -->
            <div id="cmd-oracle-text" style="font-size: 13px; color: #e0e0e0; line-height: 1.7; margin-bottom: 8px;"></div>
            
            <!-- P/T in bottom right corner -->
            <div id="cmd-pt" style="position: absolute; bottom: 12px; right: 12px; font-size: 20px; font-weight: 800; color: #fff; background: rgba(0,0,0,0.6); padding: 6px 14px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.2);"></div>
          </div>
        </div>
        
        <!-- Simple Reference (if no oracle data) -->
        <div id="cmd-simple" style="display: none;">
          <div style="font-weight: 700; font-size: 20px; margin-bottom: 8px; color: #fff;" id="cmd-name-simple">Commander</div>
          <p style="font-size: 14px; color: #b0b0c0; font-style: italic; line-height: 1.6;" id="cmd-desc-simple">Description</p>
          <p style="font-size: 12px; color: #808090; margin-top: 12px; font-style: italic;">Full card details coming soon...</p>
        </div>
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 32px 0;" class="strengths-grid">
        <div style="background: rgba(16, 185, 129, 0.08); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 12px; padding: 20px;">
          <h4 style="font-size: 18px; margin-bottom: 8px; color: #10B981;">‚öî Strengths</h4>
          <p style="font-size: 11px; color: #6b9080; margin-bottom: 12px; font-style: italic;">Use them shamelessly</p>
          <ul style="list-style: none; padding: 0;" id="strengths"></ul>
        </div>
        
        <div style="background: rgba(239, 68, 68, 0.08); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 12px; padding: 20px;">
          <h4 style="font-size: 18px; margin-bottom: 8px; color: #EF4444;">‚ö† Shadows</h4>
          <p style="font-size: 11px; color: #9b6b6b; margin-bottom: 12px; font-style: italic;">Your colleagues see this, but give you credit anyway</p>
          <ul style="list-style: none; padding: 0;" id="weaknesses"></ul>
        </div>
      </div>
      
      <div style="margin: 32px 0;">
        <h4 style="font-size: 18px; margin-bottom: 8px;">üìã Stereotypical Roles</h4>
        <p style="font-size: 12px; color: #808090; margin-bottom: 12px; font-style: italic;">Where this identity typically thrives:</p>
        <p style="color: #a0a0b0; margin-bottom: 12px;" id="roles">Roles</p>
      </div>
      
      <!-- PRIMARY Color Indicator (only for multi-color with dominant) -->
      <div id="primary-color-indicator" style="display: none; margin: 32px 0; padding: 20px; background: rgba(139, 92, 246, 0.15); border: 1px solid rgba(139, 92, 246, 0.4); border-radius: 12px; border-left: 4px solid #a78bfa;">
        <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #a78bfa; margin-bottom: 8px; font-weight: 600;">‚≠ê PRIMARY COLOR WITHIN THIS COMBINATION</div>
        <p style="font-size: 15px; color: #e0e0e0; font-weight: 600; line-height: 1.6;"></p>
      </div>
    </div>
    

      <!-- ENHANCEMENT: Deep Dive Button -->
      <div style="margin: 40px 0; padding: 32px 0; border-top: 2px solid rgba(255,255,255,0.1);">
        <h3 style="font-size: 20px; font-weight: 700; margin-bottom: 20px; color: #e0e0e0;">üìö Explore Your Identity</h3>
        <button class="deep-dive-btn" onclick="showDeepDive('philosophy', state.result.identity)">
          <span style="font-size: 16px;">‚Üí</span> Full Philosophy & Workplace Patterns
        </button>
      </div>
    <div class="card fade-in">
      <div onclick="const r1 = document.getElementById('stage1-explanation-section'); const r2 = document.getElementById('decision-patterns-section'); const wasHidden = r1.style.display === 'none'; r1.style.display = wasHidden ? 'block' : 'none'; r2.style.display = wasHidden ? 'block' : 'none'; this.querySelector('.expand-icon').textContent = wasHidden ? '‚ñº' : '‚ñ∂';" style="cursor: pointer; display: flex; align-items: center; gap: 12px;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
        <h3 style="font-size: 24px; margin: 0;">Your Mana Pool</h3>
        <span class="expand-icon" style="color: #a78bfa; font-size: 18px;">‚ñ∂</span>
      </div>
      <p style="font-size: 13px; color: #808090; margin: 8px 0 24px 0; font-style: italic;">Click to see Round 1 and Round 2 score breakdowns</p>
      <div id="breakdown"></div>
    </div>
    
    <!-- STAGE 1: Color Detection Explanation -->
    <div class="card fade-in" id="stage1-explanation-section" style="display: none;">
      <h3 style="font-size: 22px; font-weight: 700; margin-bottom: 16px; color: #e0e0e0;">üîç How We Detected Your Colors</h3>
      <p style="font-size: 14px; color: #a0a0b0; margin-bottom: 24px;">Stage 1 tested you on enemy color pairs to determine which colors activate most strongly for you.</p>
      <div id="stage1-explanation-content"></div>
    </div>
    
    <!-- ENHANCEMENT: Round 1/Round 2 Display - MOVED TO BOTTOM -->
    <div class="card fade-in" id="decision-patterns-section" style="display: none;">
      <h3 style="font-size: 22px; font-weight: 700; margin-bottom: 16px; color: #e0e0e0;">üéØ Pattern Testing Results</h3>
      <p style="font-size: 14px; color: #a0a0b0; margin-bottom: 24px;">Stage 2 tested you on different pattern combinations to refine your result. Here's how you responded to each pattern:</p>
      <div id="round2-container">
        <div id="round2-bars"></div>
        <p id="round2-note" style="font-size: 13px; color: #10B981; margin-top: 20px; font-weight: 600;"></p>
      </div>
    </div>
    
    <div style="text-align: center; margin-top: 32px;" class="fade-in">
      <button class="btn-primary" onclick="restart()" id="restart-btn">Take It Again</button>
      <p style="margin-top: 16px; color: #808090; font-size: 13px;" id="restart-text">Retake it to get the result you wanted instead of who you actually are?</p>
      
      <div style="margin-top: 24px;">
        <button onclick="showExplorer()" class="explorer-btn">
          üìö Explore All 31 Personality Types
        </button>
        <p style="margin-top: 12px; font-size: 12px; color: #808090; font-style: italic;" id="explorer-hint"></p>
      </div>
      
      <div style="margin-top: 12px;">
        <button onclick="showInteractions()" class="explorer-btn">
          ü§ù How Your Colors Interact With Others
        </button>
      </div>
      
      <div style="margin-top: 20px; padding: 20px; background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 12px; max-width: 600px; margin-left: auto; margin-right: auto;">
        <p style="font-size: 12px; color: #F59E0B; font-weight: 600; margin-bottom: 8px;">‚ö†Ô∏è WARNING: NOT FOR OFFICIAL USE</p>
        <p style="font-size: 11px; color: #d0a070; line-height: 1.6; margin-bottom: 6px;">Do not use this for hiring, firing, promoting, demoting, or any decision affecting actual humans.</p>
        <p style="font-size: 11px; color: #d0a070; line-height: 1.6; margin-bottom: 6px;">This is a personality framework based on a trading card game about wizards fighting each other.</p>
        <p style="font-size: 11px; color: #c09060; line-height: 1.6; font-style: italic;">Is this a joke? Unclear. But it's 30 years of game design about strategic philosophy, so it's not nothing.</p>
      </div>
    </div>
  </div>
  
  <!-- EXPLORER SCREEN -->
  <div id="screen-explorer" class="hidden">
    <div class="card fade-in" style="text-align: center;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <button onclick="closeExplorer()" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #a0a0b0; padding: 8px 16px; border-radius: 8px; font-size: 14px; cursor: pointer; font-weight: 600;">
          ‚Üê Back
        </button>
        <h1 style="font-size: 32px; margin: 0;">The Complete Framework</h1>
        <div style="width: 80px;"></div>
      </div>
      
      <p style="color: #a0a0b0; margin-bottom: 8px;">All 31 color identities in the Mana Curve framework</p>
      <p style="color: #808090; font-size: 13px; font-style: italic;">Click any identity to view its complete profile</p>
    </div>
    
    <!-- Two Column Layout: Grid + Detail -->
    <div style="display: grid; grid-template-columns: 1fr 1.2fr; gap: 24px; align-items: start;">
      
      <!-- LEFT: Identity Grid -->
      <div>
        <!-- Mono-Colors -->
        <div class="card fade-in" style="margin-bottom: 20px;">
          <h3 style="font-size: 16px; margin-bottom: 8px; color: #a78bfa; text-transform: uppercase; letter-spacing: 1px;">Mono-Color (5)</h3>
          <p style="font-size: 12px; color: #808090; margin-bottom: 16px; font-style: italic;">Pure, focused, uncompromising</p>
          <div style="display: grid; gap: 10px;" id="explorer-mono"></div>
        </div>
        
        <!-- Two-Color Guilds -->
        <div class="card fade-in" style="margin-bottom: 20px;">
          <h3 style="font-size: 16px; margin-bottom: 8px; color: #a78bfa; text-transform: uppercase; letter-spacing: 1px;">Two-Color Guilds (10)</h3>
          <p style="font-size: 12px; color: #808090; margin-bottom: 16px; font-style: italic;">Allied and enemy pairs</p>
          <div style="display: grid; gap: 10px;" id="explorer-guilds"></div>
        </div>
        
        <!-- Three-Color -->
        <div class="card fade-in" style="margin-bottom: 20px;">
          <h3 style="font-size: 16px; margin-bottom: 8px; color: #a78bfa; text-transform: uppercase; letter-spacing: 1px;">Three-Color (10)</h3>
          <p style="font-size: 12px; color: #808090; margin-bottom: 16px; font-style: italic;">Shards and wedges</p>
          <div style="display: grid; gap: 10px;" id="explorer-three"></div>
        </div>
        
        <!-- Four-Color -->
        <div class="card fade-in" style="margin-bottom: 20px;">
          <h3 style="font-size: 16px; margin-bottom: 8px; color: #a78bfa; text-transform: uppercase; letter-spacing: 1px;">Four-Color (5)</h3>
          <p style="font-size: 12px; color: #808090; margin-bottom: 16px; font-style: italic;">Defined by what's missing</p>
          <div style="display: grid; gap: 10px;" id="explorer-four"></div>
        </div>
        
        <!-- Five-Color -->
        <div class="card fade-in" style="margin-bottom: 20px;">
          <h3 style="font-size: 16px; margin-bottom: 8px; color: #a78bfa; text-transform: uppercase; letter-spacing: 1px;">Five-Color (1)</h3>
          <p style="font-size: 12px; color: #808090; margin-bottom: 16px; font-style: italic;">Everything at once</p>
          <div style="display: grid; gap: 10px;" id="explorer-five"></div>
        </div>
      </div>
      
      <!-- RIGHT: Detail Panel -->
      <div id="detail-panel" class="card fade-in" style="position: sticky; top: 20px; min-height: 600px;">
        <div id="detail-placeholder" style="text-align: center; padding: 60px 20px; color: #808090;">
          <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;">üëà</div>
          <p style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">Select an Identity</p>
          <p style="font-size: 13px;">Click any personality type to view its complete profile</p>
        </div>
        
        <div id="detail-content" style="display: none;">
          <!-- Identity Header -->
          <div style="text-align: center; margin-bottom: 32px; padding-bottom: 24px; border-bottom: 2px solid rgba(255,255,255,0.1);">
            <div id="detail-symbols" style="display: flex; justify-content: center; gap: 8px; margin-bottom: 16px;"></div>
            <h2 id="detail-name" style="font-size: 32px; margin-bottom: 8px;">Identity Name</h2>
            <p id="detail-tag" style="font-size: 16px; color: #a78bfa; font-style: italic;">Tagline</p>
          </div>
          
          <!-- The Pitch -->
          <div style="margin-bottom: 24px;">
            <h4 style="font-size: 14px; text-transform: uppercase; letter-spacing: 1px; color: #808090; margin-bottom: 12px;">What This Is</h4>
            <p id="detail-desc" style="font-size: 15px; color: #d0d0d0; line-height: 1.7;"></p>
          </div>
          
          <!-- Pub Descriptions -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
            <div style="background: rgba(16, 185, 129, 0.08); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; padding: 16px;">
              <div style="font-size: 11px; font-weight: 600; color: #10B981; text-transform: uppercase; margin-bottom: 8px;">üíº To Your Face</div>
              <p id="detail-normal" style="font-size: 13px; color: #b0d0c0; line-height: 1.6; font-style: italic;"></p>
            </div>
            <div style="background: rgba(245, 158, 11, 0.08); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 8px; padding: 16px;">
              <div style="font-size: 11px; font-weight: 600; color: #F59E0B; text-transform: uppercase; margin-bottom: 8px;">üç∫ Behind Your Back</div>
              <p id="detail-banter" style="font-size: 13px; color: #d0a070; line-height: 1.6; font-style: italic;"></p>
            </div>
          </div>
          
          <!-- Commander Reference -->
          <div style="background: rgba(139, 92, 246, 0.08); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; padding: 16px; margin-bottom: 24px;">
            <div style="font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: #a78bfa; margin-bottom: 8px;">‚ö° Legendary Commander</div>
            <div style="font-weight: 700; font-size: 16px; margin-bottom: 4px;" id="detail-cmd-name"></div>
            <p style="font-size: 13px; color: #b0b0c0; font-style: italic;" id="detail-cmd-desc"></p>
          </div>
          
          <!-- Quick Reference -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 24px;">
            <div>
              <h4 style="font-size: 14px; text-transform: uppercase; letter-spacing: 1px; color: #808090; margin-bottom: 8px;">‚öî Key Strengths</h4>
              <ul id="detail-strengths" style="list-style: none; padding: 0; font-size: 13px; color: #10B981;"></ul>
            </div>
            <div>
              <h4 style="font-size: 14px; text-transform: uppercase; letter-spacing: 1px; color: #808090; margin-bottom: 8px;">‚ö† Key Shadows</h4>
              <ul id="detail-shadows" style="list-style: none; padding: 0; font-size: 13px; color: #EF4444;"></ul>
            </div>
          </div>
          
          <!-- Typical Roles -->
          <div>
            <h4 style="font-size: 14px; text-transform: uppercase; letter-spacing: 1px; color: #808090; margin-bottom: 8px;">üìã Typical Roles</h4>
            <p id="detail-roles" style="font-size: 14px; color: #a0a0b0;"></p>
          </div>
        </div>
      </div>
      
    </div>
  </div>
  
  <!-- INTERACTIONS GUIDE SCREEN -->
  <div id="screen-interactions" class="hidden">
    <div class="card fade-in" style="text-align: center;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
        <button onclick="closeInteractions()" style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2); color: #a0a0b0; padding: 8px 16px; border-radius: 8px; font-size: 14px; cursor: pointer; font-weight: 600;">
          ‚Üê Back
        </button>
        <h1 style="font-size: 32px; margin: 0;">How Colors Interact</h1>
        <div style="width: 80px;"></div>
      </div>
      
      <p style="color: #a0a0b0; margin-bottom: 8px;">Communication and conflict resolution across the five colors</p>
    </div>
    
    <!-- Communication Strategies -->
    <div class="card fade-in">
      <h3 style="font-size: 20px; margin-bottom: 16px; color: #a78bfa;">Communication Strategies</h3>
      <p style="font-size: 13px; color: #808090; margin-bottom: 24px; font-style: italic;">How to effectively communicate with each color</p>
      
      <div style="display: grid; gap: 16px;">
        <!-- White -->
        <div style="background: rgba(255,255,255,0.03); border-left: 4px solid #F59E0B; padding: 16px; border-radius: 8px;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <span class="mana-symbol mana-W" style="width: 32px; height: 32px; font-size: 16px;">W</span>
            <h4 style="font-size: 16px; font-weight: 700; margin: 0;">Talking to WHITE</h4>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div>
              <div style="font-size: 12px; color: #10B981; text-transform: uppercase; margin-bottom: 8px; font-weight: 600;">‚úì DO</div>
              <ul style="list-style: none; padding: 0; font-size: 13px; color: #d0d0d0; line-height: 1.7;">
                <li>‚Ä¢ Frame in terms of team benefit</li>
                <li>‚Ä¢ Acknowledge fairness concerns</li>
                <li>‚Ä¢ Show proper process</li>
                <li>‚Ä¢ Build consensus</li>
              </ul>
            </div>
            <div>
              <div style="font-size: 12px; color: #EF4444; text-transform: uppercase; margin-bottom: 8px; font-weight: 600;">‚úó DON'T</div>
              <ul style="list-style: none; padding: 0; font-size: 13px; color: #d0d0d0; line-height: 1.7;">
                <li>‚Ä¢ Present as purely self-serving</li>
                <li>‚Ä¢ Skip process or ignore rules</li>
                <li>‚Ä¢ Make unilateral decisions</li>
                <li>‚Ä¢ Rush without buy-in</li>
              </ul>
            </div>
          </div>
        </div>
        
        <!-- Blue -->
        <div style="background: rgba(255,255,255,0.03); border-left: 4px solid #3B82F6; padding: 16px; border-radius: 8px;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <span class="mana-symbol mana-U" style="width: 32px; height: 32px; font-size: 16px;">U</span>
            <h4 style="font-size: 16px; font-weight: 700; margin: 0;">Talking to BLUE</h4>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div>
              <div style="font-size: 12px; color: #10B981; text-transform: uppercase; margin-bottom: 8px; font-weight: 600;">‚úì DO</div>
              <ul style="list-style: none; padding: 0; font-size: 13px; color: #d0d0d0; line-height: 1.7;">
                <li>‚Ä¢ Provide data and analysis</li>
                <li>‚Ä¢ Explain the logic</li>
                <li>‚Ä¢ Give time to think</li>
                <li>‚Ä¢ Respect expertise</li>
              </ul>
            </div>
            <div>
              <div style="font-size: 12px; color: #EF4444; text-transform: uppercase; margin-bottom: 8px; font-weight: 600;">‚úó DON'T</div>
              <ul style="list-style: none; padding: 0; font-size: 13px; color: #d0d0d0; line-height: 1.7;">
                <li>‚Ä¢ Rush without analysis</li>
                <li>‚Ä¢ Appeal only to emotion</li>
                <li>‚Ä¢ Make unsubstantiated claims</li>
                <li>‚Ä¢ Be imprecise or vague</li>
              </ul>
            </div>
          </div>
        </div>
        
        <!-- Black -->
        <div style="background: rgba(255,255,255,0.03); border-left: 4px solid #6B7280; padding: 16px; border-radius: 8px;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <span class="mana-symbol mana-B" style="width: 32px; height: 32px; font-size: 16px;">B</span>
            <h4 style="font-size: 16px; font-weight: 700; margin: 0;">Talking to BLACK</h4>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div>
              <div style="font-size: 12px; color: #10B981; text-transform: uppercase; margin-bottom: 8px; font-weight: 600;">‚úì DO</div>
              <ul style="list-style: none; padding: 0; font-size: 13px; color: #d0d0d0; line-height: 1.7;">
                <li>‚Ä¢ Be direct about mutual benefit</li>
                <li>‚Ä¢ Respect boundaries</li>
                <li>‚Ä¢ Negotiate clearly</li>
                <li>‚Ä¢ Don't waste time</li>
              </ul>
            </div>
            <div>
              <div style="font-size: 12px; color: #EF4444; text-transform: uppercase; margin-bottom: 8px; font-weight: 600;">‚úó DON'T</div>
              <ul style="list-style: none; padding: 0; font-size: 13px; color: #d0d0d0; line-height: 1.7;">
                <li>‚Ä¢ Expect altruism</li>
                <li>‚Ä¢ Be indirect or hint</li>
                <li>‚Ä¢ Appeal only to morality</li>
                <li>‚Ä¢ Assume they'll help for free</li>
              </ul>
            </div>
          </div>
        </div>
        
        <!-- Red -->
        <div style="background: rgba(255,255,255,0.03); border-left: 4px solid #EF4444; padding: 16px; border-radius: 8px;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <span class="mana-symbol mana-R" style="width: 32px; height: 32px; font-size: 16px;">R</span>
            <h4 style="font-size: 16px; font-weight: 700; margin: 0;">Talking to RED</h4>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div>
              <div style="font-size: 12px; color: #10B981; text-transform: uppercase; margin-bottom: 8px; font-weight: 600;">‚úì DO</div>
              <ul style="list-style: none; padding: 0; font-size: 13px; color: #d0d0d0; line-height: 1.7;">
                <li>‚Ä¢ Be authentic and passionate</li>
                <li>‚Ä¢ Get to the point quickly</li>
                <li>‚Ä¢ Bring energy</li>
                <li>‚Ä¢ Act, don't just plan</li>
              </ul>
            </div>
            <div>
              <div style="font-size: 12px; color: #EF4444; text-transform: uppercase; margin-bottom: 8px; font-weight: 600;">‚úó DON'T</div>
              <ul style="list-style: none; padding: 0; font-size: 13px; color: #d0d0d0; line-height: 1.7;">
                <li>‚Ä¢ Over-analyze everything</li>
                <li>‚Ä¢ Be cold or emotionless</li>
                <li>‚Ä¢ Make them wait unnecessarily</li>
                <li>‚Ä¢ Constrain their freedom</li>
              </ul>
            </div>
          </div>
        </div>
        
        <!-- Green -->
        <div style="background: rgba(255,255,255,0.03); border-left: 4px solid #10B981; padding: 16px; border-radius: 8px;">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <span class="mana-symbol mana-G" style="width: 32px; height: 32px; font-size: 16px;">G</span>
            <h4 style="font-size: 16px; font-weight: 700; margin: 0;">Talking to GREEN</h4>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div>
              <div style="font-size: 12px; color: #10B981; text-transform: uppercase; margin-bottom: 8px; font-weight: 600;">‚úì DO</div>
              <ul style="list-style: none; padding: 0; font-size: 13px; color: #d0d0d0; line-height: 1.7;">
                <li>‚Ä¢ Give them time</li>
                <li>‚Ä¢ Respect precedent</li>
                <li>‚Ä¢ Don't force immediate change</li>
                <li>‚Ä¢ Value their experience</li>
              </ul>
            </div>
            <div>
              <div style="font-size: 12px; color: #EF4444; text-transform: uppercase; margin-bottom: 8px; font-weight: 600;">‚úó DON'T</div>
              <ul style="list-style: none; padding: 0; font-size: 13px; color: #d0d0d0; line-height: 1.7;">
                <li>‚Ä¢ Rush or pressure</li>
                <li>‚Ä¢ Dismiss tradition</li>
                <li>‚Ä¢ Force artificial solutions</li>
                <li>‚Ä¢ Ignore accumulated wisdom</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Conflict Resolution -->
    <div class="card fade-in">
      <h3 style="font-size: 20px; margin-bottom: 16px; color: #a78bfa;">Conflict Resolution</h3>
      <p style="font-size: 13px; color: #808090; margin-bottom: 24px; font-style: italic;">Understanding and resolving the five core color tensions</p>
      
      <div style="display: grid; gap: 16px;">
        <div style="background: rgba(255,255,255,0.03); padding: 16px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <span class="mana-symbol mana-W" style="width: 28px; height: 28px; font-size: 14px;">W</span>
            <span style="font-size: 20px; color: #808090;">‚Üî</span>
            <span class="mana-symbol mana-B" style="width: 28px; height: 28px; font-size: 14px;">B</span>
            <h4 style="font-size: 16px; font-weight: 700; margin: 0;">Community vs. Self-Interest</h4>
          </div>
          <p style="font-size: 13px; color: #b0b0b0; margin-bottom: 8px;"><strong>Source:</strong> White prioritizes team, Black prioritizes self</p>
          <p style="font-size: 13px; color: #10B981;"><strong>Resolution:</strong> Clarify when each value applies ("our people first" = Black's tribe, broader community = White's fairness)</p>
        </div>
        
        <div style="background: rgba(255,255,255,0.03); padding: 16px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <span class="mana-symbol mana-U" style="width: 28px; height: 28px; font-size: 14px;">U</span>
            <span style="font-size: 20px; color: #808090;">‚Üî</span>
            <span class="mana-symbol mana-R" style="width: 28px; height: 28px; font-size: 14px;">R</span>
            <h4 style="font-size: 16px; font-weight: 700; margin: 0;">Planning vs. Action</h4>
          </div>
          <p style="font-size: 13px; color: #b0b0b0; margin-bottom: 8px;"><strong>Source:</strong> Blue wants more analysis, Red wants to act now</p>
          <p style="font-size: 13px; color: #10B981;"><strong>Resolution:</strong> Time-box planning phase, then execute with learning loops</p>
        </div>
        
        <div style="background: rgba(255,255,255,0.03); padding: 16px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <span class="mana-symbol mana-B" style="width: 28px; height: 28px; font-size: 14px;">B</span>
            <span style="font-size: 20px; color: #808090;">‚Üî</span>
            <span class="mana-symbol mana-G" style="width: 28px; height: 28px; font-size: 14px;">G</span>
            <h4 style="font-size: 16px; font-weight: 700; margin: 0;">Extraction vs. Sustainability</h4>
          </div>
          <p style="font-size: 13px; color: #b0b0b0; margin-bottom: 8px;"><strong>Source:</strong> Black maximizes short-term, Green preserves long-term</p>
          <p style="font-size: 13px; color: #10B981;"><strong>Resolution:</strong> Define regeneration rate, extract within sustainable limits</p>
        </div>
        
        <div style="background: rgba(255,255,255,0.03); padding: 16px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <span class="mana-symbol mana-R" style="width: 28px; height: 28px; font-size: 14px;">R</span>
            <span style="font-size: 20px; color: #808090;">‚Üî</span>
            <span class="mana-symbol mana-W" style="width: 28px; height: 28px; font-size: 14px;">W</span>
            <h4 style="font-size: 16px; font-weight: 700; margin: 0;">Freedom vs. Order</h4>
          </div>
          <p style="font-size: 13px; color: #b0b0b0; margin-bottom: 8px;"><strong>Source:</strong> Red wants autonomy, White wants coordination</p>
          <p style="font-size: 13px; color: #10B981;"><strong>Resolution:</strong> Minimum viable structure with clear boundaries but freedom inside</p>
        </div>
        
        <div style="background: rgba(255,255,255,0.03); padding: 16px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
          <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
            <span class="mana-symbol mana-G" style="width: 28px; height: 28px; font-size: 14px;">G</span>
            <span style="font-size: 20px; color: #808090;">‚Üî</span>
            <span class="mana-symbol mana-U" style="width: 28px; height: 28px; font-size: 14px;">U</span>
            <h4 style="font-size: 16px; font-weight: 700; margin: 0;">Acceptance vs. Improvement</h4>
          </div>
          <p style="font-size: 13px; color: #b0b0b0; margin-bottom: 8px;"><strong>Source:</strong> Green accepts what works, Blue wants to optimize everything</p>
          <p style="font-size: 13px; color: #10B981;"><strong>Resolution:</strong> Preserve what demonstrably works, improve what demonstrably doesn't</p>
        </div>
      </div>
    </div>
    
    <!-- De-escalation Strategies -->
    <div class="card fade-in">
      <h3 style="font-size: 20px; margin-bottom: 16px; color: #a78bfa;">De-escalation Strategies</h3>
      <p style="font-size: 13px; color: #808090; margin-bottom: 24px; font-style: italic;">When someone is upset, here's what they need</p>
      
      <div style="display: grid; gap: 12px;">
        <div style="background: rgba(255,255,255,0.03); padding: 14px; border-radius: 6px; border-left: 3px solid #F59E0B;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
            <span class="mana-symbol mana-W" style="width: 24px; height: 24px; font-size: 12px;">W</span>
            <strong style="font-size: 14px;">When WHITE is upset:</strong>
          </div>
          <p style="font-size: 13px; color: #d0d0d0;">Acknowledge impact on team, show concern for fairness, propose systematic solution, rebuild community connection</p>
        </div>
        
        <div style="background: rgba(255,255,255,0.03); padding: 14px; border-radius: 6px; border-left: 3px solid #3B82F6;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
            <span class="mana-symbol mana-U" style="width: 24px; height: 24px; font-size: 12px;">U</span>
            <strong style="font-size: 14px;">When BLUE is upset:</strong>
          </div>
          <p style="font-size: 13px; color: #d0d0d0;">Provide analysis and data, show logical reasoning, give time to process, address inefficiency directly</p>
        </div>
        
        <div style="background: rgba(255,255,255,0.03); padding: 14px; border-radius: 6px; border-left: 3px solid #6B7280;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
            <span class="mana-symbol mana-B" style="width: 24px; height: 24px; font-size: 12px;">B</span>
            <strong style="font-size: 14px;">When BLACK is upset:</strong>
          </div>
          <p style="font-size: 13px; color: #d0d0d0;">Acknowledge their interests weren't served, negotiate clear resolution, make explicit commitments, respect their boundaries</p>
        </div>
        
        <div style="background: rgba(255,255,255,0.03); padding: 14px; border-radius: 6px; border-left: 3px solid #EF4444;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
            <span class="mana-symbol mana-R" style="width: 24px; height: 24px; font-size: 12px;">R</span>
            <strong style="font-size: 14px;">When RED is upset:</strong>
          </div>
          <p style="font-size: 13px; color: #d0d0d0;">Let them express emotion, don't invalidate feelings, act quickly to resolve, bring energy and passion</p>
        </div>
        
        <div style="background: rgba(255,255,255,0.03); padding: 14px; border-radius: 6px; border-left: 3px solid #10B981;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
            <span class="mana-symbol mana-G" style="width: 24px; height: 24px; font-size: 12px;">G</span>
            <strong style="font-size: 14px;">When GREEN is upset:</strong>
          </div>
          <p style="font-size: 13px; color: #d0d0d0;">Give them time and space, don't force immediate change, respect their experience, slow down the pace</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
console.log('=== SCRIPT START ===');

// ============================================================================
// 40 RANDOM NAMES FOR QUOTE ATTRIBUTION
// ============================================================================
const QUOTE_NAMES = [
  'Sarah', 'Marcus', 'Jennifer', 'David', 'Emily', 'James', 'Lisa', 'Michael',
  'Amanda', 'Chris', 'Rachel', 'Tom', 'Nicole', 'Kevin', 'Ashley', 'Brian',
  'Lauren', 'Matt', 'Stephanie', 'Dan', 'Michelle', 'Alex', 'Jessica', 'Ryan',
  'Megan', 'John', 'Katie', 'Steve', 'Heather', 'Mark', 'Brittany', 'Paul',
  'Crystal', 'Tim', 'Amber', 'Greg', 'Melissa', 'Josh', 'Rebecca', 'Scott'
];

function getRandomName() {
  return QUOTE_NAMES[Math.floor(Math.random() * QUOTE_NAMES.length)];
}

// ============================================================================
// MANA COST PARSER
// ============================================================================
function renderManaCost(costString) {
  // Parse {2}{U}{U}{R} into individual symbols
  const symbols = costString.match(/{[^}]+}/g) || [];
  const html = symbols.map(symbol => {
    const content = symbol.slice(1, -1); // Remove { }
    
    // Check if it's a number (generic mana)
    if (/^\d+$/.test(content)) {
      return `<span class="mana-symbol" style="background: linear-gradient(135deg, #9CA3AF, #6B7280); color: #1F2937; border-color: #4B5563; width: 28px; height: 28px; font-size: 14px; font-weight: 800;">${content}</span>`;
    }
    // Check if it's hybrid mana like {G/W}
    else if (content.includes('/')) {
      const [c1, c2] = content.split('/');
      return `<span class="mana-symbol mana-${c1}" style="width: 28px; height: 28px; font-size: 14px; position: relative;">
        <span style="position: absolute; top: 0; left: 0; width: 50%; height: 100%; overflow: hidden;">${c1}</span>
        <span style="position: absolute; top: 0; right: 0; width: 50%; height: 100%; overflow: hidden;">${c2}</span>
      </span>`;
    }
    // Regular colored mana
    else {
      return `<span class="mana-symbol mana-${content}" style="width: 28px; height: 28px; font-size: 14px;">${content}</span>`;
    }
  }).join('');
  
  return html;
}

const POOL_A = [
  {id:'A-WB-001',pair:'W-B',ctx:'Team Leadership',sc:'Your project succeeded largely due to two star performers, though the whole team contributed.',r:[{t:'Celebrate it as a team victory and ensure everyone shares in the recognition and rewards',c:'W'},{t:'Ensure the star performers receive differentiated recognition reflecting their disproportionate impact',c:'B'}]},
  {id:'A-WB-002',pair:'W-B',ctx:'Personal Development',sc:'You are offered a significant promotion requiring relocation away from your established community and family.',r:[{t:'Decline if it would disrupt important relationships and community connections',c:'W'},{t:'Accept if the career advancement and compensation justify the personal trade-offs',c:'B'}]},
  {id:'A-WB-003',pair:'W-B',ctx:'Resource Allocation',sc:'Two initiatives need funding but budget only covers one. Both have merit but serve different stakeholder groups.',r:[{t:'Choose the initiative that benefits the broader group and serves more people fairly',c:'W'},{t:'Choose the initiative that best advances your department\'s strategic objectives',c:'B'}]},
  {id:'A-WB-004',pair:'W-B',ctx:'Performance Management',sc:'You need to deliver feedback to a colleague whose work quality has declined noticeably.',r:[{t:'Focus on understanding what support they need and how the team can help them improve',c:'W'},{t:'Be direct about whether their current performance serves what you need from this role',c:'B'}]},
  {id:'A-WB-005',pair:'W-B',ctx:'Conflict Resolution',sc:'A teammate bypasses the standard approval process to accelerate their project timeline.',r:[{t:'Address it to maintain procedural fairness and trust in our established systems',c:'W'},{t:'Assess whether their results justify the approach before deciding how to respond',c:'B'}]},
  {id:'A-WB-006',pair:'W-B',ctx:'Strategic Planning',sc:'You are selecting a strategic partner. One shares your values and culture; another offers superior capabilities.',r:[{t:'Choose the partner whose values and culture align with your organization\'s principles',c:'W'},{t:'Choose the partner whose capabilities best serve your strategic objectives',c:'B'}]},
  {id:'A-UR-001',pair:'U-R',ctx:'Crisis Management',sc:'A critical system is failing and customers are affected. Your team is looking to you for direction.',r:[{t:'Take 15 minutes to diagram the system architecture and identify root cause before acting',c:'U'},{t:'Trust your technical instinct and start trying solutions immediately to restore service',c:'R'}]},
  {id:'A-UR-002',pair:'U-R',ctx:'Strategic Planning',sc:'A significant market opportunity appears but the window is closing quickly.',r:[{t:'Spend time analyzing market fit, competitive position, and resource requirements before committing',c:'U'},{t:'Move fast to capture the opportunity and figure out the details as you execute',c:'R'}]},
  {id:'A-UR-003',pair:'U-R',ctx:'Innovation',sc:'Your team is developing a new solution to a complex customer problem.',r:[{t:'Research similar solutions, build prototypes, and test systematically before launch',c:'U'},{t:'Build something quickly, get it in customers\' hands, and iterate based on real feedback',c:'R'}]},
  {id:'A-UR-004',pair:'U-R',ctx:'Conflict Resolution',sc:'Two team members have been arguing for 30 minutes in your meeting with no resolution in sight.',r:[{t:'Table the discussion, ask both parties to document their positions, and reconvene with analysis',c:'U'},{t:'Push for a decision right now even if imperfect‚Äîcontinuing the argument is wasting everyone\'s time',c:'R'}]},
  {id:'A-UR-005',pair:'U-R',ctx:'Team Leadership',sc:'You are choosing between two final candidates: one has perfect credentials, one just feels right for the team.',r:[{t:'Choose based on objective qualifications, experience, and systematic evaluation of fit',c:'U'},{t:'Trust your gut instinct about who will actually succeed in your specific team culture',c:'R'}]},
  {id:'A-UR-006',pair:'U-R',ctx:'Strategic Planning',sc:'Your leadership team is setting strategy for the next 18 months.',r:[{t:'Build detailed roadmaps with milestones, dependencies, and contingency plans before committing',c:'U'},{t:'Set ambitious directional goals and trust the team to figure out the path as opportunities emerge',c:'R'}]},
  {id:'A-GU-007',pair:'G-U',ctx:'Change Management',sc:'Someone proposes replacing an established process with a new approach that theoretically improves efficiency.',r:[{t:'Be cautious‚Äîthe current process works and has proven itself over time',c:'G'},{t:'Analyze whether the new approach genuinely optimizes outcomes before deciding',c:'U'}]},
  {id:'A-GU-008',pair:'G-U',ctx:'Strategic Planning',sc:'Your organization is evaluating whether to adopt a new technology platform.',r:[{t:'Proceed carefully‚Äîcurrent tools work fine and transitions are disruptive',c:'G'},{t:'Systematically evaluate whether the new platform delivers measurable improvements',c:'U'}]},
  {id:'A-GU-009',pair:'G-U',ctx:'Team Leadership',sc:'You are designing a development program for your team\'s skill building.',r:[{t:'Build on existing expertise through mentorship and gradual skill deepening over time',c:'G'},{t:'Identify skill gaps systematically and design targeted training to optimize capabilities',c:'U'}]},
  {id:'A-GU-010',pair:'G-U',ctx:'Innovation',sc:'Your team faces a complex operational challenge.',r:[{t:'Look at how similar challenges were successfully resolved in the past',c:'G'},{t:'Analyze the specific problem systematically to identify the optimal new solution',c:'U'}]},
  {id:'A-GU-011',pair:'G-U',ctx:'Change Management',sc:'Leadership wants to reorganize team structure for better efficiency.',r:[{t:'Proceed slowly‚Äîcurrent relationships and patterns have value that may be lost',c:'G'},{t:'Study the org structure analytically to determine what would genuinely improve performance',c:'U'}]},
  {id:'A-GU-012',pair:'G-U',ctx:'Strategic Planning',sc:'Your company is considering entering a new market segment.',r:[{t:'Stick with core competencies and markets where you have proven track record',c:'G'},{t:'Analyze the new market opportunity systematically to determine strategic fit',c:'U'}]},
  {id:'A-WR-007',pair:'W-R',ctx:'Crisis Management',sc:'A major issue requires immediate team response.',r:[{t:'Quickly organize a coordinated response ensuring everyone knows their role',c:'W'},{t:'Act decisively right now and coordinate as you go',c:'R'}]},
  {id:'A-WR-008',pair:'W-R',ctx:'Strategic Planning',sc:'An unexpected opportunity appears requiring rapid decision-making.',r:[{t:'Convene stakeholders quickly to ensure alignment before committing',c:'W'},{t:'Seize it immediately before the window closes',c:'R'}]},
  {id:'A-WR-009',pair:'W-R',ctx:'Performance',sc:'You need to give difficult feedback about team collaboration.',r:[{t:'Frame it in terms of team impact and collective improvement',c:'W'},{t:'Be direct and passionate about what needs to change immediately',c:'R'}]},
  {id:'A-WR-010',pair:'W-R',ctx:'Conflict Resolution',sc:'Two team members have fundamentally different working styles causing friction.',r:[{t:'Facilitate a structured process for finding common ground and shared norms',c:'W'},{t:'Push them to address it directly and authentically right now',c:'R'}]},
  {id:'A-WR-011',pair:'W-R',ctx:'Innovation',sc:'Your team is launching a bold new initiative.',r:[{t:'Ensure everyone is aligned on approach and coordinated in execution',c:'W'},{t:'Move fast with passion and adjust based on what you discover',c:'R'}]},
  {id:'A-WR-012',pair:'W-R',ctx:'Team Leadership',sc:'Setting the culture and norms for your team.',r:[{t:'Establish clear shared values and processes that create fairness for everyone',c:'W'},{t:'Encourage authentic expression and trust people to be themselves',c:'R'}]},
  {id:'A-BG-007',pair:'B-G',ctx:'Strategic Planning',sc:'An initiative has run 18 months with mediocre results.',r:[{t:'Cut losses now and reallocate resources to higher-potential opportunities',c:'B'},{t:'Give it more time‚Äîmeaningful initiatives often take longer than expected',c:'G'}]},
  {id:'A-BG-008',pair:'B-G',ctx:'Team Leadership',sc:'A member with unique expertise is becoming difficult, creating friction.',r:[{t:'Assess objectively whether their specialized value outweighs the disruption they cause',c:'B'},{t:'Invest in the relationship patiently‚Äîpeople evolve and team dynamics naturally improve',c:'G'}]},
  {id:'A-BG-009',pair:'B-G',ctx:'Strategic Planning',sc:'Your market position is gradually eroding as competitors adopt more aggressive pricing strategies.',r:[{t:'Make decisive pricing moves now to regain competitive position even if margins suffer temporarily',c:'B'},{t:'Maintain pricing strategy and trust that quality and customer relationships will sustain the business',c:'G'}]},
  {id:'A-BG-010',pair:'B-G',ctx:'Resource Allocation',sc:'Your organization needs critical capabilities quickly to compete effectively.',r:[{t:'Acquire them immediately through strategic hiring, partnerships, or acquisition',c:'B'},{t:'Develop them organically from within through patient mentorship and gradual skill building',c:'G'}]},
  {id:'A-BG-011',pair:'B-G',ctx:'Innovation',sc:'Your flagship product has aging architecture and mounting technical debt but stable revenue and loyal customers.',r:[{t:'Invest in rebuilding it properly now even if it disrupts current customers temporarily',c:'B'},{t:'Continue evolving it incrementally to avoid disrupting what\'s working',c:'G'}]},
  {id:'A-BG-012',pair:'B-G',ctx:'Strategic Planning',sc:'A long-standing partnership is providing diminishing returns as your strategic priorities evolve.',r:[{t:'Renegotiate terms aggressively or exit to reallocate resources to better opportunities',c:'B'},{t:'Maintain the relationship‚Äîpartnerships often develop unexpected value over extended time',c:'G'}]}
];
const POOL_B = {
  AZORIUS:[{sc:'Your organization needs new decision-making frameworks that work for everyone.',r:[{t:'Design comprehensive systematic processes ensuring both analytical rigor and equitable outcomes for all stakeholders',g:'AZORIUS'},{t:'Build inclusive community structures that allow people to develop shared approaches naturally over time',g:'SELESNYA'},{t:'Create analytical governance systems that strategically position your function for maximum influence',g:'DIMIR'}]},{sc:'You are implementing new policies that will affect how the entire team operates.',r:[{t:'Roll out systematic fair procedures with thorough documentation ensuring everyone understands and can apply them consistently',g:'AZORIUS'},{t:'Establish clear hierarchical protocols that serve organizational authority while maintaining fairness',g:'ORZHOV'},{t:'Let decision-making processes evolve organically based on what proves most effective in practice',g:'SIMIC'}]}],
  SELESNYA:[{sc:'Shaping how your team works together and develops.',r:[{t:'Foster inclusive environment where people naturally support each other and grow sustainably',g:'SELESNYA'},{t:'Design systematic fair processes ensuring coordinated development',g:'AZORIUS'},{t:'Allow organic growth while thoughtfully optimizing team effectiveness',g:'SIMIC'}]},{sc:'Two team members have tension affecting group harmony.',r:[{t:'Create supportive space for the relationship to heal naturally while protecting team cohesion',g:'SELESNYA'},{t:'Mediate fairly while clarifying authority and what serves the organization',g:'ORZHOV'},{t:'Let them resolve it directly through authentic interaction',g:'GRUUL'}]}],
  ORZHOV:[{sc:'Designing governance for a cross-functional initiative.',r:[{t:'Create transparent fair hierarchy ensuring authority serves both team and strategic needs',g:'ORZHOV'},{t:'Build inclusive consensus-based structure from community values',g:'SELESNYA'},{t:'Design governance appearing fair while strategically positioning you',g:'DIMIR'}]},{sc:'Setting performance standards balancing consistency with pragmatism.',r:[{t:'Establish equitable standards fairly while making pragmatic exceptions when necessary',g:'ORZHOV'},{t:'Create systematic objective criteria ensuring consistent fair evaluation',g:'AZORIUS'},{t:'Set realistic bars and pragmatically cycle out underperformers',g:'GOLGARI'}]}],
  DIMIR:[{sc:'You have discovered valuable competitive information that could give you a significant advantage.',r:[{t:'Analyze it thoroughly and hold it strategically, only revealing when you can extract maximum positional advantage from the timing',g:'DIMIR'},{t:'Share it through appropriate channels while ensuring your role in discovering it is properly recognized by leadership',g:'ORZHOV'},{t:'Run rapid experiments to test what new approaches this information might enable for your work',g:'IZZET'}]},{sc:'You are deciding how much information to share with various stakeholders about your project progress and challenges.',r:[{t:'Share information selectively, revealing only what advances your strategic position while maintaining analytical understanding of impacts',g:'DIMIR'},{t:'Communicate progress thoughtfully and patiently, allowing stakeholders to naturally develop their own understanding over time',g:'SIMIC'},{t:'Be pragmatically transparent about what is working while letting less essential implementation details remain vague',g:'GOLGARI'}]}],
  IZZET:[{sc:'Developing a new solution to a complex problem.',r:[{t:'Try multiple rapid experiments learning what works through iteration',g:'IZZET'},{t:'Research systematically then execute with passionate commitment',g:'JESKAI'},{t:'Test boldly while directing energy toward strategic objectives',g:'GRIXIS'}]},{sc:'Your approach to innovation and improvement.',r:[{t:'Experiment rapidly with novel approaches and learn from results',g:'IZZET'},{t:'Design optimal systems through thorough analysis',g:'AZORIUS'},{t:'Thoughtfully enhance existing solutions through understanding patterns',g:'SIMIC'}]}],
  GRUUL:[{sc:'Your team is facing a high-stakes challenge that demands immediate powerful action.',r:[{t:'Apply overwhelming force directly, trusting the deep domain expertise and battle-tested approaches your team has proven over time',g:'GRUUL'},{t:'Trust your team\'s proven battle-tested instincts and apply overwhelming collective strength directly',g:'GRUUL'},{t:'Foster an inclusive supportive environment where people can contribute naturally, building collaborative solutions together patiently',g:'SELESNYA'}]},{sc:'Your team needs to deliver critical results while working under significant time pressure and resource constraints.',r:[{t:'Leverage your proven strength and instinctive expertise to apply overwhelming force where it matters most',g:'GRUUL'},{t:'Experiment with multiple different approaches rapidly, learning quickly from each attempt to find what actually works',g:'IZZET'},{t:'Focus pragmatically on the sustainable high-impact areas where you can extract maximum value without burning out',g:'GOLGARI'}]}],
  RAKDOS:[{sc:'Your organization is stuck in comfortable patterns.',r:[{t:'Force immediate disruptive change to break free and create opportunities for yourself',g:'RAKDOS'},{t:'Position strategically to capitalize when the status quo inevitably shifts',g:'DIMIR'},{t:'Smash through restrictions directly using your strength',g:'GRUUL'}]},{sc:'An opportunity to advance requires breaking conventions.',r:[{t:'Seize it passionately regardless of rules limiting you',g:'RAKDOS'},{t:'Experiment boldly with unconventional methods',g:'IZZET'},{t:'Make pragmatic moves positioning you in emerging landscape',g:'GOLGARI'}]}],
  GOLGARI:[{sc:'Some organizational areas thrive while others decline.',r:[{t:'Harvest value from declining areas to sustainably fuel growing ones',g:'GOLGARI'},{t:'Analyze which to extract from and position in growth areas',g:'DIMIR'},{t:'Let natural evolution occur while optimizing what works',g:'SIMIC'}]},{sc:'Managing team at different career stages.',r:[{t:'Make pragmatic investment decisions while accepting natural career cycles',g:'GOLGARI'},{t:'Replace declining performers decisively to keep competitive',g:'RAKDOS'},{t:'Manage transitions fairly while ensuring organizational needs are met',g:'ORZHOV'}]}],
  SIMIC:[{sc:'Current processes work but could theoretically improve.',r:[{t:'Analyze carefully and evolve gradually without disrupting what works',g:'SIMIC'},{t:'Let improvements emerge naturally from community while maintaining harmony',g:'SELESNYA'},{t:'Design systematic optimization ensuring fair efficient outcomes',g:'AZORIUS'}]},{sc:'Deciding your approach to innovation.',r:[{t:'Thoughtfully enhance existing solutions through deep understanding of patterns',g:'SIMIC'},{t:'Trust powerful instincts proven through experience',g:'GRUUL'},{t:'Systematically innovate for competitive advantage',g:'DIMIR'}]}],
  BOROS:[{sc:'Leading a critical high-stakes initiative.',r:[{t:'Rally passionate coordinated commitment where everyone executes decisively together',g:'BOROS'},{t:'Drive powerful direct action based on proven approaches',g:'GRUUL'},{t:'Build inclusive supportive collaboration allowing natural contributions',g:'SELESNYA'}]},{sc:'Core values are challenged by external pressures.',r:[{t:'Fight passionately to defend what the community stands for with coordinated action',g:'BOROS'},{t:'Push back aggressively to protect your freedom and autonomy',g:'RAKDOS'},{t:'Systematically defend principles through proper procedures',g:'AZORIUS'}]}]
};
const POOL_C = {
  BANT:[{sc:'Leading a complex cross-functional team.',r:[{t:'Foster inclusive patient community with systematic analytical coordination',g:'BANT'},{t:'Build supportive harmonious team developing naturally together',g:'SELESNYA'},{t:'Create comprehensive fair processes with optimal systematic structure',g:'AZORIUS'},{t:'Allow organic team evolution while thoughtfully optimizing effectiveness',g:'SIMIC'}]},{sc:'Planning a major initiative requiring coordination, analysis, and sustainability.',r:[{t:'Design systematic inclusive approach allowing patient strategic development for everyone',g:'BANT'},{t:'Create analytically optimal fair procedures ensuring coordinated execution',g:'AZORIUS'},{t:'Build community-based strategy emerging naturally from collective wisdom',g:'SELESNYA'}]}],
  ESPER:[{sc:'Designing systems for maximum effectiveness and control.',r:[{t:'Create comprehensive calculated systems that are fair yet ruthlessly optimized for results',g:'ESPER'},{t:'Design systematic equitable processes ensuring analytical coordination',g:'AZORIUS'},{t:'Build fair hierarchy serving organizational power and strategic goals',g:'ORZHOV'},{t:'Develop analytical positioning systems serving competitive advantage',g:'DIMIR'}]},{sc:'Managing team performance with focus on efficiency.',r:[{t:'Implement fair systematic metrics making pragmatic calls on who delivers optimal outcomes',g:'ESPER'},{t:'Set equitable standards while making tough pragmatic decisions',g:'ORZHOV'},{t:'Create comprehensive analytical evaluation ensuring fair consistent assessment',g:'AZORIUS'}]}],
  GRIXIS:[{sc:'Developing strategy to dominate a competitive situation.',r:[{t:'Analyze systematically and execute aggressive ruthless moves that position you to win',g:'GRIXIS'},{t:'Position strategically through patient analytical intelligence',g:'DIMIR'},{t:'Disrupt aggressively and break constraints to advance your interests',g:'RAKDOS'},{t:'Experiment boldly with innovative approaches and iterate rapidly',g:'IZZET'}]},{sc:'Executing a turnaround requiring smart aggressive moves.',r:[{t:'Execute analytically ruthless decisions with immediate decisive action',g:'GRIXIS'},{t:'Try multiple bold approaches rapidly learning what works',g:'IZZET'},{t:'Act immediately and aggressively to force transformation',g:'RAKDOS'}]}],
  JUND:[{sc:'High-stakes competition requiring aggression and proven instincts.',r:[{t:'Trust battle-tested predatory instincts and pragmatically devour the competition',g:'JUND'},{t:'Attack immediately with disruptive aggressive action',g:'RAKDOS'},{t:'Make patient pragmatic extraction moves',g:'GOLGARI'},{t:'Apply overwhelming instinctive force',g:'GRUUL'}]},{sc:'Facing rivals for a critical resource.',r:[{t:'Leverage proven predatory instincts to ruthlessly outcompete',g:'JUND'},{t:'Attack immediately and disrupt their position aggressively',g:'RAKDOS'},{t:'Make patient pragmatic moves as they naturally weaken',g:'GOLGARI'}]}],
  NAYA:[{sc:'Rallying organization around shared mission requiring collective strength.',r:[{t:'Mobilize passionate coordinated community action leveraging natural collective power',g:'NAYA'},{t:'Rally aggressive disciplined unified commitment to the mission',g:'BOROS'},{t:'Trust the group\'s powerful instincts and act forcefully together',g:'GRUUL'},{t:'Foster inclusive patient community building harmonious support',g:'SELESNYA'}]},{sc:'Defending community values through decisive coordinated action.',r:[{t:'Execute passionate unified action grounded in shared natural community strength',g:'NAYA'},{t:'Protect community values through inclusive patient collective support',g:'SELESNYA'},{t:'Fight aggressively with disciplined coordination for what the team stands for',g:'BOROS'}]}],
  ABZAN:[{sc:'Making decisions affecting your organization for generations.',r:[{t:'Build enduring fair structures through pragmatic patient multi-generational thinking',g:'ABZAN'},{t:'Create inclusive sustainable community that develops naturally over time',g:'SELESNYA'},{t:'Establish fair hierarchy with pragmatic succession serving institutional power',g:'ORZHOV'},{t:'Make pragmatic investments in what survives natural cycles',g:'GOLGARI'}]},{sc:'Building capacity to endure through changing conditions.',r:[{t:'Create fair resilient systems through pragmatic acceptance of natural cycles',g:'ABZAN'},{t:'Build sustainability through pragmatic extraction and patient regeneration',g:'GOLGARI'},{t:'Design fair institutional frameworks serving long-term survival',g:'ORZHOV'}]}],
  JESKAI:[{sc:'Leading high-performance team requiring excellence and discipline.',r:[{t:'Drive passionate systematic excellence through disciplined coordinated mastery',g:'JESKAI'},{t:'Rally aggressive coordinated commitment with intense disciplined execution',g:'BOROS'},{t:'Create comprehensive systematic processes ensuring fair optimal performance',g:'AZORIUS'},{t:'Experiment passionately with analytical learning and rapid iteration',g:'IZZET'}]},{sc:'Mastering complex skills through practice.',r:[{t:'Train passionately with systematic discipline until technique becomes instinct',g:'JESKAI'},{t:'Execute aggressively with coordinated disciplined commitment',g:'BOROS'},{t:'Study analytically to optimize approaches systematically',g:'AZORIUS'}]}],
  SULTAI:[{sc:'Extracting maximum value while ensuring sustainability.',r:[{t:'Systematically extract optimal value through patient intelligent understanding of cycles',g:'SULTAI'},{t:'Position analytically to capitalize on opportunities methodically',g:'DIMIR'},{t:'Harvest pragmatically while accepting natural regenerative cycles',g:'GOLGARI'},{t:'Optimize thoughtfully for sustainable gradual evolution',g:'SIMIC'}]},{sc:'Managing resources for long-term value.',r:[{t:'Extract intelligently through patient pragmatic understanding of natural systems',g:'SULTAI'},{t:'Make pragmatic patient moves accepting natural cycles',g:'GOLGARI'},{t:'Position strategically through analytical intelligence',g:'DIMIR'}]}],
  MARDU:[{sc:'Fast aggressive execution requiring coordination and pragmatism.',r:[{t:'Execute aggressive coordinated action with pragmatic focus on winning quickly',g:'MARDU'},{t:'Rally passionate unified disciplined assault',g:'BOROS'},{t:'Attack immediately and disruptively to force advantage',g:'RAKDOS'},{t:'Navigate strategically within structures to secure position',g:'ORZHOV'}]},{sc:'Seizing opportunities through speed and coordination.',r:[{t:'Move aggressively with coordinated pragmatic strikes to win fast',g:'MARDU'},{t:'Attack passionately with disciplined unified force',g:'BOROS'},{t:'Seize immediately and disrupt aggressively',g:'RAKDOS'}]}],
  TEMUR:[{sc:'Solving problems through adaptive strength and intelligence.',r:[{t:'Apply powerful instinctive intelligence adapting rapidly to conditions',g:'TEMUR'},{t:'Trust overwhelming natural instincts and proven strength',g:'GRUUL'},{t:'Evolve thoughtfully through analytical understanding',g:'SIMIC'},{t:'Experiment boldly with adaptive innovative approaches',g:'IZZET'}]},{sc:'Adapting to change through intelligent natural strength.',r:[{t:'Leverage powerful adaptive intelligence responding to evolving conditions',g:'TEMUR'},{t:'Apply instinctive proven strength directly',g:'GRUUL'},{t:'Adapt incrementally through thoughtful analytical evolution',g:'SIMIC'}]}]
};

// ============================================================================
// POOL D: PATTERN COMPLEXITY DISCRIMINATION
// ============================================================================
// Tests how many colors are genuinely active (1, 2, or 3) through workplace scenarios
// Responses embody different color counts without announcing complexity
const POOL_D = {
  'PATTERN-TEST': [
    {
      id: 'D-001',
      ctx: 'Crisis Response',
      sc: 'A critical project is failing and needs immediate intervention to save it.',
      r: [
        {text: 'Analyze what\'s failing systematically, identify root causes, and implement the optimal solution', pattern: 'MONO', colors: ['U'], g: 'MONO-U'},
        {text: 'Analyze the situation strategically to identify which components can be salvaged versus which should be cut to save what matters', pattern: 'GUILD', colors: ['U','B'], g: 'DIMIR'},
        {text: 'Analyze the failure points quickly, make ruthless triage decisions, and execute the turnaround with aggressive immediate action', pattern: 'THREE', colors: ['U','B','R'], g: 'GRIXIS'}
      ]
    },
    {
      id: 'D-002',
      ctx: 'Team Performance',
      sc: 'A team member\'s performance has been declining and affecting team results.',
      r: [
        {text: 'Work with them to understand what support they need and ensure the team helps them succeed', pattern: 'MONO', colors: ['W'], g: 'MONO-W'},
        {text: 'Support them fairly through proper processes while making pragmatic assessment of whether they can meet role requirements', pattern: 'GUILD', colors: ['W','B'], g: 'ORZHOV'},
        {text: 'Provide fair support and coaching patiently while making realistic pragmatic decisions about their long-term fit', pattern: 'THREE', colors: ['W','B','G'], g: 'ABZAN'}
      ]
    },
    {
      id: 'D-003',
      ctx: 'Strategic Planning',
      sc: 'Developing strategy for your function over the next 2-3 years.',
      r: [
        {text: 'Identify what advances your position and pursue those opportunities pragmatically', pattern: 'MONO', colors: ['B'], g: 'MONO-B'},
        {text: 'Analyze the competitive landscape methodically to position yourself for maximum strategic advantage', pattern: 'GUILD', colors: ['U','B'], g: 'DIMIR'},
        {text: 'Analyze which capabilities will remain valuable long-term, position to extract maximum value, and build sustainable competitive advantages patiently', pattern: 'THREE', colors: ['U','B','G'], g: 'SULTAI'}
      ]
    },
    {
      id: 'D-004',
      ctx: 'Innovation',
      sc: 'A new approach could significantly improve your team\'s work but requires changing established practices.',
      r: [
        {text: 'Try it immediately and learn through actual experience what works', pattern: 'MONO', colors: ['R'], g: 'MONO-R'},
        {text: 'Experiment with it systematically through rapid iteration to discover what actually works', pattern: 'GUILD', colors: ['U','R'], g: 'IZZET'},
        {text: 'Test it carefully through controlled experiments while trusting proven instincts about what will work in practice', pattern: 'THREE', colors: ['G','U','R'], g: 'TEMUR'}
      ]
    },
    {
      id: 'D-005',
      ctx: 'Resource Allocation',
      sc: 'You have limited budget to invest across multiple team priorities this quarter.',
      r: [
        {text: 'Invest where it advances our competitive position most effectively', pattern: 'MONO', colors: ['B'], g: 'MONO-B'},
        {text: 'Focus investment on sustainable areas that will compound value over natural cycles', pattern: 'GUILD', colors: ['B','G'], g: 'GOLGARI'},
        {text: 'Analyze which investments deliver optimal sustainable value through patient intelligent resource management', pattern: 'THREE', colors: ['U','G','B'], g: 'SULTAI'}
      ]
    },
    {
      id: 'D-006',
      ctx: 'Conflict Resolution',
      sc: 'Two team members have escalating tension that\'s starting to affect team dynamics.',
      r: [
        {text: 'Mediate to help them find common ground and restore team harmony', pattern: 'MONO', colors: ['W'], g: 'MONO-W'},
        {text: 'Facilitate structured conversation to systematically address the issues and establish clear mutual expectations', pattern: 'GUILD', colors: ['W','U'], g: 'AZORIUS'},
        {text: 'Create fair systematic process for resolution while making pragmatic decisions about what serves team effectiveness', pattern: 'THREE', colors: ['W','U','B'], g: 'ESPER'}
      ]
    },
    {
      id: 'D-007',
      ctx: 'Organizational Change',
      sc: 'Your organization is implementing major changes affecting how your team operates.',
      r: [
        {text: 'Let people adapt at their natural pace and trust the process will work itself out', pattern: 'MONO', colors: ['G'], g: 'MONO-G'},
        {text: 'Allow organic adaptation while thoughtfully optimizing the transition for effectiveness', pattern: 'GUILD', colors: ['G','U'], g: 'SIMIC'},
        {text: 'Create inclusive systematic support for people to adapt naturally while coordinating the transition analytically', pattern: 'THREE', colors: ['G','W','U'], g: 'BANT'}
      ]
    },
    {
      id: 'D-008',
      ctx: 'Market Opportunity',
      sc: 'A significant market opportunity has emerged that requires fast decisive action.',
      r: [
        {text: 'Seize it immediately and figure out the details as you execute', pattern: 'MONO', colors: ['R'], g: 'MONO-R'},
        {text: 'Rally the team into coordinated aggressive action to capture it together decisively', pattern: 'GUILD', colors: ['R','W'], g: 'BOROS'},
        {text: 'Execute aggressive coordinated strikes with pragmatic focus on capturing maximum value quickly before competitors react', pattern: 'THREE', colors: ['R','W','B'], g: 'MARDU'}
      ]
    },
    {
      id: 'D-009',
      ctx: 'Change Management',
      sc: 'Your organization needs to adapt to significant market changes.',
      r: [
        {text: 'Act immediately to transform operations with bold decisive moves and passionate commitment', pattern: 'MONO', colors: ['R'], g: 'MONO-R'},
        {text: 'Disrupt current patterns aggressively and seize opportunities for yourself as the landscape shifts', pattern: 'GUILD', colors: ['B','R'], g: 'RAKDOS'},
        {text: 'Attack the challenge aggressively using proven instincts while pragmatically focusing on what will survive and grow', pattern: 'THREE', colors: ['B','R','G'], g: 'JUND'}
      ]
    },
    {
      id: 'D-010',
      ctx: 'Long-Term Planning',
      sc: 'Defining your team\'s strategic priorities and capabilities for the next several years.',
      r: [
        {text: 'Analyze trends and design the optimal strategic roadmap', pattern: 'MONO', colors: ['U'], g: 'MONO-U'},
        {text: 'Create systematic inclusive planning process ensuring everyone contributes to analytically sound strategy', pattern: 'GUILD', colors: ['W','U'], g: 'AZORIUS'},
        {text: 'Build inclusive analytical framework allowing sustainable patient development coordinated across the team', pattern: 'THREE', colors: ['G','W','U'], g: 'BANT'}
      ]
    },
    {
      id: 'D-011',
      ctx: 'Team Culture',
      sc: 'Shaping how your team collaborates and develops together over time.',
      r: [
        {text: 'Build inclusive environment where everyone feels valued, supported, and connected as a team', pattern: 'MONO', colors: ['W'], g: 'MONO-W'},
        {text: 'Foster inclusive space where people naturally support each other and relationships develop sustainably', pattern: 'GUILD', colors: ['W','G'], g: 'SELESNYA'},
        {text: 'Create inclusive systematic framework enabling people to develop naturally while coordinating collaboration analytically', pattern: 'THREE', colors: ['G','W','U'], g: 'BANT'}
      ]
    },
    {
      id: 'D-012',
      ctx: 'Process Improvement',
      sc: 'Your team\'s current processes work but could theoretically be more efficient.',
      r: [
        {text: 'Analyze the processes systematically to identify inefficiencies and design the optimal replacement', pattern: 'MONO', colors: ['U'], g: 'MONO-U'},
        {text: 'Study what makes current processes effective and evolve them incrementally without disrupting what works', pattern: 'GUILD', colors: ['U','G'], g: 'SIMIC'},
        {text: 'Design systematic improvements ensuring fair efficient outcomes coordinated across everyone', pattern: 'GUILD', colors: ['U','W'], g: 'AZORIUS'}
      ]
    },
    {
      id: 'D-013',
      ctx: 'Stakeholder Communication',
      sc: 'Deciding how much detail to share with stakeholders about project challenges.',
      r: [
        {text: 'Share strategically based on what serves your position and objectives', pattern: 'MONO', colors: ['B'], g: 'MONO-B'},
        {text: 'Analyze what information provides advantage and reveal selectively to position yourself optimally', pattern: 'GUILD', colors: ['U','B'], g: 'DIMIR'},
        {text: 'Communicate transparently through proper channels while ensuring your contributions are appropriately recognized', pattern: 'GUILD', colors: ['W','B'], g: 'ORZHOV'}
      ]
    },
    {
      id: 'D-014',
      ctx: 'Knowledge Sharing',
      sc: 'A junior colleague asks you to teach them a complex skill you\'ve mastered.',
      r: [
        {text: 'Explain the optimal approach systematically, breaking down the logic and methodology clearly', pattern: 'MONO', colors: ['U'], g: 'MONO-U'},
        {text: 'Create structured learning process ensuring they understand each component and can apply it consistently', pattern: 'GUILD', colors: ['U','W'], g: 'AZORIUS'},
        {text: 'Share what you\'ve learned through experience and let them develop understanding gradually through practice', pattern: 'GUILD', colors: ['U','G'], g: 'SIMIC'}
      ]
    },
    {
      id: 'D-015',
      ctx: 'Competitive Positioning',
      sc: 'Strengthening your competitive position as similar roles evolve in the organization.',
      r: [
        {text: 'Identify what serves your advancement and pursue those opportunities pragmatically', pattern: 'MONO', colors: ['B'], g: 'MONO-B'},
        {text: 'Focus on sustainable advantages that will compound over natural career cycles', pattern: 'GUILD', colors: ['B','G'], g: 'GOLGARI'},
        {text: 'Analyze the competitive landscape methodically and position yourself for maximum strategic advantage', pattern: 'GUILD', colors: ['U','B'], g: 'DIMIR'}
      ]
    },
    {
      id: 'D-016',
      ctx: 'Performance Standards',
      sc: 'Setting expectations for what constitutes acceptable performance on your team.',
      r: [
        {text: 'Define standards based on what you need people to deliver for team success', pattern: 'MONO', colors: ['B'], g: 'MONO-B'},
        {text: 'Establish fair expectations while making pragmatic assessments about who meets requirements', pattern: 'GUILD', colors: ['W','B'], g: 'ORZHOV'},
        {text: 'Create equitable standards with realistic expectations about development timelines and patient coaching', pattern: 'THREE', colors: ['W','B','G'], g: 'ABZAN'}
      ]
    },
    {
      id: 'D-017',
      ctx: 'Crisis Decision',
      sc: 'Responding to unexpected crisis requiring immediate decision with imperfect information.',
      r: [
        {text: 'Trust your instinct and act decisively right now to address it', pattern: 'MONO', colors: ['R'], g: 'MONO-R'},
        {text: 'Make immediate aggressive moves to control the situation and position yourself advantageously', pattern: 'GUILD', colors: ['B','R'], g: 'RAKDOS'},
        {text: 'Rally the team into immediate coordinated response with everyone executing their role decisively', pattern: 'GUILD', colors: ['R','W'], g: 'BOROS'}
      ]
    },
    {
      id: 'D-018',
      ctx: 'Handling Tradition',
      sc: 'Your organization has long-standing practices that some newer employees question.',
      r: [
        {text: 'Explain that these practices have proven themselves over time and exist for good reasons', pattern: 'MONO', colors: ['G'], g: 'MONO-G'},
        {text: 'Help everyone understand the wisdom in our traditions while welcoming new perspectives into the community', pattern: 'GUILD', colors: ['W','G'], g: 'SELESNYA'},
        {text: 'Respect what has worked while thoughtfully evaluating if practices still serve their original purposes', pattern: 'GUILD', colors: ['G','U'], g: 'SIMIC'}
      ]
    },
    {
      id: 'D-019',
      ctx: 'Growth Pacing',
      sc: 'Your team is developing new capabilities that will take significant time to mature.',
      r: [
        {text: 'Give people time to develop naturally through experience and accumulated expertise', pattern: 'MONO', colors: ['G'], g: 'MONO-G'},
        {text: 'Invest pragmatically in what will generate sustainable value through natural development cycles', pattern: 'GUILD', colors: ['B','G'], g: 'GOLGARI'},
        {text: 'Identify optimal long-term investments through patient intelligent analysis of sustainable growth patterns', pattern: 'THREE', colors: ['U','B','G'], g: 'SULTAI'}
      ]
    },
    {
      id: 'D-020',
      ctx: 'Partnership Commitment',
      sc: 'A long-term organizational partnership is underperforming but has historical significance.',
      r: [
        {text: 'Maintain the relationship‚Äîpartnerships develop unexpected value over time and history matters', pattern: 'MONO', colors: ['G'], g: 'MONO-G'},
        {text: 'Preserve the partnership while strengthening community ties that make collaboration more sustainable', pattern: 'GUILD', colors: ['W','G'], g: 'SELESNYA'},
        {text: 'Assess whether the relationship still generates value and accept natural partnership cycles', pattern: 'GUILD', colors: ['B','G'], g: 'GOLGARI'}
      ]
    },
    {
      id: 'D-011',
      ctx: 'Team Culture',
      sc: 'Shaping how your team collaborates and develops together over time.',
      r: [
        {text: 'Build inclusive environment where everyone feels valued, supported, and connected as a team', pattern: 'MONO', colors: ['W'], g: 'MONO-W'},
        {text: 'Foster inclusive space where people naturally support each other and relationships develop sustainably', pattern: 'GUILD', colors: ['W','G'], g: 'SELESNYA'},
        {text: 'Create inclusive systematic framework enabling people to develop naturally while coordinating collaboration analytically', pattern: 'THREE', colors: ['G','W','U'], g: 'BANT'}
      ]
    },
    {
      id: 'D-012',
      ctx: 'Process Improvement',
      sc: 'Your team\'s current processes work but could theoretically be more efficient.',
      r: [
        {text: 'Analyze the processes systematically to identify inefficiencies and design the optimal replacement', pattern: 'MONO', colors: ['U'], g: 'MONO-U'},
        {text: 'Study what makes current processes effective and evolve them incrementally without disrupting what works', pattern: 'GUILD', colors: ['U','G'], g: 'SIMIC'},
        {text: 'Design systematic improvements ensuring fair efficient outcomes coordinated across everyone', pattern: 'GUILD', colors: ['U','W'], g: 'AZORIUS'}
      ]
    },
    {
      id: 'D-013',
      ctx: 'Stakeholder Communication',
      sc: 'Deciding how much detail to share with stakeholders about project challenges.',
      r: [
        {text: 'Share strategically based on what serves your position and objectives', pattern: 'MONO', colors: ['B'], g: 'MONO-B'},
        {text: 'Analyze what information provides advantage and reveal selectively to position yourself optimally', pattern: 'GUILD', colors: ['U','B'], g: 'DIMIR'},
        {text: 'Communicate transparently through proper channels while ensuring your contributions are appropriately recognized', pattern: 'GUILD', colors: ['W','B'], g: 'ORZHOV'}
      ]
    },
    {
      id: 'D-014',
      ctx: 'Knowledge Sharing',
      sc: 'A junior colleague asks you to teach them a complex skill you have mastered.',
      r: [
        {text: 'Explain the optimal approach systematically, breaking down the logic and methodology clearly', pattern: 'MONO', colors: ['U'], g: 'MONO-U'},
        {text: 'Create structured learning process ensuring they understand each component and can apply it consistently', pattern: 'GUILD', colors: ['U','W'], g: 'AZORIUS'},
        {text: 'Share what you have learned through experience and let them develop understanding gradually through practice', pattern: 'GUILD', colors: ['U','G'], g: 'SIMIC'}
      ]
    },
    {
      id: 'D-015',
      ctx: 'Competitive Positioning',
      sc: 'Strengthening your competitive position as similar roles evolve in the organization.',
      r: [
        {text: 'Identify what serves your advancement and pursue those opportunities pragmatically', pattern: 'MONO', colors: ['B'], g: 'MONO-B'},
        {text: 'Focus on sustainable advantages that will compound over natural career cycles', pattern: 'GUILD', colors: ['B','G'], g: 'GOLGARI'},
        {text: 'Analyze the competitive landscape methodically and position yourself for maximum strategic advantage', pattern: 'GUILD', colors: ['U','B'], g: 'DIMIR'}
      ]
    },
    {
      id: 'D-016',
      ctx: 'Performance Standards',
      sc: 'Setting expectations for what constitutes acceptable performance on your team.',
      r: [
        {text: 'Define standards based on what you need people to deliver for team success', pattern: 'MONO', colors: ['B'], g: 'MONO-B'},
        {text: 'Establish fair expectations while making pragmatic assessments about who meets requirements', pattern: 'GUILD', colors: ['W','B'], g: 'ORZHOV'},
        {text: 'Create equitable standards with realistic expectations about development timelines and patient coaching', pattern: 'THREE', colors: ['W','B','G'], g: 'ABZAN'}
      ]
    },
    {
      id: 'D-017',
      ctx: 'Crisis Decision',
      sc: 'Responding to unexpected crisis requiring immediate decision with imperfect information.',
      r: [
        {text: 'Trust your instinct and act decisively right now to address it', pattern: 'MONO', colors: ['R'], g: 'MONO-R'},
        {text: 'Make immediate aggressive moves to control the situation and position yourself advantageously', pattern: 'GUILD', colors: ['B','R'], g: 'RAKDOS'},
        {text: 'Rally the team into immediate coordinated response with everyone executing their role decisively', pattern: 'GUILD', colors: ['R','W'], g: 'BOROS'}
      ]
    },
    {
      id: 'D-018',
      ctx: 'Handling Tradition',
      sc: 'Your organization has long-standing practices that some newer employees question.',
      r: [
        {text: 'Explain that these practices have proven themselves over time and exist for good reasons', pattern: 'MONO', colors: ['G'], g: 'MONO-G'},
        {text: 'Help everyone understand the wisdom in our traditions while welcoming new perspectives into the community', pattern: 'GUILD', colors: ['W','G'], g: 'SELESNYA'},
        {text: 'Respect what has worked while thoughtfully evaluating if practices still serve their original purposes', pattern: 'GUILD', colors: ['G','U'], g: 'SIMIC'}
      ]
    },
    {
      id: 'D-019',
      ctx: 'Growth Pacing',
      sc: 'Your team is developing new capabilities that will take significant time to mature.',
      r: [
        {text: 'Give people time to develop naturally through experience and accumulated expertise', pattern: 'MONO', colors: ['G'], g: 'MONO-G'},
        {text: 'Invest pragmatically in what will generate sustainable value through natural development cycles', pattern: 'GUILD', colors: ['B','G'], g: 'GOLGARI'},
        {text: 'Identify optimal long-term investments through patient intelligent analysis of sustainable growth patterns', pattern: 'THREE', colors: ['U','B','G'], g: 'SULTAI'}
      ]
    },
    {
      id: 'D-020',
      ctx: 'Partnership Commitment',
      sc: 'A long-term organizational partnership is underperforming but has historical significance.',
      r: [
        {text: 'Maintain the relationship‚Äîpartnerships develop unexpected value over time and history matters', pattern: 'MONO', colors: ['G'], g: 'MONO-G'},
        {text: 'Preserve the partnership while strengthening community ties that make collaboration more sustainable', pattern: 'GUILD', colors: ['W','G'], g: 'SELESNYA'},
        {text: 'Assess whether the relationship still generates value and accept natural partnership cycles', pattern: 'GUILD', colors: ['B','G'], g: 'GOLGARI'}
      ]
    }
  ]
};

// ============================================================================
// PROFILES WITH NORMAL AND PUB BANTER DESCRIPTIONS + ARCHETYPE EXAMPLES
// ============================================================================
const ARCHETYPE_EXAMPLES = [
  {id: 'MONO-W', name: 'MONO-WHITE', colors: ['W'], 
    normal: "They're really into making sure everything is fair and everyone follows the same rules. Very by-the-book.", 
    banter: "Honestly they bog down every single decision with rule-checking. Can we just DO something without forming a committee?"},
  {id: 'MONO-U', name: 'MONO-BLUE', colors: ['U'], 
    normal: "They're the analytical type who likes to really think through problems systematically before acting.", 
    banter: "Oh they're brilliant sure but good luck getting anything done. It's always Well actually we should analyze this more first."},
  {id: 'MONO-B', name: 'MONO-BLACK', colors: ['B'], 
    normal: "They're pretty pragmatic and not afraid to make tough calls when needed.", 
    banter: "Look I'm just saying they'd absolutely throw you under the bus if it helped them. Everything's transactional with them."},
  {id: 'MONO-R', name: 'MONO-RED', colors: ['R'], 
    normal: "They're really passionate and tend to act quickly on their instincts.", 
    banter: "They just DO things without thinking first. Half the time we're cleaning up after whatever they impulsively decided to blow up this week."},
  {id: 'MONO-G', name: 'MONO-GREEN', colors: ['G'], 
    normal: "They're patient and like to stick with approaches that have proven to work over time.", 
    banter: "They resist literally every change. Their entire argument is We've always done it this way so why would we do it differently."},
  {id: 'AZORIUS', name: 'AZORIUS', colors: ['W', 'U'], 
    normal: "They're organized and systematic. They like clear processes that work for everyone.", 
    banter: "I swear they will cite the handbook chapter and verse before letting us make any decision. Everything needs a policy document first."},
  {id: 'DIMIR', name: 'DIMIR', colors: ['U', 'B'], 
    normal: "They're strategic and tend to think several steps ahead about positioning.", 
    banter: "Why do they know everything about everyone and never share what they know? Pretty sure they're BCCing leadership on literally every email."},
  {id: 'RAKDOS', name: 'RAKDOS', colors: ['B', 'R'], 
    normal: "They're bold and not afraid to shake things up to get results.", 
    banter: "They're legitimately chaotic. They'll burn down the whole project for the drama and then laugh while we put out fires. It's unhinged."},
  {id: 'GRUUL', name: 'GRUUL', colors: ['R', 'G'], 
    normal: "They're direct and rely on proven strength to solve problems head-on.", 
    banter: "Subtlety? Strategy? Never heard of it. They just smash through everything and ignore feedback like it doesn't exist."},
  {id: 'SELESNYA', name: 'SELESNYA', colors: ['W', 'G'], 
    normal: "They're really focused on team harmony and making sure everyone feels included.", 
    banter: "We cannot make a single decision without a team-building exercise. Everything has to be consensus and it takes forever."},
  {id: 'ORZHOV', name: 'ORZHOV', colors: ['W', 'B'], 
    normal: "They're good at navigating organizational politics while maintaining fairness.", 
    banter: "Every favor comes with interest later. They keep score on everything and weaponize policy the second it benefits them."},
  {id: 'IZZET', name: 'IZZET', colors: ['U', 'R'], 
    normal: "They're innovative and like to experiment with new approaches rapidly.", 
    banter: "Did they test this? No. They just experimented on production again. And now they're yelling SCIENCE while everything's broken."},
  {id: 'GOLGARI', name: 'GOLGARI', colors: ['B', 'G'], 
    normal: "They're good at extracting value from situations and working with long cycles.", 
    banter: "Why do they hoard every failed project? This workspace is a graveyard of ideas that died three years ago and won't stay buried."},
  {id: 'SIMIC', name: 'SIMIC', colors: ['G', 'U'], 
    normal: "They're thoughtful about improving existing systems without disrupting what works.", 
    banter: "They optimize everything to death. Six months to improve a two-week process and somehow it's worse now."},
  {id: 'BOROS', name: 'BOROS', colors: ['R', 'W'], 
    normal: "They're passionate about team goals and rally people around shared missions.", 
    banter: "Not everything is a crusade but they treat quarterly planning like D-Day. The intensity is just a lot."},
  {id: 'BANT', name: 'BANT', colors: ['W', 'U', 'G'], 
    normal: "They're balanced and strategic about building sustainable team outcomes.", 
    banter: "Great another two-hour planning session for a ten-minute task. Yes we all need to weigh in for the good of the team apparently."},
  {id: 'ESPER', name: 'ESPER', colors: ['W', 'U', 'B'], 
    normal: "They're systematic and effective at creating well-designed processes.", 
    banter: "Do they feel anything? Every conversation is like talking to a spreadsheet. Literally optimized the humanity out of this place."},
  {id: 'GRIXIS', name: 'GRIXIS', colors: ['U', 'B', 'R'], 
    normal: "They're strategically decisive and comfortable making bold moves.", 
    banter: "Pretty sure they create half the crises just to solve them dramatically. The evil laugh in the break room is not helping their case."},
  {id: 'JUND', name: 'JUND', colors: ['B', 'R', 'G'], 
    normal: "They're competitive and trust their proven instincts in high-stakes situations.", 
    banter: "Everything is a competition. They turn meetings into cage matches and dominate every single conversation. Exhausting."},
  {id: 'NAYA', name: 'NAYA', colors: ['R', 'G', 'W'], 
    normal: "They're enthusiastic team builders who bring a lot of energy to initiatives.", 
    banter: "Why does every task need pep talks and a literal marching band. We just needed to update a spreadsheet not plan a parade."},
  {id: 'ABZAN', name: 'ABZAN', colors: ['W', 'B', 'G'], 
    normal: "They're traditional and good at building enduring organizational structures.", 
    banter: "They block every new idea with We've always done it this way. Also they definitely keep a ledger of who owes them what."},
  {id: 'JESKAI', name: 'JESKAI', colors: ['U', 'R', 'W'], 
    normal: "They're skilled and pursue excellence through disciplined practice.", 
    banter: "So smug about their technique. Everything you do is basic and they make sure you feel it. Working with them is like being in a seminar you didn't sign up for."},
  {id: 'SULTAI', name: 'SULTAI', colors: ['B', 'G', 'U'], 
    normal: "They're patient strategists who build influence methodically over time.", 
    banter: "They co-opt your work and somehow it becomes part of their little empire. Very smooth about it. Very slimy."},
  {id: 'MARDU', name: 'MARDU', colors: ['R', 'W', 'B'], 
    normal: "They're intense about execution and will push hard to meet goals.", 
    banter: "Every deadline is life or death. They glorify burnout as dedication and yes they will flip tables if things aren't moving fast enough."},
  {id: 'TEMUR', name: 'TEMUR', colors: ['G', 'U', 'R'], 
    normal: "They're adaptive and combine creative thinking with strong instincts.", 
    banter: "Hold on tight because they'll pivot the entire strategy three times this week and you'll just have to deal with the whiplash."},
  {id: 'WITCH', name: 'FOUR-COLOR (No Red)', colors: ['W', 'U', 'B', 'G'], 
    normal: "They're comprehensive thinkers who approach things methodically without getting emotional.", 
    banter: "It's like they're running a simulation. Zero passion zero urgency just spreadsheets making Monday last all week."},
  {id: 'YORE', name: 'FOUR-COLOR (No Green)', colors: ['W', 'U', 'B', 'R'], 
    normal: "They're innovative and like to redesign things rather than use traditional approaches.", 
    banter: "They over-engineer everything. Simple solution? Nope needs seventeen moving parts and will break in two weeks requiring emergency fixes."},
  {id: 'GLINT', name: 'FOUR-COLOR (No White)', colors: ['U', 'B', 'R', 'G'], 
    normal: "They're creative and willing to work outside conventional boundaries.", 
    banter: "Rules are for suckers according to them. They hijack projects for fun and leave smoking wreckage of what used to be a plan."},
  {id: 'DUNE', name: 'FOUR-COLOR (No Blue)', colors: ['W', 'B', 'R', 'G'], 
    normal: "They're action-oriented and trust their gut feelings over extended analysis.", 
    banter: "They charge in on impulse every time. Planning never happens. Already yelling NO TIME NEXT while you're picking up pieces."},
  {id: 'INK', name: 'FOUR-COLOR (No Black)', colors: ['W', 'U', 'R', 'G'], 
    normal: "They're idealistic and genuinely want everyone to succeed.", 
    banter: "They're trying to help everyone at once and it's a circus. Unintended confetti explosions everywhere. So chaotic but they mean well I guess."},
  {id: 'WUBRG', name: 'FIVE-COLOR', colors: ['W', 'U', 'B', 'R', 'G'], 
    normal: "They're versatile and can work with pretty much any approach or person.", 
    banter: "They want everything at once. Kitchen sink in every project. I'm taking bets on which spinning plate crashes first."}
];

// ============================================================================
// COMMANDER ORACLE TEXT - ALL COMMANDERS
// ============================================================================
const COMMANDER_ORACLE = {
  // MONO-COLOR
  'Heliod, God of the Sun': {
    cost: '{3}{W}',
    pt: '5/6',
    text: ['Indestructible', 'As long as your devotion to white is less than five, Heliod isn\'t a creature.', 'Other creatures you control have vigilance.', '{2}{W}{W}: Create a 2/1 white Cleric enchantment creature token.']
  },
  'Urza, Lord High Artificer': {
    cost: '{2}{U}{U}',
    pt: '1/4',
    text: ['When Urza enters, create a 0/0 colorless Construct artifact creature token with "This creature gets +1/+1 for each artifact you control."', 'Tap an untapped artifact you control: Add {U}.', '{5}: Shuffle your library, then exile the top card. Until end of turn, you may play that card without paying its mana cost.']
  },
  "K'rrik, Son of Yawgmoth": {
    cost: '{4}{B/P}{B/P}{B/P}',
    pt: '2/2',
    text: ['({B/P} can be paid with either {B} or 2 life.)', 'Lifelink', 'For each {B} in a cost, you may pay 2 life rather than pay that mana.', 'Whenever you cast a black spell, put a +1/+1 counter on K\'rrik.']
  },
  'Krenko, Mob Boss': {
    cost: '{2}{R}{R}',
    pt: '3/3',
    text: ['{T}: Create X 1/1 red Goblin creature tokens, where X is the number of Goblins you control.']
  },
  'Omnath, Locus of Mana': {
    cost: '{2}{G}',
    pt: '1/1',
    text: ['You don\'t lose unspent green mana as steps and phases end.', 'Omnath gets +1/+1 for each unspent green mana you have.']
  },
  
  // TWO-COLOR GUILDS
  'Grand Arbiter Augustin IV': {
    cost: '{2}{W}{U}',
    pt: '2/3',
    text: ['White spells you cast cost {1} less to cast.', 'Blue spells you cast cost {1} less to cast.', 'Spells your opponents cast cost {1} more to cast.']
  },
  'Obzedat, Ghost Council': {
    cost: '{1}{W}{W}{B}{B}',
    pt: '5/5',
    text: ['When Obzedat enters, target opponent loses 2 life and you gain 2 life.', 'At the beginning of your end step, you may exile Obzedat. If you do, return it to the battlefield under your control at the beginning of your next upkeep. It gains haste.']
  },
  "Yuriko, the Tiger's Shadow": {
    cost: '{1}{U}{B}',
    pt: '1/3',
    text: ['Commander ninjutsu {U}{B} ({U}{B}, Return an unblocked attacker you control to hand: Put this card onto the battlefield from your hand or the command zone tapped and attacking.)', 'Whenever a Ninja you control deals combat damage to a player, reveal the top card of your library and put that card into your hand. Each opponent loses life equal to that card\'s mana value.']
  },
  'Niv-Mizzet, Parun': {
    cost: '{U}{U}{U}{R}{R}{R}',
    pt: '5/5',
    text: ['This spell can\'t be countered.', 'Flying', 'Whenever you draw a card, Niv-Mizzet deals 1 damage to any target.', 'Whenever a player casts an instant or sorcery spell, you draw a card.']
  },
  'Borborygmos Enraged': {
    cost: '{4}{R}{R}{G}{G}',
    pt: '7/6',
    text: ['Trample', 'Whenever Borborygmos Enraged deals combat damage to a player, reveal the top three cards of your library. Put all land cards revealed this way into your hand and the rest into your graveyard.', 'Discard a land card: Borborygmos Enraged deals 3 damage to any target.']
  },
  'Rakdos, Lord of Riots': {
    cost: '{B}{B}{R}{R}',
    pt: '6/6',
    text: ['You can\'t cast this spell unless an opponent lost life this turn.', 'Flying, trample', 'Creature spells you cast cost {1} less to cast for each 1 life your opponents have lost this turn.']
  },
  'Meren of Clan Nel Toth': {
    cost: '{2}{B}{G}',
    pt: '3/4',
    text: ['Whenever another creature you control dies, you get an experience counter.', 'At the beginning of your end step, choose target creature card in your graveyard. If that card\'s mana value is less than or equal to the number of experience counters you have, return it to the battlefield. Otherwise, put it into your hand.']
  },
  'Prime Speaker Vannifar': {
    cost: '{2}{G}{U}',
    pt: '2/4',
    text: ['{T}, Sacrifice another creature: Search your library for a creature card with mana value equal to 1 plus the sacrificed creature\'s mana value, put that card onto the battlefield, then shuffle. Activate only as a sorcery.']
  },
  'Aurelia, the Warleader': {
    cost: '{2}{R}{R}{W}{W}',
    pt: '3/4',
    text: ['Flying, vigilance, haste', 'Whenever Aurelia attacks for the first time each turn, untap all creatures you control. After this phase, there is an additional combat phase.']
  },
  "Trostani, Selesnya's Voice": {
    cost: '{G}{G}{W}{W}',
    pt: '2/5',
    text: ['Whenever another creature enters the battlefield under your control, you gain life equal to its toughness.', '{1}{G}{W}, {T}: Populate (Create a token that\'s a copy of a creature token you control.)']
  },
  
  // THREE-COLOR
  'Rafiq of the Many': {
    cost: '{1}{G}{W}{U}',
    pt: '3/3',
    text: ['Exalted (Whenever a creature you control attacks alone, that creature gets +1/+1 until end of turn.)', 'Whenever a creature you control attacks alone, it gains double strike until end of turn.']
  },
  'Oloro, Ageless Ascetic': {
    cost: '{3}{W}{U}{B}',
    pt: '4/5',
    text: ['At the beginning of your upkeep, if Oloro is on the battlefield, you gain 2 life.', 'At the beginning of your upkeep, if Oloro is in the command zone, you gain 2 life.', 'Pay 3 life: Draw a card.']
  },
  'Nekusar, the Mindrazer': {
    cost: '{2}{U}{B}{R}',
    pt: '2/4',
    text: ['At the beginning of each player\'s draw step, that player draws an additional card.', 'Whenever an opponent draws a card, Nekusar deals 1 damage to that player.']
  },
  'Prossh, Skyraider of Kher': {
    cost: '{3}{B}{R}{G}',
    pt: '5/5',
    text: ['When you cast this spell, create X 0/1 red Kobold creature tokens named Kobolds of Kher Keep, where X is the amount of mana spent to cast it.', 'Flying', 'Sacrifice another creature: Prossh gets +1/+0 until end of turn.']
  },
  'Samut, Voice of Dissent': {
    cost: '{3}{R}{G}{W}',
    pt: '3/4',
    text: ['Flash', 'Double strike, vigilance, haste', 'Other creatures you control have haste.', '{W}: Untap another target creature.']
  },
  'Anafenza, the Foremost': {
    cost: '{W}{B}{G}',
    pt: '4/4',
    text: ['Whenever Anafenza attacks, put a +1/+1 counter on another target tapped creature you control.', 'If a nontoken creature an opponent owns would die or a creature card not on the battlefield would be put into an opponent\'s graveyard, exile that card instead.']
  },
  'Narset, Enlightened Master': {
    cost: '{3}{U}{R}{W}',
    pt: '3/2',
    text: ['First strike, hexproof', 'Whenever Narset attacks, exile the top four cards of your library. Until end of turn, you may cast noncreature spells from among those cards without paying their mana costs.']
  },
  'Sidisi, Brood Tyrant': {
    cost: '{1}{B}{G}{U}',
    pt: '3/3',
    text: ['Whenever Sidisi enters or attacks, mill three cards.', 'Whenever one or more creature cards are put into your graveyard from your library, create a 2/2 black Zombie creature token.']
  },
  'Queen Marchesa': {
    cost: '{1}{R}{W}{B}',
    pt: '3/3',
    text: ['Deathtouch, haste', 'When Queen Marchesa enters, you become the monarch.', 'At the beginning of your upkeep, if an opponent is the monarch, create a 1/1 black Assassin creature token with deathtouch and haste.']
  },
  'Surrak Dragonclaw': {
    cost: '{2}{G}{U}{R}',
    pt: '6/6',
    text: ['Flash', 'This spell can\'t be countered.', 'Creature spells you control can\'t be countered.', 'Other creatures you control have trample.']
  },
  
  // FOUR-COLOR
  "Atraxa, Praetors' Voice": {
    cost: '{G}{W}{U}{B}',
    pt: '4/4',
    text: ['Flying', 'Vigilance', 'Deathtouch', 'Lifelink', 'At the beginning of your end step, proliferate. (Choose any number of permanents and/or players, then give each another counter of each kind already there.)']
  },
  'Breya, Etherium Shaper': {
    cost: '{W}{U}{B}{R}',
    pt: '4/4',
    text: ['When Breya enters, create two 1/1 blue Thopter artifact creature tokens with flying.', '{2}, Sacrifice two artifacts: Choose one ‚Äî', '‚Ä¢ Breya deals 3 damage to target player or planeswalker.', '‚Ä¢ Target creature gets -4/-4 until end of turn.', '‚Ä¢ You gain 5 life.']
  },
  'Yidris, Maelstrom Wielder': {
    cost: '{U}{B}{R}{G}',
    pt: '5/4',
    text: ['Trample', 'Whenever Yidris deals combat damage to a player, as you cast spells from your hand this turn, they gain cascade.']
  },
  'Saskia the Unyielding': {
    cost: '{B}{R}{G}{W}',
    pt: '3/4',
    text: ['Vigilance, haste', 'As Saskia enters, choose a player.', 'Whenever a creature you control deals combat damage to a player, it deals that much damage to the chosen player.']
  },
  'Kynaios and Tiro of Meletis': {
    cost: '{R}{G}{W}{U}',
    pt: '2/8',
    text: ['At the beginning of your end step, draw a card.', 'Each player may put a land card from their hand onto the battlefield, then each opponent who didn\'t draws a card.']
  },
  
  // FIVE-COLOR
  'Kenrith, the Returned King': {
    cost: '{4}{W}',
    pt: '5/5',
    text: ['{R}: All creatures gain trample and haste until end of turn.', '{1}{G}: Put a +1/+1 counter on target creature.', '{2}{W}: Target player gains 5 life.', '{3}{U}: Target player draws a card.', '{4}{B}: Put target creature card from a graveyard onto the battlefield under its owner\'s control.']
  }
};

// ============================================================================
// POOL D: MONO VS MULTI-COLOR DISCRIMINATION
// ============================================================================

const PROFILES = {
  'MONO-W':{
    name:'MONO-WHITE',
    tag:'Peace Through Structure',
    colors:['W'],
    desc:"You're someone who believes in community, fairness, and moral order. You build systems that protect everyone and ensure justice.",
    pubBanter:"You're an absolute stickler who bogs down every decision with rule-checking. Can we just make a decision without consulting the entire team?",
    cmd:'Heliod, God of the Sun',
    cmdDesc:'Protects the team through structure and moral authority, creating systems everyone follows',
    str:['Exceptional at building cohesive teams','Strong ethical compass guides decisions','Creates stable fair systems','Makes decisions everyone accepts as fair','Builds institutions that last'],
    weak:['Gets stuck enforcing rules rigidly','Struggles with moral gray areas','Can be naive about bad actors','Slow to adapt to change','Sometimes sacrifices efficiency for fairness'],
    roles:'HR Leadership, Master of Ceremonies, Compliance, Ethics, Community Management'
  },
  'MONO-U':{
    name:'MONO-BLUE',
    tag:'Perfection Through Knowledge',
    colors:['U'],
    desc:"You're someone who believes knowledge and analysis lead to optimal outcomes. You solve problems through systematic thinking and continuous improvement.",
    pubBanter:"You're an insufferable know-it-all. It's always Well actually before every decision. Can we stop analyzing and just DO something?",
    cmd:'Urza, Lord High Artificer',
    cmdDesc:'Solves every problem through analysis and systematic thinking, always optimizing',
    str:['Superior analytical and strategic thinking','Continuously learns and improves','Plans strategically before acting','Excellent at solving complex problems','Makes objective data-driven decisions'],
    weak:['Paralyzes through over-analysis','Comes across as emotionally distant','Over-complicates simple problems','Can be arrogant about intelligence','Struggles when there is no clear answer'],
    roles:'Strategy, Research, Minister of Inquiries, Analytics, Architecture'
  },
  'MONO-B':{
    name:'MONO-BLACK',
    tag:'Power Through Agency',
    colors:['B'],
    desc:"You're someone who believes in pragmatic self-interest and making hard calls. You achieve goals through clear-eyed assessment of reality.",
    pubBanter:"You're ruthlessly pragmatic and everything is transactional. Does everything have to be a calculation about what you get out of it?",
    cmd:"K'rrik, Son of Yawgmoth",
    cmdDesc:'Power at any cost‚Äîpays life for mana, ruthless ambition',
    str:['Takes decisive action','Clear about priorities and trade-offs','Politically savvy and strategic','Makes tough calls others avoid','Relentlessly results-oriented'],
    weak:['Amoral pragmatism','Has serious trust issues','Exploits people and situations','Focuses too much on short-term gains','Alienates people through self-interest'],
    roles:'Executive Leadership, Gravedigger, M&A, Private Equity, Strategy'
  },
  'MONO-R':{
    name:'MONO-RED',
    tag:'Freedom Through Action',
    colors:['R'],
    desc:"You're someone who believes in authentic expression and immediate action. You trust your instincts and act with passion.",
    pubBanter:"You're a complete loose cannon. Could you think about things for like five minutes first? We're always cleaning up after your impulsive decisions.",
    cmd:'Krenko, Mob Boss',
    cmdDesc:'Acts on instinct and passion immediately, creating chaotic momentum',
    str:['Executes incredibly fast','Engages authentically with real passion','Brings energizing disruptive presence','Comfortable taking big risks','Has strong bias toward action'],
    weak:['Makes impulsive poor decisions','Terrible at planning ahead','Creates chaos everywhere','Burns out quickly','Lacks strategic thinking completely'],
    roles:'Startups, Sales, Professional Face-Breaker, Crisis Response, Creative Roles'
  },
  'MONO-G':{
    name:'MONO-GREEN',
    tag:'Growth Through Acceptance',
    colors:['G'],
    desc:"You're someone who believes in natural growth, patience, and respecting what works. You trust proven patterns and organic development.",
    pubBanter:"You're a stubborn bulldozer who resists every change. Your entire argument is We've always done it this way. That's it. That's the whole argument.",
    cmd:'Omnath, Locus of Mana',
    cmdDesc:"Doesn't lose mana, grows from accumulated green‚Äîpatient compound power",
    str:['Patient with long-term development','Respects what has worked before','Builds sustainable lasting practices','Develops from existing strengths','Thinks long-term instinctively'],
    weak:['Resists necessary changes','Too passive about problems','Actively anti-innovation','Makes decisions painfully slowly','Gets stuck in the past'],
    roles:'Operations, Master Chef, Agriculture, Sustainability, Mentorship'
  },
  'AZORIUS':{
    name:'AZORIUS',
    tag:'Order Through Knowledge',
    colors:['W','U'],
    desc:"You're someone who combines moral order with logical perfection for systematic control. You build comprehensive rules fairly and efficiently applied.",
    pubBanter:"They become the walking pile of red tape who will cite chapter and verse of the rulebook to veto anything fun, turning even a trivial task into a drawn-out committee meeting that could have been an email.",
    cmd:'Grand Arbiter Augustin IV',
    cmdDesc:'Controls through comprehensive fair systems, combining law and logic',
    str:['Exceptional at governance and structure','Plans comprehensively before acting','Makes systematic fair decisions','Creates stable reliable environments','Thinks strategically'],
    weak:['Paralyzes through over-analysis','Bureaucratically slow at everything','Worships rules over actual outcomes','Stifles innovation and creativity','Needs the perfect plan before moving'],
    roles:'COO, Deputy of Detention, Compliance, Strategic Planning, Governance'
  },
  'SELESNYA':{
    name:'SELESNYA',
    tag:'Community Through Nature',
    colors:['W','G'],
    desc:"You're someone who combines organized community with organic interconnection for living harmony. Communities that are both alive and coordinated.",
    pubBanter:"You're an overbearing team-builder. Can we fire anyone? Ever? Every conflict needs healing and patience. Every 1-on-1 becomes a team retreat.",
    cmd:"Trostani, Selesnya's Voice",
    cmdDesc:'Builds living community where everyone grows together harmoniously',
    str:['Exceptional at building cohesive teams','Develops people and systems sustainably','Resolves conflicts naturally','Creates psychologically safe spaces','Patient mentor to everyone'],
    weak:['Seeks excessive consensus for everything','Can be naive about bad actors','Resists necessary accountability','Can become cult-like about team','Slow to cut obvious losses'],
    roles:'Chief People Officer, Centaur Peacemaker, HR, Culture & Values, Team Leads'
  },
  'ORZHOV':{
    name:'ORZHOV',
    tag:'Structure Through Power',
    colors:['W','B'],
    desc:"You're someone who combines systematic structure with self-interested ambition for organized extraction. Fair hierarchies serving strategic goals.",
    pubBanter:"They become a soul-sucking bureaucrat in a fancy suit, the type who enforces every policy to the letter when it benefits them, extorts favors under the guise of procedure, and generally taxes everyone time and energy like a one-person corporate vampire.",
    cmd:'Obzedat, Ghost Council',
    cmdDesc:'Extracts value through fair-seeming hierarchies and political leverage',
    str:['Building lasting institutions','Allocates resources pragmatically','Navigates politics expertly','Creates clear advancement paths','Balances ambition with sustainability'],
    weak:['Enables corruption and exploitation','Treats people as extractable resources','Creates Byzantine political games','Favors well-connected over capable people','Preserves genuinely unjust hierarchies'],
    roles:'COO, Finance, High Priest of Penance, Legal/Compliance, Senior Management'
  },
  'DIMIR':{
    name:'DIMIR',
    tag:'Intelligence Through Control',
    colors:['U','B'],
    desc:"You're someone who combines knowledge-seeking with power-seeking to weaponize information. You win through patient strategic positioning.",
    pubBanter:"You're an information hoarder. Why do you know that? Why won't you share what you know? Always playing 4D chess when we're playing checkers.",
    cmd:"Yuriko, the Tiger's Shadow",
    cmdDesc:'Wins through information control and patient strategic positioning',
    str:['Masters strategic positioning','Gathers information systematically','Reads situations and people expertly','Plays the long game patiently','Masters political maneuvering'],
    weak:['Has serious trust issues','Over-complicates everything unnecessarily','Alienates people through secrecy','Has serious ethical blind spots','Becomes paranoid easily'],
    roles:'Strategic Planning, Hostage Taker, M&A, Competitive Intelligence, VC/PE'
  },
  'IZZET':{
    name:'IZZET',
    tag:'Discovery Through Experimentation',
    colors:['U','R'],
    desc:"You're someone who combines analytical curiosity with experimental courage for mad science. You innovate through bold testing.",
    pubBanter:"You're a scatterbrained mad scientist. Did you test this? At all? You experiment on production and yell SCIENCE when it breaks.",
    cmd:'Niv-Mizzet, Parun',
    cmdDesc:'Innovates through rapid experimentation and bold testing',
    str:['Achieves genuine breakthrough innovation','Learns fast through rapid iteration','Solves problems creatively','Has high tolerance for failure','Brings energizing disruptive presence'],
    weak:['Experiments recklessly on people','Lacks follow-through completely','Has serious ethical blind spots','Creates exhausting chaos','Moves fast and breaks everything'],
    roles:'R&D, Goblin Electromancer, Innovation Labs, Product Development, Startups'
  },
  'GRUUL':{
    name:'GRUUL',
    tag:'Power Through Instinct',
    colors:['R','G'],
    desc:"You're someone who combines passionate action with primal strength for unstoppable force. You trust gut instinct and apply overwhelming power.",
    pubBanter:"You're a rampaging barbarian. Have you considered thinking about things? Spreadsheets are the enemy. Smash first ask questions never.",
    cmd:'Borborygmos Enraged',
    cmdDesc:'Applies overwhelming direct force based on gut instinct',
    str:['Takes decisive action','Has physical and moral courage','Communicates with authentic directness','Fights hard for what matters','Cuts through complexity fast'],
    weak:['Anti-intellectual by default','Destroys more than builds','Terrible at long-term planning','Uncomfortable with any politics','Defaults to smashing through problems'],
    roles:'Operations, Sales, Grand Warlord Radha, Construction, Military, Crisis Response'
  },
  'RAKDOS':{
    name:'RAKDOS',
    tag:'Freedom Through Chaos',
    colors:['B','R'],
    desc:"You're someone who combines self-interest with passionate action for uninhibited pursuit. You do what you want without apology.",
    pubBanter:"You're the chaos-loving prankster who treats coworkers like an unwitting audience for destructive antics, gleefully burning down hours of work for the LOLs while everyone else scrambles to put out the fires.",
    cmd:'Rakdos, Lord of Riots',
    cmdDesc:'Pursues self-interest passionately without restraint or apology',
    str:['Takes decisive bold action','Engages authentically with real passion','Cuts through pretense instantly','Brings energizing disruptive presence','Breaks rules that actually need breaking'],
    weak:['Recklessly destroys things','Burns out everyone around them','Creates zero sustainability','Has serious ethical blind spots','Creates exhausting constant chaos'],
    roles:'Disruptive Startups, Master of Cruelties, Aggressive Sales, Entertainment, Activism'
  },
  'GOLGARI':{
    name:'GOLGARI',
    tag:'Growth Through Decay',
    colors:['B','G'],
    desc:"You're someone who combines use of death with acceptance of cycles for sustainable extraction. You harvest without killing the host.",
    pubBanter:"You're a morbid hoarder. Why is everything a metaphor about death and compost? You view layoffs as natural cycles which is unsettling.",
    cmd:'Meren of Clan Nel Toth',
    cmdDesc:'Extracts sustainable value from death and decay cycles',
    str:['Long-term patient building','Resource efficiency','Comfortable with endings','Builds sustainable lasting practices','Resilient through cycles'],
    weak:['Morbid focus on death','Can be parasitic','Passive about injustice','Slow to act','Fatalistic'],
    roles:'Sustainability, Deathrite Shaman, Turnaround/Restructuring, Operations'
  },
  'SIMIC':{
    name:'SIMIC',
    tag:'Evolution Through Design',
    colors:['G','U'],
    desc:"You're someone who combines organic growth with optimization for directed evolution. You carefully improve natural systems.",
    pubBanter:"You're an overzealous lab geek. Can we ship something that's 80 percent instead of waiting for perfect? You optimize everything to death.",
    cmd:'Prime Speaker Vannifar',
    cmdDesc:'Evolves systems through careful optimization and adaptation',
    str:['Innovates sustainably over time','Improves things patiently and thoughtfully','Respects and works with existing systems','Develops capabilities for the long-term','Experiments thoughtfully not recklessly'],
    weak:['Paralyzes through over-analysis','Arrogance about knowledge','Playing god','Too slow when urgent','Constant internal conflict'],
    roles:'Product Management, Coiling Oracle, Process Improvement, Biotech, UX Research'
  },
  'BOROS':{
    name:'BOROS',
    tag:'Justice Through Action',
    colors:['R','W'],
    desc:"You're someone who combines passionate action with moral purpose for zealous execution. You fight passionately for just causes.",
    pubBanter:"You're an overzealous drill sergeant. Not everything is a crusade. You treat quarterly planning like D-Day. The intensity is exhausting.",
    cmd:'Aurelia, the Warleader',
    cmdDesc:'Executes passionately for just causes with relentless force',
    str:['Takes decisive mission-driven action','Builds high-performing intense teams','Confronts problems courageously','Commits passionately to goals','Excellent in actual crisis situations'],
    weak:['Violence as only solution','Zealotry','Poor at subtle navigation','Struggles with patience','With us or against us'],
    roles:'Military, Sunhome Enforcer, Crisis Management, Mission Nonprofits, Sales Leadership'
  },
  'BANT':{
    name:'BANT',
    tag:'Harmony Through Structure',
    colors:['W','U','G'],
    desc:"You're someone who combines order, analysis, and natural growth for harmonious civilization. Patient coordinated excellence.",
    pubBanter:"They become the sanctimonious project manager who wraps micromanagement in a smiley for the good of the team blanket, relentlessly organizing, scheduling team yoga sessions, and smothering any creative spark under so many best practices and polite check-ins that you long for one un-scheduled hour to actually get work done.",
    cmd:'Rafiq of the Many',
    cmdDesc:'Coordinates patient strategic excellence through harmony',
    str:['Exceptional balanced leadership','Patient sustainable development','Strategic and people-focused','Psychologically safe environments','Combines three colors'],
    weak:['Excessively slow','Naive about conflict','Cannot make tough calls','Too process-heavy','Lacks urgency'],
    roles:'Executive Leadership, Empyrial Archangel, Strategic HR, Educational Leadership'
  },
  'ESPER':{
    name:'ESPER',
    tag:'Perfection Through Control',
    colors:['W','U','B'],
    desc:"You're someone who combines order, analysis, and ruthless power for cold calculated dominance. Excellence without emotion or nature.",
    pubBanter:"You're a high-handed micromanager. Do you feel anything? You optimize everything including human relationships. Spreadsheets have feelings people don't.",
    cmd:'Oloro, Ageless Ascetic',
    cmdDesc:'Dominates through emotionless calculated perfection',
    str:['Superior systematic and strategic thinking','Ruthlessly effective at execution','Exercises comprehensive control','Positions strategically with patience','Achieves excellence in governance'],
    weak:['Emotionally sterile and cold','Optimizes amorally without conscience','Slow to act','Actively destroys innovation and creativity','Treats people like replaceable components'],
    roles:'CFO/Finance, Ethersworn Adjudicator, Chief Compliance, Strategic Operations'
  },
  'GRIXIS':{
    name:'GRIXIS',
    tag:'Power Through Ruthless Action',
    colors:['U','B','R'],
    desc:"You're someone who combines intelligence, ruthlessness, and decisive action for amoral competence. Smart and ruthless.",
    pubBanter:"You're a cackling instigator. Are you the villain? You create crises to solve them dramatically. The laugh doesn't help.",
    cmd:'Nekusar, the Mindrazer',
    cmdDesc:'Combines intelligence with ruthless decisive action',
    str:['Decisive strategic action','Comfortable with difficult decisions','Masters political maneuvering','Rapid learning','High-performance culture'],
    weak:['Cruel and actively destructive','Makes trust completely impossible','Burns out team members','Creates genuine ethical disasters','Creates unstable competitive culture'],
    roles:'Turnaround CEO, Sedris the Traitor King, Competitive Strategy, High-Stakes Trading'
  },
  'JUND':{
    name:'JUND',
    tag:'Survival Through Hunger',
    colors:['B','R','G'],
    desc:"You're someone who combines predation, passion, and natural selection for brutal survival. The food chain incarnate.",
    pubBanter:"You're an office predator. Is everything a competition? You turn meetings into cage matches and dominate every conversation.",
    cmd:'Prossh, Skyraider of Kher',
    cmdDesc:'Survives through predatory instinct and brutal competition',
    str:['Has aggressive competitive drive','Solves problems directly and forcefully','Drives high performance through competition','Brutally honest about power dynamics','Has strong survivor mentality'],
    weak:['Brutal and actively exploitative','Creates zero sustainability','Practices actual social Darwinism','Completely lacks sophistication','Creates genuinely toxic competitive culture'],
    roles:'Aggressive Sales, Karrthus Tyrant of Jund, Competitive Industries, Startups, Sports, PE'
  },
  'NAYA':{
    name:'NAYA',
    tag:'Power Through Community',
    colors:['R','G','W'],
    desc:"You're someone who combines passion, strength, and community for exuberant collective power. Big hearts, big ideas.",
    pubBanter:"You're an overenthusiastic steamroller. Why does every task need to be an EPIC ADVENTURE? We just needed to update a spreadsheet.",
    cmd:'Samut, Voice of Dissent',
    cmdDesc:'Builds exuberant collective power through passionate community',
    str:['Provides inspiring genuine leadership','Creates high-energy enthusiastic teams','Builds strong vibrant communities','Launches bold ambitious initiatives','Engages with authentic real passion'],
    weak:['Exhausting enthusiasm','Lacks subtlety','Can be naive','Overwhelming','Ignores details'],
    roles:'Startups, Marketing, Atla Palani Nest Tender, Sales, Event Planning, Community Building'
  },
  'ABZAN':{
    name:'ABZAN',
    tag:'Endurance Through Tradition',
    colors:['W','B','G'],
    desc:"You're someone who combines community, pragmatism, and patience for lasting institutions. Traditional power that endures.",
    pubBanter:"You're an immovable curmudgeon. You block every new idea with We've always done it this way. Also you definitely keep a ledger of favors.",
    cmd:'Anafenza, the Foremost',
    cmdDesc:'Endures through traditional power structures and pragmatic loyalty',
    str:['Builds long-term lasting institutions','Politically resilient and savvy','Practices sustainable pragmatism','Creates loyal deep relationships','Has strong survivor mentality'],
    weak:['Resists necessary changes','Can be actively exploitative','Dangerously slow to innovate anything','Holds grudges forever','Creates Byzantine political games'],
    roles:'Family Businesses, Ghave Guru of Spores, Legal, Traditional Industries, Politics'
  },
  'JESKAI':{
    name:'JESKAI',
    tag:'Excellence Through Discipline',
    colors:['U','R','W'],
    desc:"You're someone who combines knowledge, passion, and order for disciplined excellence. Mastery through practice.",
    pubBanter:"You're a pretentious prodigy. Everything we do is basic apparently. You roll your eyes at our approach constantly. Very smug.",
    cmd:'Narset, Enlightened Master',
    cmdDesc:'Achieves disciplined excellence through practiced mastery',
    str:['Achieves balanced multi-faceted excellence','Masters technical details completely','Thinks strategically','Inspires others through personal example','Executes adaptively and flexibly'],
    weak:['Arrogant about their skill level','Dismissive of basics and fundamentals','Can be genuinely elitist','Perfectionist to an unhealthy degree','Impatient and dismissive with novices'],
    roles:'Consulting, Narset Enlightened Master, Teaching, Professional Services, Strategy'
  },
  'SULTAI':{
    name:'SULTAI',
    tag:'Growth Through Exploitation',
    colors:['B','G','U'],
    desc:"You're someone who combines ruthlessness, patience, and intelligence for patient empire-building. You cultivate power.",
    pubBanter:"You're a slimy empire-builder. You co-opt everyone's work as fertilizer for your success. Very friendly about it though. Very slimy.",
    cmd:'Sidisi, Brood Tyrant',
    cmdDesc:'Cultivates empire through patient intelligent exploitation',
    str:['Builds strategic empires methodically','Positions patiently for advantage','Masters resource extraction and use','Navigates politics expertly','Thinks long-term instinctively'],
    weak:['Has parasitic exploitative tendencies','Makes trust completely impossible','Morally dubious at best','Slow to act','Alienates people'],
    roles:'Private Equity, VC, Leovold Emissary of Trest, Corporate Development, Real Estate'
  },
  'MARDU':{
    name:'MARDU',
    tag:'Victory Through Sacrifice',
    colors:['R','W','B'],
    desc:"You're someone who combines passion, order, and ruthlessness for relentless execution. Glory through any means.",
    pubBanter:"You're a tyrannical taskmaster. Every deadline is life or death. You glorify burnout and will flip tables to make us move faster.",
    cmd:'Queen Marchesa',
    cmdDesc:'Achieves victory through passionate sacrifice and ruthless will',
    str:['Executes decisions decisively','Performs well under high pressure','Masters political warfare','Gets results at any cost','Inspires people under fire'],
    weak:['Burns out team members','Glorifies unhealthy sacrifice','Believes ends justify means','Exhausting to work with','Leaves casualties behind'],
    roles:'Turnarounds, Queen Marchesa, Crisis Management, Sales, Competitive Markets'
  },
  'TEMUR':{
    name:'TEMUR',
    tag:'Power Through Adaptation',
    colors:['G','U','R'],
    desc:"You're someone who combines strength, intelligence, and passion for adaptive innovation. Wild creativity.",
    pubBanter:"You're an erratic adrenaline junkie. The pivot whiplash is real. We're just constantly adapting to whatever idea pounced out this week.",
    cmd:'Surrak Dragonclaw',
    cmdDesc:"Cannot be countered, creatures cannot be countered, flash‚Äîunstoppable force",
    str:['Innovates adaptively in any situation','Solves problems creatively','Brings consistently high energy','Thrives in genuinely chaotic environments','Experiments boldly and fearlessly'],
    weak:['Executes chaotically and unpredictably','Creates exhausting constant pivots','Terrible at planning ahead','Completely unpredictable and unstable','Genuinely hard to work with'],
    roles:'Startups, Surrak Dragonclaw, Innovation, R&D, Creative Industries'
  },
  'WITCH':{
    name:'FOUR-COLOR (No Red)',
    tag:'Perfection Without Passion',
    colors:['W','U','B','G'],
    desc:"You're someone who combines order, knowledge, ambition, and growth without passion. Patient calculated excellence.",
    pubBanter:"You're an emotionless overlord running things like a spreadsheet simulation. You dismiss any passionate idea as inefficient. Joyless.",
    cmd:"Atraxa, Praetors' Voice",
    cmdDesc:'Pursues perfection through emotionless calculated patience',
    str:['Thinks comprehensively and strategically','Executes with genuine patience','Achieves systematic excellence','Grows things sustainably over time','Masters political maneuvering'],
    weak:['Emotionally sterile and cold','Lacks urgency','Joyless','Dismisses passion','Slow to act'],
    roles:'Operations, Atraxa Praetors Voice, Finance, Strategy, Long-term Planning'
  },
  'YORE':{
    name:'FOUR-COLOR (No Green)',
    tag:'Innovation Without Nature',
    colors:['W','U','B','R'],
    desc:"You're someone who combines order, knowledge, ambition, and passion without patience. Artificial perfection.",
    pubBanter:"You're an over-engineering fanatic. Simple solution? Nope. Needs seventeen moving parts that will require emergency fixes in two weeks.",
    cmd:'Breya, Etherium Shaper',
    cmdDesc:'Innovates through artificial systems and passionate disruption',
    str:['Achieves genuine breakthrough innovation','Builds and manages complex systems','Thinks strategically','Executes with genuine passion','Optimizes through artificial systems'],
    weak:['Over-engineers literally everything','Reflexively rejects simple solutions','Maintains completely unsustainable pace','Completely lacks patience for anything','Adds complexity purely for its own sake'],
    roles:'Tech Startups, Breya Etherium Shaper, Engineering, R&D, Disruption'
  },
  'GLINT':{
    name:'FOUR-COLOR (No White)',
    tag:'Power Without Morality',
    colors:['U','B','R','G'],
    desc:"You're someone who combines knowledge, ambition, passion, and growth without morality. Amoral excellence.",
    pubBanter:"You're an unmanageable rebel. Rules are for suckers apparently. You hijack projects for fun and leave smoking wreckage everywhere.",
    cmd:'Yidris, Maelstrom Wielder',
    cmdDesc:'Pursues power without moral constraint or accountability',
    str:['Innovates without any constraints','Executes rapidly and decisively','Adapts naturally to changing conditions','Politically savvy and strategic','Has absolutely no sacred cows'],
    weak:['Completely amoral in practice','Completely unreliable and unaccountable','Creates chaos everywhere','Alienates entire teams systematically','Has zero accountability to anyone'],
    roles:'Disruption, Yidris Maelstrom Wielder, Competitive Industries, High-Risk Ventures'
  },
  'DUNE':{
    name:'FOUR-COLOR (No Blue)',
    tag:'Action Without Analysis',
    colors:['W','B','R','G'],
    desc:"You're someone who combines order, ambition, passion, and growth without analysis. Instinctive execution.",
    pubBanter:"You're a bullheaded action hero. Planning? Never. Already yelling NO TIME NEXT while we're picking up pieces from the last impulse decision.",
    cmd:'Saskia the Unyielding',
    cmdDesc:'Executes through gut instinct without analysis or hesitation',
    str:['Takes decisive action','Instinctive execution','Brings consistently high energy','Builds strong vibrant communities','No overthinking'],
    weak:['Anti-intellectual by default','Terrible at planning ahead','Reckless in every execution','Completely dismisses all analysis','Leaves wreckage everywhere they go'],
    roles:'Sales, Saskia the Unyielding, Operations, Crisis Response, Military'
  },
  'INK':{
    name:'FOUR-COLOR (No Black)',
    tag:'Altruism Without Pragmatism',
    colors:['W','U','R','G'],
    desc:"You're someone who combines order, knowledge, passion, and growth without self-interest. Pure altruism.",
    pubBanter:"You're a chaotic do-gooder. Trying to help everyone at once. It's a circus. Unintended confetti explosions. So chaotic.",
    cmd:'Kynaios and Tiro of Meletis',
    cmdDesc:'Pursues altruism without pragmatism or self-interest',
    str:['Inspiring idealism','Thinks strategically','Brings energizing disruptive presence','Community focus','Solves problems creatively'],
    weak:['Dangerously naive about self-interest','Can be easily exploited','Executes chaotically and unpredictably','Too trusting of literally everyone','Completely lacks competitive edge'],
    roles:'Nonprofits, Kynaios and Tiro of Meletis, Education, Community Building, Social Enterprise'
  },
  'WUBRG':{
    name:'FIVE-COLOR',
    tag:'Chaos or Mastery',
    colors:['W','U','B','R','G'],
    desc:"You're someone who has access to everything‚Äîall strategies, all tools, all philosophies. Renaissance person or unfocused generalist.",
    pubBanter:"You're an overambitious jack-of-all-trades. Kitchen sink into every project. Taking bets on which spinning plate crashes first.",
    cmd:'Kenrith, the Returned King',
    cmdDesc:'Accesses every strategy and tool, either mastery or scattered chaos',
    str:['Has ultimate versatility and flexibility','Thinks adaptively about everything','Has comprehensive broad perspective','Works effectively with anyone','Has genuinely no blind spots'],
    weak:['Lacks focus completely','Master of absolutely none','Highly context-dependent in identity','Hard to pin down identity','May be genuinely scattered'],
    roles:'Consulting, General Tazri, Generalist Leadership, Facilitation, Portfolio Management'
  }
};

// ============================================================================
// ============================================================================
// ENHANCEMENT: Morphing Progress Bar
// ============================================================================
function updateProgressGradient() {
  if (state.stage !== 1 || state.qNum === 0) return 'linear-gradient(90deg, #FDE047 0% 20%, #93C5FD 20% 40%, #D1D5DB 40% 60%, #FCA5A5 60% 80%, #6EE7B7 80% 100%)';
  
  // Calculate current activation using pairwise scores
  const activation = {
    W: ((state.pairwise['W-B']?.W || 0) / 6 + (state.pairwise['W-R']?.W || 0) / 6) / 2,
    U: ((state.pairwise['U-R']?.U || 0) / 6 + (state.pairwise['G-U']?.U || 0) / 6) / 2,
    B: ((state.pairwise['W-B']?.B || 0) / 6 + (state.pairwise['B-G']?.B || 0) / 6) / 2,
    R: ((state.pairwise['U-R']?.R || 0) / 6 + (state.pairwise['W-R']?.R || 0) / 6) / 2,
    G: ((state.pairwise['G-U']?.G || 0) / 6 + (state.pairwise['B-G']?.G || 0) / 6) / 2
  };
  
  // Normalize to percentages
  const total = Object.values(activation).reduce((sum, val) => sum + val, 0);
  if (total === 0) return 'linear-gradient(90deg, #FDE047 0% 20%, #93C5FD 20% 40%, #D1D5DB 40% 60%, #FCA5A5 60% 80%, #6EE7B7 80% 100%)';
  
  const pcts = {
    W: (activation.W / total) * 100,
    U: (activation.U / total) * 100,
    B: (activation.B / total) * 100,
    R: (activation.R / total) * 100,
    G: (activation.G / total) * 100
  };
  
  // Create gradient based on percentages (W=yellow, U=blue, B=gray, R=red, G=green)
  const colors = [
    { color: '#FDE047', pct: pcts.W },  // Yellow for White
    { color: '#93C5FD', pct: pcts.U },  // Blue for Blue
    { color: '#D1D5DB', pct: pcts.B },  // Gray for Black
    { color: '#FCA5A5', pct: pcts.R },  // Red for Red
    { color: '#6EE7B7', pct: pcts.G }   // Green for Green
  ];
  
  // Build gradient stops
  let position = 0;
  const stops = [];
  colors.forEach((c, i) => {
    stops.push(`${c.color} ${position.toFixed(1)}%`);
    position += c.pct;
    stops.push(`${c.color} ${position.toFixed(1)}%`);
  });
  
  return `linear-gradient(90deg, ${stops.join(', ')})`;
}

// STATE & INITIALIZATION
// ============================================================================
let state = {
  stage: 1,
  qNum: 0,
  qTot: 30,
  mode: 'draft', // 'constructed' or 'draft'
  responses: [],
  colorScores: {W:0, U:0, B:0, R:0, G:0},
  pairwise: {
    'W-B': {W:0, B:0},
    'U-R': {U:0, R:0},
    'G-U': {G:0, U:0},
    'W-R': {W:0, R:0},
    'B-G': {B:0, G:0}
  },
  poolA: [],
  poolS2: [],
  s2Track: {appear: {}, select: {}},
  activationSorted: [],
  result: null,
  candidates: null,
  originalResult: null
};

function shuffleArray(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function initArchetypeOfMonth() {
  const container = document.getElementById('archetype-of-month');
  
  const archetype = ARCHETYPE_EXAMPLES[Math.floor(Math.random() * ARCHETYPE_EXAMPLES.length)];
  
  const name1 = getRandomName();
  let name2 = getRandomName();
  while (name2 === name1) {
    name2 = getRandomName();
  }
  
  let symbolsHTML = '<div style="display: flex; justify-content: center; gap: 8px; margin: 20px 0;">';
  archetype.colors.forEach(c => {
    symbolsHTML += `<span class="mana-symbol mana-${c}" style="width: 48px; height: 48px; font-size: 24px;">${c}</span>`;
  });
  symbolsHTML += '</div>';
  
  // Randomize which quote appears on left vs right
  const normalFirst = Math.random() < 0.5;
  
  const normalQuote = `
    <div style="background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 10px; text-align: left;">
      <p style="font-size: 15px; line-height: 1.7; color: #d0d0d0; font-style: italic;">
        "${archetype.normal}"
      </p>
      <div style="text-align: right; margin-top: 8px; font-size: 13px; color: #a0a0b0;">‚Äî ${name1}</div>
    </div>
  `;
  
  const banterQuote = `
    <div style="background: rgba(245, 158, 11, 0.08); padding: 20px; border-radius: 10px; text-align: left;">
      <p style="font-size: 15px; line-height: 1.7; color: #d0a070; font-style: italic;">
        "${archetype.banter}"
      </p>
      <div style="text-align: right; margin-top: 8px; font-size: 13px; color: #d0a070;">‚Äî ${name2}</div>
    </div>
  `;
  
  container.innerHTML = `
    <div style="text-align: center; margin-bottom: 16px;">
      <div style="font-size: 14px; font-weight: 700; color: #a78bfa; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 16px;">üèÜ Employee of the Month üèÜ</div>
      <h3 style="font-size: 32px; font-weight: 800; margin-bottom: 12px; color: #e0e0e0;">${archetype.name}</h3>
      ${symbolsHTML}
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
      ${normalFirst ? normalQuote + banterQuote : banterQuote + normalQuote}
    </div>
  `;
}

// Initialize on load
window.addEventListener('DOMContentLoaded', function() {
  console.log('DOMContentLoaded fired');
  try {
    initArchetypeOfMonth();
    console.log('initArchetypeOfMonth completed successfully');
  } catch(e) {
    console.error('Error in initArchetypeOfMonth:', e);
    // Continue anyway so rest of page works
  }
});

console.log('Script file loaded successfully');

// ============================================================================
// MODE SELECTION
// ============================================================================
function selectMode(mode) {
  state.mode = mode;
  
  // Update visual selection
  const constructedCard = document.getElementById('mode-constructed');
  const draftCard = document.getElementById('mode-draft');
  const constructedCheck = document.getElementById('constructed-check');
  const draftCheck = document.getElementById('draft-check');
  
  if (mode === 'constructed') {
    constructedCard.style.border = '2px solid rgba(139, 92, 246, 0.8)';
    constructedCard.style.background = 'rgba(139, 92, 246, 0.15)';
    draftCard.style.border = '2px solid rgba(139, 92, 246, 0.3)';
    draftCard.style.background = 'rgba(255,255,255,0.05)';
    constructedCheck.style.display = 'flex';
    draftCheck.style.display = 'none';
  } else {
    draftCard.style.border = '2px solid rgba(139, 92, 246, 0.8)';
    draftCard.style.background = 'rgba(139, 92, 246, 0.15)';
    constructedCard.style.border = '2px solid rgba(139, 92, 246, 0.3)';
    constructedCard.style.background = 'rgba(255,255,255,0.05)';
    draftCheck.style.display = 'flex';
    constructedCheck.style.display = 'none';
  }
}

function startAssessment() {
  console.log('startAssessment called');
  console.log('POOL_A length:', POOL_A.length);
  state.poolA = shuffleArray(POOL_A);
  console.log('state.poolA shuffled, length:', state.poolA.length);
  document.getElementById('screen-welcome').classList.add('hidden');
  document.getElementById('screen-assessment').classList.remove('hidden');
  console.log('Screens toggled, calling showQ');
  showQ();
}

let debug = false;
function toggleDebug() {
  debug = !debug;
  const debugSection = document.getElementById('debug-section');
  if (debug) {
    debugSection.style.display = 'block';
    updateDebug();
  } else {
    debugSection.style.display = 'none';
  }
}

function updateDebug() {
  const debugSection = document.getElementById('debug-section');
  const debugContent = document.getElementById('debug-content');
  
  if (!debug) return;
  if (debugSection.style.display === 'none') return;
  
  let html = '';
  
  if (state.stage === 1) {
    html += '<div style="margin-bottom: 16px;"><strong style="color: #a78bfa;">STAGE 1: COLOR ACTIVATION</strong></div>';
    html += `<div style="margin-bottom: 12px; padding: 12px; background: rgba(139, 92, 246, 0.1); border-radius: 8px;">`;
    html += `<strong>Questions:</strong> ${state.qNum}/30<br>`;
    html += `<strong>Goal:</strong> Detect which colors activate most strongly`;
    html += `</div>`;
    
    // Color Scores with visual bars
    html += '<div style="margin-top: 12px;"><strong>Color Scores (out of 12):</strong></div>';
    const colorScoresSorted = Object.entries(state.colorScores).sort((a,b) => b[1] - a[1]);
    colorScoresSorted.forEach(([c, s]) => {
      const pct = Math.round(s/12*100);
      const barColor = {W:'#FDE047', U:'#93C5FD', B:'#D1D5DB', R:'#FCA5A5', G:'#6EE7B7'}[c];
      html += `<div style="margin: 8px 0;">`;
      html += `<div style="display: flex; justify-content: space-between; margin-bottom: 4px;">`;
      html += `<span><strong>${c}</strong>: ${s}/12</span>`;
      html += `<span style="color: ${barColor};">${pct}%</span>`;
      html += `</div>`;
      html += `<div style="background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px;">`;
      html += `<div style="background: ${barColor}; width: ${pct}%; height: 100%; border-radius: 4px;"></div>`;
      html += `</div>`;
      html += `</div>`;
    });
    
    // Pairwise battles
    html += '<div style="margin-top: 16px;"><strong>Enemy Pair Battles:</strong></div>';
    html += '<div style="font-size: 12px; color: #a0a0b0; margin-bottom: 8px;">Testing which color wins in direct conflict</div>';
    Object.entries(state.pairwise).forEach(([pair, scores]) => {
      const [c1, c2] = pair.split('-');
      const c1Score = scores[c1];
      const c2Score = scores[c2];
      const c1Pct = Math.round((c1Score/6)*100);
      const c2Pct = Math.round((c2Score/6)*100);
      const winner = c1Score > c2Score ? c1 : c2Score > c1Score ? c2 : 'TIE';
      const winnerColor = winner === c1 ? '#10B981' : winner === c2 ? '#EF4444' : '#808090';
      html += `<div style="margin: 6px 0; padding: 8px; background: rgba(255,255,255,0.03); border-radius: 6px;">`;
      html += `<div style="font-weight: 600; color: ${winnerColor};">${pair}: ${c1}(${c1Score}) vs ${c2}(${c2Score}) ‚Üí ${winner}</div>`;
      html += `</div>`;
    });
    
    if (state.qNum >= 12) {
      html += '<div style="margin-top: 16px; padding: 12px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px;">';
      html += '<strong style="color: #10B981;">üéØ ACTIVATION STRENGTH (Predicted Colors):</strong><br>';
      html += '<div style="font-size: 12px; color: #a0a0b0; margin: 8px 0;">Combined from enemy pair wins</div>';
      const act = {
        W: (state.pairwise['W-B'].W / 6 + state.pairwise['W-R'].W / 6) / 2,
        U: (state.pairwise['U-R'].U / 6 + state.pairwise['G-U'].U / 6) / 2,
        B: (state.pairwise['W-B'].B / 6 + state.pairwise['B-G'].B / 6) / 2,
        R: (state.pairwise['U-R'].R / 6 + state.pairwise['W-R'].R / 6) / 2,
        G: (state.pairwise['G-U'].G / 6 + state.pairwise['B-G'].G / 6) / 2
      };
      const actSorted = Object.entries(act).sort((a,b) => b[1] - a[1]);
      
      // Show prediction
      const top = actSorted.slice(0, 3);
      const gaps = [];
      for (let i = 0; i < actSorted.length - 1; i++) {
        gaps.push({idx: i, gap: actSorted[i][1] - actSorted[i+1][1]});
      }
      gaps.sort((a,b) => b.gap - a.gap);
      const biggestGap = gaps[0];
      
      let prediction = '';
      if (biggestGap.gap > 0.25) {
        const numTop = biggestGap.idx + 1;
        const topColors = actSorted.slice(0, numTop).map(c => c[0]).join('');
        if (numTop === 1) prediction = `Predicting: MONO-${topColors}`;
        else if (numTop === 2) prediction = `Predicting: 2-color guild with ${topColors}`;
        else if (numTop === 3) prediction = `Predicting: 3-color with ${topColors}`;
        else if (numTop === 4) prediction = `Predicting: 4-color (missing ${actSorted[4][0]})`;
        else prediction = `Predicting: 5-color (all balanced)`;
      } else {
        prediction = `Close scores - need more questions`;
      }
      
      html += `<div style="font-weight: 700; color: #10B981; margin-bottom: 8px;">${prediction}</div>`;
      
      actSorted.forEach(([c, a], idx) => {
        const pct = Math.round(a*100);
        const isTop = idx <= biggestGap.idx;
        const color = isTop ? '#10B981' : '#808090';
        html += `<div style="color: ${color}; margin: 4px 0;">${idx + 1}. ${c}: ${pct}% activated</div>`;
      });
      html += '</div>';
    }
  }
  
  if (state.stage === 2) {
    html += '<div style="margin-bottom: 16px;"><strong style="color: #a78bfa;">STAGE 2: PATTERN DETERMINATION</strong></div>';
    html += `<div style="margin-bottom: 12px; padding: 12px; background: rgba(139, 92, 246, 0.1); border-radius: 8px;">`;
    html += `<strong>Questions:</strong> ${state.qNum}/${state.qTot}<br>`;
    html += `<strong>Goal:</strong> Determine how many colors are genuinely active`;
    html += `</div>`;
    
    if (state.stage2Trigger) {
      html += '<div style="margin-top: 12px; padding: 12px; background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 8px;">';
      html += '<strong style="color: #F59E0B;">‚ö†Ô∏è Why Stage 2 Needed:</strong><br>';
      html += `<div style="color: #c0c0d0; font-style: italic; margin-top: 8px;">${state.stage2Trigger.reason}</div>`;
      html += '</div>';
    }
    
    if (state.candidates) {
      html += '<div style="margin-top: 12px;"><strong>Testing These Candidates:</strong></div>';
      html += '<div style="font-size: 12px; color: #a0a0b0; margin-bottom: 8px;">Determining which colors are truly active</div>';
      state.candidates.forEach((cand, idx) => {
        const colors = PROFILES[cand.id]?.colors || [];
        const colorSymbols = colors.map(c => `<span style="color: ${{W:'#FDE047',U:'#93C5FD',B:'#D1D5DB',R:'#FCA5A5',G:'#6EE7B7'}[c]};font-weight:700;">${c}</span>`).join('');
        html += `<div style="margin: 6px 0; padding: 8px; background: rgba(139, 92, 246, ${idx === 0 ? 0.15 : 0.05}); border-radius: 6px;">`;
        html += `<strong>${idx + 1}. ${cand.id}</strong> [${colorSymbols}] (Round 1: ${Math.round(cand.s1*100)}%)`;
        html += `</div>`;
      });
    }
    
    // Show pattern preferences from Pool D
    if (state.s2Track.patternPref && Object.values(state.s2Track.patternPref).some(v => v > 0)) {
      html += '<div style="margin-top: 16px; padding: 12px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px;">';
      html += '<strong style="color: #10B981;">üìä Pattern Preference (Pool D):</strong><br>';
      html += '<div style="font-size: 12px; color: #a0a0b0; margin: 8px 0;">Which complexity level you gravitate to</div>';
      
      const total = (state.s2Track.patternPref.MONO || 0) + 
                    (state.s2Track.patternPref.GUILD || 0) + 
                    (state.s2Track.patternPref.THREE || 0);
      
      if (total > 0) {
        ['MONO', 'GUILD', 'THREE'].forEach(pattern => {
          const count = state.s2Track.patternPref[pattern] || 0;
          const pct = Math.round((count / total) * 100);
          const color = pct > 50 ? '#10B981' : '#808090';
          html += `<div style="color: ${color}; margin: 4px 0;">${pattern}: ${count}/${total} (${pct}%)</div>`;
        });
      }
      html += '</div>';
    }
    
    // Show color frequency in selections
    if (state.s2Track.colorFreq && Object.values(state.s2Track.colorFreq).some(v => v > 0)) {
      html += '<div style="margin-top: 16px;"><strong style="color: #a78bfa;">üé® Color Frequency in Your Selections:</strong></div>';
      html += '<div style="font-size: 12px; color: #a0a0b0; margin-bottom: 8px;">Which colors appear most in what you chose</div>';
      
      const sortedFreq = Object.entries(state.s2Track.colorFreq)
        .sort((a,b) => b[1] - a[1])
        .filter(([c, v]) => v > 0);
      
      sortedFreq.forEach(([color, freq]) => {
        const rate = state.qNum > 0 ? Math.round((freq / state.qNum) * 100) : 0;
        const barColor = {W:'#FDE047', U:'#93C5FD', B:'#D1D5DB', R:'#FCA5A5', G:'#6EE7B7'}[color];
        const isActive = rate >= 70;
        
        html += `<div style="margin: 8px 0;">`;
        html += `<div style="display: flex; justify-content: space-between; margin-bottom: 4px;">`;
        html += `<span><strong style="color: ${barColor};">${color}</strong>: ${freq}/${state.qNum} selections</span>`;
        html += `<span style="color: ${isActive ? '#10B981' : '#808090'}; font-weight: 600;">${rate}%${isActive ? ' ‚úì ACTIVE' : ''}</span>`;
        html += `</div>`;
        html += `<div style="background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px;">`;
        html += `<div style="background: ${barColor}; width: ${rate}%; height: 100%; border-radius: 4px;"></div>`;
        html += `</div>`;
        html += `</div>`;
      });
      
      // Show threshold line
      html += '<div style="margin-top: 8px; font-size: 12px; color: #10B981; font-style: italic;">Colors appearing in >70% of selections = ACTIVE</div>';
    }
    
    html += '<div style="margin-top: 16px;"><strong>Identity Selections:</strong></div>';
    html += '<div style="font-size: 12px; color: #a0a0b0; margin-bottom: 8px;">Which specific identities you chose</div>';
    const s2Sorted = Object.entries(state.s2Track.select).sort((a,b) => {
      const rateA = (state.s2Track.appear[a[0]] || 0) > 0 ? a[1] / state.s2Track.appear[a[0]] : 0;
      const rateB = (state.s2Track.appear[b[0]] || 0) > 0 ? b[1] / state.s2Track.appear[b[0]] : 0;
      return rateB - rateA;
    });
    
    if (s2Sorted.length > 0) {
      s2Sorted.forEach(([guild, count]) => {
        const appeared = state.s2Track.appear[guild] || 0;
        const rate = appeared > 0 ? Math.round((count/appeared)*100) : 0;
        const colors = PROFILES[guild]?.colors || [];
        const colorSymbols = colors.map(c => `<span style="color: ${{W:'#FDE047',U:'#93C5FD',B:'#D1D5DB',R:'#FCA5A5',G:'#6EE7B7'}[c]};font-weight:700;">${c}</span>`).join('');
        html += `<div style="margin: 6px 0; padding: 8px; background: rgba(255,255,255,0.03); border-radius: 6px;">`;
        html += `<div style="display: flex; justify-content: space-between;">`;
        html += `<span><strong>${guild}</strong> [${colorSymbols}]</span>`;
        html += `<span style="color: ${rate > 50 ? '#10B981' : '#808090'}; font-weight: 600;">${count}/${appeared} (${rate}%)</span>`;
        html += `</div>`;
        html += `</div>`;
      });
    } else {
      html += '<div style="color: #808090; font-style: italic;">No identity selections yet</div>';
    }
  }
  
  debugContent.innerHTML = html;
}

function showQ() {
  console.log('showQ called, stage:', state.stage, 'qNum:', state.qNum);
  const q = state.stage === 1 ? state.poolA[state.qNum] : state.poolS2[state.qNum];
  console.log('Question:', q);
  
  if (!q) {
    console.error('No question available at index', state.qNum);
    alert('Error: No question found. Check console.');
    return;
  }
  
  document.getElementById('q-num').textContent = state.qNum + 1;
  document.getElementById('q-tot').textContent = state.qTot;
  
  if (state.stage === 1) {
    document.getElementById('stage-label').textContent = 'Stage 1';
    const pct = Math.round((state.qNum / 30) * 100);
    const progBar = document.getElementById('prog-s1');
    const prog2Bar = document.getElementById('prog-s2');
    
    progBar.style.width = pct + '%';
    progBar.style.opacity = '1';
    prog2Bar.style.width = '0%';
    prog2Bar.style.opacity = '0';
    
    // ENHANCEMENT: Apply morphing gradient and shimmer effect
    if (state.qNum > 0) {
      progBar.style.background = updateProgressGradient();
      if (!progBar.classList.contains('progress-shimmer')) {
        progBar.classList.add('progress-shimmer', 'progress-opalescent');
      }
    }
  } else {
    document.getElementById('stage-label').textContent = 'Stage 2';
    const prog1Bar = document.getElementById('prog-s1');
    const prog2Bar = document.getElementById('prog-s2');
    
    // Fade out Stage 1 bar, fade in Stage 2 bar
    prog1Bar.style.opacity = '0';
    prog2Bar.style.opacity = '1';
    prog2Bar.style.width = '0%';
    
    const pct = Math.round((state.qNum / state.qTot) * 100);
    setTimeout(() => {
      prog2Bar.style.width = pct + '%';
    }, 50);
  }
  
  document.getElementById('ctx').textContent = q.ctx || 'Context';
  
  // Build scenario with mana symbols for Stage 1 (only in constructed mode)
  const scenarioText = q.sc || q.scenario || 'Scenario';
  if (state.stage === 1 && q.pair && state.mode === 'constructed') {
    const pair = q.pair;
    const colors = pair.split('-');
    let symbolsHTML = '<div style="display: flex; gap: 8px; justify-content: center; margin: 16px 0;">';
    colors.forEach(c => {
      symbolsHTML += `<span class="mana-symbol mana-${c}" style="width: 32px; height: 32px; font-size: 16px;">${c}</span>`;
    });
    symbolsHTML += '</div>';
    document.getElementById('scenario').innerHTML = scenarioText + symbolsHTML;
  } else {
    document.getElementById('scenario').textContent = scenarioText;
  }
  
  document.getElementById('instr').innerHTML = 'Choose the response <strong>more like you</strong>.';

  // Track Stage 2 appearances (both guilds and Pool D patterns)
  if (state.stage === 2 && state.s2Track && q.r) {
    q.r.forEach(resp => {
      const guild = resp.g || resp.guild;
      if (guild) {
        state.s2Track.appear[guild] = (state.s2Track.appear[guild] || 0) + 1;
      }
      
      // Track pattern appearances for Pool D scenarios
      const pattern = resp.pattern;
      if (pattern) {
        if (!state.s2Track.patternAppear) {
          state.s2Track.patternAppear = {MONO: 0, GUILD: 0, THREE: 0};
        }
        state.s2Track.patternAppear[pattern]++;
      }
    });
  }
  
  const choicesDiv = document.getElementById('choices');
  choicesDiv.innerHTML = '';
  
  const shuffled = shuffleArray(q.r);
  shuffled.forEach(resp => {
    const btn = document.createElement('button');
    btn.className = 'choice-button';
    
    // Get color(s) for this response
    let symbolColors = [];
    if (state.stage === 1 && resp.c) {
      // Stage 1: Single color
      symbolColors = [resp.c];
    } else if (state.stage === 2 && resp.g) {
      // Stage 2: Use universal function to get colors (handles guild, three-color, four-color)
      symbolColors = getIdentityColors(resp.g);
    }
    
    // Add mana symbols and identity name (only in constructed mode)
    if (state.mode === 'constructed' && symbolColors.length > 0) {
      // Create a wrapper for symbols and name
      const symbolWrapper = document.createElement('div');
      symbolWrapper.style.cssText = 'display: flex; flex-direction: column; align-items: center; gap: 4px; margin-right: 12px;';
      
      // Symbols row
      const symbolRow = document.createElement('div');
      symbolRow.style.cssText = 'display: flex; gap: 4px;';
      symbolColors.forEach(color => {
        const symbolSpan = document.createElement('span');
        symbolSpan.className = `mana-symbol mana-${color}`;
        symbolSpan.style.cssText = 'width: 24px; height: 24px; font-size: 12px; flex-shrink: 0;';
        symbolSpan.textContent = color;
        symbolRow.appendChild(symbolSpan);
      });
      
      // Identity name label (only if guild/three/four/five)
      if (state.stage === 2 && resp.g) {
        const nameLabel = document.createElement('div');
        nameLabel.style.cssText = 'font-size: 10px; font-weight: 700; color: #a78bfa; text-transform: uppercase; letter-spacing: 0.5px;';
        nameLabel.textContent = resp.g;
        symbolWrapper.appendChild(symbolRow);
        symbolWrapper.appendChild(nameLabel);
      } else {
        symbolWrapper.appendChild(symbolRow);
      }
      
      btn.appendChild(symbolWrapper);
    }
    
    const contentDiv = document.createElement('div');
    contentDiv.style.cssText = 'flex: 1; text-align: left;';
    contentDiv.textContent = resp.t || resp.text;
    btn.appendChild(contentDiv);
    
    btn.onclick = () => answerQ(resp);
    choicesDiv.appendChild(btn);
  });
}

function answerQ(resp) {
  state.responses.push(resp);
  
  // Stage 1: Track color scores and pairwise
  if (state.stage === 1) {
    state.colorScores[resp.c]++;
    
    const q = state.poolA[state.qNum];
    const pair = q.pair;
    const color = resp.c;
    state.pairwise[pair][color]++;
  }
  
  // Stage 2: Track guild selections AND Pool D pattern selections
  if (state.stage === 2) {
    const guild = resp.g || resp.guild;
    const pattern = resp.pattern; // Pool D responses have pattern: 'MONO', 'GUILD', or 'THREE'
    let colors = resp.colors; // Pool D has explicit colors array
    
    // If no explicit colors but has guild ID, derive colors
    if (!colors && guild) {
      colors = getIdentityColors(guild);
    }
    
    if (guild) {
      state.s2Track.select[guild] = (state.s2Track.select[guild] || 0) + 1;
    }
    
    // Track pattern preferences (Pool D)
    if (pattern) {
      if (!state.s2Track.patternPref) {
        state.s2Track.patternPref = {MONO: 0, GUILD: 0, THREE: 0};
      }
      state.s2Track.patternPref[pattern]++;
      console.log(`Pattern selected: ${pattern} (total: ${state.s2Track.patternPref[pattern]})`);
    }
    
    // CRITICAL: Track color frequency in selections
    if (colors && Array.isArray(colors)) {
      if (!state.s2Track.colorFreq) {
        state.s2Track.colorFreq = {W: 0, U: 0, B: 0, R: 0, G: 0};
      }
      
      colors.forEach(color => {
        state.s2Track.colorFreq[color]++;
      });
      
      console.log(`Colors in selection: [${colors.join(',')}] - Updated freq:`, state.s2Track.colorFreq);
    }
    
    // Track color appearances in all options (for rate calculation)
    const q = state.poolS2[state.qNum];
    if (q && q.r) {
      q.r.forEach(option => {
        let optionColors = option.colors;
        // Derive from guild ID if not explicit
        if (!optionColors && (option.g || option.guild)) {
          optionColors = getIdentityColors(option.g || option.guild);
        }
        
        if (optionColors && Array.isArray(optionColors)) {
          if (!state.s2Track.colorAppear) {
            state.s2Track.colorAppear = {W: 0, U: 0, B: 0, R: 0, G: 0};
          }
          optionColors.forEach(color => {
            state.s2Track.colorAppear[color]++;
          });
        }
      });
    }
  }
  
  state.qNum++;
  
  
  // ENHANCEMENT: Update morphing progress bar
  if (state.stage === 1) {
    const progBar = document.getElementById('prog-s1');
    if (progBar) {
      progBar.style.background = updateProgressGradient();
      progBar.classList.add('progress-opalescent', 'progress-shimmer');
    }
  }
  updateDebug();
  
  if (state.qNum < state.qTot) {
    showQ();
  } else if (state.stage === 1) {
    finishS1();
  } else {
    finishS2();
  }
}

// ============================================================================
// ENHANCEMENT: Adaptive Assessment Helper Functions
// ============================================================================

function getCandidateType(id) {
  if (id.startsWith('MONO-')) return 'MONO';
  if (id === 'WUBRG') return 'FIVE';
  // Check if it's a guild (2 colors)
  const guildNames = ['AZORIUS','DIMIR','RAKDOS','GRUUL','SELESNYA','ORZHOV','IZZET','GOLGARI','SIMIC','BOROS'];
  if (guildNames.includes(id)) return 'GUILD';
  // Otherwise three-color or four-color
  if (PROFILES[id]?.colors?.length === 3) return 'THREE';
  if (PROFILES[id]?.colors?.length === 4) return 'FOUR';
  return 'UNKNOWN';
}

function determineClassificationType(candidates) {
  if (!candidates || candidates.length === 0) return 'UNKNOWN';
  const primaryType = getCandidateType(candidates[0].id);
  return primaryType;
}

function calculateRound1Confidence(activationSorted) {
  const colorNames = {W:'White', U:'Blue', B:'Black', R:'Red', G:'Green'};
  const pct = v => Math.round(v * 100);
  
  const [top, second, third, fourth] = activationSorted.slice(0, 4);
  
  // MONO confidence check: One color clearly dominant
  if (top[1] >= 0.75 && (top[1] - second[1]) >= 0.30) {
    const monoId = 'MONO-' + top[0].toUpperCase();
    return {
      type: 'MONO',
      identity: monoId,
      confidence: 0.90,
      needsRound2: false,
      message: `You clearly prefer ${colorNames[top[0]]} (${pct(top[1])}%) over other approaches‚Äîsignificantly higher than your next color (${pct(second[1])}%). This is a strong mono-color result.`
    };
  }
  
  // GUILD confidence check: Two colors clearly ahead
  if (top[1] >= 0.70 && second[1] >= 0.65 && (second[1] - third[1]) >= 0.25) {
    const guildId = getGuild([top[0], second[0]].sort().join(''));
    const guildProf = PROFILES[guildId];
    return {
      type: 'GUILD',
      identity: guildId,
      confidence: 0.85,
      needsRound2: false,
      message: `You clearly blend ${colorNames[top[0]]} (${pct(top[1])}%) and ${colorNames[second[0]]} (${pct(second[1])}%), both significantly higher than other colors. This indicates a clear ${guildProf?.name || guildId} identity.`
    };
  }
  
  // THREE-COLOR confidence check: Top 3 clustered with clear gap to 4th
  if (top[1] >= 0.65 && second[1] >= 0.60 && third[1] >= 0.55 && 
      (top[1] - third[1]) < 0.15 && (third[1] - fourth[1]) >= 0.20) {
    const threeId = getThree([top[0], second[0], third[0]].sort().join(''));
    const threeProf = PROFILES[threeId];
    return {
      type: 'THREE',
      identity: threeId,
      confidence: 0.80,
      needsRound2: false,
      message: `Your top three colors cluster together (${pct(top[1])}%, ${pct(second[1])}%, ${pct(third[1])}%) with a clear gap to your fourth (${pct(fourth[1])}%). This indicates a ${threeProf?.name || threeId} identity.`
    };
  }
  
  // NEEDS ROUND 2
  return {
    type: 'UNCLEAR',
    confidence: 0.60,
    needsRound2: true,
    message: null
  };
}

function showEarlyTerminationOffer(confidenceData) {
  // Store for later use
  window.earlyConfidenceData = confidenceData;
  
  document.getElementById('screen-interstitial').classList.add('hidden');
  document.getElementById('screen-early-offer').classList.remove('hidden');
  
  const prof = PROFILES[confidenceData.identity];
  
  // Set identity display
  document.getElementById('early-result-name').textContent = prof.name;
  document.getElementById('early-result-tag').textContent = prof.tag;
  document.getElementById('early-confidence').textContent = Math.round(confidenceData.confidence * 100) + '% CONFIDENCE';
  document.getElementById('early-message').textContent = confidenceData.message;
  
  // Set mana symbols
  const syms = document.getElementById('early-symbols');
  syms.innerHTML = '';
  prof.colors.forEach(c => {
    const s = document.createElement('span');
    s.className = `mana-symbol mana-${c}`;
    s.textContent = c;
    s.style.width = '36px';
    s.style.height = '36px';
    s.style.fontSize = '18px';
    syms.appendChild(s);
  });
  
  window.scrollTo({top: 0, behavior: 'smooth'});
}

function showResultsEarly() {
  const data = window.earlyConfidenceData;
  
  // Set result without Round 2 data
  state.result = {
    identity: data.identity,
    confidence: data.confidence >= 0.90 ? 'HIGH' : 'MODERATE',
    earlyTermination: true,
    allResults: [],
    s2Data: null
  };
  
  showCalculating();
}

function continueToRound2() {
  // User chose to continue
  document.getElementById('screen-early-offer').classList.add('hidden');
  document.getElementById('screen-interstitial').classList.remove('hidden');
  
  // Continue with normal flow
  setTimeout(() => {
    document.getElementById('screen-interstitial').classList.add('hidden');
    document.getElementById('screen-assessment').classList.remove('hidden');
    startS2(state.pendingCandidates);
  }, 100);
}

function calculateCombinedScore(candidateId, data) {
  const candidateType = getCandidateType(candidateId);
  const classification = state.classification || 'UNCLEAR';
  
  let weight_r1, weight_r2;
  
  // CASE 1: Testing same category (guild vs guild, three vs three)
  if (classification === candidateType) {
    // Round 1 is fairly reliable for this
    weight_r1 = 0.70;
    weight_r2 = 0.30;
  }
  // CASE 2: Testing mono vs multi (fundamentally different)
  else if (classification === 'MONO' && candidateType !== 'MONO') {
    // Round 2 Pool D directly tests this - weight it heavily
    weight_r1 = 0.40;
    weight_r2 = 0.60;
  }
  else if (classification !== 'MONO' && candidateType === 'MONO') {
    // Reverse case - still weight Round 2 heavily
    weight_r1 = 0.40;
    weight_r2 = 0.60;
  }
  // CASE 3: Testing guild vs three-color
  else if ((classification === 'GUILD' && candidateType === 'THREE') ||
           (classification === 'THREE' && candidateType === 'GUILD')) {
    // Round 2 is important but Round 1 still informative
    weight_r1 = 0.55;
    weight_r2 = 0.45;
  }
  // CASE 4: Unclear or other
  else {
    // Default balanced weighting
    weight_r1 = 0.60;
    weight_r2 = 0.40;
  }
  
  const combined = data.s1 * weight_r1 + data.s2 * weight_r2;
  
  console.log(`${candidateId}: weights ${Math.round(weight_r1*100)}/${Math.round(weight_r2*100)}, s1=${Math.round(data.s1*100)}%, s2=${Math.round(data.s2*100)}%, combined=${Math.round(combined*100)}%`);
  
  return combined;
}

function finishS1() {
  // Calculate activation strength
  const activation = {
    W: (state.pairwise['W-B'].W / 6 + state.pairwise['W-R'].W / 6) / 2,
    U: (state.pairwise['U-R'].U / 6 + state.pairwise['G-U'].U / 6) / 2,
    B: (state.pairwise['W-B'].B / 6 + state.pairwise['B-G'].B / 6) / 2,
    R: (state.pairwise['U-R'].R / 6 + state.pairwise['W-R'].R / 6) / 2,
    G: (state.pairwise['G-U'].G / 6 + state.pairwise['B-G'].G / 6) / 2
  };
  
  const sorted = Object.entries(activation).sort((a,b) => b[1] - a[1]);
  state.activationSorted = sorted; // Store for results explanation
  
  console.log('=== ROUND 1 CLASSIFICATION ===');
  console.log('Activation:', sorted.map(([c,v]) => `${c}:${Math.round(v*100)}%`).join(', '));
  
  let identity = null;
  let confidence = 'MODERATE';
  let needsS2 = false;
  let candidates = [];
  let classification = null;
  
  const [t1, t2, t3, t4, t5] = sorted.map(c => c[1]);
  
  // =============================================================================
  // IMPROVED CLASSIFICATION: Check for specific signatures BEFORE gap detection
  // =============================================================================
  
  // RULE 1: MONO SIGNATURE
  // One color ‚â•90%, both its enemies <15%
  if (sorted[0][1] >= 0.90) {
    const dominantColor = sorted[0][0];
    const enemies = getEnemies(dominantColor);
    const enemyScores = enemies.map(e => activation[e]);
    
    console.log(`Checking MONO signature: ${dominantColor}=${Math.round(sorted[0][1]*100)}%, enemies ${enemies.join(',')}=[${enemyScores.map(s => Math.round(s*100)).join(',')}]%`);
    
    if (enemyScores.every(s => s < 0.15)) {
      identity = 'MONO-' + dominantColor;
      classification = 'MONO';
      confidence = sorted[0][1] >= 0.95 ? 'HIGH' : 'MODERATE';
      
      console.log(`‚úì MONO SIGNATURE DETECTED: ${identity} (enemies both <15%)`);
      
      // Still trigger Round 2 if MODERATE confidence for validation
      if (confidence === 'MODERATE' || sorted[1][1] >= 0.50) {
        needsS2 = true;
        candidates = [{id: identity, s1: sorted[0][1]}];
        
        // Add top guilds containing the mono color for testing
        const topGuilds = findGuildsWithColor(dominantColor).slice(0, 2);
        topGuilds.forEach(guildId => {
          const guildColors = getGuildColors(guildId);
          if (guildColors) {
            const avgAct = guildColors.reduce((sum, c) => sum + (activation[c] || 0), 0) / guildColors.length;
            candidates.push({id: guildId, s1: avgAct});
          }
        });
        console.log(`MONO ${confidence} confidence - Round 2 will validate against: ${candidates.map(c => c.id).join(', ')}`);
      }
    }
  }
  
  // =========================================================================
  // RULE 2: ENEMY-PAIR GUILD SIGNATURE DETECTION  
  // =========================================================================
  // Pattern: Two colors sum ‚â•140%, they are enemies, gap to third ‚â•15%
  if (!identity && sorted.length >= 2) {
    const color1 = sorted[0][0];
    const color2 = sorted[1][0];
    const sumTop2 = sorted[0][1] + sorted[1][1];
    const gapToThird = sorted[2] ? (sorted[1][1] - sorted[2][1]) : 0.5;
    
    if (sumTop2 >= 1.40 && areEnemies(color1, color2) && gapToThird >= 0.15) {
      const guildId = getGuild([color1, color2].sort().join(''));
      identity = guildId;
      classification = 'GUILD';
      confidence = sumTop2 >= 1.60 ? 'MODERATE' : 'LOW';
      needsS2 = true; // Always validate enemy guilds
      
      console.log(`‚úì ENEMY-GUILD SIGNATURE: ${identity} (${color1}+${color2}=${Math.round(sumTop2*100)}%, enemies, gap=${Math.round(gapToThird*100)}%)`);
      
      candidates = [{id: identity, s1: sumTop2/2}];
      
      // Add adjacent guilds sharing one color
      [color1, color2].forEach(c => {
        const adjacentGuilds = findGuildsWithColor(c).filter(g => g !== identity).slice(0, 1);
        adjacentGuilds.forEach(guildId => {
          const guildColors = getGuildColors(guildId);
          if (guildColors) {
            const avgAct = guildColors.reduce((sum, col) => sum + (activation[col] || 0), 0) / guildColors.length;
            if (!candidates.find(cand => cand.id === guildId)) {
              candidates.push({id: guildId, s1: avgAct});
            }
          }
        });
      });
      
      console.log(`ENEMY-GUILD candidates: ${candidates.map(c => c.id).join(', ')}`);
    }
  }
  
  // =========================================================================
  // RULE 3: STANDARD GAP DETECTION (for allied guilds, three-colors, etc.)
  // =========================================================================
  if (!identity) {
    // Find gaps - existing smart logic
    const gaps = sorted.slice(0,4).map((c,i) => ({idx:i, gap: c[1] - sorted[i+1][1]}));
    gaps.sort((a,b) => b.gap - a.gap);
    
    // ... continue with existing gap detection logic
    // (keep all the existing sophisticated gap/tie detection)
    
    let bigGap = gaps[0];
    if (bigGap.gap < 0.15 && gaps.length > 1) {
      const significantGap = gaps.find(g => g.gap >= 0.15);
      if (significantGap) bigGap = significantGap;
    }
    
    let numTop = bigGap.idx + 1;
  
  console.log('=== GAP & TIE DETECTION ===');
  console.log('Sorted scores:', sorted.map(([c,v]) => `${c}:${Math.round(v*100)}%`).join(', '));
  console.log('Biggest gap:', bigGap.gap.toFixed(2), 'at index', bigGap.idx);
  console.log('Initial numTop:', numTop);
  
  // CRITICAL: Check for ties AFTER the gap
  // If multiple colors right after the gap are all tied with each other, include them ALL
  const TIE_THRESHOLD = 0.02; // 2% difference = tied
  
  if (numTop < sorted.length) {
    const valueAfterGap = sorted[numTop][1]; // First color after the gap
    console.log('Value after gap:', Math.round(valueAfterGap*100) + '%', `(${sorted[numTop][0]})`);
    let tiedCount = 0;
    
    // Count how many consecutive colors are tied at this value
    for (let i = numTop; i < sorted.length; i++) {
      if (Math.abs(sorted[i][1] - valueAfterGap) <= TIE_THRESHOLD) {
        console.log(`  sorted[${i}] (${sorted[i][0]}: ${Math.round(sorted[i][1]*100)}%) is tied with ${Math.round(valueAfterGap*100)}%`);
        tiedCount++;
      } else {
        console.log(`  sorted[${i}] (${sorted[i][0]}: ${Math.round(sorted[i][1]*100)}%) is NOT tied, stopping`);
        break;
      }
    }
    
    // If we found 2+ tied colors after the gap, include ALL of them
    if (tiedCount >= 2) {
      console.log(`Found ${tiedCount} tied colors after gap, expanding numTop from ${numTop} to ${numTop + tiedCount}`);
      numTop += tiedCount;
    }
  }
  
  console.log('Final numTop:', numTop, '‚Üí Top colors:', sorted.slice(0, numTop).map(c => c[0]).join(', '));
  console.log('==========================');
  
  // Get activation values for easy reference
  const [t1, t2, t3, t4, t5] = sorted.map(c => c[1]);
  
  // CRITICAL CHECK FIRST: Five-color detection
  // If all 5 colors are within 20% of each other, this is FIVE-COLOR (balanced)
  const all5Spread = t1 - t5;
  
  console.log('=== FIVE-COLOR CHECK ===');
  console.log(`All 5 spread: ${Math.round(all5Spread*100)}% (${Math.round(t1*100)}% - ${Math.round(t5*100)}%)`);
  
  if (all5Spread < 0.20) {
    console.log(`FIVE-COLOR DETECTED: All 5 colors within 20% - this is balanced/five-color`);
    numTop = 5;
    bigGap = {idx: 4, gap: 0}; // No meaningful gap
  }
  // Also check: Minimum gap threshold - if biggest gap < 15%, colors too close
  else if (bigGap.gap < 0.15) {
    console.log(`No meaningful gap found (biggest: ${Math.round(bigGap.gap*100)}% < 15%)`);
    // Check if it's five-color or four-color based on spread
    if (all5Spread < 0.25) {
      console.log(`All 5 spread ${Math.round(all5Spread*100)}% < 25% ‚Üí FIVE-COLOR`);
      numTop = 5;
    } else if ((sorted[0][1] - sorted[3][1]) < 0.15) {
      console.log(`Top 4 within 15% ‚Üí FOUR-COLOR`);
      numTop = 4;
      bigGap = {idx: 3, gap: sorted[3][1] - sorted[4][1]};
    }
  }
  console.log('After five-color check, numTop:', numTop);
  console.log('========================');
  
  // ADDITIONAL CHECK: If top 4 colors are all within 12% of each other AND there wasn't a big gap earlier, it's 4-color
  if (numTop !== 5 && sorted.length >= 4 && (sorted[0][1] - sorted[3][1]) < 0.12 && bigGap.gap < 0.15) {
    numTop = 4;
    bigGap = {idx: 3, gap: sorted[3][1] - sorted[4][1]};
  }
  // If top 3 colors are all within 20% of each other, it's 3-color
  else if (sorted.length >= 3 && (sorted[0][1] - sorted[2][1]) < 0.20) {
    numTop = 3;
    bigGap = {idx: 2, gap: sorted[2][1] - sorted[3][1]};
  }
  
  const top = sorted.slice(0, numTop);
  
  let identity = null;
  let confidence = 'MODERATE';
  let needsS2 = false;
  let candidates = [];
  
  // =============================================================================
  // IMPROVED CLASSIFICATION: Check for specific signatures BEFORE gap detection
  // =============================================================================
  
  // RULE 1: MONO SIGNATURE
  // One color ‚â•90%, both its enemies <15%
  if (t1 >= 0.90) {
    const topColor = sorted[0][0];
    const enemies = getEnemies(topColor);
    const enemy1Score = activation[enemies[0]] || 0;
    const enemy2Score = activation[enemies[1]] || 0;
    
    if (enemy1Score < 0.15 && enemy2Score < 0.15) {
      console.log(`‚úì MONO SIGNATURE DETECTED: ${topColor}=${Math.round(t1*100)}%, enemies=[${enemies[0]}(${Math.round(enemy1Score*100)}%), ${enemies[1]}(${Math.round(enemy2Score*100)}%)]`);
      
      identity = 'MONO-' + topColor.toUpperCase();
      confidence = t1 >= 0.95 && enemy1Score < 0.10 && enemy2Score < 0.10 ? 'HIGH' : 'MODERATE';
      
      // If second color is high (>60%), validate mono vs guild
      if (t2 > 0.60) {
        needsS2 = true;
        candidates = [{id: identity, s1: t1}];
        
        const guildId = getGuild([topColor, sorted[1][0]].sort().join(''));
        if (guildId) {
          candidates.push({id: guildId, s1: (t1 + t2) / 2});
          console.log(`  ‚Üí Will validate MONO-${topColor} vs ${guildId} in Round 2`);
        }
      }
      
      // Skip to result (bypass numTop logic)
      if (!needsS2 || confidence === 'HIGH') {
        // Jump to end of classification
      } else {
        // Continue to candidate building below
      }
    }
  }
  
  // RULE 2: ENEMY GUILD SIGNATURE
  // Two colors sum to 140%+, both >50%, they're enemies
  // Catches guilds tested IN their defining enemy pair (ORZHOV, SIMIC, GOLGARI)
  if (!identity && t1 >= 0.50 && t2 >= 0.50 && (t1 + t2) >= 1.40) {
    const color1 = sorted[0][0];
    const color2 = sorted[1][0];
    
    if (areEnemies(color1, color2)) {
      console.log(`‚úì ENEMY GUILD SIGNATURE: ${color1}(${Math.round(t1*100)}%) + ${color2}(${Math.round(t2*100)}%) = ${Math.round((t1+t2)*100)}%, enemies=YES`);
      
      identity = getGuild([color1, color2].sort().join(''));
      confidence = (t1 + t2) >= 1.60 ? 'MODERATE' : 'LOW';
      needsS2 = true;  // Always validate enemy guilds
      
      candidates = [{id: identity, s1: (t1 + t2) / 2}];
      
      console.log(`  ‚Üí Will validate ${identity} enemy guild in Round 2`);
    }
  }
  
  // =============================================================================
  // If no signature matched, use standard gap-based classification
  // =============================================================================
  if (!identity) {
    // Find gaps - existing smart logic
    const gaps = sorted.slice(0,4).map((c,i) => ({idx:i, gap: c[1] - sorted[i+1][1]}));
    gaps.sort((a,b) => b.gap - a.gap);
    
    let bigGap = gaps[0];
    if (bigGap.gap < 0.15 && gaps.length > 1) {
      const significantGap = gaps.find(g => g.gap >= 0.15);
      if (significantGap) bigGap = significantGap;
    }
    
    let numTop = bigGap.idx + 1;
  
  console.log('=== GAP & TIE DETECTION ===');
  console.log('Sorted scores:', sorted.map(([c,v]) => `${c}:${Math.round(v*100)}%`).join(', '));
  console.log('Biggest gap:', bigGap.gap.toFixed(2), 'at index', bigGap.idx);
  console.log('Initial numTop:', numTop);
  
  // CRITICAL: Check for ties AFTER the gap
  const TIE_THRESHOLD = 0.02;
  
  if (numTop < sorted.length) {
    const valueAfterGap = sorted[numTop][1];
    console.log('Value after gap:', Math.round(valueAfterGap*100) + '%', `(${sorted[numTop][0]})`);
    let tiedCount = 0;
    
    for (let i = numTop; i < sorted.length; i++) {
      if (Math.abs(sorted[i][1] - valueAfterGap) <= TIE_THRESHOLD) {
        console.log(`  sorted[${i}] (${sorted[i][0]}: ${Math.round(sorted[i][1]*100)}%) is tied`);
        tiedCount++;
      } else {
        break;
      }
    }
    
    if (tiedCount >= 2) {
      console.log(`Found ${tiedCount} tied colors after gap, expanding numTop`);
      numTop += tiedCount;
    }
  }
  
  console.log('Final numTop:', numTop);
  
  const top = sorted.slice(0, numTop);
  
  // MONO (1 dominant)
  if (numTop === 1 || (t1 >= 0.83 && t2 <= 0.42)) {
    identity = 'MONO-' + sorted[0][0].toUpperCase();
    if (t1 >= 0.83 && bigGap.gap >= 0.4 && t2 < 0.5) {
      confidence = 'HIGH';
    } else if (t2 >= 0.5) {
      needsS2 = true;
      // MONO stays as first candidate for testing
      candidates = [{id: identity, s1: t1}];
      
      // Add guilds with PROPER s1 scores AND minimum color threshold
      const MIN_SECOND_COLOR = 0.40; // Second color must be at least 40% to be viable guild
      
      const guilds = findGuildsWithColor(sorted[0][0]).slice(0,3);
      guilds.forEach(guildId => {
        const guildColors = getGuildColors(guildId);
        if (guildColors && guildColors.length === 2) {
          // Calculate s1 from actual color activations
          const c1 = guildColors[0];
          const c2 = guildColors[1];
          const c1Act = activation[c1] || 0;
          const c2Act = activation[c2] || 0;
          
          // Only include guild if BOTH colors are reasonably strong
          if (c1Act >= MIN_SECOND_COLOR && c2Act >= MIN_SECOND_COLOR) {
            const guildS1 = (c1Act + c2Act) / 2;
            candidates.push({id: guildId, s1: guildS1});
            console.log(`Stage 2 candidate: ${guildId} (${c1}=${Math.round(c1Act*100)}%, ${c2}=${Math.round(c2Act*100)}%) ‚Üí s1 = ${Math.round(guildS1*100)}%`);
          } else {
            console.log(`Skipping ${guildId}: ${c1}=${Math.round(c1Act*100)}% or ${c2}=${Math.round(c2Act*100)}% below ${MIN_SECOND_COLOR*100}% threshold`);
          }
        } else {
          // Fallback if colors not found
          candidates.push({id: guildId, s1: t1 * 0.5});
        }
      });
      
      console.log('Final Stage 2 candidates for MONO:', candidates.map(c => c.id).join(', '));
    }
  }
  // GUILD (2 colors)
  else if (numTop === 2) {
    identity = getGuild([top[0][0], top[1][0]].sort().join(''));
    
    if (t1 >= 0.75 && t2 >= 0.75 && bigGap.gap >= 0.33 && Math.abs(t1-t2) < 0.17) {
      confidence = 'HIGH';
    } else if (t1 >= 0.67 && t2 >= 0.67 && bigGap.gap >= 0.17) {
      confidence = 'MODERATE';  
    } else {
      needsS2 = true;
      candidates = [{id: identity, s1: (t1+t2)/2}];
      
      // ONLY add guilds using the ACTUAL top 3 colors, not adjacent guilds with 4th/5th colors
      // If third color is reasonably close (>=40%), include guilds with it
      const MIN_COLOR_FOR_GUILD = 0.40;
      
      if (t3 >= MIN_COLOR_FOR_GUILD) {
        // Can include guilds made from top 3 colors
        for (let i = 0; i < 3; i++) {
          for (let j = i+1; j < 3; j++) {
            const c1 = sorted[i][0].toUpperCase();
            const c2 = sorted[j][0].toUpperCase();
            const gc = [c1, c2].sort().join('');
            const guildId = getGuild(gc);
            
            // Double-check both colors are >= threshold
            if (sorted[i][1] >= MIN_COLOR_FOR_GUILD && sorted[j][1] >= MIN_COLOR_FOR_GUILD) {
              if (guildId !== identity && !candidates.find(c => c.id === guildId)) {
                candidates.push({id: guildId, s1: (sorted[i][1] + sorted[j][1])/2});
                console.log(`DUAL Stage 2 candidate: ${guildId} (${c1}=${Math.round(sorted[i][1]*100)}%, ${c2}=${Math.round(sorted[j][1]*100)}%)`);
              }
            }
          }
        }
      }
      // Otherwise only test the primary guild (top 2 colors)
    }
  }
  // THREE-COLOR (3 colors)
  else if (numTop === 3) {
    identity = getThree([top[0][0], top[1][0], top[2][0]].sort().join(''));
    
    if (t1 >= 0.75 && t2 >= 0.75 && t3 >= 0.75 && bigGap.gap >= 0.33) {
      confidence = 'HIGH';
    } else if (t1 >= 0.67 && t2 >= 0.67 && t3 >= 0.58 && bigGap.gap >= 0.25) {
      confidence = 'MODERATE';
    } else {
      needsS2 = true;
      candidates = [{id: identity, s1: (t1+t2+t3)/3}];
      
      // STRICT: Only add the 2 CLOSEST component guilds (not all 3)
      // This prevents guild bias in Round 2 (was 3 three-color vs 9 guild scenarios)
      const guildPairs = [];
      for (let i = 0; i < top.length && i < 3; i++) {
        for (let j = i+1; j < top.length && j < 3; j++) {
          const gap = Math.abs(top[i][1] - top[j][1]);
          const gc = [top[i][0].toUpperCase(), top[j][0].toUpperCase()].sort().join('');
          guildPairs.push({guild: getGuild(gc), s1: (top[i][1] + top[j][1])/2, gap: gap});
        }
      }
      
      // Sort by smallest gap (closest pairs) and take top 2
      guildPairs.sort((a, b) => a.gap - b.gap);
      guildPairs.slice(0, 2).forEach(pair => {
        if (pair.guild && !candidates.find(c => c.id === pair.guild)) {
          candidates.push({id: pair.guild, s1: pair.s1});
          console.log(`Adding guild candidate: ${pair.guild} (gap: ${Math.round(pair.gap*100)}%)`);
        }
      });
      
      console.log(`THREE-COLOR testing: 1 three-color + ${guildPairs.slice(0,2).length} closest guilds (reduced from 3 to prevent guild bias)`);
      
      // Also test if it's actually MONO of the top color
      // BUT ONLY if the top 3 spread is significant (>20%)
      const top3Spread = sorted[0][1] - sorted[2][1];
      if (top3Spread >= 0.20) {
        // Top 3 not close together - mono is plausible
        const topColor = sorted[0][0].toUpperCase();
        const monoId = 'MONO-' + topColor;
        if (!candidates.find(c => c.id === monoId)) {
          candidates.push({id: monoId, s1: t1});
          console.log(`Adding MONO-${topColor} as candidate (s1=${Math.round(t1*100)}%, top3spread=${Math.round(top3Spread*100)}%) - mono is plausible`);
        }
      } else {
        console.log(`NOT adding MONO candidate - top 3 spread only ${Math.round(top3Spread*100)}% (need ‚â•20% for mono to be plausible)`);
      }
    }
  }
  // FOUR-COLOR (4 colors, 1 absent)
  else if (numTop === 4) {
    identity = getFour(sorted[4][0]);
    if (t1 >= 0.75 && t4 >= 0.67 && bigGap.gap >= 0.33) {
      confidence = 'HIGH';
    } else {
      needsS2 = true;
      candidates = [{id: identity, s1: (t1+t2+t3+t4)/4}];
      
      // CRITICAL: Add three-color sub-pattern candidates
      // Test which three-color pattern they prefer within their four colors
      const fourColors = top.slice(0, 4).map(c => c[0].toUpperCase());
      console.log(`FOUR-COLOR ${identity}: Testing three-color sub-patterns from [${fourColors.join(',')}]`);
      
      // Generate all three-color combinations from the four colors
      for (let i = 0; i < 4; i++) {
        for (let j = i+1; j < 4; j++) {
          for (let k = j+1; k < 4; k++) {
            const threeColorCombo = [fourColors[i], fourColors[j], fourColors[k]].sort().join('');
            const threeColorId = getThree(threeColorCombo);
            if (threeColorId) {
              const avgActivation = (top[i][1] + top[j][1] + top[k][1]) / 3;
              candidates.push({id: threeColorId, s1: avgActivation});
              console.log(`  ‚Üí ${threeColorId} (${fourColors[i]}+${fourColors[j]}+${fourColors[k]}, avg=${Math.round(avgActivation*100)}%)`);
            }
          }
        }
      }
      
      console.log(`FOUR-COLOR candidates: ${candidates.map(c => c.id).join(', ')}`);
    }
  }
  // FIVE-COLOR (all balanced)
  else {
    identity = 'WUBRG';
    const variance = t1 - sorted[4][1];
    confidence = variance < 0.25 ? 'MODERATE' : 'LOW';
    
    // ALWAYS test five-color with three-color sub-patterns
    needsS2 = true;
    candidates = [{id: identity, s1: (t1+t2+t3+t4+sorted[4][1])/5}];
    
    // Add diverse three-color patterns to test
    // Include shards (allied) and wedges (enemy) for maximum discrimination
    const threeColorTests = ['BANT', 'ESPER', 'GRIXIS', 'JUND', 'NAYA', 'JESKAI', 'SULTAI'];
    threeColorTests.forEach(threeId => {
      if (PROFILES[threeId]) {
        const threeColors = PROFILES[threeId].colors;
        const avgActivation = threeColors.reduce((sum, c) => sum + (activation[c] || 0), 0) / threeColors.length;
        candidates.push({id: threeId, s1: avgActivation});
      }
    });
    
    console.log(`FIVE-COLOR: Testing diverse three-color patterns to see if any is preferred`);
    console.log(`FIVE-COLOR candidates: ${candidates.map(c => c.id).join(', ')}`);
  }
  } // End of "if (!identity)" block - gap-based classification
  
  // Force Stage 2 if gap too small or scores not high enough
  if (bigGap.gap < 0.25 || (numTop >= 2 && t1 < 0.75)) {
    needsS2 = true;
  }
  
  // ENHANCEMENT: Check if we have high confidence and can offer early termination
  if (!needsS2 || confidence === 'HIGH') {
    const confidenceCheck = calculateRound1Confidence(sorted);
    state.classification = confidenceCheck.type; // Store for weighting later
    
    if (confidenceCheck.confidence >= 0.85 && confidenceCheck.needsRound2 === false) {
      // HIGH confidence - offer early termination
      console.log(`HIGH CONFIDENCE: ${confidenceCheck.identity} (${Math.round(confidenceCheck.confidence*100)}%) - offering early termination`);
      state.pendingCandidates = candidates.length > 0 ? candidates : [{id: identity, s1: 0}];
      showEarlyTerminationOffer(confidenceCheck);
      return; // Stop here, user will choose
    }
  }
  
  // Store classification for weighting (even if not offering early term)
  if (!state.classification) {
    const confidenceCheck = calculateRound1Confidence(sorted);
    state.classification = confidenceCheck.type;
  }
  
  // All paths should go through either showEarlyTerminationOffer or showInterstitial
  // Don't call showCalculating directly - it bypasses the user choice
  if (needsS2) {
    showInterstitial(candidates.length > 0 ? candidates : [{id: identity, s1: 0}]);
  } else {
    // MODERATE or LOW confidence without Stage 2
    // Generate alternatives based on score patterns
    const simpleAlternatives = [];
    
    // Add primary identity
    const primaryScore = numTop === 1 ? t1 : 
                        numTop === 2 ? (t1 + t2) / 2 : 
                        numTop === 3 ? (t1 + t2 + t3) / 3 : 
                        (t1 + t2 + t3 + t4) / 4;
    simpleAlternatives.push([identity, {s1: primaryScore, s2: 0}]);
    
    // Generate alternatives
    if (numTop === 2) {
      // Dual - check if third color strong enough for tri
      if (t3 >= 0.50 || (confidence === 'LOW' && t3 >= 0.40)) {
        const c1 = sorted[0][0].toUpperCase();
        const c2 = sorted[1][0].toUpperCase();
        const c3 = sorted[2][0].toUpperCase();
        const threeId = getThree([c1, c2, c3].sort().join(''));
        if (threeId && !simpleAlternatives.find(a => a[0] === threeId)) {
          simpleAlternatives.push([threeId, {s1: (t1 + t2 + t3) / 3, s2: 0}]);
        }
      }
      // If LOW confidence with gap, suggest mono of first color
      if (confidence === 'LOW' && (t1 - t2) >= 0.15) {
        const monoId = 'MONO-' + sorted[0][0].toUpperCase();
        if (!simpleAlternatives.find(a => a[0] === monoId)) {
          simpleAlternatives.push([monoId, {s1: t1, s2: 0}]);
        }
      }
      // For LOW, add other nearby guilds from top 3
      if (confidence === 'LOW' && simpleAlternatives.length < 3) {
        for (let i = 0; i < 3 && i < sorted.length; i++) {
          for (let j = i+1; j < 3 && j < sorted.length; j++) {
            const c1 = sorted[i][0].toUpperCase();
            const c2 = sorted[j][0].toUpperCase();
            const gc = [c1, c2].sort().join('');
            const guildId = getGuild(gc);
            if (guildId && guildId !== identity && !simpleAlternatives.find(a => a[0] === guildId)) {
              simpleAlternatives.push([guildId, {s1: (sorted[i][1] + sorted[j][1]) / 2, s2: 0}]);
            }
          }
        }
      }
    } else if (numTop === 3) {
      // Tri - check if third is weak (might be dual)
      if (t3 < 0.50) {
        const c1 = sorted[0][0].toUpperCase();
        const c2 = sorted[1][0].toUpperCase();
        const gc = [c1, c2].sort().join('');
        const guildId = getGuild(gc);
        if (guildId && !simpleAlternatives.find(a => a[0] === guildId)) {
          simpleAlternatives.push([guildId, {s1: (t1 + t2) / 2, s2: 0}]);
        }
      }
      // For LOW, add component guilds
      if (confidence === 'LOW') {
        for (let i = 0; i < 3; i++) {
          for (let j = i+1; j < 3; j++) {
            const c1 = sorted[i][0].toUpperCase();
            const c2 = sorted[j][0].toUpperCase();
            const gc = [c1, c2].sort().join('');
            const guildId = getGuild(gc);
            if (guildId && !simpleAlternatives.find(a => a[0] === guildId)) {
              simpleAlternatives.push([guildId, {s1: (sorted[i][1] + sorted[j][1]) / 2, s2: 0}]);
            }
          }
        }
      }
    } else if (numTop === 1) {
      // Mono - check if second color significant
      if (t2 >= 0.40) {
        const c1 = sorted[0][0].toUpperCase();
        const c2 = sorted[1][0].toUpperCase();
        const gc = [c1, c2].sort().join('');
        const guildId = getGuild(gc);
        if (guildId && !simpleAlternatives.find(a => a[0] === guildId)) {
          simpleAlternatives.push([guildId, {s1: (t1 + t2) / 2, s2: 0}]);
        }
      }
    }
    
    console.log('Generated simpleAlternatives:', simpleAlternatives.map(a => a[0]).join(', '));
    
    state.result = {
      identity, 
      confidence,
      allResults: simpleAlternatives
    };
    showCalculating();
  }  // Close inner
  }  // Close the if (!identity) block from line 3246
  
  // If identity WAS set by signature detection, handle it here
  if (identity && !state.result) {
    if (!needsS2 || confidence === 'HIGH') {
      // Should have been caught by early termination check above
      // If we're here, offer early termination now
      const confidenceCheck = calculateRound1Confidence(sorted);
      state.pendingCandidates = candidates.length > 0 ? candidates : [{id: identity, s1: 0}];
      showEarlyTerminationOffer(confidenceCheck);
    } else {
      showInterstitial(candidates);
    }
  }
}

function showInterstitial(candidates) {
  state.pendingCandidates = candidates;
  
  document.getElementById('screen-assessment').classList.add('hidden');
  document.getElementById('screen-interstitial').classList.remove('hidden');
  
  const sorted = state.activationSorted;
  const colorNames = {W:'White', U:'Blue', B:'Black', R:'Red', G:'Green'};
  const pct = (v) => Math.round(v * 100);
  
  // Find the biggest gap to determine how many colors are actually activated
  const gaps = sorted.slice(0,4).map((c,i) => ({idx:i, gap: c[1] - sorted[i+1][1]}));
  gaps.sort((a,b) => b.gap - a.gap);
  const numTop = gaps[0].idx + 1;
  
  // Show color symbols for the colors ABOVE the gap
  const scoresDiv = document.getElementById('inter-scores');
  scoresDiv.innerHTML = '';
  scoresDiv.style.cssText = 'display: flex; justify-content: center; gap: 12px; flex-wrap: wrap;';
  sorted.slice(0, numTop).forEach(([c, act]) => {
    const sym = document.createElement('span');
    sym.className = `mana-symbol mana-${c}`;
    sym.textContent = c;
    sym.style.width = '44px';
    sym.style.height = '44px';
    sym.style.fontSize = '22px';
    scoresDiv.appendChild(sym);
  });
  
  const [t1, t2, t3, t4, t5] = sorted.map(c => c[1]);
  let explanation = '';
  let nextStep = '';
  
  // Generate explanation based on ACTUAL pattern detected
  if (numTop === 1) {
    // ONE color dominant
    explanation = `${colorNames[sorted[0][0]]} is clearly your dominant color (${pct(t1)}%), significantly higher than your next color (${pct(t2)}%).`;
    if (t2 >= 0.42) {
      nextStep = `We'll test to confirm if you're purely mono-${colorNames[sorted[0][0]]} or if you blend in a second color.`;
    } else {
      nextStep = `We'll verify you're mono-${colorNames[sorted[0][0]]} with targeted scenarios.`;
    }
  } else if (numTop === 2) {
    // TWO colors above the gap
    const names = sorted.slice(0,2).map(c => colorNames[c[0]]);
    explanation = `Your top two colors are ${names[0]} (${pct(t1)}%) and ${names[1]} (${pct(t2)}%), both clearly above your other colors.`;
    nextStep = `We'll test specific two-color guild scenarios to determine which combination fits you best.`;
  } else if (numTop === 3) {
    // THREE colors above the gap
    const names = sorted.slice(0,3).map(c => colorNames[c[0]]);
    explanation = `Your top three colors cluster together: ${names[0]} (${pct(t1)}%), ${names[1]} (${pct(t2)}%), ${names[2]} (${pct(t3)}%).`;
    nextStep = `We'll test to see if you're a three-color identity or primarily one of the component two-color guilds.`;
  } else if (numTop === 4) {
    // FOUR colors above the gap
    const absentColor = sorted[4][0];
    explanation = `Four colors are activated (${pct(t1)}%, ${pct(t2)}%, ${pct(t3)}%, ${pct(t4)}%) with ${colorNames[absentColor]} clearly lower (${pct(t5)}%).`;
    nextStep = `We'll verify this rare four-color pattern with targeted scenarios.`;
  } else {
    // ALL FIVE balanced
    explanation = `All five colors show balanced activation (range: ${pct(t5)}%-${pct(t1)}%).`;
    nextStep = `We'll test to determine if you're truly five-color or have a clearer pattern emerge.`;
  }
  
  document.getElementById('inter-explanation').textContent = explanation;
  document.getElementById('inter-next').textContent = nextStep;
  
  window.scrollTo({top: 0, behavior: 'smooth'});
}

function continueToStage2() {
  document.getElementById('screen-interstitial').classList.add('hidden');
  document.getElementById('screen-assessment').classList.remove('hidden');
  startS2(state.pendingCandidates);
}

function startS2(candidates) {
  const scenarios = [];
  const seenIds = new Set();
  
  // Initialize pattern tracking
  if (!state.s2Track.patternPref) {
    state.s2Track.patternPref = {MONO: 0, GUILD: 0, THREE: 0};
  }
  if (!state.s2Track.colorFreq) {
    state.s2Track.colorFreq = {W: 0, U: 0, B: 0, R: 0, G: 0};
  }
  if (!state.s2Track.colorAppear) {
    state.s2Track.colorAppear = {W: 0, U: 0, B: 0, R: 0, G: 0};
  }
  
  // Store trigger info for debug
  state.stage2Trigger = {
    reason: generateStage2Reason(state.activationSorted, candidates),
    candidates: candidates
  };
  
  // Determine Round 1 classification for smart routing
  const classification = state.classification || determineClassificationType(candidates);
  
  console.log('=== ADAPTIVE ROUND 2 SCENARIO SELECTION ===');
  console.log('Round 1 classification:', classification);
  console.log('Candidates:', candidates.map(c => c.id).join(', '));
  console.log('Strategy: Select scenarios to test specific ambiguity');
  
  // =============================================================================
  // ADAPTIVE ROUTING: Select Pool D scenarios based on specific candidates
  // =============================================================================
  
  // Get candidate types
  const hasMono = candidates.some(c => c.id.startsWith('MONO-'));
  const hasGuild = candidates.some(c => getCandidateType(c.id) === 'GUILD');
  const hasThree = candidates.some(c => getCandidateType(c.id) === 'THREE');
  const hasFour = candidates.some(c => getCandidateType(c.id) === 'FOUR');
  const hasFive = candidates.some(c => c.id === 'WUBRG');
  
  // Get the actual colors being tested from candidates
  const candidateColors = new Set();
  candidates.forEach(cand => {
    const colors = PROFILES[cand.id]?.colors || [];
    colors.forEach(c => candidateColors.add(c));
  });
  const testColors = Array.from(candidateColors);
  
  console.log('Colors being tested:', testColors.join(', '));
  
  // =============================================================================
  // PHASE 1: Select Pool D scenarios matching the test colors
  // =============================================================================
  console.log('PHASE 1: Adaptive Pool D selection');
  
  if (POOL_D && POOL_D['PATTERN-TEST']) {
    // Filter Pool D to scenarios using the candidate colors
    const relevantPoolD = POOL_D['PATTERN-TEST'].filter(scenario => {
      // Check if this scenario has options using our test colors
      return scenario.r.some(option => {
        const optionColors = option.colors || [];
        // Include if option uses colors we're testing
        return optionColors.some(c => testColors.includes(c));
      });
    });
    
    console.log(`  Found ${relevantPoolD.length}/${POOL_D['PATTERN-TEST'].length} Pool D scenarios matching test colors [${testColors.join(',')}]`);
    
    // For MONO testing: Prioritize scenarios with MONO options for their color
    if (hasMono) {
      const monoColor = candidates.find(c => c.id.startsWith('MONO-'))?.id.split('-')[1];
      const monoScenarios = relevantPoolD.filter(s => 
        s.r.some(opt => opt.pattern === 'MONO' && opt.colors && opt.colors.includes(monoColor))
      );
      
      console.log(`  MONO testing: Found ${monoScenarios.length} scenarios with MONO-${monoColor} options`);
      
      // Add all mono scenarios first (priority)
      monoScenarios.forEach(scenario => {
        if (!seenIds.has(scenario.id)) {
          scenarios.push(scenario);
          seenIds.add(scenario.id);
        }
      });
      
      // Fill remaining with other relevant scenarios
      const remaining = relevantPoolD.filter(s => !seenIds.has(s.id)).slice(0, 8 - scenarios.length);
      remaining.forEach(scenario => {
        scenarios.push(scenario);
        seenIds.add(scenario.id);
      });
    } 
    // For GUILD/THREE testing: Use scenarios matching candidate colors
    else {
      relevantPoolD.slice(0, 8).forEach(scenario => {
        if (!seenIds.has(scenario.id)) {
          scenarios.push(scenario);
          seenIds.add(scenario.id);
        }
      });
    }
    
    console.log(`‚úì Added ${scenarios.length} adaptive Pool D scenarios`);
  }
  
  // =============================================================================
  // PHASE 2: Add Pool B/C scenarios for color-specific discrimination
  // =============================================================================
  console.log('PHASE 2: Pool B/C color discrimination');
  
  candidates.forEach(cand => {
    const candType = getCandidateType(cand.id);
    
    // Add Pool C if candidate is three-color
    if (candType === 'THREE') {
      if (POOL_C[cand.id]) {
        POOL_C[cand.id].slice(0, 2).forEach(scenario => {
          const scenarioId = scenario.id || JSON.stringify(scenario).substring(0, 50);
          if (!seenIds.has(scenarioId) && scenarios.length < 15) {
            scenarios.push(scenario);
            seenIds.add(scenarioId);
          }
        });
        console.log(`  ‚úì Added 2 ${cand.id} scenarios from Pool C`);
      }
    }
    
    // Add Pool B if candidate is guild
    if (candType === 'GUILD') {
      if (POOL_B[cand.id]) {
        POOL_B[cand.id].slice(0, 2).forEach(scenario => {
          const scenarioId = scenario.id || JSON.stringify(scenario).substring(0, 50);
          if (!seenIds.has(scenarioId) && scenarios.length < 15) {
            scenarios.push(scenario);
            seenIds.add(scenarioId);
          }
        });
        console.log(`  ‚úì Added 2 ${cand.id} scenarios from Pool B`);
      }
    }
    
    // For FOUR-color: Add three-color sub-patterns from Pool C
    if (candType === 'FOUR') {
      // Get three-color candidates
      const threeColorCands = candidates.filter(c => getCandidateType(c.id) === 'THREE');
      threeColorCands.slice(0, 3).forEach(threeCand => {
        if (POOL_C[threeCand.id]) {
          POOL_C[threeCand.id].slice(0, 1).forEach(scenario => {
            const scenarioId = scenario.id || JSON.stringify(scenario).substring(0, 50);
            if (!seenIds.has(scenarioId) && scenarios.length < 15) {
              scenarios.push(scenario);
              seenIds.add(scenarioId);
            }
          });
        }
      });
      console.log(`  ‚úì Added three-color sub-pattern scenarios for four-color testing`);
    }
  });
  
  console.log(`Total scenarios collected: ${scenarios.length}`);
  
  // Ensure minimum scenario count
  if (scenarios.length < 8) {
    console.log('‚ö† Adding fallback scenarios (< 8 collected)');
    const fallbackScenarios = POOL_D['PATTERN-TEST'].filter(s => !seenIds.has(s.id)).slice(0, 8 - scenarios.length);
    fallbackScenarios.forEach(scenario => {
      scenarios.push(scenario);
      seenIds.add(scenario.id);
    });
  }
  
  const shuffled = shuffleArray(scenarios).slice(0, Math.min(12, scenarios.length));
  console.log(`Final Round 2: ${shuffled.length} questions selected`);
  console.log('=====================');
  
  state.stage = 2;
  state.qNum = 0;
  state.poolS2 = shuffled;
  state.qTot = shuffled.length;
  state.s2Track = {appear:{}, select:{}};
  state.candidates = candidates;
  
  updateDebug(); // Show Stage 2 info
  showQ();
}

function generateStage2Reason(sorted, candidates) {
  const pct = (v) => Math.round(v * 100);
  const top3 = sorted.slice(0, 3);
  const gaps = sorted.slice(0,4).map((c,i) => c[1] - sorted[i+1][1]);
  const maxGap = Math.max(...gaps);
  
  if (maxGap < 0.25) {
    return `Close scores (${pct(top3[0][1])}%, ${pct(top3[1][1])}%, ${pct(top3[2][1])}%)‚Äîneed to distinguish between similar combinations`;
  } else if (sorted[1][1] >= 0.5 && sorted[0][1] < 0.9) {
    return `Second color at ${pct(sorted[1][1])}%‚Äîtesting if mono-color or guild`;
  } else if (top3.every(c => c[1] >= 0.58) && top3.every(c => c[1] <= 0.75)) {
    return `Three colors activated (${pct(top3[0][1])}%, ${pct(top3[1][1])}%, ${pct(top3[2][1])}%)‚Äîtesting guild vs three-color`;
  } else {
    return `Pattern requires clarification‚Äîtesting ${candidates.length} possible identities`;
  }
}

function finishS2() {
  console.log('=== STAGE 2 FINAL ANALYSIS ===');
  console.log('Candidates:', state.candidates.map(c => c.id).join(', '));
  
  // Calculate Round 2 color activation rates
  const totalSelections = state.qNum; // Number of Round 2 questions answered
  const colorActivationR2 = {};
  
  console.log('Color frequency in selections:', state.s2Track.colorFreq);
  console.log('Total Round 2 selections:', totalSelections);
  
  // Calculate what % of selections each color appeared in
  ['W','U','B','R','G'].forEach(color => {
    const freq = state.s2Track.colorFreq[color] || 0;
    colorActivationR2[color] = totalSelections > 0 ? freq / totalSelections : 0;
  });
  
  console.log('Round 2 color activation rates:', 
    Object.entries(colorActivationR2).map(([c,v]) => `${c}:${Math.round(v*100)}%`).join(', '));
  
  // Get Round 1 activation
  const activationR1 = {};
  state.activationSorted.forEach(([color, value]) => {
    activationR1[color] = value;
  });
  
  // Combine Round 1 (60%) + Round 2 (40%)
  const combinedActivation = {};
  ['W','U','B','R','G'].forEach(color => {
    const r1 = activationR1[color] || 0;
    const r2 = colorActivationR2[color] || 0;
    combinedActivation[color] = (r1 * 0.6) + (r2 * 0.4);
  });
  
  const sorted = Object.entries(combinedActivation).sort((a,b) => b[1] - a[1]);
  
  console.log('Combined activation (60% R1 + 40% R2):',
    sorted.map(([c,v]) => `${c}:${Math.round(v*100)}%`).join(', '));
  
  // Determine how many colors are active
  // Active threshold: >60% combined activation
  const ACTIVE_THRESHOLD = 0.60;
  const activeColors = sorted.filter(([c, v]) => v >= ACTIVE_THRESHOLD);
  const numActive = activeColors.length;
  
  console.log(`Active colors (>${Math.round(ACTIVE_THRESHOLD*100)}%):`, 
    activeColors.map(([c,v]) => `${c}(${Math.round(v*100)}%)`).join(', '));
  console.log(`Number of active colors: ${numActive}`);
  
  // Check pattern preference from Pool D (if used)
  let patternPreference = null;
  if (state.s2Track.patternPref) {
    const total = (state.s2Track.patternPref.MONO || 0) + 
                  (state.s2Track.patternPref.GUILD || 0) + 
                  (state.s2Track.patternPref.THREE || 0);
    
    if (total > 0) {
      const rates = {
        MONO: (state.s2Track.patternPref.MONO || 0) / total,
        GUILD: (state.s2Track.patternPref.GUILD || 0) / total,
        THREE: (state.s2Track.patternPref.THREE || 0) / total
      };
      
      patternPreference = Object.entries(rates)
        .sort((a,b) => b[1] - a[1])[0][0];
      
      console.log('Pattern preferences:', 
        Object.entries(rates).map(([p,v]) => `${p}:${Math.round(v*100)}%`).join(', '));
      console.log('Preferred pattern:', patternPreference);
    }
  }
  
  // Determine identity based on number of active colors
  let identity = null;
  let confidence = 'MODERATE';
  
  if (numActive === 1) {
    // MONO-COLOR
    identity = 'MONO-' + activeColors[0][0].toUpperCase();
    
    // Validate against pattern preference
    if (patternPreference === 'MONO') {
      confidence = activeColors[0][1] >= 0.75 ? 'HIGH' : 'MODERATE';
    } else {
      confidence = 'LOW'; // Pattern preference conflicts
      console.log('WARNING: Pattern preference was', patternPreference, 'but color activation suggests MONO');
    }
  }
  else if (numActive === 2) {
    // GUILD (two-color)
    const guildColors = activeColors.slice(0, 2).map(c => c[0]).sort().join('');
    identity = getGuild(guildColors);
    
    // Validate against pattern preference
    if (patternPreference === 'GUILD' || patternPreference === null) {
      const gap = sorted[1][1] - sorted[2][1];
      confidence = gap >= 0.15 ? 'HIGH' : 'MODERATE';
    } else if (patternPreference === 'THREE') {
      confidence = 'LOW'; // They prefer three-color but only 2 colors active
      console.log('WARNING: Pattern preference was THREE but only 2 colors active');
    } else {
      confidence = 'MODERATE';
    }
  }
  else if (numActive === 3) {
    // THREE-COLOR
    const threeColors = activeColors.slice(0, 3).map(c => c[0]).sort().join('');
    identity = getThree(threeColors);
    
    // Validate against pattern preference
    if (patternPreference === 'THREE' || patternPreference === null) {
      const gap = sorted[2][1] - sorted[3][1];
      confidence = gap >= 0.12 ? 'HIGH' : 'MODERATE';
    } else if (patternPreference === 'GUILD') {
      confidence = 'LOW'; // They prefer guild but 3 colors active
      console.log('WARNING: Pattern preference was GUILD but 3 colors active');
    } else {
      confidence = 'MODERATE';
    }
  }
  else if (numActive === 4) {
    // FOUR-COLOR
    const absentColor = sorted[4][0];
    identity = getFour(absentColor);
    
    const gap = sorted[3][1] - sorted[4][1];
    confidence = gap >= 0.20 ? 'MODERATE' : 'LOW';
  }
  else if (numActive === 5) {
    // All 5 colors genuinely active
    identity = 'WUBRG';
    const spread = sorted[0][1] - sorted[4][1];
    confidence = spread < 0.15 ? 'MODERATE' : 'LOW';
  }
  else if (numActive === 0) {
    // NO colors crossed 60% threshold - need fallback strategy
    console.log('‚ö†Ô∏è No colors crossed 60% threshold, using fallback classification');
    
    // Strategy: Use 50% threshold as fallback
    const FALLBACK_THRESHOLD = 0.50;
    const fallbackActive = sorted.filter(([c, v]) => v >= FALLBACK_THRESHOLD);
    
    console.log(`Fallback active colors (>50%):`, 
      fallbackActive.map(([c,v]) => `${c}(${Math.round(v*100)}%)`).join(', '));
    
    if (fallbackActive.length === 0) {
      // Still nothing? Take top 3 colors by combined score
      const top3 = sorted.slice(0, 3);
      const colors = top3.map(c => c[0]).sort().join('');
      identity = getThree(colors);
      confidence = 'LOW';
      console.log(`Using top 3 colors by combined score: ${identity}`);
    }
    else if (fallbackActive.length === 1) {
      identity = 'MONO-' + fallbackActive[0][0].toUpperCase();
      confidence = 'LOW';
    }
    else if (fallbackActive.length === 2) {
      const guildColors = fallbackActive.map(c => c[0]).sort().join('');
      identity = getGuild(guildColors);
      confidence = 'LOW';
    }
    else if (fallbackActive.length === 3) {
      const threeColors = fallbackActive.map(c => c[0]).sort().join('');
      identity = getThree(threeColors);
      confidence = 'LOW';
    }
    else if (fallbackActive.length === 4) {
      const absentColor = sorted[4][0];
      identity = getFour(absentColor);
      confidence = 'LOW';
    }
    else {
      // All 5 colors >50% but none >60%
      identity = 'WUBRG';
      const spread = sorted[0][1] - sorted[4][1];
      confidence = spread < 0.15 ? 'MODERATE' : 'LOW';
    }
  }
  else {
    // Shouldn't reach here, but catch-all just in case
    console.error('‚ö†Ô∏è Unexpected numActive:', numActive);
    identity = 'WUBRG';
    confidence = 'LOW';
  }
  
  console.log(`FINAL RESULT: ${identity}`);
  console.log(`Confidence: ${confidence}`);
  console.log(`Active colors: ${numActive} (${activeColors.map(([c,v]) => c).join(',')})`);
  console.log('=======================');
  
  // Build allResults for alternatives display
  let allResults = [];
  
  // Determine which colors to use for scoring
  // If numActive > 0, use activeColors; otherwise use all colors in identity
  let colorsForScoring;
  if (numActive > 0) {
    colorsForScoring = activeColors.slice(0, numActive);
  } else {
    // Extract colors from identity
    const identityColors = PROFILES[identity]?.colors || [];
    colorsForScoring = identityColors.map(c => [c, combinedActivation[c]]);
  }
  
  // Add primary result
  const primaryData = {
    s1: colorsForScoring.reduce((sum, [c,v]) => sum + (activationR1[c] || 0), 0) / Math.max(1, colorsForScoring.length),
    s2: colorsForScoring.reduce((sum, [c,v]) => sum + (colorActivationR2[c] || 0), 0) / Math.max(1, colorsForScoring.length),
    combined: colorsForScoring.reduce((sum, [c,v]) => sum + (v || 0), 0) / Math.max(1, colorsForScoring.length),
    appeared: totalSelections,
    selected: totalSelections
  };
  allResults.push([identity, primaryData]);
  
  // Generate alternatives for LOW confidence results
  if (confidence === 'LOW') {
    console.log('Generating alternatives for LOW confidence', identity);
    
    if (numActive === 1) {
      // MONO-COLOR: Show top 3 guilds using that color
      const monoColor = activeColors[0][0];
      const otherColors = sorted.filter(c => c[0] !== monoColor).slice(0, 3);
      
      otherColors.forEach(([color2, act2]) => {
        const guildColors = [monoColor, color2].sort().join('');
        const guildId = getGuild(guildColors);
        if (guildId && PROFILES[guildId] && !allResults.find(a => a[0] === guildId)) {
          const guildScore = (sorted.find(c => c[0] === monoColor)[1] + act2) / 2;
          allResults.push([guildId, {
            s1: (activationR1[monoColor] + activationR1[color2]) / 2,
            s2: (colorActivationR2[monoColor] + colorActivationR2[color2]) / 2,
            combined: guildScore
          }]);
        }
      });
      
      console.log('Generated guild alternatives:', allResults.slice(1).map(a => a[0]).join(', '));
    }
    else if (numActive === 2) {
      // GUILD: Show component monos + possible three-color
      const [c1, c2] = activeColors.slice(0, 2).map(c => c[0]);
      
      // Add mono options
      const mono1 = 'MONO-' + c1.toUpperCase();
      const mono2 = 'MONO-' + c2.toUpperCase();
      if (!allResults.find(a => a[0] === mono1)) {
        allResults.push([mono1, {s1: activationR1[c1], s2: colorActivationR2[c1], combined: sorted.find(c => c[0] === c1)[1]}]);
      }
      if (!allResults.find(a => a[0] === mono2)) {
        allResults.push([mono2, {s1: activationR1[c2], s2: colorActivationR2[c2], combined: sorted.find(c => c[0] === c2)[1]}]);
      }
      
      // Add three-color if third color is strong enough
      if (sorted[2] && sorted[2][1] >= 0.50) {
        const c3 = sorted[2][0];
        const threeId = getThree([c1, c2, c3].sort().join(''));
        if (threeId && PROFILES[threeId] && !allResults.find(a => a[0] === threeId)) {
          allResults.push([threeId, {
            s1: (activationR1[c1] + activationR1[c2] + activationR1[c3]) / 3,
            s2: (colorActivationR2[c1] + colorActivationR2[c2] + colorActivationR2[c3]) / 3,
            combined: (sorted[0][1] + sorted[1][1] + sorted[2][1]) / 3
          }]);
        }
      }
      
      console.log('Generated alternatives for guild:', allResults.slice(1).map(a => a[0]).join(', '));
    }
    else if (numActive === 3) {
      // THREE-COLOR: Show component guilds
      const [c1, c2, c3] = activeColors.slice(0, 3).map(c => c[0]);
      const pairs = [[c1,c2], [c1,c3], [c2,c3]];
      
      pairs.forEach(([ca, cb]) => {
        const guildColors = [ca, cb].sort().join('');
        const guildId = getGuild(guildColors);
        if (guildId && PROFILES[guildId] && !allResults.find(a => a[0] === guildId)) {
          allResults.push([guildId, {
            s1: (activationR1[ca] + activationR1[cb]) / 2,
            s2: (colorActivationR2[ca] + colorActivationR2[cb]) / 2,
            combined: (sorted.find(c => c[0] === ca)[1] + sorted.find(c => c[0] === cb)[1]) / 2
          }]);
        }
      });
      
      console.log('Generated component guilds:', allResults.slice(1).map(a => a[0]).join(', '));
    }
    else if (numActive === 4) {
      // FOUR-COLOR: Show top 3 three-color combinations
      const top4 = sorted.slice(0, 4).map(c => c[0]);
      const threeCombos = [
        [top4[0], top4[1], top4[2]],
        [top4[0], top4[1], top4[3]],
        [top4[0], top4[2], top4[3]]
      ];
      
      threeCombos.forEach(combo => {
        const threeId = getThree(combo.sort().join(''));
        if (threeId && PROFILES[threeId] && !allResults.find(a => a[0] === threeId)) {
          const avgScore = combo.reduce((sum, c) => sum + sorted.find(sc => sc[0] === c)[1], 0) / 3;
          allResults.push([threeId, {
            s1: combo.reduce((sum, c) => sum + activationR1[c], 0) / 3,
            s2: combo.reduce((sum, c) => sum + colorActivationR2[c], 0) / 3,
            combined: avgScore
          }]);
        }
      });
      
      console.log('Generated three-color alternatives:', allResults.slice(1).map(a => a[0]).join(', '));
    }
    else if (numActive === 5 || (numActive === 0 && identity === 'WUBRG')) {
      // FIVE-COLOR: Show top 3 three-color combinations
      const top4Colors = sorted.slice(0, 4).map(c => c[0]);
      const threeCombos = [
        [top4Colors[0], top4Colors[1], top4Colors[2]],
        [top4Colors[0], top4Colors[1], top4Colors[3]],
        [top4Colors[1], top4Colors[2], top4Colors[3]]
      ];
      
      threeCombos.forEach(combo => {
        const threeId = getThree(combo.sort().join(''));
        if (threeId && PROFILES[threeId] && !allResults.find(a => a[0] === threeId)) {
          const avgScore = combo.reduce((sum, c) => sum + sorted.find(sc => sc[0] === c)[1], 0) / 3;
          allResults.push([threeId, {
            s1: combo.reduce((sum, c) => sum + activationR1[c], 0) / 3,
            s2: combo.reduce((sum, c) => sum + colorActivationR2[c], 0) / 3,
            combined: avgScore
          }]);
        }
      });
      
      console.log('Generated three-color alternatives for five-color:', allResults.slice(1).map(a => a[0]).join(', '));
    }
    
    // Fallback: If no alternatives were generated (e.g., numActive=0 with non-FIVE-COLOR identity)
    if (allResults.length === 1) {
      console.log('‚ö†Ô∏è No alternatives generated, using generic fallback');
      
      // Generate alternatives based on actual identity
      if (identity.startsWith('MONO-')) {
        // Mono fallback: top 3 guilds
        const monoColor = identity.split('-')[1].toLowerCase();
        const otherColors = sorted.filter(c => c[0] !== monoColor).slice(0, 3);
        otherColors.forEach(([c2, v2]) => {
          const guildId = getGuild([monoColor, c2].sort().join(''));
          if (guildId && PROFILES[guildId] && !allResults.find(a => a[0] === guildId)) {
            allResults.push([guildId, {
              s1: (activationR1[monoColor] + activationR1[c2]) / 2,
              s2: (colorActivationR2[monoColor] + colorActivationR2[c2]) / 2,
              combined: (combinedActivation[monoColor] + v2) / 2
            }]);
          }
        });
      } else {
        // Guild/Three-color fallback: use top 3 colors by combined score
        const top3 = sorted.slice(0, 3);
        [0, 1, 2].forEach(i => {
          [i+1, i+2].filter(j => j < 3).forEach(j => {
            const pair = [top3[i][0], top3[j][0]].sort().join('');
            const guildId = getGuild(pair);
            if (guildId && PROFILES[guildId] && !allResults.find(a => a[0] === guildId)) {
              allResults.push([guildId, {
                s1: (activationR1[top3[i][0]] + activationR1[top3[j][0]]) / 2,
                s2: (colorActivationR2[top3[i][0]] + colorActivationR2[top3[j][0]]) / 2,
                combined: (top3[i][1] + top3[j][1]) / 2
              }]);
            }
          });
        });
      }
      console.log('Generated fallback alternatives:', allResults.slice(1).map(a => a[0]).join(', '));
    }
    
    // Sort alternatives by combined score
    const winner = allResults[0];
    const alternatives = allResults.slice(1).sort((a,b) => b[1].combined - a[1].combined);
    allResults = [winner, ...alternatives];
    
    console.log('Final allResults with alternatives:', allResults.map(a => `${a[0]}(${Math.round(a[1].combined*100)}%)`).join(', '));
  } else {
    // For MODERATE/HIGH confidence, only add borderline alternatives
    if (numActive >= 2 && sorted[numActive] && sorted[numActive][1] >= 0.50) {
      // Borderline next color - could be one more
      if (numActive === 2) {
        // Could be three-color
        const altThree = getThree(sorted.slice(0,3).map(c => c[0]).sort().join(''));
        if (altThree && PROFILES[altThree]) {
          allResults.push([altThree, {s1: 0, s2: 0, combined: sorted[2][1]}]);
        }
      }
    }
  }
  
  state.result = {identity, confidence, s2Data: primaryData, allResults};
  
  showCalculating();
}

function showCalculating() {
  document.getElementById('screen-assessment').classList.add('hidden');
  document.getElementById('screen-calculating').classList.remove('hidden');
  
  // Show calculating for 2 seconds then show results
  setTimeout(() => {
    document.getElementById('screen-calculating').classList.add('hidden');
    showResults();
  }, 2000);
}

function generateIdentityExplanation(identity, activationSorted) {
  const pct = (act) => Math.round(act * 100);
  const colorName = {W:'White', U:'Blue', B:'Black', R:'Red', G:'Green'};
  
  // Get guild/three-color/etc colors
  let idColors = [];
  if (identity.startsWith('MONO-')) {
    idColors = [identity.split('-')[1]];
  } else if (PROFILES[identity]) {
    idColors = PROFILES[identity].colors;
  }
  
  const top3 = activationSorted.slice(0, 3);
  const top2 = activationSorted.slice(0, 2);
  
  // Generate explanation based on pattern
  if (identity.startsWith('MONO-')) {
    const color = idColors[0];
    const topPct = pct(activationSorted[0][1]);
    const secondPct = pct(activationSorted[1][1]);
    return `Your dominant color is ${colorName[color]} (${topPct}%), significantly stronger than your next color (${secondPct}%). This makes you mono-${colorName[color]}.`;
  }
  else if (idColors.length === 2) {
    // Guild - use the IDENTITY'S colors, not just top 2 from sorted
    const c1 = idColors[0], c2 = idColors[1];
    const c1Pct = pct(activationSorted.find(c => c[0] === c1)?.[1] || 0);
    const c2Pct = pct(activationSorted.find(c => c[0] === c2)?.[1] || 0);
    
    // Check if other colors are very close to the guild colors
    const sorted = activationSorted;
    const thirdPct = sorted[2] ? pct(sorted[2][1]) : 0;
    const fourthPct = sorted[3] ? pct(sorted[3][1]) : 0;
    
    // If 3rd or 4th color is within 10% of guild colors, acknowledge the tie
    if (Math.abs(thirdPct - c2Pct) < 10 || Math.abs(fourthPct - c2Pct) < 10) {
      // Use the ACTUAL identity colors, not top 2 from sorted
      return `Your top colors are ${colorName[c1]} (${c1Pct}%) and ${colorName[c2]} (${c2Pct}%), making you ${identity}. However, you have multiple colors close together‚Äîyou're genuinely borderline.`;
    }
    
    const diff = Math.abs(c1Pct - c2Pct);
    if (diff < 8) {
      return `Your top two colors are ${colorName[c1]} (${c1Pct}%) and ${colorName[c2]} (${c2Pct}%)‚Äînearly equal, making you ${identity}.`;
    } else {
      return `Your top two colors are ${colorName[c1]} (${c1Pct}%) and ${colorName[c2]} (${c2Pct}%), making you ${identity}.`;
    }
  }
  else if (idColors.length === 3) {
    // Three-color
    const pcts = idColors.map(c => pct(activationSorted.find(ac => ac[0] === c)?.[1] || 0));
    const names = idColors.map(c => colorName[c]);
    return `Your top three colors are ${names[0]} (${pcts[0]}%), ${names[1]} (${pcts[1]}%), and ${names[2]} (${pcts[2]})‚Äîall clustered together, making you ${identity}. You blend all three rather than focusing on just two.`;
  }
  else if (idColors.length === 4) {
    const absent = ['W','U','B','R','G'].find(c => !idColors.includes(c));
    const absentPct = pct(activationSorted.find(c => c[0] === absent)?.[1] || 0);
    return `You have four colors activated, with ${colorName[absent]} clearly absent (${absentPct}%). This makes you four-color (no ${colorName[absent]}).`;
  }
  else {
    const variance = pct(top3[0][1]) - pct(activationSorted[4][1]);
    return `All five colors are active and balanced (${pct(activationSorted[4][1])}-${pct(top3[0][1])}%), making you five-color. You are genuinely versatile or context-dependent.`;
  }
}

// ============================================================================
// ENHANCEMENT: Pattern Testing Display (Stage 2 only)
// ============================================================================
function displayRoundPatterns() {
  // Display Stage 1 explanation
  displayStage1Explanation();
  
  // Display Stage 2 if it happened
  const hasStage2 = state.result.allResults && state.result.allResults[0] && state.result.allResults[0][1].s2 !== undefined;
  if (hasStage2) {
    displayRound2Bars();
    // Section starts hidden - user must click Mana Pool to expand
  } else {
    document.getElementById('decision-patterns-section').style.display = 'none';
  }
}

function displayStage1Explanation() {
  const container = document.getElementById('stage1-explanation-content');
  if (!container) return;
  
  // Get activation from state
  let activation;
  if (state.activationSorted && state.activationSorted.length > 0) {
    activation = {};
    state.activationSorted.forEach(([color, value]) => {
      activation[color] = value;
    });
  } else {
    // Recalculate if not available
    activation = {
      W: (state.pairwise['W-B'].W / 6 + state.pairwise['W-R'].W / 6) / 2,
      U: (state.pairwise['U-R'].U / 6 + state.pairwise['G-U'].U / 6) / 2,
      B: (state.pairwise['W-B'].B / 6 + state.pairwise['B-G'].B / 6) / 2,
      R: (state.pairwise['U-R'].R / 6 + state.pairwise['W-R'].R / 6) / 2,
      G: (state.pairwise['G-U'].G / 6 + state.pairwise['B-G'].G / 6) / 2
    };
  }
  
  const sorted = Object.entries(activation).sort((a,b) => b[1] - a[1]);
  
  let html = '';
  
  // Show activation bars
  html += '<div style="margin-bottom: 24px;">';
  html += '<div style="font-size: 14px; font-weight: 600; color: #e0e0e0; margin-bottom: 12px;">Color Activation Strength</div>';
  html += '<div style="font-size: 13px; color: #a0a0b0; margin-bottom: 16px;">Based on 30 forced-choice questions testing enemy color pairs</div>';
  
  const colorNames = { W: 'WHITE', U: 'BLUE', B: 'BLACK', R: 'RED', G: 'GREEN' };
  const barColors = {W:'#FDE047', U:'#93C5FD', B:'#D1D5DB', R:'#FCA5A5', G:'#6EE7B7'};
  
  sorted.forEach(([color, value], idx) => {
    const pct = Math.round(value * 100);
    const isActive = PROFILES[state.result.identity]?.colors?.includes(color);
    
    html += '<div style="margin: 12px 0; padding: 12px; background: rgba(255,255,255,' + (isActive ? '0.05' : '0.02') + '); border: 1px solid rgba(255,255,255,' + (isActive ? '0.2' : '0.1') + '); border-radius: 8px;">';
    html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">';
    html += '<div style="display: flex; align-items: center; gap: 12px;">';
    html += '<span class="mana-symbol mana-' + color + '" style="width: 24px; height: 24px; font-size: 12px;">' + color + '</span>';
    html += '<span style="font-weight: 600; font-size: 15px; color: ' + (isActive ? '#e0e0e0' : '#808090') + ';">' + colorNames[color] + '</span>';
    if (isActive) {
      html += '<span style="font-size: 12px; color: #10B981; font-weight: 600;">‚úì IN YOUR IDENTITY</span>';
    }
    html += '</div>';
    html += '<span style="font-weight: 600; font-size: 16px; color: ' + barColors[color] + ';">' + pct + '%</span>';
    html += '</div>';
    html += '<div style="background: rgba(255,255,255,0.1); height: 12px; border-radius: 6px; overflow: hidden;">';
    html += '<div style="background: ' + barColors[color] + '; width: ' + pct + '%; height: 100%; border-radius: 6px; transition: width 0.8s;"></div>';
    html += '</div>';
    html += '</div>';
  });
  
  html += '</div>';
  
  // Explain the gap detection
  const topColors = PROFILES[state.result.identity]?.colors || [];
  const numColors = topColors.length;
  
  html += '<div style="padding: 16px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 10px; margin-top: 16px;">';
  html += '<div style="font-weight: 700; color: #10B981; margin-bottom: 8px;">üéØ Gap Detection Logic</div>';
  html += '<div style="font-size: 14px; color: #c0d0c0; line-height: 1.7;">';
  
  if (numColors === 1) {
    html += 'We found a <strong>large gap</strong> after the top color (' + Math.round(sorted[0][1] * 100) + '% vs ' + Math.round(sorted[1][1] * 100) + '%). ';
    html += 'This indicates <strong>mono-color</strong>: one dominant philosophy.';
  } else if (numColors === 2) {
    html += 'The top 2 colors scored significantly higher (' + Math.round(sorted[0][1] * 100) + '% and ' + Math.round(sorted[1][1] * 100) + '%) with a gap before the third (' + Math.round(sorted[2][1] * 100) + '%). ';
    html += 'This indicates <strong>two-color guild</strong>: two complementary philosophies.';
  } else if (numColors === 3) {
    html += 'The top 3 colors clustered together (' + Math.round(sorted[0][1] * 100) + '%, ' + Math.round(sorted[1][1] * 100) + '%, ' + Math.round(sorted[2][1] * 100) + '%) with a gap before the fourth (' + Math.round(sorted[3][1] * 100) + '%). ';
    html += 'This indicates <strong>three-color</strong>: three interacting philosophies.';
  } else if (numColors === 4) {
    html += 'The top 4 colors were all strong (' + Math.round(sorted[0][1] * 100) + '%-' + Math.round(sorted[3][1] * 100) + '%) with ' + colorNames[sorted[4][0]] + ' clearly weaker (' + Math.round(sorted[4][1] * 100) + '%). ';
    html += 'This indicates <strong>four-color</strong>: defined by what\'s missing.';
  } else {
    html += 'All 5 colors scored within a narrow range (' + Math.round(sorted[0][1] * 100) + '%-' + Math.round(sorted[4][1] * 100) + '%). ';
    html += 'This indicates <strong>five-color</strong>: balanced across all philosophies.';
  }
  
  html += '</div>';
  html += '</div>';
  
  container.innerHTML = html;
}

function displayRound2Bars() {
  const r2Bars = document.getElementById('round2-bars');
  if (!r2Bars) return;
  
  r2Bars.innerHTML = '';
  
  if (!state.result.s2Data || !state.s2Track.colorFreq) {
    document.getElementById('decision-patterns-section').style.display = 'none';
    return;
  }
  
  const totalSelections = state.result.s2Data.appeared || 0;
  if (totalSelections === 0) {
    document.getElementById('decision-patterns-section').style.display = 'none';
    return;
  }
  
  const colorNames = {W:'White', U:'Blue', B:'Black', R:'Red', G:'Green'};
  const colorFreq = state.s2Track.colorFreq;
  const winnerColors = PROFILES[state.result.identity]?.colors || [];
  
  const colorData = ['W','U','B','R','G'].map(c => ({
    color: c,
    name: colorNames[c],
    freq: colorFreq[c] || 0,
    rate: totalSelections > 0 ? (colorFreq[c] || 0) / totalSelections : 0,
    inIdentity: winnerColors.includes(c)
  })).sort((a,b) => b.rate - a.rate);
  
  let html = '<div style="margin-bottom: 20px;">';
  html += '<div style="font-size: 15px; font-weight: 700; color: #d0d0d0; margin-bottom: 16px;">üé® Round 2 Color Frequency</div>';
  html += '<div style="font-size: 13px; color: #a0a0b0; margin-bottom: 16px;">How often each color appeared in your Round 2 selections:</div>';
  
  colorData.forEach(c => {
    const pct = Math.round(c.rate * 100);
    const isActive = c.rate >= 0.60;
    const barColor = c.inIdentity ? 'linear-gradient(90deg, #a78bfa, #ec4899)' : 'rgba(139, 92, 246, 0.3)';
    
    html += `<div style="margin: 12px 0; ${isActive ? 'padding: 12px; background: rgba(139, 92, 246, 0.08); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px;' : ''}">`;
    html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">`;
    html += `<div style="display: flex; align-items: center; gap: 8px;">`;
    html += `<span class="mana-symbol mana-${c.color}" style="width: 20px; height: 20px; font-size: 11px;">${c.color}</span>`;
    html += `<span style="font-weight: ${c.inIdentity ? '700' : '500'}; color: ${c.inIdentity ? '#c4b5fd' : '#e0e0e0'};">${c.inIdentity ? '‚úì ' : ''}${c.name}</span>`;
    if (isActive) {
      html += `<span style="font-size: 11px; color: #10B981; font-weight: 600; text-transform: uppercase;">ACTIVE</span>`;
    }
    html += `</div>`;
    html += `<span style="color: ${c.inIdentity ? '#c4b5fd' : '#a0a0b0'}; font-weight: 600;">${pct}%</span>`;
    html += `</div>`;
    html += `<div style="background: rgba(255,255,255,0.08); height: 10px; border-radius: 5px; position: relative;">`;
    html += `<div style="position: absolute; left: 60%; top: 0; bottom: 0; width: 1px; background: rgba(16, 185, 129, 0.5);"></div>`;
    html += `<div style="background: ${barColor}; width: ${pct}%; height: 100%; border-radius: 5px;"></div>`;
    html += `</div>`;
    html += `</div>`;
  });
  
  html += '<div style="font-size: 12px; color: #808090; margin-top: 12px; font-style: italic;">Colors appearing in >60% of selections are considered active and part of your identity.</div>';
  html += '</div>';
  
  r2Bars.innerHTML = html;
  
  const activeColorsList = winnerColors
    .filter(c => (colorFreq[c] || 0) / totalSelections >= 0.60)
    .map(c => `${colorNames[c]} (${Math.round(((colorFreq[c] || 0) / totalSelections) * 100)}%)`)
    .join(', ');
  
  let explanation;
  if (activeColorsList.length > 0) {
    const plural = winnerColors.length > 1 ? 'colors are' : 'color is';
    explanation = `Round 2 validated ${PROFILES[state.result.identity]?.name || state.result.identity}: ${activeColorsList} appeared consistently in your selections, confirming this ${plural} genuinely active in your decision-making.`;
  } else {
    explanation = `Round 2 testing confirmed ${PROFILES[state.result.identity]?.name || state.result.identity} based on your selection patterns.`;
  }
  
  document.getElementById('round2-note').textContent = explanation;
}


// ============================================================================
// ENHANCEMENT: Modal Deep Dive System  
// ============================================================================
function openModal(id) {
  const profile = PROFILES[id];
  if (!profile) {
    console.error('Profile not found:', id);
    return;
  }
  
  // Populate header
  let headerHTML = '<div style="display: flex; justify-content: center; gap: 12px; margin-bottom: 16px;">';
  profile.colors.forEach(c => {
    headerHTML += `<span class="mana-symbol mana-${c}" style="width: 36px; height: 36px; font-size: 18px;">${c}</span>`;
  });
  headerHTML += '</div>';
  headerHTML += `<h2 style="font-size: 32px; font-weight: 800; text-align: center; margin-bottom: 8px; color: #e0e0e0;">${profile.name}</h2>`;
  headerHTML += `<p style="font-size: 18px; color: #a78bfa; text-align: center; font-style: italic;">${profile.tag}</p>`;
  
  document.getElementById('modal-header').innerHTML = headerHTML;
  
  // Populate all tab contents
  document.getElementById('tab-overview').innerHTML = getOverviewContent(id);
  document.getElementById('tab-philosophy').innerHTML = getPhilosophyContent(id);
  document.getElementById('tab-workplace').innerHTML = getWorkplaceContent(id);
  document.getElementById('tab-stress').innerHTML = getStressContent(id);
  document.getElementById('tab-development').innerHTML = getDevelopmentContent(id);
  
  // Reset to overview tab
  document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('tab-overview').classList.remove('hidden');
  document.querySelector('.tab-btn').classList.add('active');
  
  // Show modal
  document.getElementById('modal-overlay').classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}

function closeModal() {
  document.getElementById('modal-overlay').classList.add('hidden');
  document.body.style.overflow = 'auto';
}

function switchModalTab(event, tabName) {
  // Hide all tabs
  document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  
  // Show selected tab
  document.getElementById('tab-' + tabName).classList.remove('hidden');
  event.target.classList.add('active');
}

function showDeepDive(type, id) {
  // Now just opens modal with all tabs, starting on overview
  openModal(id);
}

// ============================================================================
// MODAL CONTENT GENERATION - All 5 Tabs with Rich Content
// ============================================================================

function getOverviewContent(id) {
  const profile = PROFILES[id];
  if (!profile) return '<p>Content not available</p>';
  
  const type = getCandidateType(id);
  let html = '';
  
  // Core philosophy
  html += `<div class="info-box" style="border-left-color: #a78bfa;">
    <div class="box-header">
      <span style="font-size: 20px;">üîÆ</span>
      <h4>Core Philosophy</h4>
    </div>
    <div class="box-content">
      <p style="font-size: 15px; line-height: 1.8;">${profile.desc}</p>
    </div>
  </div>`;
  
  // Quick Facts for multi-color
  if (type === 'GUILD' || type === 'THREE') {
    html += getQuickFacts(id, profile, type);
  }
  
  // Top 3 Strengths
  html += `<div class="info-box strength">
    <div class="box-header">
      <span style="font-size: 20px;">‚öîÔ∏è</span>
      <h4>Top Strengths</h4>
    </div>
    <div class="box-content">
      <ul>`;
  profile.str.slice(0, 3).forEach(s => {
    html += `<li>‚Ä¢ ${s}</li>`;
  });
  html += `</ul>
      <p style="font-size: 13px; color: #808090; margin-top: 12px; font-style: italic;">See Workplace tab for all ${profile.str.length} strengths</p>
    </div>
  </div>`;
  
  // Top 3 Shadows
  html += `<div class="info-box shadow">
    <div class="box-header">
      <span style="font-size: 20px;">‚ö†Ô∏è</span>
      <h4>Top Shadows</h4>
    </div>
    <div class="box-content">
      <ul>`;
  profile.weak.slice(0, 3).forEach(w => {
    html += `<li>‚Ä¢ ${w}</li>`;
  });
  html += `</ul>
      <p style="font-size: 13px; color: #808090; margin-top: 12px; font-style: italic;">See Workplace tab for all ${profile.weak.length} shadows</p>
    </div>
  </div>`;
  
  html += `<p style="font-size: 13px; color: #808090; text-align: center; margin-top: 32px; font-style: italic;">
    Click the tabs above to explore philosophy, workplace patterns, stress responses, and development paths.
  </p>`;
  
  return html;
}

function getQuickFacts(id, profile, type) {
  const colorNames = {W:'White', U:'Blue', B:'Black', R:'Red', G:'Green'};
  let html = `<div class="info-box" style="border-left-color: #60A5FA;">
    <div class="box-header">
      <span style="font-size: 20px;">üìä</span>
      <h4>Quick Facts</h4>
    </div>
    <div class="box-content">`;
  
  if (type === 'GUILD') {
    const colors = profile.colors;
    const absent = ['W','U','B','R','G'].filter(c => !colors.includes(c));
    
    html += `<div class="quick-fact">
      <strong>Partnership:</strong>
      <p style="margin: 0; color: #d0d0d0;">${colorNames[colors[0]]} + ${colorNames[colors[1]]} combine for unique synergy.</p>
    </div>`;
    
    html += `<div class="quick-fact">
      <strong>What's Absent:</strong>
      <p style="margin: 0; color: #d0d0d0;">No ${absent.map(c => colorNames[c]).join(', ')}. This shapes your approach as much as what you have.</p>
    </div>`;
    
    const isAllied = isAlliedPair(colors);
    html += `<div class="quick-fact">
      <strong>${isAllied ? 'Allied Pair' : 'Enemy Pair'}:</strong>
      <p style="margin: 0; color: #d0d0d0;">${isAllied ? 'Colors reinforce each other smoothly' : 'Productive tension between opposing values'}.</p>
    </div>`;
    
  } else if (type === 'THREE') {
    const colors = profile.colors;
    const absent = ['W','U','B','R','G'].filter(c => !colors.includes(c));
    
    html += `<div class="quick-fact">
      <strong>Three-Color Identity:</strong>
      <p style="margin: 0; color: #d0d0d0;">Versatile and complete‚Äîonly lacks 2 colors instead of 3 or 4.</p>
    </div>`;
    
    html += `<div class="quick-fact">
      <strong>Common Enemies:</strong>
      <p style="margin: 0; color: #d0d0d0;">${absent.map(c => colorNames[c]).join(' and ')}. Your identity is defined by lacking these two.</p>
    </div>`;
  }
  
  html += `</div></div>`;
  return html;
}

function isAlliedPair(colors) {
  if (colors.length !== 2) return false;
  const alliedPairs = [['W','U'], ['U','B'], ['B','R'], ['R','G'], ['G','W']];
  const sorted = [colors[0], colors[1]].sort().join('');
  return alliedPairs.some(p => p.join('') === sorted);
}

function getPhilosophyContent(id) {
  const profile = PROFILES[id];
  if (!profile) return '<p>Content not available</p>';
  
  const type = getCandidateType(id);
  let html = '';
  
  if (type === 'GUILD') {
    html += getGuildPhilosophy(id, profile);
  } else if (type === 'THREE') {
    html += getThreeColorPhilosophy(id, profile);
  } else if (type === 'MONO') {
    html += getMonoPhilosophy(id, profile);
  } else {
    html += `<div class="info-box">
      <div class="box-content">
        <p style="font-size: 15px; line-height: 1.8;">${profile.desc}</p>
      </div>
    </div>`;
  }
  
  return html;
}

function getGuildPhilosophy(id, profile) {
  const colorNames = {W:'White', U:'Blue', B:'Black', R:'Red', G:'Green'};
  const colors = profile.colors;
  const absent = ['W','U','B','R','G'].filter(c => !colors.includes(c));
  
  let html = '';
  
  html += `<div class="info-box">
    <div class="box-header">
      <span style="font-size: 20px;">ü§ù</span>
      <h4>What ${colorNames[colors[0]]} & ${colorNames[colors[1]]} Share</h4>
    </div>
    <div class="box-content">
      <p>Both colors value certain approaches, and when combined, these shared values get <strong>EMPHASIZED</strong>.</p>
      <p style="margin-top: 16px; padding: 16px; background: rgba(139,92,246,0.1); border-radius: 8px;">
        <strong style="color: #c4b5fd;">Together:</strong> They reinforce each other's core philosophy, creating something stronger than either alone.
      </p>
    </div>
  </div>`;
  
  html += `<div class="info-box">
    <div class="box-header">
      <span style="font-size: 20px;">‚öñÔ∏è</span>
      <h4>The Productive Tension</h4>
    </div>
    <div class="box-content">
      <p>While ${colorNames[colors[0]]} and ${colorNames[colors[1]]} share core values, they <strong>DISAGREE</strong> on key points.</p>
      <p style="margin-top: 16px; font-style: italic; color: #d0d0d0;">
        This tension creates the unique character of ${profile.name}‚Äîyou balance two different perspectives.
      </p>
    </div>
  </div>`;
  
  html += `<div class="info-box">
    <div class="box-header">
      <span style="font-size: 20px;">‚ú®</span>
      <h4>What Emerges Uniquely</h4>
    </div>
    <div class="box-content">
      <p>${profile.name} creates patterns that <strong>neither color alone produces</strong>.</p>
      <p style="margin-top: 12px;">This isn't just "${colorNames[colors[0]]} AND ${colorNames[colors[1]]}"‚Äîit's a genuine fusion with emergent properties.</p>
    </div>
  </div>`;
  
  html += `<div class="info-box shadow">
    <div class="box-header">
      <span style="font-size: 20px;">üö´</span>
      <h4>What's Absent & Why It Matters</h4>
    </div>
    <div class="box-content">
      <p><strong>No ${absent.map(c => colorNames[c]).join(', ')}:</strong></p>
      <ul style="margin-top: 12px;">`;
  
  const absentMeanings = {
    W: {impact: 'No community focus or moral framework', result: 'Must work through efficiency, self-interest, or natural patterns'},
    U: {impact: 'No analytical depth or strategic planning', result: 'Must rely on instinct, tradition, passion, or pragmatism'},
    B: {impact: 'No self-interest or ruthless pragmatism', result: 'Naive about power dynamics, struggles with tough calls'},
    R: {impact: 'No passion, urgency, or emotional authenticity', result: 'Everything calm, measured, potentially too slow'},
    G: {impact: 'No patience, organic growth, or respect for tradition', result: 'Everything active, engineered, potentially unsustainable'}
  };
  
  absent.forEach(c => {
    const meaning = absentMeanings[c];
    html += `<li><strong>${colorNames[c]}:</strong> ${meaning.impact}
      <div style="font-size: 13px; color: #a0a0b0; margin-top: 4px;">‚Üí ${meaning.result}</div>
    </li>`;
  });
  
  html += `</ul>
      <p style="margin-top: 16px; padding: 12px; background: rgba(239,68,68,0.1); border-radius: 8px; border-left: 3px solid #EF4444;">
        <strong style="color: #EF4444;">Key insight:</strong> Your approach is defined by what you CAN'T do as much as what you can.
      </p>
    </div>
  </div>`;
  
  return html;
}

function getThreeColorPhilosophy(id, profile) {
  const colorNames = {W:'White', U:'Blue', B:'Black', R:'Red', G:'Green'};
  const colors = profile.colors;
  const absent = ['W','U','B','R','G'].filter(c => !colors.includes(c));
  
  let html = '';
  
  html += `<div class="info-box">
    <div class="box-header">
      <span style="font-size: 20px;">üéØ</span>
      <h4>What All Three Colors Seek</h4>
    </div>
    <div class="box-content">
      <p>${colorNames[colors[0]]}, ${colorNames[colors[1]]}, and ${colorNames[colors[2]]} all share philosophical common ground.</p>
      <p style="margin-top: 16px; padding: 16px; background: rgba(139,92,246,0.1); border-radius: 8px;">
        When three colors align, they create a <strong style="color: #c4b5fd;">complete and versatile identity</strong> with only minor blind spots (just 2 absent colors).
      </p>
    </div>
  </div>`;
  
  html += `<div class="info-box shadow">
    <div class="box-header">
      <span style="font-size: 20px;">‚öîÔ∏è</span>
      <h4>Common Enemies</h4>
    </div>
    <div class="box-content">
      <p><strong>${absent.map(c => colorNames[c]).join(' and ')}:</strong> All three of your colors oppose these two.</p>
      <p style="margin-top: 12px;">This shared opposition defines your blind spots:</p>
      <ul style="margin-top: 12px;">`;
  
  const absentMeanings = {
    W: 'No community focus‚Äîindividual or collective but not "fair for all"',
    U: 'No analytical optimization‚Äîinstinct and tradition guide you',
    B: 'No self-interest‚Äîeverything serves collective or natural order',
    R: 'No passion or urgency‚Äîcalm, measured, patient',
    G: 'No organic patience‚Äîeverything active and engineered'
  };
  
  absent.forEach(c => {
    html += `<li>‚Ä¢ ${absentMeanings[c]}</li>`;
  });
  
  html += `</ul>
    </div>
  </div>`;
  
  html += `<div class="info-box development">
    <div class="box-header">
      <span style="font-size: 20px;">üîÆ</span>
      <h4>Why Three-Color Is Different</h4>
    </div>
    <div class="box-content">
      <p><strong>You're more complete than simpler identities:</strong></p>
      <ul style="margin-top: 12px;">
        <li>‚Ä¢ Mono-color lacks 4 colors (major limitations)</li>
        <li>‚Ä¢ Two-color lacks 3 colors (significant gaps)</li>
        <li>‚Ä¢ <strong>Three-color lacks only 2 colors</strong> (minor blind spots)</li>
      </ul>
      <p style="margin-top: 16px;">This makes you versatile and adaptable, able to handle diverse situations. The trade-off: less focused than simpler identities.</p>
    </div>
  </div>`;
  
  return html;
}

function getMonoPhilosophy(id, profile) {
  const colorNames = {W:'White', U:'Blue', B:'Black', R:'Red', G:'Green'};
  const color = profile.colors[0];
  const others = ['W','U','B','R','G'].filter(c => c !== color);
  
  let html = '';
  
  html += `<div class="info-box">
    <div class="box-header">
      <span style="font-size: 20px;">üéØ</span>
      <h4>Pure ${colorNames[color]} Philosophy</h4>
    </div>
    <div class="box-content">
      <p style="font-size: 15px; line-height: 1.8;">${profile.desc}</p>
      <p style="margin-top: 16px; padding: 16px; background: rgba(139,92,246,0.1); border-radius: 8px;">
        <strong style="color: #c4b5fd;">Mono-color means:</strong> You're strongly focused in one philosophical direction. This gives you depth and clarity, but limits your range.
      </p>
    </div>
  </div>`;
  
  html += `<div class="info-box shadow">
    <div class="box-header">
      <span style="font-size: 20px;">üö´</span>
      <h4>What You Lack (Four Colors Absent)</h4>
    </div>
    <div class="box-content">
      <p>As a mono-color identity, you lack the perspectives and approaches of <strong>FOUR other colors:</strong></p>
      <ul style="margin-top: 12px;">
        ${others.map(c => `<li>‚Ä¢ No ${colorNames[c]}‚Äîmissing that entire dimension</li>`).join('')}
      </ul>
      <p style="margin-top: 16px; font-style: italic; color: #a0a0b0;">
        This is your biggest development opportunity. See Development tab for how to add other colors.
      </p>
    </div>
  </div>`;
  
  return html;
}

function getWorkplaceContent(id) {
  const profile = PROFILES[id];
  if (!profile) return '<p>Content not available</p>';
  
  let html = '';
  
  html += `<div class="info-box strength">
    <div class="box-header">
      <span style="font-size: 20px;">‚öîÔ∏è</span>
      <h4>Strengths</h4>
    </div>
    <div class="box-content">
      <p style="margin-bottom: 12px; color: #6b9080; font-style: italic;">Use them shamelessly</p>
      <ul>`;
  profile.str.forEach(s => {
    html += `<li>‚Ä¢ ${s}</li>`;
  });
  html += `</ul>
    </div>
  </div>`;
  
  html += `<div class="info-box shadow">
    <div class="box-header">
      <span style="font-size: 20px;">‚ö†Ô∏è</span>
      <h4>Shadows</h4>
    </div>
    <div class="box-content">
      <p style="margin-bottom: 12px; color: #9b6b6b; font-style: italic;">Your colleagues see this, but give you credit anyway</p>
      <ul>`;
  profile.weak.forEach(w => {
    html += `<li>‚Ä¢ ${w}</li>`;
  });
  html += `</ul>
    </div>
  </div>`;
  
  html += `<div class="info-box">
    <div class="box-header">
      <span style="font-size: 20px;">üìã</span>
      <h4>Where You Thrive</h4>
    </div>
    <div class="box-content">
      <p><strong>Stereotypical roles for this identity:</strong></p>
      <p style="margin-top: 12px; font-size: 15px; line-height: 1.6;">${profile.roles}</p>
      <p style="margin-top: 16px; font-size: 13px; color: #a0a0b0; font-style: italic;">
        These aren't limitations‚Äîthey're where this identity naturally excels. You can succeed anywhere, but these roles play to your strengths.
      </p>
    </div>
  </div>`;
  
  if (profile.pubBanter) {
    html += `<div class="info-box stress">
      <div class="box-header">
        <span style="font-size: 20px;">üç∫</span>
        <h4>What They Say Behind Your Back</h4>
      </div>
      <div class="box-content">
        <p style="font-style: italic; color: #d0a070; font-size: 15px; line-height: 1.6;">"${profile.pubBanter}"</p>
        <p style="margin-top: 16px; font-size: 13px; color: #a0a0b0;">
          The unvarnished truth. This is your shadow side from others' perspective.
        </p>
      </div>
    </div>`;
  }
  
  return html;
}

function getStressContent(id) {
  const profile = PROFILES[id];
  if (!profile) return '<p>Content not available</p>';
  
  let html = '';
  
  html += `<div class="info-box stress">
    <div class="box-header">
      <span style="font-size: 20px;">‚ö†Ô∏è</span>
      <h4>Under Pressure</h4>
    </div>
    <div class="box-content">
      <p><strong>When ${profile.name} is stressed, watch for:</strong></p>
      <ul style="margin-top: 12px;">`;
  
  const stressPatterns = getStressPatterns(id);
  stressPatterns.forEach(pattern => {
    html += `<li>‚Ä¢ ${pattern}</li>`;
  });
  
  html += `</ul>
      <p style="margin-top: 16px; padding: 12px; background: rgba(245,158,11,0.1); border-radius: 8px; border-left: 3px solid #F59E0B;">
        <strong style="color: #F59E0B;">For teams:</strong> If these patterns intensify, this identity is stressed and needs support.
      </p>
    </div>
  </div>`;
  
  html += `<div class="info-box development">
    <div class="box-header">
      <span style="font-size: 20px;">üîß</span>
      <h4>Recovery Strategies</h4>
    </div>
    <div class="box-content">
      <p><strong>For yourself:</strong></p>
      <ul style="margin-top: 8px; margin-bottom: 16px;">
        <li>‚Ä¢ Recognize the stress pattern early</li>
        <li>‚Ä¢ Channel opposite colors deliberately</li>
        <li>‚Ä¢ Set external accountability and deadlines</li>
        <li>‚Ä¢ Focus on outcomes, not comfortable patterns</li>
        <li>‚Ä¢ Practice the missing colors intentionally</li>
      </ul>
      <p><strong>For your team:</strong></p>
      <ul style="margin-top: 8px;">
        <li>‚Ä¢ Inject missing colors (pair with complementary identities)</li>
        <li>‚Ä¢ Provide structure or freedom as needed</li>
        <li>‚Ä¢ Challenge patterns gently but firmly</li>
        <li>‚Ä¢ Remind them of mission over method</li>
      </ul>
    </div>
  </div>`;
  
  return html;
}

function getStressPatterns(id) {
  const patterns = {
    'AZORIUS': ['Withdraws into process design, avoiding decisions', 'Creates bureaucracy to delay action', 'Condescending about "proper procedure"', 'Dismisses urgency as "lack of planning"', 'Paralyzed between fairness and efficiency'],
    'DIMIR': ['Hoards information more aggressively', 'Paranoid about being outmaneuvered', 'Manipulates situations to regain control', 'Trusts no one', 'Withdraws into strategic scheming'],
    'RAKDOS': ['Explosively destructive', 'Reckless gratification-seeking', 'Burns bridges impulsively', 'Creates chaos deliberately', 'Lashes out at all constraints'],
    'IZZET': ['Scattered across too many experiments', 'Reckless with resources and testing', 'Ignores practical constraints', 'Blows things up (literally or figuratively)', 'Excited by chaos'],
    'GRUUL': ['Increasingly aggressive and hostile', 'Smashes obstacles without thinking', 'Rejects all subtlety completely', 'Hostile to any complexity', 'Pure force over all finesse'],
    'SELESNYA': ['Enables dysfunction through acceptance', 'Sacrifices too much for false harmony', 'Avoids all necessary conflict', 'Toxic positivity', 'Won\'t address real problems'],
    'ORZHOV': ['Increasingly extractive and exploitative', 'Rigid hierarchy enforcement', 'Debt collection mentality', 'Political manipulation intensifies', 'Everything becomes transactional'],
    'GOLGARI': ['Fatalistic acceptance of decay', 'Exploits death and failure coldly', 'Patient to point of complete passivity', 'Cynical about all improvement', 'Waiting for things to die'],
    'SIMIC': ['Over-optimizes organic systems destructively', 'Experiments on people without consent', 'Perfectionism paralysis', 'Loses sight of "good enough"', 'Hubris about improvement capability'],
    'BOROS': ['Zealous to dangerous fault', 'Aggressively enforces "right" way', 'Burnout from unsustainable intensity', 'Rigid about honor code', 'Cult-like fervor'],
    'MONO-W': ['Rigidly rule-bound', 'Excessive self-sacrifice', 'Martyr complex', 'Slow consensus-seeking', 'Judges others harshly for rule-breaking'],
    'MONO-U': ['Analysis paralysis worsens', 'Condescending intellectualism', 'Avoids action completely', 'Designs over-complex solutions', 'Dismisses all emotions'],
    'MONO-B': ['Ruthlessly transactional with everyone', 'Cuts people off easily', 'Increasingly amoral decisions', 'Paranoid about exploitation', 'Hoards everything'],
    'MONO-R': ['Explosively emotional', 'Recklessly impulsive', 'Quits/destroys when frustrated', 'Refuses all planning', 'Completely chaotic and scattered'],
    'MONO-G': ['Increasingly passive', 'Fatalistic resignation', 'Stubbornly repetitive despite failure', 'Nostalgic for "good old days"', 'Enables dysfunction through acceptance']
  };
  
  return patterns[id] || [
    'Intensifies characteristic patterns',
    'Shadow behaviors emerge more strongly',
    'Becomes less balanced and flexible',
    'May withdraw or become rigid',
    'Struggles with rapid adaptation'
  ];
}

function getDevelopmentContent(id) {
  const profile = PROFILES[id];
  if (!profile) return '<p>Content not available</p>';
  
  const type = getCandidateType(id);
  const colorNames = {W:'White', U:'Blue', B:'Black', R:'Red', G:'Green'};
  
  let html = '';
  
  html += `<div style="margin-bottom: 24px; padding: 20px; background: rgba(139,92,246,0.08); border-radius: 12px; border-left: 4px solid #a78bfa;">
    <p style="font-size: 15px; color: #d0d0d0; line-height: 1.7;">
      <strong style="color: #c4b5fd;">Development path:</strong> Add colors you're weak in. Each color you add transforms your identity and unlocks new capabilities.
    </p>
  </div>`;
  
  const hasColors = profile.colors;
  const missing = ['W','U','B','R','G'].filter(c => !hasColors.includes(c));
  
  missing.forEach(color => {
    const newIdentity = getNewIdentity(id, color);
    html += `<div class="info-box development">
      <div class="box-header">
        <span class="mana-symbol mana-${color}" style="width: 24px; height: 24px; font-size: 12px;">${color}</span>
        <h4>Adding ${colorNames[color]}</h4>
      </div>
      <div class="box-content">
        ${getDevelopmentPath(id, color, colorNames[color], newIdentity)}
      </div>
    </div>`;
  });
  
  return html;
}

function getNewIdentity(currentId, addingColor) {
  const profile = PROFILES[currentId];
  if (!profile) return null;
  
  const newColors = [...profile.colors, addingColor].sort();
  
  for (const [id, prof] of Object.entries(PROFILES)) {
    if (prof.colors && prof.colors.length === newColors.length) {
      const profColorsSorted = [...prof.colors].sort();
      if (profColorsSorted.every((c, i) => c === newColors[i])) {
        return prof.name;
      }
    }
  }
  
  return null;
}

function getDevelopmentPath(id, color, colorName, newIdentity) {
  const developments = {
    W: {
      what: 'Community focus, fairness, systematic coordination',
      why: 'Adds stakeholder thinking and moral framework',
      how: ['Volunteer for team coordination roles', 'Ask "what\'s best for the team?" before deciding', 'Build one process that helps everyone', 'Practice sacrificing something small for group benefit']
    },
    U: {
      what: 'Analytical depth, strategic thinking, optimization',
      why: 'Adds evidence-based planning and long-term thinking',
      how: ['Analyze before acting‚Äîask "why?" more often', 'Read research on problems before solving', 'Map out consequences 3-5 steps ahead', 'Practice systematic optimization']
    },
    B: {
      what: 'Pragmatism, self-advocacy, tough decisions',
      why: 'Adds agency and ability to make hard calls',
      how: ['Negotiate explicitly for what you need', 'Practice saying no to protect your interests', 'Make one tough call per month', 'Evaluate personal benefit honestly']
    },
    R: {
      what: 'Passion, urgency, decisive action, authenticity',
      why: 'Adds energy and bias toward action',
      how: ['Act on 70% information sometimes', 'Express emotions more openly in meetings', 'Run quick experiments instead of extensive planning', 'Practice "ship it and iterate"']
    },
    G: {
      what: 'Patience, sustainability, organic growth, accumulated wisdom',
      why: 'Adds long-term thinking and respect for what works',
      how: ['Give initiatives time to develop naturally', 'Learn from precedent and experience', 'Practice patience with development timelines', 'Trust proven patterns and tradition']
    }
  };
  
  const dev = developments[color];
  if (!dev) return '<p>Development path information coming soon.</p>';
  
  let html = `
    <p><strong>What ${colorName} adds:</strong> ${dev.what}</p>
    <p style="margin-top: 8px;"><strong>Why you need it:</strong> ${dev.why}</p>
    <p style="margin-top: 12px;"><strong>How to develop:</strong></p>
    <ul style="margin-top: 8px;">`;
  
  dev.how.forEach(h => {
    html += `<li>‚Ä¢ ${h}</li>`;
  });
  
  html += `</ul>`;
  
  if (newIdentity) {
    html += `<p style="margin-top: 16px; padding: 12px; background: rgba(139,92,246,0.1); border-radius: 8px;">
      <strong style="color: #c4b5fd;">What you become:</strong> ${newIdentity}
    </p>`;
  }
  
  return html;
}

function getInteractionsContent(id) {
  return '<p style="color: #e0e0e0;">Interaction content coming soon.</p>';
}

function showResults() {

  // DEFENSIVE: Ensure activationSorted is set
  if (!state.activationSorted || state.activationSorted.length === 0) {
    console.error('CRITICAL: activationSorted not set, recalculating');
    const activation = {
      W: (state.pairwise['W-B'].W / 6 + state.pairwise['W-R'].W / 6) / 2,
      U: (state.pairwise['U-R'].U / 6 + state.pairwise['G-U'].U / 6) / 2,
      B: (state.pairwise['W-B'].B / 6 + state.pairwise['B-G'].B / 6) / 2,
      R: (state.pairwise['U-R'].R / 6 + state.pairwise['W-R'].R / 6) / 2,
      G: (state.pairwise['G-U'].G / 6 + state.pairwise['B-G'].G / 6) / 2
    };
    state.activationSorted = Object.entries(activation).sort((a,b) => b[1] - a[1]);
  }
  
  document.getElementById('screen-assessment').classList.add('hidden');
  document.getElementById('screen-results').classList.remove('hidden');
  
  const p = PROFILES[state.result.identity];
  
  document.getElementById('res-id').textContent = p.name;
  document.getElementById('res-tag').textContent = p.tag;
  
  // ENHANCEMENT: Detect PRIMARY color in multi-color combinations
  const primaryIndicator = document.getElementById('primary-color-indicator');
  const isCombination = !state.result.identity.startsWith('MONO-');
  if (isCombination && state.activationSorted && state.activationSorted.length >= 2) {
    const topColor = state.activationSorted[0];
    const secondColor = state.activationSorted[1];
    const gap = Math.round((topColor[1] - secondColor[1]) * 100);
    
    // Show primary indicator if gap is ‚â•15%
    if (gap >= 15) {
      const colorNames = { W: 'WHITE', U: 'BLUE', B: 'BLACK', R: 'RED', G: 'GREEN' };
      const primaryName = colorNames[topColor[0]];
      primaryIndicator.querySelector('p').textContent = `${primaryName} is your primary color within this combination (+${gap}% higher than next)`;
      primaryIndicator.style.display = 'block';
    } else {
      primaryIndicator.style.display = 'none';
    }
  } else {
    primaryIndicator.style.display = 'none';
  }
  
  document.getElementById('tot-q').textContent = state.responses.length;
  
  // Show which mode was used
  const modeText = state.mode === 'constructed' ? 'Constructed (mana symbols visible)' : 'Blind Draft (pure instinct)';
  document.getElementById('mode-used').textContent = modeText;
  
  // Set restart button text for assessment results
  document.getElementById('restart-btn').textContent = 'Take It Again';
  document.getElementById('restart-text').textContent = 'Retake it to get the result you wanted instead of who you actually are?';
  document.getElementById('explorer-hint').textContent = '';
  
  const badge = document.getElementById('conf-badge');
  badge.textContent = state.result.confidence + ' CONFIDENCE';
  badge.className = 'confidence-badge confidence-' + state.result.confidence;
  
  const expl = {
    HIGH: 'Clear, consistent pattern across stages.',
    MODERATE: 'Strong pattern with some variation.',
    LOW: 'Less clear‚Äîbalanced or context-dependent.'
  };
  document.getElementById('conf-exp').textContent = expl[state.result.confidence];
  
  // Generate identity explanation
  const sorted = state.activationSorted;
  const id = state.result.identity;
  const idExp = generateIdentityExplanation(id, sorted);
  document.getElementById('identity-exp').textContent = idExp;
  
  const syms = document.getElementById('res-syms');
  syms.innerHTML = '';
  
  // ENHANCEMENT: Display Round 1 and Round 2 patterns
  displayRoundPatterns();
  p.colors.forEach(c => {
    const s = document.createElement('span');
    s.className = `mana-symbol mana-${c}`;
    s.textContent = c;
    s.style.width = '44px';
    s.style.height = '44px';
    s.style.fontSize = '22px';
    syms.appendChild(s);
  });
  
  document.getElementById('res-desc').textContent = p.desc;
  document.getElementById('res-counter').textContent = p.pubBanter || '';
  
  // Show alternatives for LOW or MODERATE confidence if borderline
  const allResults = state.result.allResults || [];
  console.log('=== DISPLAYING ALTERNATIVES ===');
  console.log('Confidence:', state.result.confidence);
  console.log('allResults:', allResults.map(a => a[0]).join(', '));
  console.log('allResults.length:', allResults.length);
  
  // Check if top colors are borderline (pattern-specific checks)
  let colorsTied = false;
  const isGuild = state.result.identity && (state.result.identity.length === 2 || 
    ['AZORIUS','SELESNYA','ORZHOV','DIMIR','IZZET','SIMIC','RAKDOS','GOLGARI','GRUUL','BOROS'].includes(state.result.identity));
  const isThreeColor = state.result.identity && 
    ['BANT','ESPER','GRIXIS','JUND','NAYA','ABZAN','JESKAI','SULTAI','MARDU','TEMUR'].includes(state.result.identity);
  
  if (isGuild && sorted.length >= 2) {
    // For guild: check if top 2 colors very close
    colorsTied = Math.abs(sorted[0][1] - sorted[1][1]) < 0.05;
  } else if (isThreeColor && sorted.length >= 3) {
    // For three-color: check if spread across top 3 is small
    const spread = sorted[0][1] - sorted[2][1];
    colorsTied = spread < 0.08;
  } else if (sorted.length >= 3) {
    // For other patterns: check if 2nd and 3rd are tied
    colorsTied = Math.abs(sorted[1][1] - sorted[2][1]) < 0.08;
  }
  
  // Always show alternatives for MODERATE or LOW confidence
  if ((state.result.confidence === 'MODERATE' || state.result.confidence === 'LOW') && allResults.length === 0) {
    colorsTied = true; // Force display if no allResults but confidence not HIGH
  }
  
  console.log('colorsTied:', colorsTied);
  console.log('isGuild:', isGuild, 'isThreeColor:', isThreeColor);
  
  // Show if (LOW or MODERATE confidence) AND (colors are tied OR we have actual alternatives)
  const shouldShowAlternatives = (state.result.confidence === 'LOW' || state.result.confidence === 'MODERATE') && 
                                  (colorsTied || allResults.length > 1);
  
  if (shouldShowAlternatives) {
    document.getElementById('alternative-results').style.display = 'block';
    
    let whyText = '';
    
    if (allResults.length > 1) {
      const winner = allResults[0];
      const topAlt = allResults[1];
      const winnerData = winner[1];
      const altData = topAlt[1];
      
      whyText = `We're calling you ${state.result.identity} because `;
      
      if (winnerData.s1 > altData.s1 && winnerData.s2 > altData.s2) {
        whyText += `it scored higher in both rounds (Round 1: ${Math.round(winnerData.s1*100)}% vs ${Math.round(altData.s1*100)}%, Round 2: ${Math.round(winnerData.s2*100)}% vs ${Math.round(altData.s2*100)}%).`;
      } else if (winnerData.s1 > altData.s1) {
        whyText += `your color pattern in Round 1 pointed more strongly to it (${Math.round(winnerData.s1*100)}% vs ${Math.round(altData.s1*100)}%), and Round 1 carries more weight.`;
      } else if (winnerData.s2 > altData.s2) {
        whyText += `you picked it more consistently in Round 2 (${Math.round(winnerData.s2*100)}% vs ${Math.round(altData.s2*100)}%).`;
      } else {
        whyText += `the overall pattern across both rounds pointed to it.`;
      }
      
      whyText += ` That said, you're borderline‚Äîyou could legitimately be any of these:`;
    } else {
      whyText = 'Your pattern was borderline. You could legitimately be any of these:';
    }
    
    document.getElementById('why-explanation').textContent = whyText;
    
    const altList = document.getElementById('alternatives-list');
    altList.innerHTML = '';
    
    console.log('=== ALTERNATIVE SELECTION ===');
    console.log('allResults.length:', allResults.length);
    if (allResults.length > 0) {
      console.log('allResults[0] (winner):', allResults[0][0], Math.round((allResults[0][1].combined || allResults[0][1].s1)*100) + '%');
      console.log('state.result.identity (displayed):', state.result.identity);
      console.log('Match?', allResults[0][0] === state.result.identity);
    }
    console.log('Full allResults:', allResults.map(a => `${a[0]}(${Math.round((a[1].combined || a[1].s1)*100)}%)`).join(', '));
    
    // Get alternatives from allResults (ranked Stage 2 results), excluding winner
    const alternatives = allResults.slice(1, 4);
    console.log('Alternatives after slice(1,4):', alternatives.map(a => a[0]).join(', '));
    console.log('==============================');
    
    // If we have no alternatives but LOW/MODERATE confidence, show guidance
    if (alternatives.length === 0) {
      const guidanceDiv = document.createElement('div');
      guidanceDiv.style.cssText = 'background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 10px; padding: 20px;';
      
      if (state.result.confidence === 'LOW') {
        guidanceDiv.innerHTML = `
          <div style="font-size: 16px; font-weight: 600; color: #F59E0B; margin-bottom: 12px;">‚ö†Ô∏è Pattern Not Clear</div>
          <div style="font-size: 14px; color: #c0c0d0; line-height: 1.6;">
            Your color distribution doesn't show strong clustering. You might be genuinely balanced across approaches,
            or the assessment questions may not have captured enough nuance.
            <br><br>
            <strong>Your result is still valid</strong> ‚Äî consider the alternatives below to see if any resonate more strongly.
          </div>
        `;
      } else {
        guidanceDiv.innerHTML = `
          <div style="font-size: 14px; color: #c0c0d0; line-height: 1.6;">
            Your pattern points most strongly to <strong>${state.result.identity}</strong>, 
            though confidence is moderate. Review the alternatives below to see if another pattern fits better.
          </div>
        `;
      }
      altList.appendChild(guidanceDiv);
    } else {
      // Render actual alternatives
      alternatives.forEach(alt => {
      console.log('Processing alternative:', alt[0]);
      
      // Handle GUIDANCE type
      if (alt[0] === 'GUIDANCE') {
        const guidanceDiv = document.createElement('div');
        guidanceDiv.style.cssText = 'background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.3); border-radius: 10px; padding: 16px; margin-bottom: 12px;';
        guidanceDiv.innerHTML = `
          <div style="font-weight: 600; margin-bottom: 8px; color: #F59E0B;">üìã Recommendation</div>
          <div style="font-size: 14px; color: #c0c0d0;">${alt[1].note}</div>
        `;
        altList.appendChild(guidanceDiv);
        return;
      }
      
      const altProfile = PROFILES[alt[0]];
      console.log('Profile found for', alt[0], ':', !!altProfile);
      if (!altProfile) {
        console.warn('No profile found for:', alt[0]);
        return;
      }
      
      const altCard = document.createElement('div');
      altCard.style.cssText = 'background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 10px; padding: 16px; cursor: pointer; transition: all 0.2s;';
      altCard.onmouseover = () => altCard.style.background = 'rgba(139, 92, 246, 0.15)';
      altCard.onmouseout = () => altCard.style.background = 'rgba(139, 92, 246, 0.1)';
      altCard.onclick = () => switchToAlternative(alt[0]);
      
      const symbolsDiv = document.createElement('div');
      symbolsDiv.style.cssText = 'display: flex; gap: 6px; margin-bottom: 12px;';
      altProfile.colors.forEach(c => {
        const sym = document.createElement('span');
        sym.className = `mana-symbol mana-${c}`;
        sym.textContent = c;
        sym.style.width = '24px';
        sym.style.height = '24px';
        sym.style.fontSize = '12px';
        symbolsDiv.appendChild(sym);
      });
      
      const nameDiv = document.createElement('div');
      nameDiv.style.cssText = 'font-weight: 700; font-size: 16px; margin-bottom: 8px;';
      nameDiv.textContent = altProfile.name;
      
      const descDiv = document.createElement('div');
      descDiv.style.cssText = 'font-size: 13px; color: #c0c0d0; line-height: 1.6;';
      descDiv.textContent = altProfile.tag;
      
      altCard.appendChild(symbolsDiv);
      altCard.appendChild(nameDiv);
      altCard.appendChild(descDiv);
      altList.appendChild(altCard);
    });
    } // Close else block for alternatives rendering
  } else {
    // Hide alternatives if not genuinely borderline
    document.getElementById('alternative-results').style.display = 'none';
  }
  
  // Display commander with conditional formatting
  const oracleData = COMMANDER_ORACLE[p.cmd];
  
  if (oracleData) {
    // Show full card frame
    document.getElementById('cmd-card-frame').style.display = 'block';
    document.getElementById('cmd-simple').style.display = 'none';
    
    // Populate card frame
    document.getElementById('cmd-name-card').textContent = p.cmd;
    document.getElementById('cmd-desc-card').textContent = p.cmdDesc;
    
    const costDiv = document.getElementById('cmd-cost');
    costDiv.innerHTML = renderManaCost(oracleData.cost);
    
    const ptDiv = document.getElementById('cmd-pt');
    ptDiv.textContent = oracleData.pt;
    
    const oracleText = document.getElementById('cmd-oracle-text');
    oracleText.innerHTML = oracleData.text.map(line => 
      `<div style="margin-bottom: 8px;">${line}</div>`
    ).join('');
  } else {
    // Show simple reference
    document.getElementById('cmd-card-frame').style.display = 'none';
    document.getElementById('cmd-simple').style.display = 'block';
    
    document.getElementById('cmd-name-simple').textContent = p.cmd;
    document.getElementById('cmd-desc-simple').textContent = p.cmdDesc;
  }
  
  // Strengths
  const strList = document.getElementById('strengths');
  strList.innerHTML = '';
  p.str.forEach(s => {
    const li = document.createElement('li');
    li.style.cssText = 'padding: 6px 0; color: #10B981; font-size: 14px;';
    li.textContent = '‚Ä¢ ' + s;
    strList.appendChild(li);
  });
  
  // Weaknesses
  const weakList = document.getElementById('weaknesses');
  weakList.innerHTML = '';
  p.weak.forEach(w => {
    const li = document.createElement('li');
    li.style.cssText = 'padding: 6px 0; color: #EF4444; font-size: 14px;';
    li.textContent = '‚Ä¢ ' + w;
    weakList.appendChild(li);
  });
  
  document.getElementById('roles').textContent = p.roles;
  
  // Color breakdown - use ACTIVATION scores, not raw colorScores
  const names = {W:'White',U:'Blue',B:'Black',R:'Red',G:'Green'};
  const grads = {
    W:'linear-gradient(90deg, #FDE047, #F59E0B)',
    U:'linear-gradient(90deg, #93C5FD, #3B82F6)',
    B:'linear-gradient(90deg, #D1D5DB, #6B7280)',
    R:'linear-gradient(90deg, #FCA5A5, #EF4444)',
    G:'linear-gradient(90deg, #6EE7B7, #10B981)'
  };
  
  // DEBUG: Log scores before display
  console.log('=== SCORE DISPLAY DEBUG ===');
  console.log('Identity:', state.result.identity);
  console.log('Expected colors:', PROFILES[state.result.identity].colors);
  console.log('activationSorted:', state.activationSorted);
  console.log('========================');
  
  const bd = document.getElementById('breakdown');
  bd.innerHTML = '';
  
  // Use activationSorted (the actual scores used for identity determination)
  state.activationSorted.forEach(([color, activation]) => {
    const pct = Math.round(activation * 100);
    
    const bar = document.createElement('div');
    bar.style.cssText = 'margin: 16px 0;';
    bar.innerHTML = `
      <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: 600;">
        <div style="display: flex; align-items: center; gap: 12px;">
          <span class="mana-symbol mana-${color}" style="width: 28px; height: 28px; font-size: 14px;">${color}</span>
          <span>${names[color]}</span>
        </div>
        <span style="font-size: 20px; font-weight: 800;">${pct}%</span>
      </div>
      <div style="width: 100%; height: 12px; background: rgba(255,255,255,0.1); border-radius: 6px; overflow: hidden;">
        <div style="height: 100%; width: ${pct}%; background: ${grads[color]}; border-radius: 6px; transition: width 0.5s;"></div>
      </div>
    `;
    bd.appendChild(bar);
  });
  
  window.scrollTo({top: 0, behavior: 'smooth'});
}

function switchToAlternative(altIdentity) {
  // Find current result and selected alternative in allResults
  if (!state.result.allResults || state.result.allResults.length === 0) {
    console.error('No allResults available for switching');
    return;
  }
  
  const currentIdentity = state.result.identity;
  const allResults = state.result.allResults;
  
  // Find indices of current and alternative
  const currentIdx = allResults.findIndex(r => r[0] === currentIdentity);
  const altIdx = allResults.findIndex(r => r[0] === altIdentity);
  
  if (currentIdx === -1 || altIdx === -1) {
    console.error('Could not find identities in allResults', {currentIdentity, altIdentity, allResults});
    return;
  }
  
  // Swap positions in array
  [allResults[currentIdx], allResults[altIdx]] = [allResults[altIdx], allResults[currentIdx]];
  
  // Update state to new identity
  state.result.identity = altIdentity;
  
  // Re-render entire results page with updated allResults
  showResults();
  
  window.scrollTo({top: 0, behavior: 'smooth'});
}

function restart() {
  // Reset state completely
  state = {
    stage: 1,
    qNum: 0,
    qTot: 30,
    mode: 'draft', // Reset to default mode
    responses: [],
    colorScores: {W:0, U:0, B:0, R:0, G:0},
    pairwise: {
      'W-B': {W:0, B:0},
      'U-R': {U:0, R:0},
      'G-U': {G:0, U:0},
      'W-R': {W:0, R:0},
      'B-G': {B:0, G:0}
    },
    poolA: [],
    poolS2: [],
    s2Track: {appear: {}, select: {}},
    activationSorted: [],
    result: null,
    candidates: null,
    originalResult: null
  };
  
  document.getElementById('screen-results').classList.add('hidden');
  document.getElementById('screen-welcome').classList.remove('hidden');
  window.scrollTo({top: 0});
  
  // Reinitialize front page
  initArchetypeOfMonth();
  
  // Reset mode selection to draft
  selectMode('draft');
}

// ============================================================================
// EXPLORER FUNCTIONS
// ============================================================================
function showExplorer() {
  // Hide current screen
  document.getElementById('screen-welcome').classList.add('hidden');
  document.getElementById('screen-results').classList.add('hidden');
  document.getElementById('screen-explorer').classList.remove('hidden');
  
  // Populate explorer cards
  populateExplorer();
  window.scrollTo({top: 0, behavior: 'smooth'});
}

function closeExplorer() {
  document.getElementById('screen-explorer').classList.add('hidden');
  
  // Return to previous screen
  if (state.result && !state.result.isExplorer) {
    document.getElementById('screen-results').classList.remove('hidden');
  } else {
    document.getElementById('screen-welcome').classList.remove('hidden');
  }
  
  window.scrollTo({top: 0, behavior: 'smooth'});
}

function populateExplorer() {
  const monoIds = ['MONO-W', 'MONO-U', 'MONO-B', 'MONO-R', 'MONO-G'];
  const guildIds = ['AZORIUS', 'DIMIR', 'RAKDOS', 'GRUUL', 'SELESNYA', 'ORZHOV', 'IZZET', 'GOLGARI', 'SIMIC', 'BOROS'];
  const threeIds = ['BANT', 'ESPER', 'GRIXIS', 'JUND', 'NAYA', 'ABZAN', 'JESKAI', 'SULTAI', 'MARDU', 'TEMUR'];
  const fourIds = ['WITCH', 'YORE', 'GLINT', 'DUNE', 'INK'];
  const fiveIds = ['WUBRG'];
  
  document.getElementById('explorer-mono').innerHTML = monoIds.map(id => createExplorerCard(id)).join('');
  document.getElementById('explorer-guilds').innerHTML = guildIds.map(id => createExplorerCard(id)).join('');
  document.getElementById('explorer-three').innerHTML = threeIds.map(id => createExplorerCard(id)).join('');
  document.getElementById('explorer-four').innerHTML = fourIds.map(id => createExplorerCard(id)).join('');
  document.getElementById('explorer-five').innerHTML = fiveIds.map(id => createExplorerCard(id)).join('');
}

function createExplorerCard(id) {
  const p = PROFILES[id];
  if (!p) return '';
  
  const symbolsHTML = p.colors.map(c => 
    `<span class="mana-symbol mana-${c}" style="width: 24px; height: 24px; font-size: 12px;">${c}</span>`
  ).join('');
  
  return `
    <div id="card-${id}" onclick="showDetail('${id}')" style="
      background: rgba(255,255,255,0.03);
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 12px;
    " 
    onmouseover="this.style.background='rgba(139, 92, 246, 0.1)'; this.style.borderColor='rgba(139, 92, 246, 0.4)';"
    onmouseout="if(!this.classList.contains('selected')) { this.style.background='rgba(255,255,255,0.03)'; this.style.borderColor='rgba(255,255,255,0.1)'; }">
      
      <div style="display: flex; gap: 4px;">
        ${symbolsHTML}
      </div>
      
      <div style="flex: 1; min-width: 0;">
        <div style="font-size: 14px; font-weight: 700; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${p.name}</div>
        <div style="font-size: 11px; color: #a0a0b0; font-style: italic; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${p.tag}</div>
      </div>
    </div>
  `;
}

function showDetail(id) {
  const p = PROFILES[id];
  if (!p) return;
  
  // Clear previous selection
  document.querySelectorAll('[id^="card-"]').forEach(card => {
    card.classList.remove('selected');
    card.style.background = 'rgba(255,255,255,0.03)';
    card.style.borderColor = 'rgba(255,255,255,0.1)';
  });
  
  // Highlight selected card
  const selectedCard = document.getElementById(`card-${id}`);
  if (selectedCard) {
    selectedCard.classList.add('selected');
    selectedCard.style.background = 'rgba(139, 92, 246, 0.15)';
    selectedCard.style.borderColor = 'rgba(139, 92, 246, 0.6)';
  }
  
  // Hide placeholder, show content
  document.getElementById('detail-placeholder').style.display = 'none';
  document.getElementById('detail-content').style.display = 'block';
  
  // Populate detail panel
  const symbolsDiv = document.getElementById('detail-symbols');
  symbolsDiv.innerHTML = '';
  p.colors.forEach(c => {
    const s = document.createElement('span');
    s.className = `mana-symbol mana-${c}`;
    s.style.cssText = 'width: 40px; height: 40px; font-size: 20px;';
    s.textContent = c;
    symbolsDiv.appendChild(s);
  });
  
  document.getElementById('detail-name').textContent = p.name;
  document.getElementById('detail-tag').textContent = p.tag;
  document.getElementById('detail-desc').textContent = p.desc;
  
  // Get archetype example descriptions
  const example = ARCHETYPE_EXAMPLES.find(e => e.id === id);
  document.getElementById('detail-normal').textContent = example ? example.normal : p.desc;
  document.getElementById('detail-banter').textContent = example ? example.banter : p.pubBanter;
  
  // Commander
  document.getElementById('detail-cmd-name').textContent = p.cmd;
  document.getElementById('detail-cmd-desc').textContent = p.cmdDesc;
  
  // Strengths (show first 3)
  const strList = document.getElementById('detail-strengths');
  strList.innerHTML = '';
  p.str.slice(0, 3).forEach(s => {
    const li = document.createElement('li');
    li.style.cssText = 'padding: 4px 0; font-size: 13px;';
    li.textContent = '‚Ä¢ ' + s;
    strList.appendChild(li);
  });
  
  // Shadows (show first 3)
  const shadowList = document.getElementById('detail-shadows');
  shadowList.innerHTML = '';
  p.weak.slice(0, 3).forEach(w => {
    const li = document.createElement('li');
    li.style.cssText = 'padding: 4px 0; font-size: 13px;';
    li.textContent = '‚Ä¢ ' + w;
    shadowList.appendChild(li);
  });
  
  document.getElementById('detail-roles').textContent = p.roles;
  
  // Scroll detail panel to top
  document.getElementById('detail-panel').scrollTop = 0;
}

// ============================================================================
// INTERACTIONS GUIDE FUNCTIONS
// ============================================================================
function showInteractions() {
  // Hide current screen
  document.getElementById('screen-welcome').classList.add('hidden');
  document.getElementById('screen-results').classList.add('hidden');
  document.getElementById('screen-explorer').classList.add('hidden');
  document.getElementById('screen-interactions').classList.remove('hidden');
  
  // If coming from results (user has an identity), personalize it
  if (state.result && !state.result.isExplorer) {
    personalizeInteractions();
  } else {
    // Generic view
    document.getElementById('your-colors-section').style.display = 'none';
  }
  
  window.scrollTo({top: 0, behavior: 'smooth'});
}

function closeInteractions() {
  document.getElementById('screen-interactions').classList.add('hidden');
  
  // Return to previous screen
  if (state.result && !state.result.isExplorer) {
    document.getElementById('screen-results').classList.remove('hidden');
  } else {
    document.getElementById('screen-welcome').classList.remove('hidden');
  }
  
  window.scrollTo({top: 0, behavior: 'smooth'});
}

function personalizeInteractions() {
  const p = PROFILES[state.result.identity];
  if (!p) return;
  
  // Show and populate "Your Colors" section
  document.getElementById('your-colors-section').style.display = 'block';
  
  // Populate your symbols
  const symsDiv = document.getElementById('interactions-your-symbols');
  symsDiv.innerHTML = '';
  p.colors.forEach(c => {
    const s = document.createElement('span');
    s.className = `mana-symbol mana-${c}`;
    s.style.cssText = 'width: 36px; height: 36px; font-size: 18px;';
    s.textContent = c;
    symsDiv.appendChild(s);
  });
  
  document.getElementById('interactions-your-name').textContent = p.name;
  document.getElementById('interactions-your-tag').textContent = p.tag;
  
  // Generate personalized interaction guidance
  const yourContent = document.getElementById('interactions-your-content');
  let content = '<div style="font-size: 14px; color: #d0d0d0; line-height: 1.7;">';
  
  content += '<p style="margin-bottom: 16px;"><strong>Your strongest colors are:</strong> ';
  content += p.colors.map(c => ['White','Blue','Black','Red','Green'][['W','U','B','R','G'].indexOf(c)]).join(' and ');
  content += '.</p>';
  
  content += '<p style="margin-bottom: 12px;"><strong>This means you naturally:</strong></p>';
  content += '<ul style="list-style: none; padding-left: 0; margin-bottom: 16px;">';
  
  // Add natural tendencies based on colors
  const colorTraits = {
    W: 'Value team coordination and fairness',
    U: 'Seek optimal strategies through analysis',
    B: 'Prioritize results and self-advocacy',
    R: 'Trust your instincts and act quickly',
    G: 'Prefer proven approaches and patience'
  };
  
  p.colors.forEach(c => {
    content += `<li style="padding: 4px 0;">‚Ä¢ ${colorTraits[c]}</li>`;
  });
  
  content += '</ul>';
  content += '<p><strong>Scroll down to see how to work with people who think differently from you.</strong></p>';
  content += '</div>';
  
  yourContent.innerHTML = content;
}

// HELPER FUNCTIONS
function getGuild(c) {
  const m = {UW:'AZORIUS',WU:'AZORIUS',UB:'DIMIR',BU:'DIMIR',BR:'RAKDOS',RB:'RAKDOS',RG:'GRUUL',GR:'GRUUL',GW:'SELESNYA',WG:'SELESNYA',WB:'ORZHOV',BW:'ORZHOV',UR:'IZZET',RU:'IZZET',BG:'GOLGARI',GB:'GOLGARI',GU:'SIMIC',UG:'SIMIC',RW:'BOROS',WR:'BOROS'};
  return m[c] || 'AZORIUS';
}

function getThree(c) {
  const m = {GUW:'BANT',GWU:'BANT',UGW:'BANT',UWG:'BANT',WGU:'BANT',WUG:'BANT',UWB:'ESPER',UBW:'ESPER',WUB:'ESPER',WBU:'ESPER',BUW:'ESPER',BWU:'ESPER',UBR:'GRIXIS',URB:'GRIXIS',BUR:'GRIXIS',BRU:'GRIXIS',RUB:'GRIXIS',RBU:'GRIXIS',BRG:'JUND',BGR:'JUND',RBG:'JUND',RGB:'JUND',GBR:'JUND',GRB:'JUND',RGW:'NAYA',RWG:'NAYA',GRW:'NAYA',GWR:'NAYA',WRG:'NAYA',WGR:'NAYA',WBG:'ABZAN',WGB:'ABZAN',BWG:'ABZAN',BGW:'ABZAN',GWB:'ABZAN',GBW:'ABZAN',URW:'JESKAI',UWR:'JESKAI',RUW:'JESKAI',RWU:'JESKAI',WUR:'JESKAI',WRU:'JESKAI',BGU:'SULTAI',BUG:'SULTAI',GBU:'SULTAI',GUB:'SULTAI',UBG:'SULTAI',UGB:'SULTAI',RWB:'MARDU',RBW:'MARDU',WRB:'MARDU',WBR:'MARDU',BRW:'MARDU',BWR:'MARDU',GUR:'TEMUR',GRU:'TEMUR',UGR:'TEMUR',URG:'TEMUR',RGU:'TEMUR',RUG:'TEMUR'};
  return m[c] || 'BANT';
}

function getFour(absent) {
  const m = {R:'WITCH',G:'YORE',W:'GLINT',U:'DUNE',B:'INK'};
  return m[absent] || 'WITCH';
}

// NEW: Helper functions for improved classification
function getEnemies(color) {
  const enemyMap = {
    W: ['B', 'R'],
    U: ['R', 'G'],
    B: ['W', 'G'],
    R: ['U', 'W'],
    G: ['U', 'B']
  };
  return enemyMap[color] || [];
}

function areEnemies(color1, color2) {
  const enemyPairs = [
    ['W', 'B'], ['B', 'W'],
    ['U', 'R'], ['R', 'U'],
    ['G', 'U'], ['U', 'G'],
    ['W', 'R'], ['R', 'W'],
    ['B', 'G'], ['G', 'B']
  ];
  return enemyPairs.some(pair => 
    (pair[0] === color1 && pair[1] === color2) ||
    (pair[0] === color2 && pair[1] === color1)
  );
}

function generateThreeColorCombos(fourColors) {
  const combos = [];
  for (let i = 0; i < 4; i++) {
    for (let j = i+1; j < 4; j++) {
      for (let k = j+1; k < 4; k++) {
        const combo = [fourColors[i], fourColors[j], fourColors[k]].sort().join('');
        const threeId = getThree(combo);
        if (threeId) combos.push(threeId);
      }
    }
  }
  return combos;
}

function getGuildColors(guild) {
  const m = {AZORIUS:['W','U'],SELESNYA:['W','G'],ORZHOV:['W','B'],DIMIR:['U','B'],IZZET:['U','R'],SIMIC:['U','G'],RAKDOS:['B','R'],GOLGARI:['B','G'],GRUUL:['R','G'],BOROS:['R','W']};
  return m[guild] || ['W','U'];
}

// NEW: Universal function to get colors for ANY identity (mono, guild, three, four, five)
function getIdentityColors(identityId) {
  // First check if it's in PROFILES (handles everything)
  if (PROFILES[identityId] && PROFILES[identityId].colors) {
    return PROFILES[identityId].colors;
  }
  
  // Fallback to getGuildColors for two-color
  if (getGuildColors(identityId)) {
    return getGuildColors(identityId);
  }
  
  // Last resort: return empty array
  return [];
}

function findAdjacentGuilds(colors, exclude) {
  const all = ['AZORIUS','SELESNYA','ORZHOV','DIMIR','IZZET','SIMIC','RAKDOS','GOLGARI','GRUUL','BOROS'];
  return all.filter(g => {
    if (g === exclude) return false;
    const gc = getGuildColors(g);
    return (gc.includes(colors[0]) || gc.includes(colors[1])) && !(gc.includes(colors[0]) && gc.includes(colors[1]));
  });
}

function findGuildsWithColor(color) {
  const all = ['AZORIUS','SELESNYA','ORZHOV','DIMIR','IZZET','SIMIC','RAKDOS','GOLGARI','GRUUL','BOROS'];
  return all.filter(g => getGuildColors(g).includes(color));
}

console.log('=== SCRIPT END - All functions defined ===');
</script>
</body>
</html>
